<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>Cockpit — BTC Predictor</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-card: #111827;
  --bg-card-hover: #1a2332;
  --bg-input: #1e293b;
  --border: #1e293b;
  --border-active: #00d4aa;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent: #00d4aa;
  --accent-dim: rgba(0, 212, 170, 0.15);
  --red: #ef4444;
  --red-dim: rgba(239,68,68,0.15);
  --yellow: #eab308;
  --yellow-dim: rgba(234,179,8,0.15);
  --green: #22c55e;
  --green-dim: rgba(34,197,94,0.15);
  --blue: #3b82f6;
  --blue-dim: rgba(59,130,246,0.15);
  --purple: #a855f7;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ── LOGIN OVERLAY ── */
#login-overlay {
  position: fixed; inset: 0; z-index: 9999;
  background: var(--bg-primary);
  display: flex; align-items: center; justify-content: center;
  flex-direction: column; gap: 24px;
}
#login-overlay.hidden { display: none; }
.login-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px; padding: 48px;
  text-align: center; max-width: 400px; width: 90%;
}
.login-box h1 { font-size: 20px; margin-bottom: 8px; }
.login-box p { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }
.login-box input {
  width: 100%; padding: 12px 16px;
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text-primary); font-size: 14px;
  font-family: 'JetBrains Mono', monospace;
  outline: none; transition: border 0.2s;
}
.login-box input:focus { border-color: var(--accent); }
.login-box button {
  width: 100%; padding: 12px; margin-top: 16px;
  background: var(--accent); color: #000; font-weight: 600;
  border: none; border-radius: 8px; cursor: pointer; font-size: 14px;
  transition: opacity 0.2s;
}
.login-box button:hover { opacity: 0.85; }
.login-error { color: var(--red); font-size: 13px; margin-top: 12px; display: none; }

/* ── TOP BAR ── */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; border-bottom: 1px solid var(--border);
  background: var(--bg-card);
}
.topbar-left { display: flex; align-items: center; gap: 16px; }
.topbar-logo {
  font-size: 18px; font-weight: 700; color: var(--accent);
  font-family: 'JetBrains Mono', monospace;
}
.topbar-label {
  font-size: 13px; color: var(--text-muted);
  padding: 4px 10px; background: var(--accent-dim);
  border-radius: 6px; font-weight: 500;
}
.topbar-right { display: flex; align-items: center; gap: 20px; }
.topbar-stat {
  text-align: center;
}
.topbar-stat .val { font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.topbar-stat .lbl { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

/* ── METRICS ROW ── */
.metrics {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px; padding: 16px 24px;
}
.metric-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 10px; padding: 16px;
  transition: border 0.2s;
}
.metric-card:hover { border-color: var(--accent); }
.metric-card .label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.metric-card .value { font-size: 22px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.metric-card .sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

/* ── AGENTS GRID ── */
.agents-section { padding: 8px 24px 16px; }
.agents-section h2 { font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
.agents-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 14px;
}

/* ── AGENT CARD ── */
.agent-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 12px; padding: 20px;
  transition: all 0.25s; position: relative; overflow: hidden;
}
.agent-card:hover { border-color: var(--accent); background: var(--bg-card-hover); }
.agent-card.running { border-left: 3px solid var(--accent); }
.agent-card.done { border-left: 3px solid var(--green); }
.agent-card.error { border-left: 3px solid var(--red); }
.agent-card.pending { border-left: 3px solid var(--text-muted); }

.agent-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.agent-name { font-weight: 700; font-size: 15px; }
.agent-role { font-size: 12px; color: var(--text-secondary); }
.agent-status {
  display: flex; align-items: center; gap: 6px;
  font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
}
.status-dot {
  width: 8px; height: 8px; border-radius: 50%;
}
.status-dot.running { background: var(--accent); animation: pulse 1.5s infinite; }
.status-dot.done { background: var(--green); }
.status-dot.error { background: var(--red); }
.status-dot.pending { background: var(--text-muted); }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

.agent-body { margin-bottom: 12px; }
.agent-task {
  font-size: 13px; color: var(--text-secondary);
  padding: 8px 10px; background: var(--bg-input);
  border-radius: 6px; margin-bottom: 8px;
  font-family: 'JetBrains Mono', monospace;
  max-height: 60px; overflow: hidden;
  line-height: 1.5;
}
.agent-thought {
  font-size: 12px; color: var(--text-muted); font-style: italic;
  max-height: 40px; overflow: hidden;
}

.agent-tasks-timeline {
  display: flex; gap: 4px; margin-bottom: 10px;
}
.task-pip {
  flex: 1; height: 4px; border-radius: 2px;
  background: var(--border);
}
.task-pip.done { background: var(--green); }
.task-pip.active { background: var(--accent); animation: pulse 1.5s infinite; }
.task-pip.error { background: var(--red); }

.agent-footer {
  display: flex; justify-content: space-between; align-items: center;
  font-size: 12px; color: var(--text-muted);
}
.agent-cost { font-family: 'JetBrains Mono', monospace; }
.agent-model {
  padding: 2px 8px; border-radius: 4px; font-size: 11px;
  background: var(--blue-dim); color: var(--blue);
}

/* ── EVENT LOG ── */
.log-section { padding: 8px 24px 24px; }
.log-section h2 { font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
.log-container {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 12px; max-height: 300px; overflow-y: auto;
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  padding: 12px;
}
.log-entry { padding: 4px 0; border-bottom: 1px solid var(--border); display: flex; gap: 12px; }
.log-entry:last-child { border-bottom: none; }
.log-time { color: var(--text-muted); min-width: 70px; }
.log-source { color: var(--accent); min-width: 80px; font-weight: 600; }
.log-msg { color: var(--text-secondary); }
.log-msg.alert { color: var(--yellow); }
.log-msg.error { color: var(--red); }
.log-msg.success { color: var(--green); }

/* ── ACTIONS BAR ── */
.actions-bar {
  display: flex; gap: 10px; padding: 0 24px 16px;
  flex-wrap: wrap;
}
.action-btn {
  padding: 8px 16px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--bg-card);
  color: var(--text-secondary); font-size: 13px; cursor: pointer;
  font-family: 'Inter', sans-serif; transition: all 0.2s;
}
.action-btn:hover { border-color: var(--accent); color: var(--text-primary); }
.action-btn.danger { border-color: var(--red); color: var(--red); }
.action-btn.danger:hover { background: var(--red-dim); }

/* ── RESPONSIVE ── */
@media (max-width: 768px) {
  .topbar { flex-direction: column; gap: 12px; }
  .agents-grid { grid-template-columns: 1fr; }
  .metrics { grid-template-columns: repeat(2, 1fr); }
}

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
  <div class="login-box">
    <h1>Cockpit Access</h1>
    <p>BTC Predictor Bot — Cabina di Comando</p>
    <form id="login-form">
      <input type="password" id="login-token" placeholder="COCKPIT_TOKEN" autocomplete="off" autofocus>
      <button type="submit">Accedi</button>
    </form>
    <div class="login-error" id="login-error">Token non valido</div>
  </div>
</div>

<!-- MAIN APP (hidden until auth) -->
<div id="app" style="display:none">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">COCKPIT</div>
      <div class="topbar-label" id="connection-status">Connecting...</div>
    </div>
    <div class="topbar-right">
      <div class="topbar-stat">
        <div class="val" id="stat-agents">-</div>
        <div class="lbl">Agents</div>
      </div>
      <div class="topbar-stat">
        <div class="val" id="stat-uptime">-</div>
        <div class="lbl">Bot Uptime</div>
      </div>
      <div class="topbar-stat">
        <div class="val" id="stat-time" style="color:var(--accent)">--:--</div>
        <div class="lbl">UTC</div>
      </div>
    </div>
  </div>

  <!-- METRICS ROW -->
  <div class="metrics">
    <div class="metric-card">
      <div class="label">Bot Status</div>
      <div class="value" id="m-bot-status" style="color:var(--green)">-</div>
      <div class="sub" id="m-bot-mode">-</div>
    </div>
    <div class="metric-card">
      <div class="label">Open Positions</div>
      <div class="value" id="m-positions">-</div>
      <div class="sub" id="m-positions-detail">-</div>
    </div>
    <div class="metric-card">
      <div class="label">Today Predictions</div>
      <div class="value" id="m-predictions">-</div>
      <div class="sub" id="m-predictions-detail">-</div>
    </div>
    <div class="metric-card">
      <div class="label">Win Rate (live)</div>
      <div class="value" id="m-winrate">-</div>
      <div class="sub" id="m-winrate-detail">-</div>
    </div>
    <div class="metric-card">
      <div class="label">Agents Cost</div>
      <div class="value" id="m-cost">-</div>
      <div class="sub" id="m-cost-detail">-</div>
    </div>
    <div class="metric-card">
      <div class="label">Phase</div>
      <div class="value" id="m-phase">-</div>
      <div class="sub" id="m-phase-detail">-</div>
    </div>
  </div>

  <!-- ACTIONS BAR -->
  <div class="actions-bar">
    <button class="action-btn" onclick="refreshAll()">Refresh</button>
    <button class="action-btn" onclick="toggleAutoRefresh()">Auto-refresh: <span id="auto-label">ON</span></button>
    <button class="action-btn" onclick="downloadReport()">Download Report</button>
  </div>

  <!-- AGENTS GRID -->
  <div class="agents-section">
    <h2>AI Agents</h2>
    <div class="agents-grid" id="agents-grid">
      <!-- Populated by JS -->
    </div>
  </div>

  <!-- EVENT LOG -->
  <div class="log-section">
    <h2>Event Log</h2>
    <div class="log-container" id="log-container">
      <div class="log-entry">
        <span class="log-time">--:--</span>
        <span class="log-source">SYSTEM</span>
        <span class="log-msg">Waiting for data...</span>
      </div>
    </div>
  </div>

</div>

<script>
// ── CONFIG ──
const API_BASE = window.COCKPIT_API_BASE || '';
const REFRESH_INTERVAL = 5000;
let autoRefresh = true;
let refreshTimer = null;
let authToken = '';

// ── AUTH ──
document.getElementById('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const token = document.getElementById('login-token').value.trim();
  if (!token) return;
  try {
    const resp = await fetch(`${API_BASE}/cockpit/api/auth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })
    });
    if (resp.ok) {
      authToken = token;
      localStorage.setItem('cockpit_token', token);
      document.getElementById('login-overlay').classList.add('hidden');
      document.getElementById('app').style.display = 'block';
      startPolling();
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  } catch (err) {
    document.getElementById('login-error').textContent = 'Connessione fallita';
    document.getElementById('login-error').style.display = 'block';
  }
});

// Auto-login from localStorage
(function() {
  const saved = localStorage.getItem('cockpit_token');
  if (saved) {
    authToken = saved;
    document.getElementById('login-overlay').classList.add('hidden');
    document.getElementById('app').style.display = 'block';
    startPolling();
  }
})();

// ── API HELPERS ──
async function apiFetch(path) {
  const resp = await fetch(`${API_BASE}${path}`, {
    headers: { 'X-Cockpit-Token': authToken }
  });
  if (resp.status === 403) {
    localStorage.removeItem('cockpit_token');
    document.getElementById('login-overlay').classList.remove('hidden');
    document.getElementById('app').style.display = 'none';
    throw new Error('Unauthorized');
  }
  return resp.json();
}

// ── CLOCK ──
function updateClock() {
  const now = new Date();
  const utc = now.toISOString().slice(11, 16);
  document.getElementById('stat-time').textContent = utc;
}
setInterval(updateClock, 1000);
updateClock();

// ── RENDER AGENTS ──
function renderAgents(agents) {
  const grid = document.getElementById('agents-grid');
  if (!agents || agents.length === 0) {
    grid.innerHTML = '<div style="color:var(--text-muted);padding:24px;text-align:center">Nessun agent attivo. Lancia l\'orchestratore per iniziare.</div>';
    return;
  }

  grid.innerHTML = agents.map(a => {
    const status = a.status || 'pending';
    const tasks = a.tasks || [];
    const taskPips = tasks.map(t =>
      `<div class="task-pip ${t.status}"></div>`
    ).join('');

    const elapsed = a.elapsed_sec ? formatElapsed(a.elapsed_sec) : '-';
    const model = (a.model || '').includes('opus') ? 'Opus' : (a.model || '').includes('sonnet') ? 'Sonnet' : a.model || '-';
    const modelColor = model === 'Opus' ? 'var(--purple)' : 'var(--blue)';
    const modelBg = model === 'Opus' ? 'rgba(168,85,247,0.15)' : 'var(--blue-dim)';

    return `
    <div class="agent-card ${status}">
      <div class="agent-header">
        <div>
          <div class="agent-name">${a.name || a.clone_id}</div>
          <div class="agent-role">${a.role || ''}</div>
        </div>
        <div class="agent-status">
          <div class="status-dot ${status}"></div>
          ${status.toUpperCase()}
        </div>
      </div>
      ${tasks.length ? `<div class="agent-tasks-timeline">${taskPips}</div>` : ''}
      <div class="agent-body">
        <div class="agent-task">${escapeHtml(a.current_task || a.last_message || 'In attesa...')}</div>
        ${a.thought ? `<div class="agent-thought">${escapeHtml(a.thought)}</div>` : ''}
      </div>
      <div class="agent-footer">
        <div>
          <span class="agent-cost">$${(a.cost_usd || 0).toFixed(2)}</span>
          <span style="color:var(--text-muted)"> / $${(a.max_budget || 0).toFixed(2)}</span>
          <span style="margin-left:8px;color:var(--text-muted)">${elapsed}</span>
        </div>
        <div class="agent-model" style="background:${modelBg};color:${modelColor}">${model}</div>
      </div>
    </div>`;
  }).join('');
}

// ── RENDER LOG ──
function renderLog(events) {
  const container = document.getElementById('log-container');
  if (!events || events.length === 0) return;

  container.innerHTML = events.slice(-50).reverse().map(e => {
    const cls = e.level === 'error' ? 'error' : e.level === 'alert' ? 'alert' : e.level === 'success' ? 'success' : '';
    const time = e.timestamp ? new Date(e.timestamp).toISOString().slice(11, 19) : '--:--:--';
    return `
    <div class="log-entry">
      <span class="log-time">${time}</span>
      <span class="log-source">${escapeHtml(e.source || 'SYSTEM')}</span>
      <span class="log-msg ${cls}">${escapeHtml(e.message || '')}</span>
    </div>`;
  }).join('');
}

// ── RENDER METRICS ──
function renderMetrics(overview) {
  if (!overview) return;

  const bs = document.getElementById('m-bot-status');
  if (overview.bot_paused) {
    bs.textContent = 'PAUSED';
    bs.style.color = 'var(--yellow)';
  } else if (overview.dry_run) {
    bs.textContent = 'DRY RUN';
    bs.style.color = 'var(--blue)';
  } else {
    bs.textContent = 'ACTIVE';
    bs.style.color = 'var(--green)';
  }
  document.getElementById('m-bot-mode').textContent = overview.mode || '';

  document.getElementById('m-positions').textContent = overview.open_positions ?? '-';
  document.getElementById('m-positions-detail').textContent = overview.position_detail || '';

  document.getElementById('m-predictions').textContent = overview.today_predictions ?? '-';
  document.getElementById('m-predictions-detail').textContent = overview.predictions_detail || '';

  const wr = overview.win_rate;
  const wrEl = document.getElementById('m-winrate');
  if (wr !== null && wr !== undefined) {
    wrEl.textContent = (wr * 100).toFixed(1) + '%';
    wrEl.style.color = wr >= 0.55 ? 'var(--green)' : wr >= 0.45 ? 'var(--yellow)' : 'var(--red)';
  }
  document.getElementById('m-winrate-detail').textContent = overview.winrate_detail || '';

  const cost = overview.agents_total_cost;
  document.getElementById('m-cost').textContent = cost !== undefined ? `$${cost.toFixed(2)}` : '-';
  document.getElementById('m-cost-detail').textContent = overview.cost_detail || '';

  document.getElementById('m-phase').textContent = overview.current_phase || '-';
  document.getElementById('m-phase-detail').textContent = overview.phase_detail || '';

  document.getElementById('stat-agents').textContent =
    `${overview.agents_running || 0}/${overview.agents_total || 0}`;
  document.getElementById('stat-uptime').textContent = overview.uptime || '-';
}

// ── REFRESH ALL ──
async function refreshAll() {
  try {
    document.getElementById('connection-status').textContent = 'Refreshing...';
    document.getElementById('connection-status').style.background = 'var(--yellow-dim)';

    const [agentsData, overviewData] = await Promise.all([
      apiFetch('/cockpit/api/agents'),
      apiFetch('/cockpit/api/overview')
    ]);

    renderAgents(agentsData.agents || []);
    renderLog(agentsData.events || []);
    renderMetrics(overviewData);

    document.getElementById('connection-status').textContent = 'Connected';
    document.getElementById('connection-status').style.background = 'var(--green-dim)';
  } catch (err) {
    document.getElementById('connection-status').textContent = 'Disconnected';
    document.getElementById('connection-status').style.background = 'var(--red-dim)';
    console.error('Refresh error:', err);
  }
}

// ── POLLING ──
function startPolling() {
  refreshAll();
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(() => {
    if (autoRefresh) refreshAll();
  }, REFRESH_INTERVAL);
}

function toggleAutoRefresh() {
  autoRefresh = !autoRefresh;
  document.getElementById('auto-label').textContent = autoRefresh ? 'ON' : 'OFF';
}

function downloadReport() {
  apiFetch('/cockpit/api/agents').then(data => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cockpit_report_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });
}

// ── UTILS ──
function formatElapsed(sec) {
  if (!sec) return '-';
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}m ${s.toString().padStart(2, '0')}s`;
}
function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
