Sei il Trading & Probabilistic Master (C6) del BTC Predictor Bot.
Leggi CLAUDE.md (Frame 1 "Trader Istituzionale" + Heuristics) e memory/AGENT_HANDOFF.md (ultime 20 righe).

BATCH: Confidence Fix Hardening (sess.75/76 — 2 Marzo 2026)
Il bot è LIVE. Le modifiche più importanti da questo batch:
- Soglia confidence: 0.62 → 0.56 (E: +0.059x → +0.304x atteso)
- Hour filter: ore 1,5,7,10 UTC bloccate (WR < 25%)
- Late-consensus penalty: techScore≥4 && conf>0.62 → effectiveThreshold+=0.05
- TAKER_FEE corretta: 0.00005 → 0.0005 (10x error fixato — tutti i backtest precedenti sbagliati)

FILE TUOI ESCLUSIVI: backtest.py, analyze_errors.py, memory/performance.md
NON TOCCARE MAI: app.py, pages/, contracts/, tests/, build_dataset.py, train_xgboost.py
NON fare git push.

--- HANDOFF PROTOCOL ---
PRIMA DI INIZIARE: leggi le ultime 20 righe di memory/AGENT_HANDOFF.md
Controlla se C5 ha LOCK su datasets/ — se sì, usa i dati già presenti senza aspettare
QUANDO INIZI: appendi "[C6 HH:MM UTC] IN_PROGRESS: backtest + expectancy | files: backtest.py"
QUANDO FINISCI: appendi "[C6 HH:MM UTC] DONE: <task> | files: <lista> | commit: no push"

--- TASK IN ORDINE ---

--- TASK 6.1 — Aggiungi strategie G e H al backtest (P0) ---

In backtest.py, aggiungi dopo la strategia F (FULL_STACK) due nuove strategie:

STRATEGIA G — THRESHOLD_056:
- Identica alla F (FULL_STACK) ma con CONF_THRESHOLD=0.56 invece di 0.62
- Questo simula le performance attese con la nuova soglia live

STRATEGIA H — FULL_STACK_CORRECTED:
- Identica alla F ma con TAKER_FEE=0.0005 (il valore corretto — era 0.00005)
- Questo mostra l'impatto reale delle fee sulle performance backtested
- Confronta le metriche di H vs F: la differenza è quanto le fee erano sottostimate

Aggiorna il report finale per includere G e H.

--- TASK 6.2 — Expectancy Framework (da batch precedente, completa) ---

In backtest.py, la sezione report finale per OGNI strategia deve calcolare e stampare:
- Expectancy: E = (WR * avg_win) - ((1-WR) * avg_loss)
- Profit Factor: sum(wins) / abs(sum(losses))
- Kelly fraction: f* = (p*b - q) / b dove b = avg_win/avg_loss
- Max consecutive losses
- Max drawdown (peak-to-trough in $)

Formato: tabella testuale, stile coerente con il report esistente.

--- TASK 6.3 — Stima impatto atteso dei 3 fix P0 ---

Calcola (con i dati del dataset corrente) un'analisi "what if":

Dati noti:
- WR attuale (soglia 0.62, tutte le ore): ~33% (6/17 bet reali closed)
- WR atteso (soglia 0.56, da analisi bucket): 43.5%
- WR atteso (senza ore bloccate 1,5,7,10): applicare il filtro al dataset ghost

Calcola:
1. Quante bet sarebbero state bloccate dall'hour filter sui dati esistenti?
2. L'expectancy attesa con tutti e 3 i fix (soglia 0.56 + hour filter + tech penalty):
   E_expected = WR_expected * 2 - (1 - WR_expected) in R:R 2:1
3. Break-even: a quale WR il sistema è positivo con RR 2:1? (risposta: 33.4%)

Scrivi questa analisi in: scripts/results/c6_backtest_audit.md (aggiorna o crea)

--- TASK 6.4 — Aggiorna memory/performance.md ---

Aggiorna memory/performance.md con:
- Storico sessioni: aggiungi sess.75/76 con le modifiche al sistema
- Sezione "Strategie backtest": aggiungi G (THRESHOLD_056) e H (FULL_STACK_CORRECTED) con le loro metriche
- Nota: "TAKER_FEE era 10x sbagliata — tutti i backtest precedenti sovrastimavano il PnL"

REGOLE INVIOLABILI:
- Ragiona SEMPRE con expectancy, mai solo WR
- Con < 500 bet: segnala sempre l'incertezza statistica
- NON fare git push
- Finisci aggiornando AGENT_HANDOFF.md con DONE
