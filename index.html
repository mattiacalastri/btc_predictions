<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>BTC BOT · ASTRA DIGITAL</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='15' fill='%230d0d0d'/%3E%3Ctext x='50' y='72' font-size='70' text-anchor='middle' fill='%2300ff88' font-family='Arial'%3E%E2%82%BF%3C/text%3E%3C/svg%3E">
<style>
  :root {
    --bg: #080b0f;
    --surface: #0d1117;
    --card: #111820;
    --border: #1e2d3d;
    --accent: #00ff88;
    --blue: #00aaff;
    --text: #e8f0fe;
    --muted: #4a6070;
    --danger: #ff4466;
    --warn: #ffaa00;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.025) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { position: relative; z-index: 1; max-width: 1600px; margin: 0 auto; padding: 20px 24px; }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .logo { font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; color: var(--muted); }
  .logo span { color: var(--accent); }
  h1 { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
  h1 span { color: var(--accent); }

  .header-right { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }

  .btc-live-ticker { display: flex; flex-direction: column; align-items: flex-end; }
  .btc-live-price { font-size: 20px; font-weight: 900; color: var(--accent); font-family: 'Syne', sans-serif; letter-spacing: -0.5px; line-height: 1; transition: color 0.3s; }
  .btc-live-price.up { color: var(--accent); }
  .btc-live-price.down { color: var(--danger); }
  .btc-price-meta { font-size: 9px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 2px; }
  .btc-price-change { font-size: 10px; font-weight: 700; }
  .btc-price-change.pos { color: var(--accent); }
  .btc-price-change.neg { color: var(--danger); }

  .live-badge { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); border: 1px solid rgba(0,255,136,0.3); padding: 5px 12px; border-radius: 2px; background: rgba(0,255,136,0.05); }
  .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 1.5s infinite; }
  .last-update { font-size: 10px; color: var(--muted); letter-spacing: 1px; }

  .bot-status { display: flex; align-items: center; gap: 7px; font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; padding: 5px 12px; border-radius: 2px; border: 1px solid; transition: all 0.4s; }
  .bot-status.alive   { color: var(--accent); border-color: rgba(0,255,136,0.3); background: rgba(0,255,136,0.05); }
  .bot-status.warning { color: var(--warn);   border-color: rgba(255,170,0,0.3); background: rgba(255,170,0,0.05); }
  .bot-status.dead    { color: var(--danger);  border-color: rgba(255,68,102,0.3); background: rgba(255,68,102,0.07); animation: deadPulse 2s infinite; }
  .bot-status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .alive .bot-status-dot   { background: var(--accent); box-shadow: 0 0 5px var(--accent); animation: pulse 1.5s infinite; }
  .warning .bot-status-dot { background: var(--warn);   box-shadow: 0 0 5px var(--warn); animation: pulse 2s infinite; }
  .dead .bot-status-dot    { background: var(--danger); }
  .bot-status-inner { display: flex; flex-direction: column; }
  .bot-status-detail { font-size: 9px; color: var(--muted); letter-spacing: 1px; font-weight: 400; margin-top: 1px; }

  @keyframes pulse    { 0%,100%{opacity:1} 50%{opacity:0.4} }
  @keyframes deadPulse{ 0%,100%{opacity:1} 50%{opacity:0.5} }
  @keyframes blink    { 0%,100%{opacity:1} 50%{opacity:0} }
  .loading { display: inline-block; animation: blink 1s step-end infinite; color: var(--accent); }

  /* KPI GRID */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  @media (max-width: 1300px) { .kpi-grid { grid-template-columns: repeat(5, 1fr); } }
  @media (max-width: 700px)  { .kpi-grid { grid-template-columns: repeat(3, 1fr); } }

  .kpi { background: var(--card); border: 1px solid var(--border); padding: 14px 16px; position: relative; overflow: hidden; transition: border-color 0.2s; min-width: 0; cursor: pointer; }
  .kpi:hover { border-color: rgba(255,255,255,0.12); }
  .kpi::after { content: ''; position: absolute; top: 0; left: 0; width: 2px; height: 100%; }
  .kpi.green::after  { background: var(--accent); }
  .kpi.red::after    { background: var(--danger); }
  .kpi.yellow::after { background: var(--warn); }
  .kpi.blue::after   { background: var(--blue); }
  .kpi.purple::after { background: #aa66ff; }

  .kpi-label { font-size: 9px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .kpi-value { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
  .kpi-value.green  { color: var(--accent); }
  .kpi-value.red    { color: var(--danger); }
  .kpi-value.yellow { color: var(--warn); }
  .kpi-value.white  { color: var(--text); }
  .kpi-value.blue   { color: var(--blue); }
  .kpi-value.purple { color: #aa66ff; }
  .kpi-sub { font-size: 10px; color: var(--muted); margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* STATS ROW */
  .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--border); margin-bottom: 16px; }
  @media (max-width: 900px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
  .stat-cell { background: var(--card); padding: 14px 18px; text-align: center; }
  .stat-cell-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .stat-cell-val { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; }

  /* MAIN GRID */
  .main-grid { display: grid; grid-template-columns: 1fr 320px; gap: 14px; margin-bottom: 14px; }
  @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }

  /* PANEL */
  .panel { background: var(--card); border: 1px solid var(--border); overflow: hidden; }
  .panel-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 18px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.015); flex-wrap: wrap; gap: 8px; }
  .panel-title { font-size: 10px; font-weight: 700; letter-spacing: 2.5px; text-transform: uppercase; color: var(--muted); }
  .next-signal-badge { font-size: 9px; font-weight: 700; letter-spacing: 0.8px; color: var(--muted); background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 4px; padding: 1px 6px; margin-left: 6px; font-family: 'IBM Plex Mono', monospace; vertical-align: middle; white-space: nowrap; }
  .next-signal-badge.imminent { color: var(--accent); border-color: rgba(0,255,136,0.3); }
  .next-signal-badge.overdue  { color: var(--warn);   border-color: rgba(255,170,0,0.3); }
  .panel-tag { font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; padding: 3px 9px; border-radius: 2px; }
  .tag-green  { background: rgba(0,255,136,0.08);  color: var(--accent); border: 1px solid rgba(0,255,136,0.2); }
  .tag-red    { background: rgba(255,68,102,0.08); color: var(--danger); border: 1px solid rgba(255,68,102,0.2); }
  .tag-yellow { background: rgba(255,170,0,0.08);  color: var(--warn);   border: 1px solid rgba(255,170,0,0.2); }
  .tag-blue   { background: rgba(0,170,255,0.08);  color: var(--blue);   border: 1px solid rgba(0,170,255,0.2); }
  .tag-muted  { background: rgba(74,96,112,0.1);   color: var(--muted);  border: 1px solid rgba(74,96,112,0.2); }

  /* COSTS TAB */
  .cost-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .cost-table th { font-size: 9px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); }
  .cost-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
  .cost-table tr:last-child td { border-bottom: none; font-weight: 700; color: var(--text); }
  .cost-bar-wrap { width: 120px; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; }
  .cost-bar-fill { height: 100%; border-radius: 3px; transition: width 0.4s ease; }
  .cost-type-badge { font-size: 8px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; padding: 2px 6px; border-radius: 2px; display: inline-block; }
  .svc-logo { width:24px; height:24px; border-radius:3px; display:inline-flex; align-items:center; justify-content:center; font-size:6px; font-weight:800; letter-spacing:0px; border:1px solid; flex-shrink:0; font-family:'JetBrains Mono',monospace; }

  /* TABLE */
  .table-wrap { overflow-x: auto; max-height: 500px; overflow-y: auto; }
  .table-wrap::-webkit-scrollbar { width: 3px; height: 3px; }
  .table-wrap::-webkit-scrollbar-thumb { background: var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 11px; }
  thead th { text-align: left; font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); padding: 9px 12px; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 2; white-space: nowrap; }
  tbody tr { border-bottom: 1px solid rgba(30,45,61,0.4); transition: background 0.12s; }
  tbody tr:hover { background: rgba(255,255,255,0.025); }
  tbody td { padding: 8px 12px; white-space: nowrap; vertical-align: middle; }

  .dir-up   { color: var(--accent); font-weight: 700; }
  .dir-down { color: var(--danger); font-weight: 700; }

  .badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 7px; border-radius: 2px; font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .badge-bet     { background: rgba(0,170,255,0.1);  color: var(--blue); }
  .badge-nobet   { background: rgba(74,96,112,0.15); color: var(--muted); }
  .badge-correct  { background: rgba(0,255,136,0.1);  color: var(--accent); }
  .badge-wrong    { background: rgba(255,68,102,0.1); color: var(--danger); }
  .badge-skip     { background: rgba(74,96,112,0.2);   color: #8ca0b0; border: 1px solid rgba(74,96,112,0.3); }
  .badge-alert    { background: rgba(255,170,0,0.1);   color: var(--warn); border: 1px solid rgba(255,170,0,0.3); }
  .badge-pending  { background: rgba(170,102,255,0.1); color: #aa66ff; border: 1px solid rgba(170,102,255,0.3); }

  #apiErrorBanner {
    display: none;
    align-items: center;
    gap: 10px;
    background: rgba(255,68,102,0.08);
    border: 1px solid rgba(255,68,102,0.3);
    border-radius: 4px;
    padding: 8px 16px;
    margin-bottom: 14px;
    font-size: 11px;
    color: var(--danger);
    letter-spacing: 0.5px;
  }
  #apiErrorBanner.visible { display: flex; }
  #apiErrorBanner .err-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--danger); flex-shrink: 0; animation: pulse 1.5s ease-in-out infinite; }
  #apiErrorBanner .err-dismiss { margin-left: auto; cursor: pointer; opacity: 0.6; font-size: 14px; line-height: 1; }
  #apiErrorBanner .err-dismiss:hover { opacity: 1; }

  .pnl-pos  { color: var(--accent); }
  .pnl-neg  { color: var(--danger); }
  .pnl-null { color: var(--muted); }
  .no-data-row td { text-align: center; color: var(--muted); padding: 28px; font-size: 11px; letter-spacing: 2px; }

  /* SIZE cell */
  .size-val    { color: var(--blue); font-weight: 700; font-size: 10px; display: block; }
  .size-reason { color: var(--muted); font-size: 9px; display: block; margin-top: 2px; letter-spacing: 0.5px; }
  .size-mult   { font-size: 9px; }
  .size-mult.up   { color: var(--accent); }
  .size-mult.down { color: var(--danger); }
  .size-mult.base { color: var(--muted); }

  /* FILTERS */
  .filters-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
  .time-pill { font-family: inherit; font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; padding: 3px 9px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; border-radius: 2px; transition: all 0.15s; }
  .time-pill:hover { color: var(--text); border-color: var(--muted); }
  .time-pill.active { background: var(--accent); border-color: var(--accent); color: #000; }
  select.filter-sel { background: var(--surface); border: 1px solid var(--border); color: var(--text); font-family: inherit; font-size: 9px; padding: 3px 7px; letter-spacing: 1px; cursor: pointer; outline: none; border-radius: 2px; }

  /* CHART */
  .chart-area { padding: 16px 18px; }
  .pnl-chart { display: flex; align-items: flex-end; gap: 2px; height: 90px; margin-bottom: 6px; }
  .bar { flex: 1; border-radius: 1px 1px 0 0; min-width: 6px; transition: opacity 0.15s; cursor: pointer; position: relative; }
  .bar:hover { opacity: 0.75; }
  .bar.pos  { background: var(--accent); }
  .bar.neg  { background: var(--danger); align-self: flex-start; border-radius: 0 0 1px 1px; }
  .bar.zero { background: var(--muted); height: 2px !important; }
  .bar-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--muted); }
  .tooltip { position: absolute; bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%); background: var(--surface); border: 1px solid var(--border); padding: 3px 7px; font-size: 9px; white-space: nowrap; pointer-events: none; z-index: 100; display: none; }
  .bar:hover .tooltip { display: block; }

  /* SIGNAL QUALITY */
  .signal-grid { padding: 14px 18px; display: flex; flex-direction: column; gap: 12px; }
  .signal-row { display: flex; flex-direction: column; gap: 5px; }
  .signal-meta { display: flex; justify-content: space-between; font-size: 9px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
  .signal-label { color: var(--muted); }
  .signal-val   { color: var(--text); }
  .signal-bar-bg   { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .signal-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

  /* CONF DIST */
  .conf-bars { padding: 14px 18px; display: flex; flex-direction: column; gap: 9px; }
  .conf-row { display: flex; align-items: center; gap: 9px; }
  .conf-label   { font-size: 9px; color: var(--muted); width: 42px; text-align: right; }
  .conf-bar-bg  { flex: 1; height: 12px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .conf-bar-fill{ height: 100%; background: var(--blue); transition: width 0.5s ease; }
  .conf-count   { font-size: 9px; color: var(--muted); width: 22px; text-align: right; }

  .equity-svg { width: 100%; }

  /* ═══════════════════════════════════════════
     ACCOUNT SUMMARY SECTION
  ═══════════════════════════════════════════ */

  .account-summary-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    margin-bottom: 14px;
  }
  @media (max-width: 1200px) { .account-summary-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 600px)  { .account-summary-grid { grid-template-columns: 1fr; } }

  .acct-panel {
    background: var(--card);
    border: 1px solid var(--border);
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .acct-panel:hover { border-color: rgba(255,255,255,0.1); }

  .acct-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(255,255,255,0.015);
  }
  .acct-panel-title {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .acct-panel-title .icon { font-size: 11px; }
  .acct-refresh-ts {
    font-size: 8px;
    color: var(--muted);
    letter-spacing: 0.5px;
  }

  .acct-body { padding: 14px 16px; display: flex; flex-direction: column; gap: 10px; }

  /* Wallet rows */
  .acct-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid rgba(30,45,61,0.5);
  }
  .acct-row:last-child { border-bottom: none; }
  .acct-row-label {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .acct-row-val {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
  }
  .acct-row-val.green  { color: var(--accent); }
  .acct-row-val.red    { color: var(--danger); }
  .acct-row-val.blue   { color: var(--blue); }
  .acct-row-val.yellow { color: var(--warn); }
  .acct-row-val.muted  { color: var(--muted); }

  /* Margin bar */
  .margin-bar-wrap { margin-top: 4px; }
  .margin-bar-label { display: flex; justify-content: space-between; font-size: 8px; color: var(--muted); margin-bottom: 4px; letter-spacing: 1px; text-transform: uppercase; }
  .margin-bar-bg { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .margin-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease, background 0.3s; }

  /* Position badge */
  .position-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border-radius: 2px;
    margin-bottom: 8px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .position-status.flat {
    background: rgba(74,96,112,0.12);
    border: 1px solid rgba(74,96,112,0.3);
    color: var(--muted);
  }
  .position-status.long {
    background: rgba(0,255,136,0.07);
    border: 1px solid rgba(0,255,136,0.25);
    color: var(--accent);
  }
  .position-status.short {
    background: rgba(255,68,102,0.07);
    border: 1px solid rgba(255,68,102,0.25);
    color: var(--danger);
  }
  .position-dot {
    width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
  }
  .position-status.flat  .position-dot { background: var(--muted); }
  .position-status.long  .position-dot { background: var(--accent); box-shadow: 0 0 5px var(--accent); animation: pulse 2s infinite; }
  .position-status.short .position-dot { background: var(--danger); box-shadow: 0 0 5px var(--danger); animation: pulse 2s infinite; }

  /* Fills table */
  .fills-table { width: 100%; border-collapse: collapse; font-size: 10px; }
  .fills-table th {
    text-align: left;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .fills-table td {
    padding: 7px 8px;
    border-bottom: 1px solid rgba(30,45,61,0.3);
    vertical-align: middle;
    white-space: nowrap;
  }
  .fills-table tr:last-child td { border-bottom: none; }
  .fill-buy  { color: var(--accent); font-weight: 700; }
  .fill-sell { color: var(--danger); font-weight: 700; }

  /* BTC Price card big number */
  .btc-mark-big {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: -1px;
    line-height: 1;
    margin-bottom: 4px;
  }
  .btc-price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid rgba(30,45,61,0.4);
  }
  .btc-price-row:last-child { border-bottom: none; }
  .btc-price-row-label { font-size: 9px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  .btc-price-row-val   { font-size: 11px; font-weight: 700; color: var(--text); }

  /* Summary section divider */
  .section-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 6px 0 14px;
  }
  .section-divider-label {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
  }
  .section-divider-line {
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .section-divider-ts {
    font-size: 8px;
    color: var(--muted);
    letter-spacing: 1px;
    white-space: nowrap;
  }

  /* Unrealized PnL indicator in position card */
  .pnl-indicator {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-radius: 2px;
    font-size: 11px;
    font-weight: 700;
  }
  .pnl-indicator.pos { background: rgba(0,255,136,0.07); border: 1px solid rgba(0,255,136,0.2); color: var(--accent); }
  .pnl-indicator.neg { background: rgba(255,68,102,0.07); border: 1px solid rgba(255,68,102,0.2); color: var(--danger); }
  .pnl-indicator.zero { background: rgba(74,96,112,0.1); border: 1px solid rgba(74,96,112,0.2); color: var(--muted); }

  /* Loading skeleton */
  .acct-skeleton {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 14px 16px;
  }
  .skeleton-line {
    height: 14px;
    background: var(--border);
    border-radius: 2px;
    animation: shimmer 1.5s infinite linear;
    background: linear-gradient(90deg, var(--border) 25%, rgba(30,45,61,0.8) 50%, var(--border) 75%);
    background-size: 200% 100%;
  }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  footer { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
  .footer-text { font-size: 9px; color: var(--muted); letter-spacing: 1px; }
  .footer-text span { color: var(--accent); }
  .config-hint { font-size: 9px; color: var(--muted); background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 5px 12px; border-radius: 2px; letter-spacing: 1px; }
  .config-hint code { color: var(--accent); }

  /* CHARTS GRID */
  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
  @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }

  .pnl-bars-large { display: flex; align-items: flex-end; gap: 3px; height: 130px; }

  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-thumb { background: var(--border); }

  /* ── TAB SYSTEM ──────────────────────────────────────────── */
  .tab-nav {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 0 16px; border-bottom: 1px solid var(--border);
    margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
  }
  .tab-buttons { display: flex; gap: 4px; }
  .tab-btn {
    font-family: inherit; font-size: 10px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase; padding: 7px 16px;
    border: 1px solid var(--border); background: transparent;
    color: var(--muted); cursor: pointer; border-radius: 2px; transition: all 0.15s;
  }
  .tab-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.2); }
  .tab-btn.active { background: rgba(0,255,136,0.08); border-color: rgba(0,255,136,0.3); color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Nascosta su desktop, mostrata solo dal media query mobile */
  .mobile-period-bar { display: none; }

  /* ── TAB NAV MOBILE SCROLL ──────────────────────────────── */
  @media (max-width: 900px) {
    .tab-nav {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      flex-wrap: nowrap;
      scrollbar-width: none;
      -ms-overflow-style: none;
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg);
      padding: 8px 0 8px;
      margin-bottom: 14px;
      gap: 8px;
    }
    .tab-nav::-webkit-scrollbar { display: none; }
    .tab-buttons {
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      flex-shrink: 0;
    }
    .tab-buttons::-webkit-scrollbar { display: none; }
    .tab-btn {
      white-space: nowrap;
      flex-shrink: 0;
      padding: 9px 14px;
      min-height: 36px;
    }
    /* WAR ROOM + period pills: una riga senza wrap */
    .tab-controls {
      flex-wrap: nowrap !important;
      gap: 5px !important;
      flex-shrink: 0;
    }
    .tab-controls-sep,
    .period-label,
    .desktop-period-pill { display: none; }

    /* Barra periodo mobile — sticky sotto il tab nav */
    .mobile-period-bar {
      display: flex;
      gap: 6px;
      align-items: center;
      position: sticky;
      top: 52px; /* altezza tab-nav mobile: padding 8+8 + btn 36px */
      z-index: 99;
      background: var(--bg);
      padding: 6px 0 8px;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    body.war-room .mobile-period-bar {
      background: #000;
      border-color: #111;
    }
  }

  /* ── AGENTS TAB ──────────────────────────────────────────── */
  .agents-section-header {
    font-size: 9px; font-weight: 700; letter-spacing: 2.5px;
    text-transform: uppercase; color: var(--muted);
    margin: 20px 0 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .agents-section-header:first-child { margin-top: 0; }
  .wf-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;
  }
  @media (max-width: 1100px) { .wf-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 600px)  { .wf-grid { grid-template-columns: 1fr; } }
  .wf-card {
    background: var(--card); border: 1px solid var(--border);
    padding: 14px 16px; transition: border-color 0.2s;
  }
  .wf-card:hover { border-color: rgba(255,255,255,0.1); }
  .wf-card-name {
    font-size: 11px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .wf-card-id { font-size: 9px; color: var(--muted); letter-spacing: 0.5px; margin-bottom: 10px; }
  .wf-card-meta { font-size: 10px; color: var(--muted); margin-top: 8px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  .agents-refresh-btn {
    font-family: inherit; font-size: 9px; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; padding: 4px 10px; border: 1px solid var(--border);
    background: transparent; color: var(--muted); cursor: pointer;
    border-radius: 2px; transition: all 0.15s;
  }
  .agents-refresh-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.2); }
  .launchd-table td code { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--blue); }

  /* ═══════════════════════════════════════
     AI SIGNAL SOURCES STRIP
  ═══════════════════════════════════════ */
  .sources-strip {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 9px 16px;
    background: var(--card);
    border: 1px solid var(--border);
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  .sources-label {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
    flex-shrink: 0;
    padding-right: 14px;
    border-right: 1px solid var(--border);
    line-height: 1.5;
  }
  .sources-label em { font-style: normal; color: var(--accent); }
  .sources-list {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    flex: 1;
  }
  .src-chip {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 5px 10px 5px 9px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    position: relative;
    overflow: hidden;
  }
  .src-chip:hover {
    background: rgba(255,255,255,0.04);
    border-color: var(--src-color, var(--muted));
  }
  .src-chip::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 2px;
    background: var(--src-color, var(--muted));
  }
  .src-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--src-color, var(--muted));
    flex-shrink: 0;
    animation: pulse 2.5s ease-in-out infinite;
  }
  .src-info { display: flex; flex-direction: column; gap: 1px; }
  .src-name {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text);
    white-space: nowrap;
    line-height: 1.2;
  }
  .src-cat {
    font-size: 7px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--src-color, var(--muted));
    opacity: 0.75;
    white-space: nowrap;
    line-height: 1;
  }
  @media (max-width: 900px) { .sources-label { border-right: none; padding-right: 0; } }

/* INFO MODAL */
#infoModal {
  display: none;
  position: fixed;
  z-index: 1000;
  background: #111820;
  border: 1px solid #1e2d3d;
  padding: 16px 20px;
  max-width: 320px;
  min-width: 220px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  pointer-events: none;
}
#infoModal.visible { display: block; }
#infoModal .im-title {
  font-family: 'Syne', sans-serif;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #e8f0fe;
  margin-bottom: 6px;
}
#infoModal .im-cat {
  font-size: 8px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--im-color, #4a6070);
  margin-bottom: 8px;
}
#infoModal .im-body {
  font-size: 10px;
  color: #4a6070;
  line-height: 1.6;
  letter-spacing: 0.3px;
}
#infoModal .im-bar {
  height: 2px;
  background: var(--im-color, #4a6070);
  margin-bottom: 10px;
  opacity: 0.6;
}

/* KPI TOOLTIP (floating card, no overlay) */
#kpiTooltip {
  display: none;
  position: fixed;
  z-index: 2000;
  width: 220px;
  padding: 12px 14px 13px;
  background: var(--card);
  border: 1px solid var(--border);
  border-top: 2px solid var(--accent);
  box-shadow: 0 8px 28px rgba(0,0,0,0.55);
  border-radius: 6px;
  font-family: 'JetBrains Mono', monospace;
  opacity: 0;
  transform: translateY(6px) scale(0.97);
  transition: opacity 0.14s ease, transform 0.14s ease;
  pointer-events: none;
}
#kpiTooltip.kt-visible {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}
#kpiTooltip .kt-label {
  font-family: 'Syne', sans-serif;
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 4px;
}
#kpiTooltip .kt-val {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
  line-height: 1;
}
#kpiTooltip .kt-desc {
  font-size: 10px;
  color: var(--muted);
  line-height: 1.6;
  border-top: 1px solid var(--border);
  padding-top: 8px;
}
/* Clickable hint on KPI tiles */
.kpi-grid .kpi { cursor: pointer; }
.kpi-grid .kpi:hover { border-color: rgba(0,255,136,0.25); }
/* [i] badge on hoverable elements */
[data-tip]          { cursor: pointer; }
[data-tip]:hover    { opacity: 0.85; }

/* ═══════════════════════════════════════
   LIVE POSITION WIDGET
═══════════════════════════════════════ */
  .live-pos-card {
    display: grid;
    grid-template-columns: 200px 1fr 160px;
    gap: 0;
    background: var(--card);
    border: 1px solid rgba(0,255,136,0.25);
    box-shadow: 0 0 24px rgba(0,255,136,0.06);
    position: relative;
    overflow: visible;
  }
  .live-pos-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(0,255,136,0.5), transparent);
    animation: shimmer 3s linear infinite;
  }
  .lp-left {
    padding: 16px 18px;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .lp-header { display: flex; align-items: center; gap: 7px; margin-bottom: 2px; }
  .lp-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); animation: pulse 1s ease-in-out infinite; flex-shrink: 0; }
  .lp-label { font-size: 9px; font-weight: 700; letter-spacing: 2.5px; text-transform: uppercase; color: var(--accent); }
  .lp-id   { font-size: 22px; font-weight: 800; font-family:'Syne',sans-serif; color: var(--text); letter-spacing: -0.5px; line-height: 1; }
  .lp-dir  { font-size: 12px; font-weight: 700; letter-spacing: 1px; }
  .lp-conf { font-size: 10px; font-weight: 700; color: var(--warn); letter-spacing: 1px; }
  .lp-time { font-size: 9px; color: var(--muted); letter-spacing: 0.5px; line-height: 1.4; }
  .lp-pnl  { font-size: 14px; font-weight: 700; letter-spacing: 0.5px; margin-top: 2px; }
  .lp-size { font-size: 9px; color: var(--muted); letter-spacing: 1px; }
  .lp-pyramid-badge { display:none; align-items:center; gap:4px; margin-top:4px; padding:2px 8px; border-radius:12px; font-size:9px; font-weight:700; letter-spacing:1px; color:#ff9500; background:rgba(255,149,0,0.15); border:1px solid rgba(255,149,0,0.35); text-transform:uppercase; }

  .lp-center {
    padding: 14px 24px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 6px;
  }
  .lp-gauge-header { display: flex; justify-content: space-between; font-size: 9px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; }
  .lp-gauge-sl    { color: var(--danger); }
  .lp-gauge-entry { color: var(--warn); }
  .lp-gauge-tp    { color: var(--accent); }
  .lp-gauge-track {
    position: relative;
    height: 8px;
    background: linear-gradient(90deg, #ff4466 0%, #ffaa00 42%, #00ff88 100%);
    border-radius: 4px;
    margin: 6px 0;
  }
  .lp-gauge-marker {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    border: 2px solid var(--bg);
    transition: left 1s ease;
    z-index: 2;
  }
  .lp-gauge-marker.entry { width: 10px; height: 10px; background: var(--warn); box-shadow: 0 0 8px rgba(255,170,0,0.7); }
  .lp-gauge-marker.live  { width: 16px; height: 16px; background: var(--text); box-shadow: 0 0 16px rgba(255,255,255,0.8); }
  .lp-gauge-marker.live::after {
    content: '';
    position: absolute;
    inset: -5px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.3);
    animation: pulse 1.2s ease-in-out infinite;
  }
  .lp-gauge-footer { display: flex; align-items: center; justify-content: space-between; font-size: 9px; font-weight: 700; letter-spacing: 1px; }
  .lp-current-price { font-size: 16px; font-weight: 900; font-family:'Syne',sans-serif; color: var(--text); letter-spacing: -0.5px; }

  .lp-right {
    padding: 14px 16px;
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .ai-cube-scene { width: 56px; height: 56px; perspective: 160px; }
  .ai-cube {
    width: 100%; height: 100%;
    position: relative;
    transform-style: preserve-3d;
    animation: cubeRotate 9s linear infinite;
  }
  @keyframes cubeRotate {
    0%   { transform: rotateX(15deg) rotateY(0deg); }
    100% { transform: rotateX(375deg) rotateY(360deg); }
  }
  .cube-face {
    position: absolute;
    width: 56px; height: 56px;
    border: 1px solid rgba(0,255,136,0.2);
    background: rgba(8,11,15,0.88);
    display: flex; align-items: center; justify-content: center;
    font-size: 7px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
    color: rgba(0,255,136,0.8);
  }
  .ai-cube[data-state="profit"] .cube-face { color: var(--accent); border-color: rgba(0,255,136,0.4); box-shadow: inset 0 0 12px rgba(0,255,136,0.15); }
  .ai-cube[data-state="loss"]   .cube-face { color: var(--danger); border-color: rgba(255,68,102,0.4); box-shadow: inset 0 0 12px rgba(255,68,102,0.15); }
  .ai-cube[data-state="neutral"].cube-face  { color: var(--warn);   border-color: rgba(255,170,0,0.4);  box-shadow: inset 0 0 12px rgba(255,170,0,0.12); }
  .cube-face.cube-front  { transform: translateZ(28px); }
  .cube-face.cube-back   { transform: rotateY(180deg)  translateZ(28px); }
  .cube-face.cube-right  { transform: rotateY(90deg)   translateZ(28px); }
  .cube-face.cube-left   { transform: rotateY(-90deg)  translateZ(28px); }
  .cube-face.cube-top    { transform: rotateX(90deg)   translateZ(28px); }
  .cube-face.cube-bottom { transform: rotateX(-90deg)  translateZ(28px); }
  .ai-decision { display:flex; align-items:center; gap:5px; font-size:10px; font-weight:700; letter-spacing:1px; color:var(--text); text-align:center; }
  .ai-status-dot { width:5px; height:5px; border-radius:50%; background:var(--accent); animation:pulse 1.5s ease-in-out infinite; flex-shrink:0; }
  .ai-think-label { font-size:7px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--muted); }

  /* ═══════════════════════════════════════════
     MOBILE RESPONSIVE — max-width: 600px
  ═══════════════════════════════════════════ */

  /* AUTO-TRAINING STATUS panel */
  .train-panel-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px 20px;
    padding: 14px 18px 16px;
  }
  /* QW9 — responsive 2-col grid for Backtest/Training panels */
  .two-col-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }
  @media (max-width: 600px) {
    .two-col-grid { grid-template-columns: 1fr; }
  }

  .train-progress-bar {
    width: 100%; height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }
  .train-progress-fill {
    height: 100%; border-radius: 2px;
    background: var(--accent);
    transition: width 0.9s ease;
  }
  .train-status-pill {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 10px; font-weight: 700; letter-spacing: 2px;
    text-transform: uppercase; padding: 4px 10px; border-radius: 2px;
  }
  .train-status-pill.recent      { color: var(--accent); background: rgba(0,255,136,0.08); border: 1px solid rgba(0,255,136,0.25); }
  .train-status-pill.on_track    { color: var(--blue);   background: rgba(0,170,255,0.08); border: 1px solid rgba(0,170,255,0.25); }
  .train-status-pill.retrain_ready { color: var(--warn); background: rgba(255,170,0,0.08); border: 1px solid rgba(255,170,0,0.25); animation: pulse 2s ease-in-out infinite; }

  /* TRAINING TAB — enhanced design */
  .trn-section-sep {
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
    margin: 18px 0;
  }
  .trn-badge {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
    padding: 3px 10px; border-radius: 2px; border: 1px solid;
  }
  .trn-badge.trained  { color: var(--accent); background: rgba(0,255,136,0.08); border-color: rgba(0,255,136,0.35); }
  .trn-badge.stale    { color: var(--warn);   background: rgba(255,170,0,0.08); border-color: rgba(255,170,0,0.35); }
  .trn-badge.error    { color: var(--danger); background: rgba(255,68,102,0.08); border-color: rgba(255,68,102,0.35); }
  .trn-metric-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  @media (max-width: 700px) { .trn-metric-cards { grid-template-columns: repeat(2, 1fr); } }
  .trn-metric-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 4px;
    padding: 12px 14px; display: flex; flex-direction: column; gap: 6px;
  }
  .trn-metric-icon { font-size: 16px; line-height: 1; }
  .trn-metric-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); }
  .trn-metric-value { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; color: var(--text); line-height: 1; }
  .trn-metric-sub { font-size: 9px; color: var(--muted); }
  .trn-acc-bar-wrap { margin: 2px 0 4px; }
  .trn-acc-bar-track { width: 100%; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .trn-acc-bar-fill  { height: 100%; border-radius: 2px; background: var(--accent); transition: width 1s ease; }
  .trn-retrain-btn {
    display: inline-flex; align-items: center; gap: 7px;
    background: rgba(0,255,136,0.07); border: 1px solid rgba(0,255,136,0.35);
    color: var(--accent); font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
    padding: 7px 16px; border-radius: 2px; cursor: pointer; font-family: 'JetBrains Mono', monospace;
    transition: background 0.2s, border-color 0.2s;
  }
  .trn-retrain-btn:hover { background: rgba(0,255,136,0.14); border-color: rgba(0,255,136,0.6); }
  .trn-model-row { display: flex; align-items: center; justify-content: space-between; font-size: 11px; padding: 6px 0; border-bottom: 1px solid rgba(30,45,61,0.5); }
  .trn-model-row:last-child { border-bottom: none; }
  .trn-mono { font-family: 'JetBrains Mono', monospace; font-weight: 700; }

  /* Mobile-only KPI boxes */
  .kpi.mobile-only    { display: none; }
  .stat-cell.mobile-only { display: none; }
  @media (max-width: 600px) {
    .kpi.mobile-only    { display: block; }
    .stat-cell.mobile-only { display: block; }
  }

  /* Bot alert banner */
  #botAlertBanner {
    display: none; align-items: center; gap: 10px;
    background: rgba(255,170,0,0.08); border: 1px solid rgba(255,170,0,0.3);
    border-radius: 2px; padding: 8px 14px; margin-bottom: 14px;
    font-size: 11px; color: var(--warn); font-weight: 600; letter-spacing: 1px;
    word-break: break-word;
  }
  #botAlertBanner.visible { display: flex; }

  /* TASK 1 — AI FEEDS strip: auto-scroll carousel su mobile */
  @keyframes feedScroll {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
  @media (max-width: 600px) {
    .sources-strip {
      flex-wrap: nowrap;
      overflow: hidden;
      padding: 6px 10px;
    }
    .sources-label { display: none; }
    .sources-list {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      width: max-content;
    }
    .src-chip { flex-shrink: 0; }
  }

  /* TASK 2 — Story Highlights */
  .story-highlights { display: none; }
  @media (max-width: 600px) {
    .story-highlights {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 4px 4px 12px;
      margin-bottom: 8px;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }
    .story-highlights::-webkit-scrollbar { display: none; }
    .story-item {
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      cursor: pointer;
      min-width: 80px;
      background: var(--card-bg, #1a1a2e);
      border: 1px solid var(--border, rgba(255,255,255,0.08));
      border-radius: 12px;
      padding: 9px 12px 8px;
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative;
      overflow: hidden;
    }
    .story-item:active { transform: scale(0.96); }
    .story-ring {
      font-size: 8px;
      font-weight: 800;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    /* accent bar on top-left */
    .story-item::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 3px; height: 100%;
      border-radius: 12px 0 0 12px;
    }
    .story-ring-yellow { color: var(--warn); }
    .story-ring-yellow ~ .story-val { color: var(--warn); }
    .story-item:has(.story-ring-yellow)::before { background: var(--warn); }
    .story-ring-purple { color: #aa66ff; }
    .story-ring-purple ~ .story-val { color: #aa66ff; }
    .story-item:has(.story-ring-purple)::before { background: #aa66ff; }
    .story-ring-blue   { color: var(--blue); }
    .story-ring-blue ~ .story-val { color: var(--blue); }
    .story-item:has(.story-ring-blue)::before { background: var(--blue); }
    .story-ring-green  { color: var(--accent); }
    .story-ring-green ~ .story-val { color: var(--accent); }
    .story-item:has(.story-ring-green)::before { background: var(--accent); }
    .story-ring-red    { color: var(--danger); }
    .story-ring-red ~ .story-val { color: var(--danger); }
    .story-item:has(.story-ring-red)::before { background: var(--danger); }
    .story-ring-orange { color: #ff8800; }
    .story-ring-orange ~ .story-val { color: #ff8800; }
    .story-item:has(.story-ring-orange)::before { background: #ff8800; }
    .story-label {
      font-size: 7.5px;
      font-weight: 700;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .story-val {
      font-size: 15px;
      font-weight: 800;
      font-family: 'Syne', sans-serif;
      line-height: 1.1;
    }
  }

  /* TASK 3 — Mobile Primary Grid */
  .mobile-primary-grid { display: none; }
  @media (max-width: 600px) {
    .mobile-primary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 8px;
      margin-bottom: 10px;
    }
    .mp-box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 10px 12px;
      position: relative;
      overflow: hidden;
    }
    .mp-box::after {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 2px;
    }
    .mp-primary::after { background: var(--accent); }
    .mp-secondary { grid-column: 1 / -1; }
    .mp-secondary::after { background: var(--blue); }
    .mp-label {
      font-size: 8px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 5px;
    }
    .mp-value {
      font-family: 'Syne', sans-serif;
      font-size: 20px;
      font-weight: 700;
      line-height: 1;
      color: var(--accent);
    }
    .mp-sub {
      font-size: 9px;
      color: var(--muted);
      margin-top: 3px;
    }
    .mp-last-signal {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
  }

  /* TASK 4 — KPI grid compatta su mobile */
  @media (max-width: 600px) {
    .kpi-grid { gap: 6px; }
    .kpi { padding: 10px 10px; }
    .kpi-value { font-size: 14px; }
    .kpi-label { font-size: 8px; }
    .kpi-sub { font-size: 8px; margin-top: 3px; }
  }

  /* TASK 5 — Bet list card layout su mobile */
  @media (max-width: 600px) {
    .table-wrap { overflow-x: hidden; }
    .table-wrap table { display: none; }
    .mobile-bet-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 420px;
      overflow-y: auto;
      padding: 4px 2px;
    }
    .mbet-card {
      display: grid;
      grid-template-columns: 28px 1fr 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 2px 8px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-left: 3px solid var(--muted);
      padding: 8px 10px;
      font-size: 10px;
    }
    .mbet-card.win  { border-left-color: var(--accent); }
    .mbet-card.loss { border-left-color: var(--danger); }
    .mbet-card.nobet { border-left-color: var(--muted); opacity: 0.6; }
    .mbet-id   { grid-row: 1; color: var(--muted); font-size: 9px; }
    .mbet-dir  { grid-row: 1; font-weight: 900; font-size: 12px; }
    .mbet-dir.up   { color: var(--accent); }
    .mbet-dir.down { color: var(--danger); }
    .mbet-conf { grid-row: 1; color: var(--blue); font-size: 10px; }
    .mbet-result { grid-row: 1; font-weight: 700; font-size: 11px; text-align: right; }
    .mbet-result.win  { color: var(--accent); }
    .mbet-result.loss { color: var(--danger); }
    .mbet-result.skip { color: var(--muted); }
    .mbet-time { grid-column: 1/3; grid-row: 2; color: var(--muted); font-size: 8px; }
    .mbet-pnl  { grid-column: 3/5; grid-row: 2; text-align: right; font-size: 10px; font-weight: 700; }
    .mbet-pnl.pos { color: var(--accent); }
    .mbet-pnl.neg { color: var(--danger); }
  }

  /* TASK 6 — Stats row compatta su mobile */
  @media (max-width: 600px) {
    .stats-row { grid-template-columns: repeat(3, 1fr); }
    .stat-cell { padding: 8px 10px; }
    .stat-cell-label { font-size: 7px; }
    .stat-cell-val { font-size: 14px; }
  }

  /* Auto-training panel single-column on mobile */
  @media (max-width: 600px) {
    .train-panel-grid {
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .train-panel-grid > div:first-child {
      order: 1; /* New bets + progress bar first */
    }
  }

  /* MOBILE DASHBOARD REORDER — signal list before analytics charts */
  #dashboardMain { display: flex; flex-direction: column; }
  @media (max-width: 900px) {
    #equityCurvePanel { order: 1; }
    .charts-grid      { order: 2; }
    #signalLogPanel   { order: 3; }
    /* small panels + pnlChartPanel hidden on mobile */
    #dashSmallPanels  { display: none; }
    /* KPI values bigger on mobile */
    .kpi-value { font-size: 20px !important; }
    /* Costs KPI: 3 cols on tablet */
    .costs-kpi-grid { grid-template-columns: repeat(3, 1fr) !important; }
  }
  @media (max-width: 600px) {
    .kpi-value { font-size: 17px !important; }
    /* Costs KPI: 2 cols on phone */
    .costs-kpi-grid { grid-template-columns: repeat(2, 1fr) !important; }
    .kpi-sub { white-space: normal; overflow: visible; text-overflow: unset; }
  }

  /* Expectancy tab: 2-col grid on mobile */
  @media (max-width: 600px) {
    #exp-breakdownGrid { grid-template-columns: 1fr 1fr !important; }
  }

  /* TASK 9 — Live Position widget layout su mobile */
  @media (max-width: 600px) {
    /* Stack tutto in colonna: info+pnl row | gauge barra sotto */
    .live-pos-card {
      display: flex;
      flex-direction: column;
      grid-template-columns: unset;
    }

    /* Prima riga: info a sinistra + PnL a destra */
    .lp-left {
      flex: 1;
      border-right: none;
      border-bottom: 1px solid var(--border);
      padding: 12px 14px 10px;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 4px 10px;
      order: 1;
    }

    /* Dentro lp-left: header su riga intera, poi info compatte */
    .lp-left .lp-header   { flex: 0 0 100%; margin-bottom: 0; }
    .lp-left .lp-id       { font-size: 16px; flex: 0 0 auto; }
    .lp-left .lp-dir      { font-size: 11px; flex: 0 0 auto; }
    .lp-left .lp-conf     { font-size: 10px; flex: 0 0 auto; }
    .lp-left .lp-time     { font-size: 8px; flex: 0 0 100%; }
    .lp-left .lp-size     { font-size: 8px; flex: 0 0 100%; }

    /* PnL: spostato a destra nella stessa prima riga tramite margin-left:auto */
    .lp-left .lp-pnl {
      font-size: 20px;
      font-weight: 900;
      letter-spacing: -0.5px;
      line-height: 1;
      margin-top: 0;
      margin-left: auto;
      text-align: right;
      align-self: center;
      flex: 0 0 auto;
      padding-right: 52px; /* spazio per il cubo che sborda */
    }

    /* AI cube su mobile: angolo top-right assoluto, sborda per effetto profondità */
    #livePositionWidget {
      position: relative;
      z-index: 10;
      overflow: visible;
    }
    .live-pos-card {
      overflow: visible;
    }
    .lp-right {
      display: block;
      position: absolute;
      top: -20px;
      right: 8px;
      z-index: 50;
      padding: 0;
      border-left: none;
      background: none;
    }
    .lp-right .ai-cube-scene {
      width: 44px;
      height: 44px;
      perspective: 130px;
      /* NO filter: drop-shadow — crea stacking context che rompe preserve-3d */
    }
    .lp-right .cube-face {
      width: 44px;
      height: 44px;
      font-size: 7px;
    }
    .lp-right .cube-face.cube-front  { transform: translateZ(22px); }
    .lp-right .cube-face.cube-back   { transform: rotateY(180deg)  translateZ(22px); }
    .lp-right .cube-face.cube-right  { transform: rotateY(90deg)   translateZ(22px); }
    .lp-right .cube-face.cube-left   { transform: rotateY(-90deg)  translateZ(22px); }
    .lp-right .cube-face.cube-top    { transform: rotateX(90deg)   translateZ(22px); }
    .lp-right .cube-face.cube-bottom { transform: rotateX(-90deg)  translateZ(22px); }
    .lp-right .ai-decision,
    .lp-right .ai-think-label {
      display: none;
    }

    /* Gauge SL/TP: seconda riga, full width, in fondo */
    .lp-center {
      order: 3;
      padding: 10px 14px 12px;
      border-left: none;
      border-top: 1px solid var(--border);
      width: 100%;
      box-sizing: border-box;
    }
  }

  /* ═══════════════════════════════════════
     WAR ROOM MODE
  ═══════════════════════════════════════ */
  .war-room-btn {
    font-family: inherit;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 6px 14px;
    border: 1px solid rgba(0,255,65,0.35);
    background: rgba(0,255,65,0.05);
    color: #00ff41;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .war-room-btn:hover { background: rgba(0,255,65,0.12); border-color: rgba(0,255,65,0.6); }
  .war-room-btn.wr-active { background: rgba(0,255,65,0.15); border-color: #00ff41; box-shadow: 0 0 8px rgba(0,255,65,0.25); }

  /* WAR ROOM BODY OVERRIDES */
  body.war-room { background: #000 !important; color: #00ff41 !important; }
  body.war-room::before { background-image: linear-gradient(rgba(0,255,65,0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,65,0.04) 1px, transparent 1px); }
  body.war-room .kpi { background: #0a0a0a !important; border: 1px solid #00ff41 !important; box-shadow: 0 0 10px rgba(0,255,65,0.3) !important; }
  body.war-room .kpi::after { display: none; }
  body.war-room .kpi-value { font-size: 2.2rem !important; font-family: 'JetBrains Mono', monospace !important; line-height: 1.1 !important; }
  body.war-room .kpi-label { color: #888 !important; font-family: 'JetBrains Mono', monospace !important; font-size: 0.65rem !important; letter-spacing: 1px !important; }
  body.war-room .kpi-sub   { color: #555 !important; font-size: 0.7rem !important; }
  body.war-room .tab-btn   { background: #0a0a0a !important; border-color: #222 !important; color: #555 !important; }
  body.war-room .tab-btn.active { background: rgba(0,255,65,0.1) !important; border-color: #00ff41 !important; color: #00ff41 !important; }
  body.war-room .tab-nav   { background: #000 !important; border-color: #111 !important; }
  body.war-room .panel, body.war-room .acct-panel { background: #0a0a0a !important; border-color: #1a1a1a !important; }
  body.war-room .panel-header, body.war-room .acct-panel-header { background: #050505 !important; border-color: #111 !important; }
  body.war-room header { border-color: #111 !important; }
  /* Hide non-essential elements in War Room */
  body.war-room footer { display: none !important; }
  body.war-room .sources-strip { display: none !important; }
  body.war-room .charts-grid { display: none !important; }
  body.war-room .stats-row { display: none !important; }
  body.war-room #pnlChartPanel { display: none !important; }

  /* War Room header bar */
  #warRoomHeader {
    display: none;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0 14px;
    border-bottom: 1px solid #00ff41;
    margin-bottom: 14px;
  }
  body.war-room #warRoomHeader { display: flex; }
  #warRoomTitle {
    font-family: 'JetBrains Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    color: #00ff41;
    letter-spacing: 3px;
    text-shadow: 0 0 16px rgba(0,255,65,0.5);
  }
  #warRoomClock {
    font-family: 'JetBrains Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    color: #00ff41;
    letter-spacing: 4px;
    text-shadow: 0 0 12px rgba(0,255,65,0.4);
  }
  #warRoomClockLabel {
    font-size: 8px;
    color: #555;
    letter-spacing: 2px;
    text-align: right;
    margin-top: 2px;
  }

  /* ═══════════════════════════════════════
     SIGNAL LOG FILTERS
  ═══════════════════════════════════════ */
  .signal-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
    padding: 10px 12px;
    background: var(--card);
    border-radius: 4px;
    border: 1px solid var(--border);
    align-items: center;
  }
  .filter-group { display: flex; gap: 4px; }
  .filter-btn {
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    font-family: inherit;
    font-size: 0.72rem;
    letter-spacing: 0.8px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .filter-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.2); }
  .filter-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700; }
  .filter-group-sep { width: 1px; background: var(--border); align-self: stretch; margin: 0 2px; }
  #signal-search {
    flex: 1;
    min-width: 140px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: inherit;
    font-size: 0.72rem;
    padding: 4px 10px;
    border-radius: 20px;
    outline: none;
    letter-spacing: 0.5px;
    transition: border-color 0.15s;
  }
  #signal-search::placeholder { color: var(--muted); }
  #signal-search:focus { border-color: rgba(0,255,136,0.4); }
  body.war-room .signal-filters { background: #0a0a0a; border-color: #222; }
  body.war-room .filter-btn { border-color: #333; color: #555; }
  body.war-room .filter-btn.active { background: #00ff41; color: #000; border-color: #00ff41; }
  body.war-room #signal-search { background: #050505; border-color: #333; color: #00ff41; }
</style>
</head>
<body>
  <div id="dry-run-banner" style="display:none; background:#f59e0b; color:#000; text-align:center; padding:10px; font-weight:bold; font-size:14px; letter-spacing:1px;">
  🧪 DRY RUN MODE — Nessun trade reale in esecuzione
</div>
<div class="container">

  <!-- WAR ROOM HEADER (visible only when body.war-room is active) -->
  <div id="warRoomHeader">
    <div id="warRoomTitle">&#9876;&#65039; BTC BOT // WAR ROOM</div>
    <div style="text-align:right;">
      <div id="warRoomClock">00:00:00</div>
      <div id="warRoomClockLabel">UTC</div>
    </div>
  </div>

  <header>
    <div>
      <div class="logo">ASTRA DIGITAL · <span>BOT ENGINE v2.0</span></div>
      <h1>BTC <span>SIGNAL</span> DASHBOARD</h1>
    </div>
    <div class="header-right">
      <div class="btc-live-ticker">
        <div class="btc-live-price" id="btcLivePrice">—</div>
        <div class="btc-price-meta">BTC/USD · LIVE <span class="btc-price-change" id="btcPriceChange"></span></div>
      </div>
      <span class="last-update" id="lastUpdate">LAST UPDATE: <span class="loading">—</span></span>
      <div class="live-badge"><div class="live-dot"></div>LIVE DATA</div>
      <div id="botStatus" class="bot-status alive">
        <div class="bot-status-dot"></div>
        <div class="bot-status-inner">
          <div id="botStatusText">BOT ALIVE<span id="botPausedIndicator" style="display:none;color:var(--warn);font-size:9px;font-weight:700;margin-left:6px;">⏸ PAUSED</span></div>
          <div class="bot-status-detail" id="botStatusDetail">Checking...</div>
        </div>
      </div>
    </div>
  </header>

  <!-- AI SIGNAL SOURCES -->
  <div class="sources-strip">
    <div class="sources-label">AI FEEDS<br><em>13</em> SOURCES</div>
    <div class="sources-list">
      <div class="src-chip" style="--src-color:#00aaff" title="BTC/USD spot price — Kraken Futures">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">KRAKEN</span><span class="src-cat">PRICE</span></div>
      </div>
      <div class="src-chip" style="--src-color:#3399ee" title="BTC OHLCV candlesticks 5m — Binance">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">BINANCE</span><span class="src-cat">KLINES</span></div>
      </div>
      <div class="src-chip" style="--src-color:#00d4aa" title="Market cap, volume, dominance — CoinGecko">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">COINGECKO</span><span class="src-cat">MARKET</span></div>
      </div>
      <div class="src-chip" style="--src-color:#aa66ff" title="Perpetual funding rate — Kraken Futures">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">FUNDING RATE</span><span class="src-cat">DERIVATIVES</span></div>
      </div>
      <div class="src-chip" style="--src-color:#cc88ff" title="Long/Short ratio — market positioning">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">L/S RATIO</span><span class="src-cat">DERIVATIVES</span></div>
      </div>
      <div class="src-chip" style="--src-color:#00ff88" title="Crypto Fear &amp; Greed Index (0–100)">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">FEAR &amp; GREED</span><span class="src-cat">SENTIMENT</span></div>
      </div>
      <div class="src-chip" style="--src-color:#ff9500" title="Latest crypto news feed — CryptoCompare">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">CRYPTOCMP</span><span class="src-cat">NEWS</span></div>
      </div>
      <div class="src-chip" style="--src-color:#ffcc00" title="Latest articles RSS — CoinDesk">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">COINDESK</span><span class="src-cat">NEWS</span></div>
      </div>
      <div class="src-chip" style="--src-color:#ff6b35" title="Italian financial news RSS — Sole24Ore">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">SOLE24ORE</span><span class="src-cat">NEWS</span></div>
      </div>
      <div class="src-chip" style="--src-color:#ff44aa" title="Historical signal patterns — Supabase Memory">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">PATTERNS</span><span class="src-cat">MEMORY</span></div>
      </div>
      <div class="src-chip" style="--src-color:#e5251b" title="US financial &amp; markets news — CNBC Finance">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">CNBC</span><span class="src-cat">NEWS</span></div>
      </div>
      <div class="src-chip" style="--src-color:#00ccff" title="Order book imbalance 5 livelli bid/ask — Kraken Futures">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">ORDER BOOK</span><span class="src-cat">MICROSTRUCTURE</span></div>
      </div>
      <div class="src-chip" style="--src-color:#88ddff" title="EMA+RSI multi-timeframe 15m e 4h — Binance">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">MULTI-TF</span><span class="src-cat">TECHNICAL</span></div>
      </div>
    </div>
  </div>

  <!-- TAB NAVIGATION + GLOBAL TIME FILTER -->
  <div class="tab-nav">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="dashboard"   onclick="switchTab(this)">📊 Dashboard</button>
      <button class="tab-btn"        data-tab="training"    onclick="switchTab(this)">🧠 Training</button>
      <button class="tab-btn"        data-tab="expectancy"  onclick="switchTab(this)">📈 Expectancy</button>
      <button class="tab-btn"        data-tab="agents"      onclick="switchTab(this)">🤖 Agents</button>
      <button class="tab-btn"        data-tab="costs"       onclick="switchTab(this)">💰 Costs</button>
      <button class="tab-btn"        data-tab="backtest"    onclick="switchTab(this)">📊 Backtest</button>
    </div>
    <div class="tab-controls" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <button class="war-room-btn" id="warRoomToggle" onclick="toggleWarRoom(this)">&#9876;&#65039; War Room</button>
      <div class="tab-controls-sep" style="width:1px;height:20px;background:var(--border);"></div>
      <span class="period-label" style="font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-right:4px">PERIOD</span>
      <button class="time-pill desktop-period-pill active" data-period="ALL"   onclick="setTimePeriod(this)">ALL</button>
      <button class="time-pill desktop-period-pill"        data-period="7D"    onclick="setTimePeriod(this)">7D</button>
      <button class="time-pill desktop-period-pill"        data-period="24H"   onclick="setTimePeriod(this)">24H</button>
      <button class="time-pill desktop-period-pill"        data-period="TODAY" onclick="setTimePeriod(this)">TODAY</button>
    </div>
  </div>

  <!-- MOBILE PERIOD BAR — visible only on mobile, sticky below tab nav -->
  <div class="mobile-period-bar" id="mobilePeriodBar">
    <button class="time-pill active" data-period="ALL"   onclick="setTimePeriod(this)">ALL</button>
    <button class="time-pill"        data-period="7D"    onclick="setTimePeriod(this)">7D</button>
    <button class="time-pill"        data-period="24H"   onclick="setTimePeriod(this)">24H</button>
    <button class="time-pill"        data-period="TODAY" onclick="setTimePeriod(this)">TODAY</button>
  </div>

  <!-- DASHBOARD TAB -->
  <div id="tab-dashboard" class="tab-content active">

  <!-- API error banner -->
  <div id="apiErrorBanner">
    <div class="err-dot"></div>
    <span id="apiErrorMsg">Railway API non raggiungibile — dati non aggiornati</span>
    <span class="err-dismiss" onclick="document.getElementById('apiErrorBanner').classList.remove('visible')" title="Dismiss">✕</span>
  </div>

  <!-- Bot alert banner (wf02/orphaned bets) -->
  <div id="botAlertBanner">
    <span style="font-size:14px">⚠️</span>
    <span id="botAlertMsg">—</span>
    <span style="margin-left:auto;cursor:pointer;opacity:0.6;" onclick="document.getElementById('botAlertBanner').classList.remove('visible')">✕</span>
  </div>

  <!-- ⬡ LIVE POSITION WIDGET -->
  <div id="livePositionWidget" style="display:none;margin-bottom:16px">
    <div class="live-pos-card">
      <!-- LEFT: position info -->
      <div class="lp-left">
        <div class="lp-header">
          <div class="lp-dot"></div>
          <span class="lp-label">Live Position</span>
        </div>
        <div class="lp-id" id="lpBetId">#—</div>
        <div class="lp-dir" id="lpDirection">—</div>
        <div class="lp-conf" id="lpConfidence">—</div>
        <div class="lp-time" id="lpOpenTime">—</div>
        <div class="lp-pnl" id="lpPnl">—</div>
        <div class="lp-size" id="lpSize">—</div>
        <div class="lp-pyramid-badge" id="lpPyramidBadge" style="display:none">⬆ PYRAMID</div>
      </div>
      <!-- CENTER: price gauge SL → TP -->
      <div class="lp-center">
        <div class="lp-gauge-header">
          <span class="lp-gauge-sl" id="lpSlLabel">SL —</span>
          <span class="lp-gauge-entry" id="lpEntryLabel">ENTRY —</span>
          <span class="lp-gauge-tp" id="lpTpLabel">TP —</span>
        </div>
        <div class="lp-gauge-track">
          <div class="lp-gauge-marker entry" id="lpEntryMarker" style="left:40%"></div>
          <div class="lp-gauge-marker live"  id="lpLiveMarker"  style="left:50%"></div>
        </div>
        <div class="lp-gauge-footer">
          <span style="color:var(--danger);font-size:9px">◀ SL</span>
          <div class="lp-current-price" id="lpCurrentPrice">$—</div>
          <span style="color:var(--accent);font-size:9px">TP ▶</span>
        </div>
      </div>
      <!-- RIGHT: AI cube + decision -->
      <div class="lp-right">
        <div class="ai-cube-scene" id="cubeScene">
          <div class="ai-cube" id="aiCube" data-state="neutral">
            <div class="cube-face cube-front">AI</div>
            <div class="cube-face cube-back">XGB</div>
            <div class="cube-face cube-right">HOLD</div>
            <div class="cube-face cube-left">EXIT</div>
            <div class="cube-face cube-top" id="cubeFaceConf">—%</div>
            <div class="cube-face cube-bottom">BOT</div>
          </div>
        </div>
        <div class="ai-decision">
          <span class="ai-status-dot"></span>
          <span id="aiDecisionText">Monitoring</span>
        </div>
        <div class="ai-think-label">AI Exit Manager</div>
      </div>
    </div>
  </div>

  <!-- TASK 2: Story Highlights (mobile only) -->
  <div class="story-highlights" id="storyHighlights">
    <div class="story-item" data-source="kpiWinRate">
      <div class="story-ring story-ring-yellow" style="color:var(--warn)">WR%</div>
      <div class="story-label">WIN RATE</div>
      <div class="story-val" id="storyWR">—</div>
    </div>
    <div class="story-item" data-source="kpiRoi">
      <div class="story-ring story-ring-purple" style="color:#aa66ff">ROI</div>
      <div class="story-label">P&amp;L</div>
      <div class="story-val" id="storyROI">—</div>
    </div>
    <div class="story-item" data-source="kpiFG">
      <div class="story-ring story-ring-blue" style="color:var(--blue)">F/G</div>
      <div class="story-label">FEAR/GREED</div>
      <div class="story-val" id="storyFG">—</div>
    </div>
    <div class="story-item" data-source="kpiBets">
      <div class="story-ring story-ring-green" style="color:var(--accent)">#BET</div>
      <div class="story-label">BETS</div>
      <div class="story-val" id="storyBets">—</div>
    </div>
    <div class="story-item" data-source="kpiDrawdown">
      <div class="story-ring story-ring-red" style="color:var(--danger)">DD</div>
      <div class="story-label">DRAWDOWN</div>
      <div class="story-val" id="storyDD">—</div>
    </div>
    <div class="story-item" data-source="statStreak">
      <div class="story-ring story-ring-orange" style="color:#ff8800">STK</div>
      <div class="story-label">STREAK</div>
      <div class="story-val" id="storyStreak">—</div>
    </div>
  </div>

  <!-- TASK 3: Mobile Primary Grid (mobile only) -->
  <div class="mobile-primary-grid" id="mobilePrimaryGrid">
    <!-- Box 1: Bot Status -->
    <div class="mp-box mp-primary">
      <div class="mp-label">BOT</div>
      <div class="mp-value" id="mpBotStatus">—</div>
      <div class="mp-sub" id="mpBotSub">checking...</div>
    </div>
    <!-- Box 2: Today Equity -->
    <div class="mp-box mp-primary">
      <div class="mp-label">TODAY PnL</div>
      <div class="mp-value" id="mpTodayPnl">—</div>
      <div class="mp-sub" id="mpTodaySub">bets today</div>
    </div>
    <!-- Box 3: Last Signal (medium) -->
    <div class="mp-box mp-secondary">
      <div class="mp-label">LAST SIGNAL</div>
      <div class="mp-last-signal">
        <span id="mpLastDir" style="font-size:18px;font-weight:900;">—</span>
        <span id="mpLastConf" style="font-size:11px;color:var(--muted);">conf —</span>
        <span id="mpLastResult" style="font-size:10px;font-weight:700;">—</span>
        <span id="mpLastTime" style="font-size:9px;color:var(--muted);">—</span>
      </div>
    </div>
  </div>

  <!-- 9 KPI tiles -->
  <div class="kpi-grid">
    <div class="kpi blue">
      <div class="kpi-label">BTC Price</div>
      <div class="kpi-value blue" id="kpiPrice">—</div>
      <div class="kpi-sub">Last entry</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Total Signals</div>
      <div class="kpi-value white" id="kpiTotal">—</div>
      <div class="kpi-sub">All time</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Accuracy</div>
      <div class="kpi-value green" id="kpiAccuracy">—</div>
      <div class="kpi-sub">Correct pred.</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Total PnL</div>
      <div class="kpi-value green" id="kpiPnl">—</div>
      <div class="kpi-sub" id="kpiPnlSub">from 2026-02-24</div>
    </div>
    <div class="kpi purple">
      <div class="kpi-label">Session ROI</div>
      <div class="kpi-value purple" id="kpiRoi">—</div>
      <div class="kpi-sub" id="kpiRoiSub">since 2026-02-24</div>
    </div>
    <div class="kpi yellow">
      <div class="kpi-label">Win Rate</div>
      <div class="kpi-value yellow" id="kpiWinRate">—</div>
      <div class="kpi-sub">Executed trades</div>
    </div>
    <div class="kpi yellow">
      <div class="kpi-label">WR NoBet</div>
      <div class="kpi-value yellow" id="kpiWrNoBet">—</div>
      <div class="kpi-sub">Theoretical pred.</div>
    </div>
    <div class="kpi blue">
      <div class="kpi-label">Fear &amp; Greed</div>
      <div class="kpi-value blue" id="kpiFG">—</div>
      <div class="kpi-sub" id="kpiFGLabel">Loading...</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Bets Taken</div>
      <div class="kpi-value white" id="kpiBets">—</div>
      <div class="kpi-sub">Out of total</div>
    </div>
    <div class="kpi red">
      <div class="kpi-label">Max Drawdown</div>
      <div class="kpi-value red" id="kpiDrawdown">—</div>
      <div class="kpi-sub">Single trade</div>
    </div>
    <!-- Mobile-only: 2 extra KPI slots fill the last row on 3-col mobile grid -->
    <div class="kpi mobile-only green" data-tip-title="Expectancy" data-tip="Valore atteso per ogni bet = PnL totale / numero bet chiuse. Positivo = sistema profittevole nel lungo periodo.">
      <div class="kpi-label">Expectancy</div>
      <div class="kpi-value white" id="kpiExpectancyVal">—</div>
      <div class="kpi-sub">avg $/bet</div>
    </div>
    <div class="kpi mobile-only purple" data-tip-title="Profit Factor" data-tip="Profit Factor = Guadagni lordi / Perdite lorde. Sopra 1.0 = sistema in profitto. &gt;1.5 è considerato buono.">
      <div class="kpi-label">Profit Factor</div>
      <div class="kpi-value purple" id="kpiProfitFactorVal">—</div>
      <div class="kpi-sub">wins/losses</div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-cell">
      <div class="stat-cell-label">Avg Confidence</div>
      <div class="stat-cell-val" id="statConf" style="color:var(--blue)">—</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Best Trade PnL</div>
      <div class="stat-cell-val" id="statBest" style="color:var(--accent)">—</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Current Streak</div>
      <div class="stat-cell-val" id="statStreak" style="color:var(--text)">—</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Avg Entry Slippage</div>
      <div class="stat-cell-val" id="statSlippage" style="color:var(--warn)">—</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Avg RR Ratio</div>
      <div class="stat-cell-val" id="statRR" style="color:var(--accent)">—</div>
    </div>
    <!-- Mobile-only: fills empty slot in 3-col row 2 -->
    <div class="stat-cell mobile-only" data-tip-title="Best Win Streak" data-tip="Numero massimo di vincite consecutive nell'intera storia delle bet. Indica la stabilità del modello.">
      <div class="stat-cell-label">Best Streak</div>
      <div class="stat-cell-val" id="statBestStreak" style="color:var(--accent)">—</div>
    </div>
  </div>

  <div id="dashboardMain">

  <!-- ═══════════════════════════════════════════
       CUMULATIVE EQUITY CURVE
  ═══════════════════════════════════════════ -->
  <div class="panel" id="equityCurvePanel" style="margin-bottom:14px;">
    <div class="panel-header">
      <div class="panel-title">Cumulative Equity Curve (Real Bets)</div>
      <div class="panel-tag tag-green" id="equityTag" data-tip-title="Equity Curve" data-tip="Curva del capitale nel tempo basata sui PnL reali di ogni bet chiusa. Include fee di trading.">LOADING</div>
    </div>
    <div style="padding:16px 18px 10px;">
      <svg id="equitySvg" class="equity-svg" height="110" viewBox="0 0 1000 110" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════
       CHARTS GRID — 4 temporal charts
  ═══════════════════════════════════════════ -->
  <!-- Top charts: BTC Price vs Predictions + Rolling Win Rate -->
  <div class="charts-grid">

    <!-- Chart 1: BTC Price + Predictions Overlay -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">BTC Price vs Predictions</div>
        <div style="display:flex;gap:8px;font-size:9px;">
          <span style="color:var(--accent);">● correct</span>
          <span style="color:var(--danger);">● wrong</span>
          <span style="color:var(--muted);">▲▼ = direction</span>
        </div>
      </div>
      <div style="padding:12px 16px 8px;">
        <svg id="btcOverlaySvg" width="100%" height="110" viewBox="0 0 600 110" preserveAspectRatio="none"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px;">
          <span>oldest</span><span>newest</span>
        </div>
      </div>
    </div>

    <!-- Chart 2: Rolling Win Rate -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Rolling Win Rate (BETs)</div>
        <div style="display:flex;gap:8px;font-size:9px;color:var(--muted);">
          <span style="color:var(--accent);">— WR-10</span>
          <span style="color:var(--blue);">— WR-20</span>
          <span style="color:var(--muted);">— 50%</span>
        </div>
      </div>
      <div style="padding:12px 16px 8px;">
        <svg id="wrSvg" width="100%" height="110" viewBox="0 0 600 110" preserveAspectRatio="none"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px;">
          <span>oldest bet</span><span>newest bet</span>
        </div>
      </div>
    </div>

  </div><!-- /.charts-grid top -->

  <!-- Signal Log — full width -->
  <div class="panel" id="signalLogPanel" style="margin-bottom:14px;">
    <div class="panel-header">
      <div class="panel-title" id="signalLogTitle">Signal Log <span id="nextSignalTimer" class="next-signal-badge"></span></div>
      <div class="filters-row">
        <select id="filterDir"   class="filter-sel"><option value="ALL">ALL DIR</option><option value="UP">UP</option><option value="DOWN">DOWN</option></select>
        <select id="filterClass" class="filter-sel"><option value="ALL">ALL</option><option value="BET">BETS</option><option value="NO_BET">NO-BET</option></select>
      </div>
    </div>
    <!-- SIGNAL LOG FILTER BAR -->
    <div class="signal-filters" id="signalFiltersBar">
      <div class="filter-group">
        <button class="filter-btn active" data-filter="type" data-value="all" onclick="setSignalFilter(this,'type')">Tutti</button>
        <button class="filter-btn"        data-filter="type" data-value="bet"   onclick="setSignalFilter(this,'type')">BET</button>
        <button class="filter-btn"        data-filter="type" data-value="skip"  onclick="setSignalFilter(this,'type')">SKIP</button>
        <button class="filter-btn"        data-filter="type" data-value="nobet" onclick="setSignalFilter(this,'type')">NO BET</button>
      </div>
      <div class="filter-group-sep"></div>
      <div class="filter-group">
        <button class="filter-btn active" data-filter="outcome" data-value="all"  onclick="setSignalFilter(this,'outcome')">Tutti</button>
        <button class="filter-btn"        data-filter="outcome" data-value="win"  onclick="setSignalFilter(this,'outcome')">WIN</button>
        <button class="filter-btn"        data-filter="outcome" data-value="loss" onclick="setSignalFilter(this,'outcome')">LOSS</button>
        <button class="filter-btn"        data-filter="outcome" data-value="open" onclick="setSignalFilter(this,'outcome')">Aperte</button>
      </div>
      <div class="filter-group-sep"></div>
      <div class="filter-group">
        <button class="filter-btn active" data-filter="direction" data-value="all"  onclick="setSignalFilter(this,'direction')">Entrambe</button>
        <button class="filter-btn"        data-filter="direction" data-value="up"   onclick="setSignalFilter(this,'direction')">&#8593; UP</button>
        <button class="filter-btn"        data-filter="direction" data-value="down" onclick="setSignalFilter(this,'direction')">&#8595; DOWN</button>
      </div>
      <input type="text" id="signal-search" placeholder="&#128269; Cerca ID, conf..." oninput="applySignalFilters()">
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>DATE/TIME</th>
            <th>DIR</th>
            <th>CONF</th>
            <th>ENTRY $</th>
            <th>EXIT $</th>
            <th>RSI</th>
            <th>EMA</th>
            <th>SCORE</th>
            <th>SIZE</th>
            <th>TYPE</th>
            <th>RESULT</th>
            <th>PNL $ / THR%</th>
            <th>FEE $</th>
            <th>SL/TP</th>
            <th title="On-chain audit trail — Polygon PoS">⛓</th>
          </tr>
        </thead>
        <tbody id="signalTable"></tbody>
      </table>
      <div class="mobile-bet-list" id="mobileBetList"></div>
    </div>
  </div>

  <!-- Lower charts: Confidence Over Time + PnL per Bet -->
  <div class="charts-grid">

    <!-- Confidence Over Time -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Confidence Over Time</div>
        <div class="panel-tag tag-blue" id="confTag">ALL</div>
      </div>
      <div style="padding:12px 16px 8px;">
        <svg id="confSvg" width="100%" height="110" viewBox="0 0 600 110" preserveAspectRatio="none"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px;">
          <span>oldest</span><span>newest</span>
        </div>
      </div>
    </div>

    <!-- PnL Per Bet Bar Chart (large) -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">PnL per Bet ($)</div>
        <div class="panel-tag tag-muted" id="pnlBarsTag">REAL BETS</div>
      </div>
      <div style="padding:12px 16px 8px;">
        <div class="pnl-bars-large" id="pnlBarsLarge"></div>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:4px;">
          <span>oldest</span><span>newest</span>
        </div>
      </div>
    </div>

  </div><!-- /.charts-grid lower -->

  <!-- Small panels row: PnL per Trade · Signal Quality · Confidence Distribution -->
  <div id="dashSmallPanels" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px;">

    <div class="panel" id="pnlChartPanel">
      <div class="panel-header">
        <div class="panel-title">PnL per Trade</div>
        <div class="panel-tag tag-green" id="totalPnlTag">TOTAL: —</div>
      </div>
      <div class="chart-area">
        <div class="pnl-chart" id="pnlChart"></div>
        <div class="bar-labels"><span id="chartStart">—</span><span>PnL USD</span><span id="chartEnd">—</span></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Signal Quality</div>
        <div class="panel-tag tag-blue">LIVE</div>
      </div>
      <div class="signal-grid" id="signalQuality"></div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Confidence Distribution</div>
        <div class="panel-tag tag-yellow">HISTOGRAM</div>
      </div>
      <div class="conf-bars" id="confDist"></div>
    </div>

  </div>

  </div><!-- /#dashboardMain -->

  <!-- ═══════════════════════════════════════════
       AUTO-TRAINING STATUS
  ═══════════════════════════════════════════ -->
  <div class="panel" style="margin-bottom:14px;" id="trainingStatusPanel">
    <div class="panel-header">
      <div class="panel-title">Auto-Training &mdash; XGBoost Engine</div>
      <div id="trainStatusPill" class="train-status-pill recent" data-tip-title="Auto-Training Status" data-tip="RECENT = retrained &lt;7 giorni fa. ON TRACK = last train &lt;14 giorni. RETRAIN READY = &gt;14 giorni, domenica notte verrà riaddestrато. Il retraining avviene ogni domenica alle 3:00 AM automaticamente.">
        <span id="trainStatusDot" style="width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;animation:pulse 2s infinite;"></span>
        <span id="trainStatusText">LOADING</span>
      </div>
    </div>
    <div class="train-panel-grid">
      <div style="display:flex;flex-direction:column;gap:4px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">New Bets Since Retrain</div>
        <div style="display:flex;align-items:baseline;gap:8px;">
          <div style="font-size:28px;font-weight:700;font-family:'Syne',sans-serif;" id="trainBetsSince">—</div>
          <div style="font-size:11px;color:var(--muted);" id="trainBetsThreshold">/ 30 target</div>
        </div>
        <div class="train-progress-bar">
          <div class="train-progress-fill" id="trainProgressFill" style="width:0%"></div>
        </div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px;" id="trainProgressLabel">0% toward next meaningful retrain</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Direction Accuracy</div>
          <div style="font-size:26px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent);" id="trainDirAcc">—</div>
          <div style="font-size:9px;color:var(--muted);" id="trainTrainN">— signals in dataset</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Last Retrain</div>
        <div style="font-size:12px;font-weight:600;color:var(--text);" id="trainLastDate">—</div>
        <div style="font-size:9px;color:var(--muted);" id="trainDaysAgo">—</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Next Scheduled</div>
        <div style="font-size:12px;font-weight:600;color:var(--blue);" id="trainNextDate">—</div>
        <div style="font-size:9px;color:var(--muted);">Sunday 3:00 UTC · auto</div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════
       TRADING STATS — Expectancy & Direction
  ═══════════════════════════════════════════ -->
  <div class="panel" style="margin-bottom:14px;" id="tradingStatsPanel">
    <div class="panel-header">
      <div class="panel-title">Trading Stats &mdash; Expectancy</div>
      <div class="panel-tag tag-muted" id="tsVerdictBadge">LOADING</div>
    </div>
    <div style="padding:14px 18px 16px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px 20px;">
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Expectancy</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;" id="tsExpectancy">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);">per bet (all time)</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Expectancy L20</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;" id="tsExpectancyL20">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);">last 20 bets</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Avg Win / Avg Loss</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--warn);" id="tsWinLossRatio">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);">reward/risk ratio</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">UP Bets WR</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--accent);" id="tsUpWr">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);" id="tsUpPnl">PnL: &#8212;</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">DOWN Bets WR</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--danger);" id="tsDownWr">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);" id="tsDownPnl">PnL: &#8212;</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Avg PnL / Bet</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;" id="tsAvgPnl">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);" id="tsAvgPnlSub">wins: &#8212; / losses: &#8212;</div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════
       HOURLY WR HEATMAP
  ═══════════════════════════════════════════ -->
  <div class="panel" style="margin-bottom:14px;" id="hourlyHeatmapPanel">
    <div class="panel-header">
      <div class="panel-title">Win Rate per UTC Hour</div>
      <div class="panel-tag tag-muted" id="heatmapTag" data-tip="Heatmap delle performance orarie. Basato su tutte le scommesse chiuse, mostra a quali ore del giorno il bot performa meglio.">LOADING</div>
    </div>
    <div style="padding:12px 18px 14px;">
      <div id="hourlyHeatmapGrid" style="display:grid;grid-template-columns:repeat(8,1fr);gap:4px;"></div>
      <div style="display:flex;gap:16px;margin-top:8px;font-size:9px;color:var(--muted);">
        <span style="color:var(--accent);">&#9632; &gt;55% WR</span>
        <span style="color:var(--danger);">&#9632; &lt;45% WR</span>
        <span style="color:var(--muted);">&#9632; neutral / no data</span>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════
       ACCOUNT SUMMARY SECTION
  ═══════════════════════════════════════════ -->
  <div class="section-divider">
    <div class="section-divider-label">Account Summary</div>
    <div class="section-divider-line"></div>
    <div class="section-divider-ts" id="acctTs">Loading...</div>
  </div>

  <div class="account-summary-grid">

    <!-- WALLET -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">💰</span>Wallet</div>
        <div class="panel-tag tag-blue" id="acctWalletTag">—</div>
      </div>
      <div class="acct-body" id="acctWalletBody">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%"></div>
          <div class="skeleton-line" style="width:80%"></div>
          <div class="skeleton-line" style="width:60%"></div>
          <div class="skeleton-line" style="width:90%"></div>
        </div>
      </div>
    </div>

    <!-- POSITION -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">📍</span>Position</div>
        <div class="panel-tag" id="acctPositionTag" style="background:rgba(74,96,112,0.15);color:var(--muted);border:1px solid rgba(74,96,112,0.3)">FLAT</div>
      </div>
      <div class="acct-body" id="acctPositionBody">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%"></div>
          <div class="skeleton-line" style="width:70%"></div>
          <div class="skeleton-line" style="width:85%"></div>
        </div>
      </div>
    </div>

    <!-- BTC PRICE -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">₿</span>BTC Live</div>
        <div class="panel-tag tag-green" id="acctBtcTag">—</div>
      </div>
      <div class="acct-body" id="acctBtcBody">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%"></div>
          <div class="skeleton-line" style="width:75%"></div>
          <div class="skeleton-line" style="width:60%"></div>
        </div>
      </div>
    </div>

    <!-- RECENT FILLS -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">🕐</span>Recent Fills</div>
        <div class="panel-tag tag-yellow" id="acctFillsTag">—</div>
      </div>
      <div id="acctFillsBody" style="padding:0;">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%;margin:14px 16px 0;width:calc(100% - 32px)"></div>
          <div class="skeleton-line" style="width:90%;margin:0 16px;width:calc(90% - 32px)"></div>
          <div class="skeleton-line" style="width:80%;margin:0 16px 14px;width:calc(80% - 32px)"></div>
        </div>
      </div>
    </div>

  </div>
  <!-- END ACCOUNT SUMMARY -->

  <footer>
    <div class="footer-text">ASTRA DIGITAL MARKETING · <span>BOT ENGINE</span> · AUTO REFRESH 60s</div>
    <div class="footer-text" style="font-size:9px">
      ⛓ <span>ON-CHAIN</span> · Polygon PoS ·
      <a href="https://polygonscan.com/address/0xe4661F7dB62644951Eb1F9Fd23DB90e647833a55" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;letter-spacing:1px" title="BTCBotAudit.sol — immutable prediction audit trail">0xe4661F…833a55 ↗</a>
    </div>
    <div class="config-hint">Table: <code>btc_predictions</code> · Capital: <code id="footerCapital">$20 USDC</code> · Refresh <code>60s</code></div>
  </footer>

  </div><!-- /#tab-dashboard -->

  <!-- AGENTS TAB -->
  <div id="tab-agents" class="tab-content">

    <!-- n8n Workflows -->
    <div class="agents-section-header">
      <span>n8n Workflows</span>
      <button class="agents-refresh-btn" onclick="refreshAgentsTab()">↻ Refresh</button>
    </div>
    <div id="n8nWorkflowsGrid" class="wf-grid">
      <div style="grid-column:1/-1;padding:20px;color:var(--muted);font-size:11px;letter-spacing:1px">
        Premi Refresh per caricare i workflow n8n.
      </div>
    </div>

    <!-- launchd Agents -->
    <div class="agents-section-header"><span>launchd Agents — Mac Local</span></div>
    <div class="panel" style="margin-bottom:14px">
      <div class="panel-header">
        <div class="panel-title">Scheduled Tasks</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="panel-tag tag-muted">LOCAL · macOS launchd</div>
          <div id="launchdClock" style="font-size:9px;color:var(--muted);font-family:monospace;letter-spacing:1px"></div>
        </div>
      </div>
      <div class="table-wrap">
        <table class="launchd-table">
          <thead>
            <tr>
              <th>AGENT</th>
              <th>LABEL</th>
              <th>SCHEDULE</th>
              <th>NEXT RUN</th>
              <th>LOG</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody id="launchdBody">
            <!-- filled by renderLaunchdTasks() -->
          </tbody>
        </table>
      </div>
    </div>


  </div><!-- /#tab-agents -->

  <!-- BACKTEST TAB -->
  <div id="tab-backtest" class="tab-content">

    <!-- KPI row -->
    <div class="kpi-grid" style="grid-template-columns:repeat(6,1fr);margin-bottom:16px" id="btKpiGrid">
      <div class="kpi"><div class="kpi-label">Best Strategy</div><div class="kpi-value" id="btKpiBest">—</div><div class="kpi-sub" id="btKpiBestPnl">—</div></div>
      <div class="kpi"><div class="kpi-label">Current (FULL_STACK)</div><div class="kpi-value" id="btKpiCurrent">—</div><div class="kpi-sub" id="btKpiCurrentPnl">—</div></div>
      <div class="kpi"><div class="kpi-label">Test WR</div><div class="kpi-value" id="btKpiWR">—</div><div class="kpi-sub" id="btKpiWRSub">—</div></div>
      <div class="kpi"><div class="kpi-label">Profit Factor</div><div class="kpi-value" id="btKpiPF">—</div><div class="kpi-sub">Best strategy</div></div>
      <div class="kpi"><div class="kpi-label">XGB CV Acc</div><div class="kpi-value" id="btKpiXgb">—</div><div class="kpi-sub" id="btKpiXgbSub">train set</div></div>
      <div class="kpi"><div class="kpi-label">Max Streak</div><div class="kpi-value green" id="btKpiStreak">—</div><div class="kpi-sub" id="btKpiStreakSub">W / L</div></div>
    </div>

    <!-- Equity curves chart -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Equity Curves — Test Set</div>
        <div class="panel-tag tag-muted">per strategia, partendo da $0</div>
      </div>
      <div style="padding:12px 16px 14px">
        <div id="btEquityLegend" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px;font-size:10px"></div>
        <svg id="btEquitySvg" width="100%" height="200" style="display:block;background:#111;border-radius:6px;overflow:visible"></svg>
      </div>
    </div>

    <!-- Strategy table -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Confronto Strategie</div>
        <div class="panel-tag tag-blue">WALK-FORWARD</div>
      </div>
      <div style="overflow-x:auto;padding:0 4px">
        <table style="width:100%;border-collapse:collapse;font-size:11px" id="btStratTable">
          <thead>
            <tr style="color:var(--muted);text-transform:uppercase;font-size:9px;letter-spacing:1px">
              <th style="text-align:left;padding:6px 8px">Strategia</th>
              <th style="text-align:right;padding:6px 8px">N</th>
              <th style="text-align:right;padding:6px 8px">WR%</th>
              <th style="text-align:right;padding:6px 8px">PnL</th>
              <th style="text-align:right;padding:6px 8px">$/bet</th>
              <th style="text-align:right;padding:6px 8px">MaxDD</th>
              <th style="text-align:right;padding:6px 8px">PF</th>
              <th style="text-align:right;padding:6px 8px">Sortino</th>
              <th style="text-align:right;padding:6px 8px">Sharpe</th>
            </tr>
          </thead>
          <tbody id="btStratBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Confidence calibration + Hourly heatmap side by side -->
    <div class="two-col-grid">

      <div class="panel">
        <div class="panel-header"><div class="panel-title">Confidence Calibration</div><div class="panel-tag tag-yellow">CALIBRATION</div></div>
        <div style="padding:0 4px"><table style="width:100%;border-collapse:collapse;font-size:11px">
          <thead>
            <tr style="color:var(--muted);text-transform:uppercase;font-size:9px;letter-spacing:1px">
              <th style="text-align:left;padding:4px 6px">Bucket</th>
              <th style="text-align:right;padding:4px 6px">N</th>
              <th style="text-align:right;padding:4px 6px">ExpWR</th>
              <th style="text-align:right;padding:4px 6px">ActWR</th>
              <th style="text-align:right;padding:4px 6px">Δ</th>
              <th style="text-align:right;padding:4px 6px">$/bet</th>
            </tr>
          </thead>
          <tbody id="btCalibBody"></tbody>
        </table></div>
      </div>

      <div class="panel">
        <div class="panel-header"><div class="panel-title">24h Heatmap — Win Rate</div><div class="panel-tag tag-muted">BACKTEST</div></div>
        <div style="padding:12px 16px 14px">
          <div id="btHeatmap" style="display:grid;grid-template-columns:repeat(6,1fr);gap:3px"></div>
          <div style="display:flex;gap:8px;margin-top:8px;font-size:9px;color:var(--muted)">
            <span style="color:var(--accent)">■ HOT ≥60%</span><span style="color:var(--danger)">■ DEAD &lt;45%</span><span>■ no data</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Raw text reports (collapsible) -->
    <details style="margin-bottom:12px">
      <summary style="cursor:pointer;font-size:11px;color:var(--muted);padding:6px 0;letter-spacing:1px;text-transform:uppercase">
        ▸ Walk-Forward Report (testo grezzo)
        <span id="backtestBadge" style="font-size:10px;font-weight:400;opacity:0.5;margin-left:8px"></span>
      </summary>
      <pre id="backtestReportPre" style="font-size:11px;line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:400px;overflow-y:auto;background:#111;padding:12px;border-radius:6px;color:#ccc;margin-top:8px">Loading...</pre>
    </details>

    <details>
      <summary style="cursor:pointer;font-size:11px;color:var(--muted);padding:6px 0;letter-spacing:1px;text-transform:uppercase">
        ▸ XGBoost Model Report
        <span id="xgbBadge" style="font-size:10px;font-weight:400;opacity:0.5;margin-left:8px"></span>
      </summary>
      <pre id="xgbReportPre" style="font-size:11px;line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:500px;overflow-y:auto;background:#111;padding:12px;border-radius:6px;color:#ccc;margin-top:8px">Loading...</pre>
    </details>

  </div><!-- /#tab-backtest -->

  <!-- COSTS TAB -->
  <div id="tab-costs" class="tab-content">

    <!-- 6 KPI -->
    <div class="kpi-grid costs-kpi-grid" style="grid-template-columns:repeat(6,1fr);margin-bottom:16px">
      <div class="kpi red" id="costKpiTotal">
        <div class="kpi-label">Total Cost MTD</div>
        <div class="kpi-value red" id="costKpiTotalVal">—</div>
        <div class="kpi-sub" id="costKpiTotalSub">loading...</div>
      </div>
      <div class="kpi yellow" id="costKpiKraken">
        <div class="kpi-label">Kraken Fees</div>
        <div class="kpi-value yellow" id="costKpiKrakenVal">—</div>
        <div class="kpi-sub" id="costKpiKrakenSub">loading...</div>
      </div>
      <div class="kpi blue" id="costKpiN8n">
        <div class="kpi-label">n8n Plan</div>
        <div class="kpi-value blue" id="costKpiN8nVal">—</div>
        <div class="kpi-sub" id="costKpiN8nSub">loading...</div>
      </div>
      <div class="kpi purple" id="costKpiClaudeApi">
        <div class="kpi-label">Claude API</div>
        <div class="kpi-value purple" id="costKpiClaudeApiVal">—</div>
        <div class="kpi-sub" id="costKpiClaudeApiSub">loading...</div>
      </div>
      <div class="kpi" style="--kc:#e5251b" id="costKpiClaudeCode">
        <div class="kpi-label">Claude Code</div>
        <div class="kpi-value" style="color:#e5251b" id="costKpiClaudeCodeVal">—</div>
        <div class="kpi-sub" id="costKpiClaudeCodeSub">loading...</div>
      </div>
      <div class="kpi" id="costKpiRailway">
        <div class="kpi-label">Railway</div>
        <div class="kpi-value white" id="costKpiRailwayVal">—</div>
        <div class="kpi-sub" id="costKpiRailwaySub">loading...</div>
      </div>
    </div>

    <!-- Railway Budget Widget -->
    <div style="margin-bottom:16px;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-left:3px solid #8866ff">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <span style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#8866ff">RAILWAY BUDGET — Hobby Plan</span>
        <span style="font-size:8px;color:var(--muted)">aggiorna manualmente</span>
      </div>
      <div style="display:flex;gap:28px;align-items:baseline;flex-wrap:wrap">
        <div>
          <div style="font-size:24px;font-weight:800;font-family:'Syne',sans-serif;color:#8866ff" id="rlyCredits">$4.87</div>
          <div style="font-size:8px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px">CREDITS LEFT</div>
        </div>
        <div>
          <div style="font-size:24px;font-weight:800;font-family:'Syne',sans-serif;color:var(--text)" id="rlyDays">27</div>
          <div style="font-size:8px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px">DAYS LEFT</div>
        </div>
        <div>
          <div style="font-size:24px;font-weight:800;font-family:'Syne',sans-serif;color:#00ff88" id="rlyBurn">$0.04</div>
          <div style="font-size:8px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px">BURN/DAY</div>
        </div>
        <div>
          <div style="font-size:24px;font-weight:800;font-family:'Syne',sans-serif;color:var(--warn)" id="rlyProj">$1.30</div>
          <div style="font-size:8px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px">PROJ/MONTH</div>
        </div>
      </div>
      <!-- Burn progress: (plan_total - credits_left) / plan_total -->
      <div style="margin-top:12px;height:3px;background:rgba(255,255,255,0.05);border-radius:2px;overflow:hidden">
        <div style="height:100%;width:2.6%;background:linear-gradient(90deg,#8866ff,#00ff88);border-radius:2px"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:4px">
        <span style="font-size:8px;color:var(--muted)">$0.13 used (2.6%)</span>
        <span style="font-size:8px;color:var(--muted)">$5.00 credit/mese</span>
      </div>
    </div>

    <!-- Breakdown -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Cost Breakdown</div>
        <button class="agents-refresh-btn" onclick="refreshCostsTab()">↻ Refresh</button>
      </div>
      <div id="costBreakdownBody" style="padding:16px">Loading...</div>
    </div>

  </div><!-- /#tab-costs -->

  <!-- EXPECTANCY TAB -->
  <div id="tab-expectancy" class="tab-content">

    <!-- KPI row -->
    <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px">
      <div class="kpi green">
        <div class="kpi-label">Expectancy / Trade</div>
        <div class="kpi-value green" id="exp-expectancy">—</div>
        <div class="kpi-sub">E = WR x avgWin - (1-WR) x avgLoss</div>
      </div>
      <div class="kpi yellow">
        <div class="kpi-label">Profit Factor</div>
        <div class="kpi-value yellow" id="exp-profitFactor">—</div>
        <div class="kpi-sub">gross wins / gross losses</div>
      </div>
      <div class="kpi blue">
        <div class="kpi-label">Kelly %</div>
        <div class="kpi-value blue" id="exp-kelly">—</div>
        <div class="kpi-sub">optimal fraction</div>
      </div>
      <div class="kpi purple">
        <div class="kpi-label">Win Rate</div>
        <div class="kpi-value purple" id="exp-winRate">—</div>
        <div class="kpi-sub" id="exp-winRateSub">executed bets</div>
      </div>
    </div>

    <!-- Expectancy detail panel -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Expectancy &mdash; Formula Breakdown</div>
        <div class="panel-tag" id="exp-verdictBadge" style="background:rgba(74,96,112,0.15);color:var(--muted);border:1px solid rgba(74,96,112,0.3)">LOADING</div>
      </div>
      <div style="padding:18px 20px;display:grid;grid-template-columns:repeat(3,1fr);gap:14px 24px;" id="exp-breakdownGrid">
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Avg Win</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent);" id="exp-avgWin">—</div>
          <div style="font-size:9px;color:var(--muted);">per winning bet</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Avg Loss</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--danger);" id="exp-avgLoss">—</div>
          <div style="font-size:9px;color:var(--muted);">per losing bet</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Win/Loss Ratio</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--warn);" id="exp-wlRatio">—</div>
          <div style="font-size:9px;color:var(--muted);">avgWin / avgLoss</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Total Bets (closed)</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;" id="exp-totalBets">—</div>
          <div style="font-size:9px;color:var(--muted);">sample size</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Gross Wins</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent);" id="exp-grossWins">—</div>
          <div style="font-size:9px;color:var(--muted);">sum of profitable trades</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Gross Losses</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--danger);" id="exp-grossLosses">—</div>
          <div style="font-size:9px;color:var(--muted);">sum of losing trades</div>
        </div>
      </div>
    </div>

    <!-- Direction breakdown -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" style="color:var(--accent)">▲ UP Bets</div>
          <div class="panel-tag tag-green" id="exp-upWrBadge">—</div>
        </div>
        <div style="padding:14px 18px;display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Win Rate</span>
            <span style="font-weight:700;color:var(--accent)" id="exp-upWr">—</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Total PnL</span>
            <span style="font-weight:700" id="exp-upPnl">—</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Count</span>
            <span style="font-weight:700" id="exp-upCount">—</span>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" style="color:var(--danger)">▼ DOWN Bets</div>
          <div class="panel-tag tag-red" id="exp-downWrBadge">—</div>
        </div>
        <div style="padding:14px 18px;display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Win Rate</span>
            <span style="font-weight:700;color:var(--danger)" id="exp-downWr">—</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Total PnL</span>
            <span style="font-weight:700" id="exp-downPnl">—</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Count</span>
            <span style="font-weight:700" id="exp-downCount">—</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Expectancy L20 rolling -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Rolling Expectancy &mdash; Last 20 Bets</div>
        <div class="panel-tag tag-blue" id="exp-l20Badge">—</div>
      </div>
      <div style="padding:14px 20px;display:flex;align-items:baseline;gap:12px;flex-wrap:wrap">
        <div style="font-size:36px;font-weight:800;font-family:'Syne',sans-serif;" id="exp-l20">—</div>
        <div style="font-size:11px;color:var(--muted);line-height:1.6">
          Expectancy delle ultime 20 bet chiuse.<br>
          Positivo = sistema in profitto nel breve termine.
        </div>
      </div>
    </div>

  </div><!-- /#tab-expectancy -->

  <!-- TRAINING TAB -->
  <div id="tab-training" class="tab-content">

    <!-- ── SECTION 1: Status header ── -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Auto-Training &mdash; XGBoost Engine</div>
        <div style="display:flex;align-items:center;gap:10px">
          <span id="trn-stateBadge" class="trn-badge trained">
            <span style="width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;animation:pulse 2s infinite;display:inline-block;"></span>
            <span id="trn-statusText">LOADING</span>
          </span>
        </div>
      </div>
      <div style="padding:14px 18px 16px">
        <div id="trn-statusPill" class="train-status-pill recent" style="display:none"><span id="trn-statusText2"></span></div>
        <!-- Retrain progress -->
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:6px">
          <span>Bets toward next retrain</span>
          <span id="trn-progressLabel" class="trn-mono" style="font-size:10px">—</span>
        </div>
        <div class="train-progress-bar">
          <div class="train-progress-fill" id="trn-progressFill" style="width:0%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:4px">
          <span id="trn-betsSince" class="trn-mono" style="font-size:9px">—</span>
          <span id="trn-betsThr" style="font-size:9px">/ 30 new bets</span>
        </div>
      </div>
    </div>

    <div class="trn-section-sep"></div>

    <!-- ── SECTION 2: Key Metric Cards ── -->
    <div class="trn-metric-cards">
      <div class="trn-metric-card">
        <div class="trn-metric-icon">&#127919;</div>
        <div class="trn-metric-label">CV Accuracy</div>
        <div class="trn-metric-value green" id="trn-dirAcc">—</div>
        <div class="trn-acc-bar-wrap">
          <div class="trn-acc-bar-track">
            <div class="trn-acc-bar-fill" id="trn-accBarFill" style="width:0%"></div>
          </div>
        </div>
        <div class="trn-metric-sub" id="trn-trainN">— signals</div>
      </div>
      <div class="trn-metric-card">
        <div class="trn-metric-icon">&#128197;</div>
        <div class="trn-metric-label">Last Retrain</div>
        <div class="trn-metric-value" id="trn-lastDate" style="font-size:12px">—</div>
        <div class="trn-metric-sub" id="trn-daysAgo">—</div>
      </div>
      <div class="trn-metric-card">
        <div class="trn-metric-icon">&#9201;</div>
        <div class="trn-metric-label">Next Scheduled</div>
        <div class="trn-metric-value yellow" id="trn-nextDate" style="font-size:12px">—</div>
        <div class="trn-metric-sub">Sunday 3:00 UTC</div>
      </div>
      <div class="trn-metric-card">
        <div class="trn-metric-icon">&#128272;</div>
        <div class="trn-metric-label">Confidence Thr.</div>
        <div class="trn-metric-value" id="trn-confThr">—</div>
        <div class="trn-metric-sub">min to open bet</div>
      </div>
    </div>

    <div class="trn-section-sep"></div>

    <!-- ── SECTION 3: Models + Pipeline ── -->
    <div class="two-col-grid">

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Model Status</div>
          <div class="panel-tag tag-muted">LIVE</div>
        </div>
        <div style="padding:14px 18px;display:flex;flex-direction:column;gap:2px">
          <div class="trn-model-row">
            <span style="color:var(--muted)">XGB Direction</span>
            <span id="trn-xgbStatus" class="trn-mono">—</span>
          </div>
          <div class="trn-model-row">
            <span style="color:var(--muted)">XGB Correctness</span>
            <span id="trn-corrStatus" class="trn-mono">—</span>
          </div>
          <div class="trn-model-row">
            <span style="color:var(--muted)">Base Position Size</span>
            <span id="trn-baseSize" class="trn-mono">—</span>
          </div>
          <div style="padding-top:10px">
            <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px">Dead Hours UTC</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--warn);letter-spacing:1px" id="trn-deadHours">—</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Pipeline Automatica</div>
          <div class="panel-tag tag-blue">LAUNCHD · DOM 3:00 UTC</div>
        </div>
        <div style="padding:14px 18px">
          <div style="font-size:11px;line-height:2;color:var(--text)">
            <span style="color:var(--muted);display:inline-block;width:16px">1.</span><code style="font-size:10px;color:var(--accent)">build_dataset.py</code> — aggiorna dataset da Supabase<br>
            <span style="color:var(--muted);display:inline-block;width:16px">2.</span><code style="font-size:10px;color:var(--accent)">train_xgboost.py</code> — ri-addestra XGBoost<br>
            <span style="color:var(--muted);display:inline-block;width:16px">3.</span><code style="font-size:10px;color:var(--accent)">backtest.py</code> — walk-forward validation<br>
            <span style="color:var(--muted);display:inline-block;width:16px">4.</span><code style="font-size:10px;color:var(--accent)">analyze_errors.py</code> — pattern errori<br>
            <span style="color:var(--muted);display:inline-block;width:16px">5.</span><span style="color:var(--blue)">git push → Railway auto-deploy</span><br>
            <span style="color:var(--muted);display:inline-block;width:16px">6.</span><span style="color:var(--blue)">/reload-calibration → hot reload</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Raw reports -->
    <details style="margin-bottom:12px">
      <summary style="cursor:pointer;font-size:11px;color:var(--muted);padding:6px 0;letter-spacing:1px;text-transform:uppercase">▸ XGBoost Model Report</summary>
      <pre id="trn-xgbReport" style="font-size:11px;line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:500px;overflow-y:auto;background:#111;padding:12px;border-radius:6px;color:#ccc;margin-top:8px">Loading...</pre>
    </details>
    <details>
      <summary style="cursor:pointer;font-size:11px;color:var(--muted);padding:6px 0;letter-spacing:1px;text-transform:uppercase">▸ Walk-Forward Backtest Report</summary>
      <pre id="trn-backtestReport" style="font-size:11px;line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:400px;overflow-y:auto;background:#111;padding:12px;border-radius:6px;color:#ccc;margin-top:8px">Loading...</pre>
    </details>

  </div><!-- /#tab-training -->

</div><!-- /.container -->
<script>
const CONFIG = {
  RAILWAY_URL: window.RAILWAY_URL || 'https://web-production-e27d0.up.railway.app',
  BTC_REFRESH: 10000,
  LIMIT: 500,
  REFRESH_INTERVAL: 60000,
  ACCT_REFRESH: 30000,
  CAPITAL: 100,
  SESSION_START: '2026-02-24'  // top-up $100 — ROI calcolato da questa data
};

let liveWalletEquity = null;   // aggiornato da renderAccountSummary()
let lastTotalPnl = 0;          // aggiornato da renderAll(), usato per ricalcolare ROI live
let lastSessionPnl = 0;        // PnL solo dal SESSION_START — per Session ROI live

const SAMPLE_DATA = [];

function showApiError(msg) {
  const banner = document.getElementById('apiErrorBanner');
  if (!banner) return;
  document.getElementById('apiErrorMsg').textContent = msg || 'Railway API non raggiungibile — dati non aggiornati';
  banner.classList.add('visible');
}
function hideApiError() {
  const banner = document.getElementById('apiErrorBanner');
  if (banner) banner.classList.remove('visible');
}

// ── ACCOUNT SUMMARY ──────────────────────────────────────────────────────────

async function fetchAccountSummary() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/account-summary`, {
      signal: AbortSignal.timeout(8000)
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  } catch(e) {
    console.warn('Account summary fetch error:', e);
    showApiError(`Railway /account-summary non raggiungibile (${e.message})`);
    return null;
  }
}

function fmtUsd(v, decimals = 2) {
  const n = Number(v);
  if (!isFinite(n)) return '—';
  return '$' + n.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function fmtPnlAcct(v, decimals = 4) {
  if (v === null || v === undefined) return '—';
  const n = parseFloat(v);
  return (n >= 0 ? '+' : '') + '$' + Math.abs(n).toFixed(decimals);
}

function pnlClass(v) {
  if (v === null || v === undefined) return 'muted';
  return parseFloat(v) > 0 ? 'green' : parseFloat(v) < 0 ? 'red' : 'muted';
}

function renderAccountSummary(data) {
  if (!data || data.status !== 'ok') {
    ['acctWalletBody', 'acctPositionBody', 'acctBtcBody'].forEach(id => {
      document.getElementById(id).innerHTML =
        '<div style="padding:16px;color:var(--danger);font-size:10px;letter-spacing:1px">⚠️ FETCH ERROR</div>';
    });
    return;
  }

  // Timestamp
  const ts = data.timestamp ? new Date(data.timestamp).toLocaleTimeString('it-IT') : '—';
  document.getElementById('acctTs').textContent = 'Updated: ' + ts;

  // ── WALLET ────────────────────────────────────────────────────────────────
  const w = data.wallet || {};
  const equity = parseFloat(w.margin_equity || 0);
  if (equity > 0) {
    liveWalletEquity = equity;
    const roiPct = (lastSessionPnl / equity) * 100;
    const roiEl = document.getElementById('kpiRoi');
    if (roiEl) {
      roiEl.textContent = (roiPct >= 0 ? '+' : '') + roiPct.toFixed(2) + '%';
      roiEl.className   = 'kpi-value ' + (roiPct >= 0 ? 'purple' : 'red');
    }
    const roiSubEl = document.getElementById('kpiRoiSub');
    if (roiSubEl) roiSubEl.textContent =
      (lastSessionPnl >= 0 ? '+' : '') + fmtUsd(lastSessionPnl) + ' · ' + fmtUsd(equity) + ' eq.';
    const footerCapEl = document.getElementById('footerCapital');
    if (footerCapEl) footerCapEl.textContent = fmtUsd(equity) + ' equity';
  }
  const usdc   = parseFloat(w.usdc_available || 0);
  const marginUsage = parseFloat(w.margin_usage_pct || 0);
  const unrealPnl = parseFloat(w.pnl_unrealized || 0);
  const funding   = parseFloat(w.funding_unrealized || 0);

  // Tag: total equity
  const walletTag = document.getElementById('acctWalletTag');
  walletTag.textContent = fmtUsd(equity);
  walletTag.className = 'panel-tag ' + (equity >= CONFIG.CAPITAL ? 'tag-green' : 'tag-red');

  // Margin bar color
  let marginBarColor = 'var(--accent)';
  if (marginUsage > 70) marginBarColor = 'var(--danger)';
  else if (marginUsage > 40) marginBarColor = 'var(--warn)';

  document.getElementById('acctWalletBody').innerHTML = `
    <div class="acct-row">
      <span class="acct-row-label">USDC Available</span>
      <span class="acct-row-val blue">${fmtUsd(usdc)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">Margin Equity</span>
      <span class="acct-row-val ${equity >= CONFIG.CAPITAL ? 'green' : 'red'}">${fmtUsd(equity)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">Free Margin</span>
      <span class="acct-row-val">${fmtUsd(w.available_margin)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">Portfolio</span>
      <span class="acct-row-val">${fmtUsd(w.portfolio_value)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">P&amp;L Unrealized</span>
      <span class="acct-row-val ${pnlClass(unrealPnl)}">${fmtPnlAcct(unrealPnl)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">Funding Accum.</span>
      <span class="acct-row-val ${pnlClass(funding)}">${fmtPnlAcct(funding, 6)}</span>
    </div>
    <div class="margin-bar-wrap">
      <div class="margin-bar-label">
        <span>Margin Usage</span>
        <span style="color:${marginBarColor}">${marginUsage.toFixed(2)}%</span>
      </div>
      <div class="margin-bar-bg">
        <div class="margin-bar-fill" style="width:${Math.min(marginUsage,100)}%;background:${marginBarColor}"></div>
      </div>
    </div>
  `;

  // ── POSITION ──────────────────────────────────────────────────────────────
  const pos = data.position || {};
  const posTag = document.getElementById('acctPositionTag');

  if (!pos.open) {
    posTag.textContent = 'FLAT';
    posTag.className = 'panel-tag';
    posTag.style.cssText = 'background:rgba(74,96,112,0.15);color:var(--muted);border:1px solid rgba(74,96,112,0.3)';
    document.getElementById('acctPositionBody').innerHTML = `
      <div class="position-status flat">
        <div class="position-dot"></div>
        FLAT — No open position
      </div>
    `;
  } else {
    const side = pos.side || 'unknown';
    const pnl  = parseFloat(pos.pnl || 0);
    const pnlPct = parseFloat(pos.pnl_pct || 0);
    posTag.textContent = side.toUpperCase();
    if (side === 'long') {
      posTag.className = 'panel-tag tag-green';
    } else {
      posTag.className = 'panel-tag tag-red';
    }
    posTag.style.cssText = '';

    const pnlIndicatorClass = pnl > 0 ? 'pos' : pnl < 0 ? 'neg' : 'zero';

    document.getElementById('acctPositionBody').innerHTML = `
      <div class="position-status ${side}">
        <div class="position-dot"></div>
        ${side.toUpperCase()} — ${pos.size} BTC
      </div>
      <div class="acct-row">
        <span class="acct-row-label">Entry Price</span>
        <span class="acct-row-val">${fmtUsd(pos.entry_price, 2)}</span>
      </div>
      <div class="acct-row">
        <span class="acct-row-label">Size</span>
        <span class="acct-row-val blue">${pos.size} BTC</span>
      </div>
      <div class="pnl-indicator ${pnlIndicatorClass}" style="margin-top:4px;">
        <span style="font-size:9px;letter-spacing:1px;text-transform:uppercase;opacity:0.7">Unrealized P&amp;L</span>
        <span>${fmtPnlAcct(pnl)} (${pnlPct > 0 ? '+' : ''}${pnlPct}%)</span>
      </div>
    `;
  }

  // ── BTC PRICE ─────────────────────────────────────────────────────────────
  const btc = data.btc || {};
  const mark = parseFloat(btc.mark_price || 0);
  const last = parseFloat(btc.last_price || 0);
  const fundingRate = parseFloat(btc.funding_rate_pct || 0);
  const oi = btc.open_interest;

  const btcTag = document.getElementById('acctBtcTag');
  btcTag.textContent = mark > 0 ? fmtUsd(mark, 0) : '—';

  document.getElementById('acctBtcBody').innerHTML = `
    <div class="btc-mark-big">${mark > 0 ? fmtUsd(mark, 2) : '—'}</div>
    <div style="font-size:8px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px">MARK PRICE</div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Last Price</span>
      <span class="btc-price-row-val">${fmtUsd(last, 2)}</span>
    </div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Funding Rate</span>
      <span class="btc-price-row-val" style="color:${fundingRate > 0 ? 'var(--danger)' : fundingRate < 0 ? 'var(--accent)' : 'var(--muted)'}">
        ${fundingRate > 0 ? '+' : ''}${fundingRate.toFixed(4)}%
      </span>
    </div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Open Interest</span>
      <span class="btc-price-row-val">${oi != null ? parseFloat(oi).toFixed(2) + ' BTC' : '—'}</span>
    </div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Vol 24h</span>
      <span class="btc-price-row-val">${btc.volume_24h != null ? parseFloat(btc.volume_24h).toLocaleString('en-US', {maximumFractionDigits:0}) : '—'}</span>
    </div>
  `;

  // ── RECENT FILLS ──────────────────────────────────────────────────────────
  const activity = data.recent_activity || {};
  const fills    = activity.fills || [];
  // realized_pnl_recent is now -(sum of fees) since Kraken fills don't return P&L
  const totalFeesCost = Math.abs(parseFloat(activity.realized_pnl_recent || 0));

  const fillsTag = document.getElementById('acctFillsTag');
  fillsTag.textContent = totalFeesCost > 0 ? '-$' + totalFeesCost.toFixed(5) : '+$0.0000';
  fillsTag.className = 'panel-tag ' + (totalFeesCost > 0 ? 'tag-yellow' : 'tag-green');

  if (!fills.length) {
    document.getElementById('acctFillsBody').innerHTML =
      '<div style="padding:18px 16px;color:var(--muted);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;">No recent fills</div>';
    return;
  }

  const rows = fills.map(f => {
    const side     = (f.side || '').toLowerCase();
    const sideClass = side === 'buy' ? 'fill-buy' : 'fill-sell';
    const sideLabel = side === 'buy' ? '▲ BUY' : '▼ SELL';
    const fillPnl   = f.pnl != null ? parseFloat(f.pnl) : null;
    const fee       = parseFloat(f.fee || 0);
    const ts        = f.timestamp ? new Date(f.timestamp).toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'}) : '—';
    return `<tr>
      <td><span class="${sideClass}">${sideLabel}</span></td>
      <td style="color:var(--text)">${parseFloat(f.size || 0).toFixed(4)}</td>
      <td style="color:var(--blue)">${fmtUsd(f.price, 0)}</td>
      <td class="${fillPnl != null ? (fillPnl >= 0 ? 'pnl-pos' : 'pnl-neg') : 'pnl-null'}">${fillPnl != null ? fmtPnlAcct(fillPnl, 4) : '—'}</td>
      <td style="color:${fee > 0 ? 'var(--warn)' : 'var(--muted)'}">${fee > 0 ? '-$' + fee.toFixed(5) : '—'}</td>
      <td style="color:var(--muted)">${ts}</td>
    </tr>`;
  }).join('');

  document.getElementById('acctFillsBody').innerHTML = `
    <div style="padding:8px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase">Fees Paid (recent)</span>
      <span style="font-size:12px;font-weight:700;font-family:'Syne',sans-serif;color:var(--warn)">${totalFeesCost > 0 ? '-$' + totalFeesCost.toFixed(5) : '+$0.0000'}</span>
    </div>
    <div style="overflow-x:auto;">
      <table class="fills-table">
        <thead>
          <tr>
            <th>Side</th>
            <th>Size</th>
            <th>Price</th>
            <th>P&amp;L</th>
            <th>Fee</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

async function refreshAccountSummary() {
  const data = await fetchAccountSummary();
  if (data) renderAccountSummary(data);
}

// ── LIVE POSITION WIDGET ──────────────────────────────────────────────────────

let _liveOpenBet = null;

function renderLivePosition() {
  if (!allData || !allData.length) return;
  const openBet = allData.find(d => d.bet_taken === true && d.correct === null);
  const widget  = document.getElementById('livePositionWidget');
  if (!openBet) { widget.style.display = 'none'; _liveOpenBet = null; return; }
  _liveOpenBet = openBet;
  widget.style.display = 'block';

  const entry   = parseFloat(openBet.entry_fill_price || openBet.btc_price_entry || 0);
  const sl      = parseFloat(openBet.sl_price || 0);
  const tp      = parseFloat(openBet.tp_price || 0);
  const conf    = parseFloat(openBet.confidence || 0);
  const dir     = openBet.direction || '—';
  const size    = parseFloat(openBet.bet_size || 0);
  const cur     = lastBtcPrice || entry;

  const pnlUsd  = cur && entry ? (dir === 'UP' ? (cur - entry) * size : (entry - cur) * size) : 0;
  const pnlPct  = entry ? ((cur - entry) / entry * 100 * (dir === 'UP' ? 1 : -1)).toFixed(2) : '0.00';

  const range     = (sl > 0 && tp > 0) ? tp - sl : 0;
  const entryPct  = range > 0 ? Math.max(1, Math.min(99, ((entry - sl) / range) * 100)) : 40;
  const livePct   = range > 0 ? Math.max(1, Math.min(99, ((cur   - sl) / range) * 100)) : 50;

  // DOM updates
  document.getElementById('lpBetId').textContent       = '#' + openBet.id;
  const dirEl = document.getElementById('lpDirection');
  dirEl.textContent  = dir === 'UP' ? '↑ LONG UP' : '↓ SHORT DOWN';
  dirEl.style.color  = dir === 'UP' ? 'var(--accent)' : 'var(--danger)';
  document.getElementById('lpConfidence').textContent  = Math.round(conf * 100) + '% confidence';
  document.getElementById('lpSize').textContent        = size.toFixed(4) + ' BTC · 0.00240 req';

  const pyrCount = parseInt(openBet.pyramid_count || 0);
  const pyrEl = document.getElementById('lpPyramidBadge');
  if (pyrEl) {
    if (pyrCount > 0) {
      pyrEl.style.display = 'inline-flex';
      pyrEl.textContent = '⬆ PYRAMID ×' + pyrCount;
    } else {
      pyrEl.style.display = 'none';
    }
  }

  try {
    const created  = new Date(openBet.created_at);
    const minsOpen = Math.round((Date.now() - created.getTime()) / 60000);
    document.getElementById('lpOpenTime').textContent  = fmtDate(openBet.created_at) + ' · ' + minsOpen + 'min open';
  } catch(e) {}

  const pnlEl = document.getElementById('lpPnl');
  const pos   = pnlUsd >= 0;
  pnlEl.innerHTML = `<span style="color:${pos ? 'var(--accent)' : 'var(--danger)'}">${pos?'+':''}$${pnlUsd.toFixed(3)}</span>&nbsp;<span style="color:var(--muted)">(${pnlPct}%)</span>`;

  if (sl > 0)    document.getElementById('lpSlLabel').textContent    = 'SL $'    + sl.toLocaleString('en-US',{maximumFractionDigits:0});
  if (entry > 0) document.getElementById('lpEntryLabel').textContent = 'ENTRY $' + entry.toLocaleString('en-US',{maximumFractionDigits:0});
  if (tp > 0)    document.getElementById('lpTpLabel').textContent    = 'TP $'    + tp.toLocaleString('en-US',{maximumFractionDigits:0});

  document.getElementById('lpEntryMarker').style.left = entryPct + '%';
  document.getElementById('lpLiveMarker').style.left  = livePct + '%';
  document.getElementById('lpCurrentPrice').textContent = cur ? '$' + cur.toLocaleString('en-US',{maximumFractionDigits:0}) : '—';
  document.getElementById('cubeFaceConf').textContent = Math.round(conf * 100) + '%';
  const cube  = document.getElementById('aiCube');
  const state = pnlUsd > 0.05 ? 'profit' : pnlUsd < -0.05 ? 'loss' : 'neutral';
  cube.dataset.state = state;

  const aiText = document.getElementById('aiDecisionText');
  if (Math.abs(pnlUsd) < 0.02) aiText.textContent = 'Flat — watching';
  else if (pos) aiText.textContent = 'In profit — HOLD?';
  else          aiText.textContent = 'In loss — evaluating';
}

// ── SIGNALS ──────────────────────────────────────────────────────────────────

async function fetchData() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/signals?limit=${CONFIG.LIMIT}`, {
      signal: AbortSignal.timeout(10000)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    hideApiError();
    return data;
  } catch(e) {
    console.warn('Fetch failed:', e);
    showApiError(`Railway /signals non raggiungibile (${e.message}) — mostro dati precedenti`);
    return SAMPLE_DATA;
  }
}

function fmtTime(ts) {
  return new Date(ts).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
}
function fmtDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }) + ' '
       + d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
}
function fmtPrice(p) {
  if (p === null || p === undefined) return '—';
  return '$' + parseFloat(p).toLocaleString('en-US', { maximumFractionDigits: 0 });
}
function fmtConf(c) { return (parseFloat(c) * 100).toFixed(0) + '%'; }
function fmtPnl(v) {
  if (v === null || v === undefined) return '—';
  const n = parseFloat(v);
  return (n >= 0 ? '+' : '') + '$' + n.toFixed(4);
}
function emaLabel(e) {
  if (!e) return '—';
  return e.includes('bullish') ? '🟢 BULL' : '🔴 BEAR';
}

function renderEntryCell(d) {
  if (!d.bet_taken || !d.entry_fill_price) return fmtPrice(d.btc_price_entry);
  const slip = (d.entry_slippage !== null && d.entry_slippage !== undefined) ? parseFloat(d.entry_slippage) : null;
  let slipStr = '';
  if (slip !== null && !isNaN(slip) && slip !== 0) {
    const slipColor = Math.abs(slip) > 20 ? 'var(--danger)' : Math.abs(slip) > 5 ? 'var(--warn)' : 'var(--muted)';
    const slipStr2 = (slip >= 0 ? '+' : '-') + '$' + Math.abs(slip).toFixed(1) + ' slip';
    slipStr = `<span style="display:block;font-size:9px;color:${slipColor};margin-top:1px">${slipStr2}</span>`;
  }
  return `<span style="display:block">${fmtPrice(d.entry_fill_price)}</span>${slipStr}`;
}

function renderSizeCell(d) {
  if (!d.bet_size) return '<span style="color:var(--muted)">—</span>';
  const size = parseFloat(d.bet_size);
  const reason = d.size_reason || '';
  let multClass = 'base';
  let multLabel = '×1.0';
  if (reason.includes('win_streak')) {
    multClass = 'up';
    multLabel = reason.includes('high_conf') ? '×1.5' : '×1.2';
  } else if (reason.includes('loss_streak')) {
    multClass = 'down';
    multLabel = '×0.5';
  } else if (reason.includes('drawdown')) {
    multClass = 'down';
    multLabel = '×0.25';
  }
  let reasonDisplay = reason
    .replace('_high_conf', '')
    .replace('_low_conf', '')
    .replace('win_streak_', 'W×')
    .replace('loss_streak_', 'L×')
    .replace('drawdown_protection', 'drawdown')
    .replace('insufficient_history', 'no hist.')
    .replace('base', '—');
  return `<span class="size-val">${size.toFixed(5)}</span>` +
         `<span class="size-mult ${multClass}">${multLabel} ${reasonDisplay}</span>`;
}

let currentPeriod = 'ALL';
let allData = [];

function setTimePeriod(btn) {
  const period = btn.dataset.period;
  // Sincronizza active su tutte le pill (desktop tab-nav + mobile bar)
  document.querySelectorAll('.time-pill').forEach(b => {
    b.classList.toggle('active', b.dataset.period === period);
  });
  currentPeriod = period;
  renderAll(allData);
}

function filterByPeriod(data) {
  if (currentPeriod === 'ALL') return data;
  const now = new Date();
  let cutoff;
  if      (currentPeriod === 'TODAY') cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  else if (currentPeriod === '24H')   cutoff = new Date(now - 86400000);
  else if (currentPeriod === '7D')    cutoff = new Date(now - 7 * 86400000);
  return data.filter(d => new Date(d.created_at) >= cutoff);
}

function updateBotStatus(data) {
  if (!data || !data.length) return;
  const latest = data[0];
  if (!latest || !latest.created_at) return;
  const minutesAgo = Math.floor((new Date() - new Date(latest.created_at)) / 60000);
  const el       = document.getElementById('botStatus');
  const textEl   = document.getElementById('botStatusText');
  const detailEl = document.getElementById('botStatusDetail');
  const timeStr  = new Date(latest.created_at).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
  const timeLabel= minutesAgo < 1 ? 'just now' : minutesAgo + ' min ago';
  detailEl.textContent = 'Last: ' + timeStr + ' (' + timeLabel + ')';
  el.className = 'bot-status';
  if      (minutesAgo <= 8)  { el.classList.add('alive');   textEl.textContent = 'BOT ALIVE'; }
  else if (minutesAgo <= 20) { el.classList.add('warning'); textEl.textContent = 'BOT SLOW ⚠️'; }
  else                       { el.classList.add('dead');    textEl.textContent = '🚨 BOT OFFLINE'; detailEl.textContent = 'No signal for ' + minutesAgo + ' min!'; }
}

let lastBtcPrice = null;
async function fetchLiveBtcPrice() {
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/btc-price', { signal: AbortSignal.timeout(5000) });
    if (!res.ok) throw new Error();
    const data  = await res.json();
    const price = data.mark_price || data.last_price;
    if (!price) return;
    const priceEl  = document.getElementById('btcLivePrice');
    const changeEl = document.getElementById('btcPriceChange');
    if (lastBtcPrice !== null) {
      const diff    = price - lastBtcPrice;
      const diffPct = ((diff / lastBtcPrice) * 100).toFixed(3);
      priceEl.className  = 'btc-live-price ' + (diff >= 0 ? 'up' : 'down');
      changeEl.className = 'btc-price-change ' + (diff >= 0 ? 'pos' : 'neg');
      changeEl.textContent = (diff >= 0 ? '+' : '') + diffPct + '%';
    }
    priceEl.textContent = '$' + price.toLocaleString('en-US', { maximumFractionDigits: 0 });
    lastBtcPrice = price;
    const kp = price >= 1000 ? '$' + Math.round(price / 1000) + 'k' : '$' + Math.round(price);
    document.title = '₿ ' + kp + ' · BTC Bot';
    renderLivePosition(); // aggiorna gauge live ogni volta che arriva un nuovo prezzo
  } catch(e) {
    const priceEl = document.getElementById('btcLivePrice');
    if (priceEl.textContent === '—' && allData.length) {
      const last = allData.find(d => d.btc_price_entry);
      if (last) priceEl.textContent = '$' + Number(last.btc_price_entry).toLocaleString('it-IT', { maximumFractionDigits: 0 });
    }
  }
}

function renderAll(data) {
  const filtered = filterByPeriod(data);
  const titleEl  = document.getElementById('signalLogTitle');
  titleEl.textContent = currentPeriod === 'ALL'
    ? 'Signal Log'
    : `Signal Log · ${filtered.length} signals (${currentPeriod})`;
  render(filtered);
  renderLivePosition(); // mostra widget se c'è posizione aperta
}

// ── Next Signal countdown timer ───────────────────────────────────────────────
let _nextSignalInterval = null;
function startNextSignalTimer(lastTs) {
  if (_nextSignalInterval) { clearInterval(_nextSignalInterval); _nextSignalInterval = null; }
  const el = document.getElementById('nextSignalTimer');
  if (!el || !lastTs) return;
  const lastMs = new Date(lastTs).getTime();
  function tick() {
    const remaining = (lastMs + 6 * 60 * 1000) - Date.now();
    if (remaining > 0) {
      const m = Math.floor(remaining / 60000);
      const s = Math.floor((remaining % 60000) / 1000);
      el.textContent = `⏱ ${m}m ${String(s).padStart(2,'0')}s`;
      el.className = 'next-signal-badge';
    } else if (remaining > -3 * 60 * 1000) {
      el.textContent = '⏳ imminente…';
      el.className = 'next-signal-badge imminent';
    } else {
      el.textContent = '⚠ ritardo';
      el.className = 'next-signal-badge overdue';
    }
  }
  tick();
  _nextSignalInterval = setInterval(tick, 1000);
}

function render(data) {
  updateBotStatus(data);
  document.getElementById('lastUpdate').innerHTML =
    `LAST UPDATE: <strong>${new Date().toLocaleTimeString('it-IT')}</strong>`;
  // Start next-signal countdown from most recent record
  if (data.length > 0) startNextSignalTimer(data[0].created_at);

  const bets        = data.filter(d => d.classification === 'BET');
  const realBets    = bets.filter(d => d.pnl_usd !== null);
  const closedBets  = bets.filter(d => d.correct !== null);
  const correctBets = closedBets.filter(d => d.correct === true);
  const closed      = data.filter(d => d.correct !== null);
  const correct     = closed.filter(d => d.correct === true);

  const totalPnl   = realBets.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  lastTotalPnl = totalPnl;
  const capitalBase = liveWalletEquity || CONFIG.CAPITAL;

  // Session ROI: solo bets dal top-up $100 (2026-02-24)
  const sessionBets = realBets.filter(d => d.created_at && d.created_at.slice(0, 10) >= CONFIG.SESSION_START);
  const sessionPnl  = sessionBets.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  lastSessionPnl = sessionPnl;
  const roiPct      = (sessionPnl / capitalBase) * 100;
  const avgConf  = data.length ? data.reduce((s, d) => s + parseFloat(d.confidence || 0), 0) / data.length : 0;
  const pnlVals  = realBets.map(d => parseFloat(d.pnl_usd || 0));
  const bestPnl  = pnlVals.length ? Math.max(...pnlVals) : 0;
  const worstPnl = pnlVals.length ? Math.min(...pnlVals) : 0;

  const lastEntry = data.find(d => d.btc_price_entry);
  const lastFG    = lastEntry ? lastEntry.fear_greed_value : null;

  document.getElementById('kpiPrice').textContent   = lastEntry ? fmtPrice(lastEntry.btc_price_entry) : '—';
  document.getElementById('kpiTotal').textContent   = data.length;

  const accEl = document.getElementById('kpiAccuracy');
  accEl.textContent = closed.length ? Math.round(correct.length / closed.length * 100) + '%' : '—';

  const pnlEl = document.getElementById('kpiPnl');
  pnlEl.textContent = (sessionPnl >= 0 ? '+' : '') + '$' + sessionPnl.toFixed(2);
  pnlEl.className   = 'kpi-value ' + (sessionPnl >= 0 ? 'green' : 'red');

  const roiEl = document.getElementById('kpiRoi');
  roiEl.textContent = (roiPct >= 0 ? '+' : '') + roiPct.toFixed(2) + '%';
  roiEl.className   = 'kpi-value ' + (roiPct >= 0 ? 'purple' : 'red');
  document.getElementById('kpiRoiSub').textContent =
    (sessionPnl >= 0 ? '+' : '') + fmtUsd(sessionPnl) + ' · ' + fmtUsd(capitalBase) + ' eq.';
  document.getElementById('footerCapital').textContent = fmtUsd(capitalBase) + ' equity';

  document.getElementById('kpiWinRate').textContent = closedBets.length ? Math.round(correctBets.length / closedBets.length * 100) + '%' : '—';
  const noBets        = data.filter(d => !d.bet_taken);  // include SKIP+NO_BET+ALERT
  const noBetsClosed  = noBets.filter(d => d.correct !== null);
  const noBetsCorrect = noBetsClosed.filter(d => d.correct === true);
  document.getElementById('kpiWrNoBet').textContent = noBetsClosed.length ? Math.round(noBetsCorrect.length / noBetsClosed.length * 100) + '%' : '—';
  document.getElementById('kpiFG').textContent      = lastFG !== null ? lastFG : '—';
  document.getElementById('kpiFGLabel').textContent = lastFG !== null
    ? (lastFG < 20 ? 'EXTREME FEAR' : lastFG < 40 ? 'FEAR' : lastFG < 60 ? 'NEUTRAL' : lastFG < 80 ? 'GREED' : 'EXTREME GREED') : '';
  document.getElementById('kpiBets').textContent    = bets.length + '/' + data.length;
  document.getElementById('kpiDrawdown').textContent= worstPnl ? '$' + worstPnl.toFixed(2) : '—';

  document.getElementById('statConf').textContent  = (avgConf * 100).toFixed(1) + '%';
  document.getElementById('statBest').textContent  = bestPnl  ? '+$' + bestPnl.toFixed(2)  : '—';
  const closedBetsDesc = bets.filter(d => d.correct !== null);
  let streak = 0, streakType = null;
  if (closedBetsDesc.length) {
    streakType = closedBetsDesc[0].correct ? 'W' : 'L';
    for (const b of closedBetsDesc) {
      if ((b.correct ? 'W' : 'L') === streakType) streak++;
      else break;
    }
  }
  const streakEl = document.getElementById('statStreak');
  streakEl.textContent = streak > 0 ? streakType + '×' + streak : '—';
  streakEl.style.color = streakType === 'W' ? 'var(--accent)' : streakType === 'L' ? 'var(--danger)' : 'var(--muted)';
  const betsWithSlip = realBets.filter(d => d.entry_slippage !== null && d.entry_slippage !== undefined);
  const avgSlip = betsWithSlip.length
    ? betsWithSlip.reduce((s, d) => s + parseFloat(d.entry_slippage || 0), 0) / betsWithSlip.length
    : null;
  const slipEl = document.getElementById('statSlippage');
  slipEl.textContent = avgSlip !== null ? (avgSlip >= 0 ? '+' : '') + '$' + avgSlip.toFixed(2) : '—';
  slipEl.style.color = avgSlip === null ? 'var(--muted)' : Math.abs(avgSlip) > 20 ? 'var(--danger)' : Math.abs(avgSlip) > 5 ? 'var(--warn)' : 'var(--accent)';
  const betsWithRR = bets.filter(d => d.rr_ratio !== null && d.rr_ratio !== undefined);
  const avgRR = betsWithRR.length
    ? betsWithRR.reduce((s, d) => s + parseFloat(d.rr_ratio || 0), 0) / betsWithRR.length
    : null;
  const rrEl = document.getElementById('statRR');
  rrEl.textContent = avgRR !== null ? avgRR.toFixed(2) + '×' : '—';
  rrEl.style.color = avgRR === null ? 'var(--muted)' : avgRR >= 2 ? 'var(--accent)' : avgRR >= 1.5 ? 'var(--warn)' : 'var(--danger)';

  // Mobile-only: Expectancy, Profit Factor, Best Streak
  const grossWins  = closedBets.filter(d => d.pnl_usd > 0).reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  const grossLoss  = Math.abs(closedBets.filter(d => d.pnl_usd < 0).reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0));
  const expectancy = closedBets.length ? totalPnl / closedBets.length : null;
  const profitFactor = grossLoss > 0 ? grossWins / grossLoss : null;
  const expEl = document.getElementById('kpiExpectancyVal');
  if (expEl) {
    expEl.textContent = expectancy !== null ? (expectancy >= 0 ? '+' : '') + '$' + expectancy.toFixed(3) : '—';
    expEl.className = 'kpi-value ' + (expectancy === null ? 'white' : expectancy >= 0 ? 'green' : 'red');
  }
  const pfEl = document.getElementById('kpiProfitFactorVal');
  if (pfEl) {
    pfEl.textContent = profitFactor !== null ? profitFactor.toFixed(2) : '—';
    pfEl.className = 'kpi-value ' + (profitFactor === null ? 'purple' : profitFactor >= 1.5 ? 'green' : profitFactor < 1 ? 'red' : 'yellow');
  }
  // Best streak
  let bestStreakW = 0, bestStreakL = 0, curW = 0, curL = 0;
  for (const b of closedBetsDesc) {
    if (b.correct) { curW++; curL = 0; bestStreakW = Math.max(bestStreakW, curW); }
    else           { curL++; curW = 0; bestStreakL = Math.max(bestStreakL, curL); }
  }
  const bsEl = document.getElementById('statBestStreak');
  if (bsEl) {
    bsEl.textContent = bestStreakW > 0 ? 'W×' + bestStreakW : '—';
    bsEl.style.color = 'var(--accent)';
  }

  renderTable(data);

  const chronoBets = [...realBets].reverse();
  renderPnlChart(chronoBets);
  renderSignalQuality(data);
  renderConfDist(data);
  renderEquityCurve(chronoBets, totalPnl);

  // Charts Grid (4 temporal charts)
  const chronoAll = [...data].reverse();
  renderConfidenceOverTime(chronoAll);
  renderRollingWinRate(chronoBets);
  renderPnlBarsLarge(chronoBets);
  renderBtcPredictionsOverlay(chronoAll);

  const tag = document.getElementById('totalPnlTag');
  tag.textContent = 'TOTAL: ' + (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
  tag.className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');

  // Mobile sync
  syncStoryHighlights();
  syncMobilePrimary();
  // renderMobileBetList already called inside renderTable() — no duplicate needed
}

function renderTable(data) {
  const dirFilter   = document.getElementById('filterDir').value;
  const classFilter = document.getElementById('filterClass').value;
  const filtered = data.filter(d => {
    if (dirFilter   !== 'ALL' && d.direction      !== dirFilter)   return false;
    if (classFilter !== 'ALL' && d.classification !== classFilter) return false;
    return true;
  });
  const tbody = document.getElementById('signalTable');
  if (!filtered.length) {
    tbody.innerHTML = '<tr class="no-data-row"><td colspan="15">NO DATA</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(d => {
    const dirCls  = d.direction === 'UP' ? 'dir-up' : 'dir-down';
    const dirIcon = d.direction === 'UP' ? '↑' : '↓';
    let betBadge;
    if      (d.classification === 'BET')     betBadge = '<span class="badge badge-bet">BET</span>';
    else if (d.classification === 'SKIP')    betBadge = '<span class="badge badge-skip">SKIP</span>';
    else if (d.classification === 'ALERT')   betBadge = '<span class="badge badge-alert">ALERT</span>';
    else if (d.classification === 'PENDING') betBadge = '<span class="badge badge-pending">PEND</span>';
    else                                     betBadge = '<span class="badge badge-nobet">NO BET</span>';
    const isDry = (d.entry_order_id || '').startsWith('DRY_');
    let resultBadge;
    const isBet = d.classification === 'BET' && d.bet_taken;
    if (d.correct === true) {
      resultBadge = isDry
        ? '<span class="badge" style="background:rgba(0,255,136,0.06);color:rgba(0,255,136,0.6);border:1px solid rgba(0,255,136,0.2)">✓ SIM WIN</span>'
        : isBet
          ? '<span class="badge badge-correct">✓ WIN</span>'
          : '<span class="badge badge-correct" style="opacity:0.75">✓ RIGHT</span>';
    } else if (d.correct === false) {
      resultBadge = isDry
        ? '<span class="badge" style="background:rgba(255,68,102,0.06);color:rgba(255,68,102,0.6);border:1px solid rgba(255,68,102,0.2)">✗ SIM LOSS</span>'
        : isBet
          ? '<span class="badge badge-wrong">✗ LOSS</span>'
          : '<span class="badge badge-wrong" style="opacity:0.75">✗ WRONG</span>';
    } else {
      resultBadge = isBet
        ? '<span style="color:var(--warn);font-size:9px;letter-spacing:1px">⏳ OPEN</span>'
        : '<span style="color:var(--muted);font-size:10px;">—</span>';
    }
    const pnlCls    = d.pnl_usd === null ? 'pnl-null' : parseFloat(d.pnl_usd) >= 0 ? 'pnl-pos' : 'pnl-neg';
    const score     = (d.technical_score !== null && d.technical_score !== undefined) ? parseFloat(d.technical_score).toFixed(1) : '—';
    const scoreColor= parseFloat(d.technical_score) >= 0 ? 'var(--accent)' : 'var(--danger)';
    // EXIT $: use actual fill price first, fallback to signal exit price
    const exitPrice = d.exit_fill_price ?? d.btc_price_exit;
    // PNL cell: real $ for BETs, theoretical % for NO BETs
    let pnlCell;
    if (d.classification === 'BET') {
      pnlCell = `<span class="${pnlCls}">${fmtPnl(d.pnl_usd)}</span>`;
    } else if (d.pnl_pct !== null && d.pnl_pct !== undefined) {
      const pct = parseFloat(d.pnl_pct);
      const pctCls = pct >= 0 ? 'pnl-pos' : 'pnl-neg';
      const pctSign = pct >= 0 ? '+' : '';
      pnlCell = `<span class="${pctCls}" style="font-style:italic;opacity:0.7;font-size:10px">${pctSign}${pct.toFixed(2)}%</span>`;
    } else {
      pnlCell = `<span class="pnl-null">—</span>`;
    }
    const TAKER_RATE = 0.00005;
    let feeCell = '<span style="color:var(--muted)">—</span>';
    if (d.classification === 'BET' && d.bet_taken) {
      const feeVal = (d.fees_total !== null && d.fees_total !== undefined)
        ? parseFloat(d.fees_total)
        : (() => {
            const sz = parseFloat(d.bet_size || 0);
            const ep = parseFloat(d.entry_fill_price || 0);
            const xp = parseFloat(d.exit_fill_price || d.btc_price_exit || 0);
            return sz * (ep + xp) * TAKER_RATE;
          })();
      if (feeVal > 0) feeCell = `<span style="color:var(--warn);font-size:10px">-$${feeVal.toFixed(5)}</span>`;
    }
    return `<tr>
      <td style="color:var(--muted)">${d.id}</td>
      <td style="color:var(--muted)">${fmtDate(d.created_at)}</td>
      <td class="${dirCls}">${dirIcon} ${d.direction}</td>
      <td>${fmtConf(d.confidence)}</td>
      <td>${renderEntryCell(d)}</td>
      <td>${fmtPrice(exitPrice)}</td>
      <td>${d.rsi14 ? parseFloat(d.rsi14).toFixed(1) : '—'}</td>
      <td>${emaLabel(d.ema_trend)}</td>
      <td style="color:${scoreColor}">${score}</td>
      <td>${renderSizeCell(d)}</td>
      <td>${betBadge}</td>
      <td>${resultBadge}</td>
      <td>${pnlCell}</td>
      <td>${feeCell}</td>
      <td>${d.sl_price || d.tp_price || d.rr_ratio ? `<span style="font-size:9px;color:var(--danger)">SL ${d.sl_price ? fmtPrice(d.sl_price) : '—'}</span><br><span style="font-size:9px;color:var(--accent)">TP ${d.tp_price ? fmtPrice(d.tp_price) : '—'}</span><br><span style="font-size:9px;color:var(--muted)">RR ${d.rr_ratio ? parseFloat(d.rr_ratio).toFixed(2) + '×' : '—'}</span>` : '<span style="color:var(--muted)">—</span>'}</td>
      <td style="text-align:center">${d.onchain_commit_tx ? `<a href="https://polygonscan.com/tx/${d.onchain_commit_tx}" target="_blank" rel="noopener" title="Verified on Polygon PoS" style="text-decoration:none;font-size:13px">🔗</a>` : '<span style="color:var(--muted);font-size:9px">—</span>'}</td>
    </tr>`;
  }).join('');
  renderMobileBetList(data);
}

function renderPnlChart(chronoBets) {
  if (!chronoBets.length) return;
  const chart  = document.getElementById('pnlChart');
  const maxAbs = Math.max(...chronoBets.map(d => Math.abs(parseFloat(d.pnl_usd || 0))));
  const maxH   = 82;
  chart.innerHTML = chronoBets.map(d => {
    const v   = parseFloat(d.pnl_usd || 0);
    const h   = maxAbs > 0 ? Math.max(2, Math.abs(v) / maxAbs * maxH) : 2;
    const cls = v > 0 ? 'pos' : v < 0 ? 'neg' : 'zero';
    return `<div class="bar ${cls}" style="height:${h}px"><div class="tooltip">${fmtPnl(v)}</div></div>`;
  }).join('');
  const times = chronoBets.map(d => fmtTime(d.created_at));
  document.getElementById('chartStart').textContent = times[0];
  document.getElementById('chartEnd').textContent   = times[times.length - 1];
}

function renderSignalQuality(data) {
  const pct = (arr, fn) => arr.length ? Math.round(arr.filter(fn).length / arr.length * 100) : 0;
  const upClosed  = data.filter(d => d.direction === 'UP'   && d.correct !== null);
  const dnClosed  = data.filter(d => d.direction === 'DOWN' && d.correct !== null);

  const betsWithPnl = data.filter(d => d.classification === 'BET' && d.pnl_usd !== null);
  const grossWin  = betsWithPnl.filter(d => parseFloat(d.pnl_usd) > 0).reduce((s, d) => s + parseFloat(d.pnl_usd), 0);
  const grossLoss = Math.abs(betsWithPnl.filter(d => parseFloat(d.pnl_usd) < 0).reduce((s, d) => s + parseFloat(d.pnl_usd), 0));
  const pf = grossLoss > 0 ? grossWin / grossLoss : grossWin > 0 ? 99 : 0;
  const pfLabel = betsWithPnl.length ? pf.toFixed(2) + 'x' : '—';

  const totalPnlSig = betsWithPnl.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  const avgPnl = betsWithPnl.length ? totalPnlSig / betsWithPnl.length : 0;
  const avgPnlLabel = betsWithPnl.length ? (avgPnl >= 0 ? '+' : '') + '$' + avgPnl.toFixed(4) : '—';

  const metrics = [
    { label: 'Profit Factor',        barVal: Math.min(pf / 2 * 100, 100), displayVal: pfLabel,    color: pf >= 1 ? 'var(--accent)' : 'var(--danger)' },
    { label: 'Avg PnL / Trade',      barVal: 50,                           displayVal: avgPnlLabel, color: avgPnl >= 0 ? 'var(--accent)' : 'var(--danger)' },
    { label: 'UP Signal Accuracy',   barVal: pct(upClosed, d => d.correct), displayVal: null,      color: 'var(--accent)' },
    { label: 'DOWN Signal Accuracy', barVal: pct(dnClosed, d => d.correct), displayVal: null,      color: 'var(--danger)' },
    { label: 'Bet Coverage',         barVal: data.length ? Math.round(data.filter(d => d.classification === 'BET').length / data.length * 100) : 0, displayVal: null, color: 'var(--warn)' },
  ];
  document.getElementById('signalQuality').innerHTML = metrics.map(m => `
    <div class="signal-row">
      <div class="signal-meta">
        <span class="signal-label">${m.label}</span>
        <span class="signal-val" style="color:${m.color}">${m.displayVal !== null ? m.displayVal : m.barVal + '%'}</span>
      </div>
      <div class="signal-bar-bg"><div class="signal-bar-fill" style="width:${m.barVal}%;background:${m.color}"></div></div>
    </div>`).join('');
}

function renderConfDist(data) {
  const buckets = [
    { label: '50-54%', min: 0.50, max: 0.55 },
    { label: '55-59%', min: 0.55, max: 0.60 },
    { label: '60-64%', min: 0.60, max: 0.65 },
    { label: '65-69%', min: 0.65, max: 0.70 },
    { label: '70%+',   min: 0.70, max: 1.01 },
  ];
  const counts   = buckets.map(b => ({ ...b, count: data.filter(d => { const c = parseFloat(d.confidence); return c >= b.min && c < b.max; }).length }));
  const maxCount = Math.max(...counts.map(c => c.count), 1);
  document.getElementById('confDist').innerHTML = counts.map(c => `
    <div class="conf-row">
      <div class="conf-label">${c.label}</div>
      <div class="conf-bar-bg"><div class="conf-bar-fill" style="width:${Math.round(c.count / maxCount * 100)}%"></div></div>
      <div class="conf-count">${c.count}</div>
    </div>`).join('');
}

function renderEquityCurve(chronoBets, totalPnl) {
  const svg = document.getElementById('equitySvg');
  if (!chronoBets.length) { svg.innerHTML = ''; return; }
  let cum = 0;
  const points = [{ i: 0, cum: 0 }];
  chronoBets.forEach((d, i) => { cum += parseFloat(d.pnl_usd || 0); points.push({ i: i+1, cum }); });
  const minV = Math.min(...points.map(p => p.cum));
  const maxV = Math.max(...points.map(p => p.cum));
  const range= maxV - minV || 0.001;
  const W = 1000, H = 100;
  const toX = i => (i / (points.length - 1)) * W;
  const toY = v => H - ((v - minV) / range) * (H - 10) - 5;
  const pts  = points.map((p, i) => `${toX(i).toFixed(1)},${toY(p.cum).toFixed(1)}`).join(' ');
  const areaClose = `${toX(points.length-1).toFixed(1)},${H} 0,${H}`;
  const color  = totalPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
  const gradId = totalPnl >= 0 ? 'eqG' : 'eqGR';
  svg.innerHTML = `
    <defs>
      <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pts} ${areaClose}" fill="url(#${gradId})"/>
    <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${toX(points.length-1).toFixed(1)}" cy="${toY(points[points.length-1].cum).toFixed(1)}" r="3.5" fill="${color}"/>`;
  document.getElementById('equityTag').textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
  document.getElementById('equityTag').className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');
}

// ── CHARTS GRID FUNCTIONS ────────────────────────────────────────────────────

function renderConfidenceOverTime(chronoAll) {
  const svg = document.getElementById('confSvg');
  if (!chronoAll.length) { svg.innerHTML = ''; return; }
  const W = 600, H = 100;
  const minConf = 0.50, maxConf = 1.0;
  const toY = c => H - ((c - minConf) / (maxConf - minConf)) * (H - 10) - 5;
  const pts = chronoAll.map((d, i) => {
    const x = (i / Math.max(chronoAll.length - 1, 1)) * W;
    return `${x.toFixed(1)},${toY(parseFloat(d.confidence || 0.5)).toFixed(1)}`;
  }).join(' ');
  const threshY = toY(0.60);
  const avgConf = chronoAll.reduce((s, d) => s + parseFloat(d.confidence || 0.5), 0) / chronoAll.length;
  const lastX = ((chronoAll.length - 1) / Math.max(chronoAll.length - 1, 1)) * W;
  const lastY = toY(parseFloat(chronoAll[chronoAll.length - 1].confidence || 0.5));
  svg.innerHTML = `
    <defs>
      <linearGradient id="confG" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--blue)" stop-opacity="0.25"/>
        <stop offset="100%" stop-color="var(--blue)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pts} ${W},${H} 0,${H}" fill="url(#confG)"/>
    <line x1="0" y1="${threshY.toFixed(1)}" x2="${W}" y2="${threshY.toFixed(1)}" stroke="var(--muted)" stroke-width="0.8" stroke-dasharray="4,3"/>
    <text x="4" y="${(threshY - 3).toFixed(1)}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono,monospace">60%</text>
    <polyline points="${pts}" fill="none" stroke="var(--blue)" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${lastX.toFixed(1)}" cy="${lastY.toFixed(1)}" r="3" fill="var(--blue)"/>`;
  document.getElementById('confTag').textContent = 'AVG ' + (avgConf * 100).toFixed(1) + '%';
}

function renderRollingWinRate(chronoBets) {
  const svg = document.getElementById('wrSvg');
  const closed = chronoBets.filter(d => d.correct !== null);
  if (closed.length < 3) {
    svg.innerHTML = '<text x="10" y="55" fill="var(--muted)" font-size="10" font-family="JetBrains Mono,monospace">Not enough data (need 3+ bets)</text>';
    return;
  }
  const W = 600, H = 100;
  const toX = i => (i / Math.max(closed.length - 1, 1)) * W;
  const toY = pct => H - (pct / 100) * (H - 10) - 5;
  const wr10pts = [], wr20pts = [];
  closed.forEach((d, i) => {
    const s10 = closed.slice(Math.max(0, i - 9), i + 1);
    const s20 = closed.slice(Math.max(0, i - 19), i + 1);
    wr10pts.push(`${toX(i).toFixed(1)},${toY(s10.filter(x => x.correct).length / s10.length * 100).toFixed(1)}`);
    wr20pts.push(`${toX(i).toFixed(1)},${toY(s20.filter(x => x.correct).length / s20.length * 100).toFixed(1)}`);
  });
  const line50Y = toY(50);
  svg.innerHTML = `
    <line x1="0" y1="${line50Y.toFixed(1)}" x2="${W}" y2="${line50Y.toFixed(1)}" stroke="var(--muted)" stroke-width="0.8" stroke-dasharray="4,3"/>
    <text x="4" y="${(line50Y - 3).toFixed(1)}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono,monospace">50%</text>
    <polyline points="${wr20pts.join(' ')}" fill="none" stroke="var(--blue)" stroke-width="1.2" stroke-linejoin="round" opacity="0.6"/>
    <polyline points="${wr10pts.join(' ')}" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linejoin="round"/>
    <circle cx="${toX(closed.length-1).toFixed(1)}" cy="${wr10pts[wr10pts.length-1].split(',')[1]}" r="3" fill="var(--accent)"/>`;
}

function renderPnlBarsLarge(chronoBets) {
  const container = document.getElementById('pnlBarsLarge');
  if (!chronoBets.length) {
    container.innerHTML = '<span style="color:var(--muted);font-size:10px">No data</span>';
    document.getElementById('pnlBarsTag').textContent = 'REAL BETS';
    return;
  }
  const maxAbs = Math.max(...chronoBets.map(d => Math.abs(parseFloat(d.pnl_usd || 0))), 0.0001);
  const maxH = 120;
  container.innerHTML = chronoBets.map(d => {
    const v = parseFloat(d.pnl_usd || 0);
    const h = Math.max(2, Math.abs(v) / maxAbs * maxH);
    const cls = v > 0 ? 'pos' : v < 0 ? 'neg' : 'zero';
    const label = (v >= 0 ? '+' : '') + '$' + v.toFixed(4);
    return `<div class="bar ${cls}" style="height:${h}px;flex:1;min-width:2px;max-width:14px;" title="${label}"><div class="tooltip">${label}</div></div>`;
  }).join('');
  document.getElementById('pnlBarsTag').textContent = chronoBets.length + ' BETS';
}

function renderBtcPredictionsOverlay(chronoAll) {
  const svg = document.getElementById('btcOverlaySvg');
  const pts = chronoAll.filter(d => d.btc_price_entry && parseFloat(d.btc_price_entry) > 0);
  if (pts.length < 2) {
    svg.innerHTML = '<text x="10" y="55" fill="var(--muted)" font-size="10" font-family="JetBrains Mono,monospace">Not enough data</text>';
    return;
  }
  const W = 600, H = 100;
  const prices = pts.map(d => parseFloat(d.btc_price_entry));
  const minP = Math.min(...prices), maxP = Math.max(...prices);
  const range = maxP - minP || 1;
  const toX = i => (i / Math.max(pts.length - 1, 1)) * W;
  const toY = p => H - ((p - minP) / range) * (H - 14) - 7;
  const pricePts = pts.map((d, i) => `${toX(i).toFixed(1)},${toY(parseFloat(d.btc_price_entry)).toFixed(1)}`).join(' ');
  const markers = pts.map((d, i) => {
    if (d.correct === null || d.classification !== 'BET') return '';
    const x = toX(i), y = toY(parseFloat(d.btc_price_entry));
    const color = d.correct ? 'var(--accent)' : 'var(--danger)';
    const isUp = d.direction === 'UP';
    const tri = isUp
      ? `${x.toFixed(1)},${(y-9).toFixed(1)} ${(x-4).toFixed(1)},${(y-1).toFixed(1)} ${(x+4).toFixed(1)},${(y-1).toFixed(1)}`
      : `${x.toFixed(1)},${(y+9).toFixed(1)} ${(x-4).toFixed(1)},${(y+1).toFixed(1)} ${(x+4).toFixed(1)},${(y+1).toFixed(1)}`;
    return `<polygon points="${tri}" fill="${color}" opacity="0.9"/>`;
  }).join('');
  svg.innerHTML = `
    <defs>
      <linearGradient id="btcG" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--muted)" stop-opacity="0.15"/>
        <stop offset="100%" stop-color="var(--muted)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pricePts} ${W},${H} 0,${H}" fill="url(#btcG)"/>
    <polyline points="${pricePts}" fill="none" stroke="var(--muted)" stroke-width="1.2" stroke-linejoin="round" opacity="0.6"/>
    ${markers}`;
}

// ── INIT ─────────────────────────────────────────────────────────────────────

async function refresh() {
  try { allData = await fetchData(); renderAll(allData); }
  catch(e) { console.error('Render error:', e); }
}

document.getElementById('filterDir').addEventListener('change',   () => { if (typeof applySignalFilters === 'function') applySignalFilters(); else renderTable(filterByPeriod(allData)); });
document.getElementById('filterClass').addEventListener('change', () => { if (typeof applySignalFilters === 'function') applySignalFilters(); else renderTable(filterByPeriod(allData)); });

// ── TAB SYSTEM ────────────────────────────────────────────────────────────────

function switchTab(btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const targetTab = btn.dataset.tab;
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + targetTab).classList.add('active');
  if (targetTab === 'agents')     refreshAgentsTab();
  if (targetTab === 'costs')      refreshCostsTab();
  if (targetTab === 'backtest')   fetchBacktestReport();
  if (targetTab === 'training')   fetchTrainingTab();
  if (targetTab === 'expectancy') fetchExpectancyTab();
}

// ── EXPECTANCY TAB ────────────────────────────────────────────────────────────

async function fetchExpectancyTab() {
  try {
    const [tsRes, sigRes] = await Promise.allSettled([
      fetch(`${CONFIG.RAILWAY_URL}/training-status`, { signal: AbortSignal.timeout(10000) }),
      fetch(`${CONFIG.RAILWAY_URL}/signals?limit=500`,  { signal: AbortSignal.timeout(12000) })
    ]);

    // Build metrics from signals (closed bets only)
    let signals = [];
    if (sigRes.status === 'fulfilled' && sigRes.value.ok) {
      const j = await sigRes.value.json();
      signals = (j.signals || j || []);
    }

    const closedBets = signals.filter(s =>
      s.classification === 'BET' && s.bet_taken &&
      s.correct !== null && s.correct !== undefined
    );

    const wins   = closedBets.filter(s => s.correct === true);
    const losses = closedBets.filter(s => s.correct === false);
    const n      = closedBets.length;
    const wr     = n > 0 ? wins.length / n : 0;

    const grossWins   = wins.reduce((acc, s) => acc + parseFloat(s.pnl_usd || 0), 0);
    const grossLosses = Math.abs(losses.reduce((acc, s) => acc + parseFloat(s.pnl_usd || 0), 0));
    const avgWin  = wins.length   > 0 ? grossWins   / wins.length   : 0;
    const avgLoss = losses.length > 0 ? grossLosses / losses.length : 0;
    const expectancy = wr * avgWin - (1 - wr) * avgLoss;
    const pf = grossLosses > 0 ? grossWins / grossLosses : (grossWins > 0 ? 999 : 0);
    // Kelly: WR - (1-WR)/WL_ratio
    const wlRatio = avgLoss > 0 ? avgWin / avgLoss : 0;
    const kelly   = wlRatio > 0 ? (wr - (1 - wr) / wlRatio) * 100 : 0;

    // Last 20 bets expectancy
    const last20 = closedBets.slice(-20);
    const l20w   = last20.filter(s => s.correct === true);
    const l20l   = last20.filter(s => s.correct === false);
    const l20n   = last20.length;
    const l20wr  = l20n > 0 ? l20w.length / l20n : 0;
    const l20aw  = l20w.length > 0 ? l20w.reduce((a, s) => a + parseFloat(s.pnl_usd || 0), 0) / l20w.length : 0;
    const l20al  = l20l.length > 0 ? Math.abs(l20l.reduce((a, s) => a + parseFloat(s.pnl_usd || 0), 0)) / l20l.length : 0;
    const l20exp = l20wr * l20aw - (1 - l20wr) * l20al;

    // Direction breakdown
    const upBets   = closedBets.filter(s => s.direction === 'UP');
    const downBets = closedBets.filter(s => s.direction === 'DOWN');
    const upWins   = upBets.filter(s => s.correct === true).length;
    const downWins = downBets.filter(s => s.correct === true).length;
    const upWr     = upBets.length   > 0 ? upWins   / upBets.length   : 0;
    const downWr   = downBets.length > 0 ? downWins / downBets.length : 0;
    const upPnl    = upBets.reduce((a, s) => a + parseFloat(s.pnl_usd || 0), 0);
    const downPnl  = downBets.reduce((a, s) => a + parseFloat(s.pnl_usd || 0), 0);

    // Render KPI row
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    const setHtml = (id, val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; };
    const fmtE = v => (v >= 0 ? '+' : '') + '$' + Math.abs(v).toFixed(3);

    set('exp-expectancy',   fmtE(expectancy));
    const expEl = document.getElementById('exp-expectancy');
    if (expEl) expEl.className = 'kpi-value ' + (expectancy >= 0 ? 'green' : 'red');

    set('exp-profitFactor', pf >= 999 ? '∞' : pf.toFixed(2));
    set('exp-kelly',        (kelly > 0 ? kelly.toFixed(1) : '0.0') + '%');
    set('exp-winRate',      (wr * 100).toFixed(1) + '%');
    set('exp-winRateSub',   n + ' closed bets');

    // Verdict badge
    const badge = document.getElementById('exp-verdictBadge');
    if (badge) {
      if (expectancy > 0.05)       { badge.className = 'panel-tag tag-green'; badge.textContent = 'POSITIVE EV'; }
      else if (expectancy >= -0.01){ badge.className = 'panel-tag tag-yellow'; badge.textContent = 'BREAK EVEN'; }
      else                         { badge.className = 'panel-tag tag-red';    badge.textContent = 'NEGATIVE EV'; }
    }

    // Breakdown
    set('exp-avgWin',     '$' + avgWin.toFixed(3));
    set('exp-avgLoss',    '$' + avgLoss.toFixed(3));
    set('exp-wlRatio',    wlRatio > 0 ? wlRatio.toFixed(2) + 'x' : '—');
    set('exp-totalBets',  n);
    set('exp-grossWins',  '$' + grossWins.toFixed(2));
    set('exp-grossLosses','$' + grossLosses.toFixed(2));

    // Direction
    set('exp-upWr',    (upWr * 100).toFixed(1) + '%');
    set('exp-upPnl',   (upPnl >= 0 ? '+' : '') + '$' + upPnl.toFixed(2));
    set('exp-upCount', upBets.length + ' bets');
    const upWrBadge = document.getElementById('exp-upWrBadge');
    if (upWrBadge) upWrBadge.textContent = (upWr * 100).toFixed(1) + '%';

    set('exp-downWr',    (downWr * 100).toFixed(1) + '%');
    set('exp-downPnl',   (downPnl >= 0 ? '+' : '') + '$' + downPnl.toFixed(2));
    set('exp-downCount', downBets.length + ' bets');
    const downWrBadge = document.getElementById('exp-downWrBadge');
    if (downWrBadge) downWrBadge.textContent = (downWr * 100).toFixed(1) + '%';

    // L20
    set('exp-l20', fmtE(l20exp));
    const l20El = document.getElementById('exp-l20');
    if (l20El) l20El.style.color = l20exp >= 0 ? 'var(--accent)' : 'var(--danger)';
    const l20Badge = document.getElementById('exp-l20Badge');
    if (l20Badge) {
      l20Badge.textContent = 'LAST 20: ' + fmtE(l20exp);
      l20Badge.className = 'panel-tag ' + (l20exp >= 0 ? 'tag-green' : 'tag-red');
    }

  } catch(e) {
    console.warn('fetchExpectancyTab error:', e);
  }
}

// ── AGENTS TAB ────────────────────────────────────────────────────────────────

// ── launchd tasks config ───────────────────────────────────────────────────
const LAUNCHD_TASKS = [
  { icon:'💓', name:'Health Monitor',  label:'com.btcbot.health',       schedule:'every_1h',   log:'/tmp/btcbot_health.log' },
  { icon:'📊', name:'Daily Report',    label:'com.btcbot.daily',         schedule:'daily_0700', log:'/tmp/btcbot_daily.log' },
  { icon:'📈', name:'Weekly Analysis', label:'com.btcbot.weekly',        schedule:'sun_0800',   log:'/tmp/btcbot_weekly.log' },
  { icon:'👁', name:'Bet Monitor',     label:'com.btcbot.monitor_bets',  schedule:'every_5m',   log:'/tmp/btcbot_monitor.log' },
  { icon:'🤖', name:'XGB Retrain',     label:'com.btcbot.xgb_retrain',   schedule:'sun_0300',   log:'/tmp/btcbot_xgb_retrain.log' },
];

function _launchdScheduleLabel(s) {
  return { every_5m:'Every 5min', every_1h:'Every 1h', daily_0700:'Daily 07:00 UTC+1', sun_0800:'Sun 08:00 UTC+1', sun_0300:'Sun 03:00 UTC+1' }[s] || s;
}

function _launchdNextRun(schedule) {
  const now = new Date();
  let next  = new Date(now);
  if (schedule === 'every_5m') {
    const ms = (5 - (now.getMinutes() % 5)) * 60000 - now.getSeconds() * 1000 - now.getMilliseconds();
    next = new Date(now.getTime() + ms);
  } else if (schedule === 'every_1h') {
    next.setMinutes(0, 0, 0);
    next = new Date(next.getTime() + 3600000);
  } else if (schedule === 'daily_0700') {
    next.setHours(7, 0, 0, 0);
    if (next <= now) next.setDate(next.getDate() + 1);
  } else if (schedule === 'sun_0800') {
    const d = (7 - now.getDay()) % 7 || 7;
    next.setDate(next.getDate() + d); next.setHours(8, 0, 0, 0);
  } else if (schedule === 'sun_0300') {
    const d = (7 - now.getDay()) % 7 || 7;
    next.setDate(next.getDate() + d); next.setHours(3, 0, 0, 0);
  }
  const diff = next - now;
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  const s = Math.floor((diff % 60000) / 1000);
  if (h > 47) return 'in ' + Math.ceil(h / 24) + 'd';
  if (h > 0)  return 'in ' + h + 'h ' + m + 'm';
  if (m > 0)  return 'in ' + m + 'm ' + s + 's';
  return 'in ' + s + 's';
}

function renderLaunchdTasks() {
  const tbody = document.getElementById('launchdBody');
  if (!tbody) return;
  tbody.innerHTML = LAUNCHD_TASKS.map(t => `
    <tr>
      <td><span style="margin-right:6px">${t.icon}</span>${t.name}</td>
      <td><code style="font-size:9px;color:var(--blue)">${t.label}</code></td>
      <td style="color:var(--muted);font-size:10px">${_launchdScheduleLabel(t.schedule)}</td>
      <td style="font-family:monospace;font-size:10px;color:var(--accent)" class="launchd-next" data-schedule="${t.schedule}">${_launchdNextRun(t.schedule)}</td>
      <td style="color:var(--muted);font-size:10px">${t.log}</td>
      <td><span class="badge badge-correct">ACTIVE</span></td>
    </tr>`).join('');
}

// Live countdown + clock for launchd
setInterval(() => {
  document.querySelectorAll('.launchd-next').forEach(el => {
    el.textContent = _launchdNextRun(el.dataset.schedule);
  });
  const clk = document.getElementById('launchdClock');
  if (clk) clk.textContent = new Date().toLocaleTimeString('it-IT');
}, 1000);

async function refreshAgentsTab() {
  const grid = document.getElementById('n8nWorkflowsGrid');
  grid.innerHTML = '<div style="grid-column:1/-1;padding:20px;color:var(--muted);font-size:11px;letter-spacing:1px">Loading n8n workflows<span class="loading">...</span></div>';
  renderLaunchdTasks();
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/n8n-status', { signal: AbortSignal.timeout(15000) });
    const data = res.ok ? await res.json() : null;
    renderAgents(data);
  } catch(e) {
    renderAgents(null, e.message);
  }
}

function _agentRelTime(iso) {
  if (!iso) return '—';
  const diff = Date.now() - new Date(iso).getTime();
  const s = Math.floor(diff / 1000);
  if (s < 60)  return s + 's ago';
  const m = Math.floor(s / 60);
  if (m < 60)  return m + 'm ago';
  const h = Math.floor(m / 60);
  if (h < 24)  return h + 'h ago';
  return Math.floor(h / 24) + 'd ago';
}

// Agent personality map — keyed on 2-digit workflow prefix
const _WF_META = {
  '01': { code: 'SIG', role: 'Signal Generator',  accent: '#00ff88' },
  '02': { code: 'TRD', role: 'Position Monitor',   accent: '#00aaff' },
  '03': { code: 'BAL', role: 'Balance Guardian',   accent: '#ffaa00' },
  '04': { code: 'LLM', role: 'LLM Analyst',        accent: '#aa66ff' },
  '05': { code: 'VRF', role: 'Result Auditor',     accent: '#00ff88' },
  '06': { code: 'MNT', role: 'System Janitor',     accent: '#4a6070' },
  '07': { code: 'CMD', role: 'Command Center',     accent: '#00ccff' },
  '08': { code: 'MON', role: 'Position Watchdog',  accent: '#ffaa00' },
};

function renderAgents(data, errorMsg) {
  const grid = document.getElementById('n8nWorkflowsGrid');
  if (!data || data.status !== 'ok') {
    const errDetail = errorMsg || (data && data.error) || 'Railway non raggiungibile';
    const hint = (data && data.error && data.error.includes('N8N_API_KEY'))
      ? '<br><span style="font-size:10px;color:var(--muted)">Configura <code style="color:var(--blue)">N8N_API_KEY</code> su Railway per abilitare questo pannello</span>'
      : '';
    grid.innerHTML = `<div style="grid-column:1/-1;padding:24px 16px;color:var(--danger);font-size:11px;letter-spacing:1px">⚠️ n8n status non disponibile: ${errDetail}${hint}</div>`;
    return;
  }
  const wfs = data.workflows || [];
  if (!wfs.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;padding:24px;color:var(--muted);font-size:11px">No workflows found</div>';
    return;
  }
  grid.innerHTML = wfs.map(wf => {
    const isActive     = wf.active;
    const lastEx       = wf.last_execution;
    const status       = lastEx?.status || null;
    const execHistory  = wf.exec_history || [];
    const successRate  = wf.success_rate;

    // Agent personality
    const prefix = (wf.name || '').substring(0, 2);
    const meta   = _WF_META[prefix] || { code: 'BOT', role: 'Automation Agent', accent: '#4a6070' };

    // Health color — use var(--accent) for success (var(--green) doesn't exist)
    let borderCol, dotCol, dotGlow;
    if (!isActive) {
      borderCol = '#2a2a2a'; dotCol = '#444'; dotGlow = '';
    } else if (status === 'success') {
      borderCol = meta.accent; dotCol = meta.accent; dotGlow = `0 0 6px ${meta.accent}88`;
    } else if (status === 'crashed' || status === 'error') {
      borderCol = 'var(--danger)'; dotCol = 'var(--danger)'; dotGlow = '0 0 6px var(--danger)';
    } else {
      borderCol = 'var(--warn)'; dotCol = 'var(--warn)'; dotGlow = '0 0 4px var(--warn)';
    }

    // Status badge
    let statusBadge = '<span style="font-size:9px;color:var(--muted)">—</span>';
    if (status === 'success')
      statusBadge = `<span class="panel-tag tag-green" style="font-size:8px;padding:2px 6px">✓ SUCCESS</span>`;
    else if (status === 'crashed')
      statusBadge = `<span class="panel-tag tag-red" style="font-size:8px;padding:2px 6px">⚡ CRASHED</span>`;
    else if (status === 'error')
      statusBadge = `<span class="panel-tag tag-red" style="font-size:8px;padding:2px 6px">✗ ERROR</span>`;
    else if (status)
      statusBadge = `<span class="panel-tag tag-yellow" style="font-size:8px;padding:2px 6px">${status.toUpperCase()}</span>`;

    // Sparkline — last 5 executions as colored squares (fixed: use #00ff88 not var(--green))
    let sparkline = '';
    if (execHistory.length) {
      const dots = execHistory.map(s => {
        const col = s === 'success' ? '#00ff88' : (s === 'crashed' || s === 'error') ? 'var(--danger)' : '#2a3a4a';
        return `<span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${col};box-shadow:${s==='success'?'0 0 4px rgba(0,255,136,0.4)':'none'}" title="${s}"></span>`;
      }).join('');
      const srLabel = successRate != null
        ? `<span style="font-size:9px;color:${successRate>=80?'#00ff88':successRate>=50?'var(--warn)':'var(--danger)'};">${successRate}%</span>`
        : '';
      sparkline = `<div style="display:flex;gap:3px;align-items:center;margin-top:8px">${dots}${srLabel ? '<span style="margin-left:5px">'+srLabel+'</span>' : ''}</div>`;
    }

    const relT = lastEx?.started_at ? _agentRelTime(lastEx.started_at) : 'No executions';
    const absT = lastEx?.started_at ? new Date(lastEx.started_at).toLocaleString('it-IT') : '';

    return `
    <div class="wf-card" style="border-left:3px solid ${borderCol};padding-left:12px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <div style="display:flex;align-items:center;gap:7px;min-width:0">
          <span style="width:7px;height:7px;border-radius:50%;background:${dotCol};box-shadow:${dotGlow};flex-shrink:0"></span>
          <div class="wf-card-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${wf.name || '—'}</div>
        </div>
        <span class="panel-tag ${isActive ? 'tag-green' : 'tag-muted'}" style="flex-shrink:0;font-size:8px">${isActive ? 'ACTIVE' : 'INACTIVE'}</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:5px">
        <span style="font-size:6px;font-weight:800;letter-spacing:1px;color:${meta.accent};background:${meta.accent}18;border:1px solid ${meta.accent}35;padding:2px 5px;border-radius:2px">${meta.code}</span>
        <span style="font-size:8px;color:var(--muted);letter-spacing:0.5px">${meta.role}</span>
      </div>
      <div class="wf-card-id" style="margin-top:4px">${wf.id}</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        ${statusBadge}
        <span style="font-size:10px;color:var(--muted);cursor:default" title="${absT}">${relT}</span>
      </div>
      ${sparkline}
    </div>`;
  }).join('');
}


// ── Backtest report syntax highlighting ──────────────────────────────────────
function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function syntaxHighlight(text) {
  return text.split('\n').map(line => {
    // Decorator lines (ASCII box-drawing) — near-invisible border color
    if (/[═─╔╚╗╝║╠╣╦╩╬]/.test(line)) {
      return `<span style="color:#1e2d3d">${line}</span>`;
    }
    // Trophy / star / "Miglior" lines — gold bold
    if (/[🏆★]|Miglior/.test(line)) {
      return `<span style="color:#ffbb00;font-weight:700">${line}</span>`;
    }
    // Section headers like [1/5] [2/5] etc.
    if (/\[\d+\/\d+\]/.test(line)) {
      return `<span style="color:#00aaff">${line}</span>`;
    }
    // Win / positive lines
    if (/\+|\bWIN\b|▲|%\]/.test(line)) {
      return `<span style="color:#00ff88">${line}</span>`;
    }
    // Loss / error / negative lines
    if (/-\$|\bLOSS\b|\bERROR\b|⚠/.test(line)) {
      return `<span style="color:#ff4466">${line}</span>`;
    }
    // Lines containing percentage numbers — yellow
    if (/\d+(\.\d+)?%/.test(line)) {
      return `<span style="color:#ffaa00">${line}</span>`;
    }
    return line;
  }).join('\n');
}

async function fetchBacktestReport() {
  // ── Text reports (raw) ──────────────────────────────────────────────────
  const preBT   = document.getElementById('backtestReportPre');
  const badgeBT = document.getElementById('backtestBadge');
  const preXGB  = document.getElementById('xgbReportPre');
  const badgeXGB = document.getElementById('xgbBadge');

  Promise.all([
    fetch(CONFIG.RAILWAY_URL + '/backtest-report', { signal: AbortSignal.timeout(8000) }).then(r => r.ok ? r.json() : null).catch(() => null),
    fetch(CONFIG.RAILWAY_URL + '/xgb-report',      { signal: AbortSignal.timeout(8000) }).then(r => r.ok ? r.json() : null).catch(() => null),
    fetch(CONFIG.RAILWAY_URL + '/backtest-data',   { signal: AbortSignal.timeout(8000) }).then(r => r.ok ? r.json() : null).catch(() => null),
  ]).then(([btTxt, xgbTxt, btData]) => {
    if (btTxt)  { preBT.innerHTML = syntaxHighlight(escapeHtml(btTxt.report || 'Vuoto.')); badgeBT.textContent = btTxt.lines + ' righe'; }
    else          preBT.textContent = 'Report non disponibile.';
    if (xgbTxt) { preXGB.innerHTML = syntaxHighlight(escapeHtml(xgbTxt.report || 'Vuoto.')); badgeXGB.textContent = xgbTxt.lines + ' righe'; }
    else          preXGB.textContent = 'Report non disponibile.';

    if (btData) renderBacktestDashboard(btData);
  });
}

// ── Backtest dashboard rendering ─────────────────────────────────────────────

const BT_COLORS = {
  A_BASELINE:  '#555',
  B_CONF_062:  '#4a90d9',
  C_CONF_065:  '#7ec8a4',
  D_DEAD_HOURS:'#e6b86a',
  E_XGB_GATE:  '#c97cd9',
  F_FULL_STACK:'#e06b6b',
};

function renderBacktestDashboard(d) {
  const strats = d.strategies || {};
  const best   = d.best_strategy;
  const curr   = 'F_FULL_STACK';
  const bestR  = strats[best]  || {};
  const currR  = strats[curr]  || {};

  // ── KPIs ───────────────────────────────────────────────────────────────
  const pnlCol = v => v >= 0 ? 'var(--accent)' : 'var(--danger)';
  const fmtPnl = v => (v >= 0 ? '+' : '') + '$' + Number(v).toFixed(4);

  _bt('btKpiBest',    best?.replace(/^[A-Z]_/, '') || '—');
  _bt('btKpiBestPnl', fmtPnl(bestR.pnl || 0), pnlCol(bestR.pnl || 0));
  _bt('btKpiCurrent', currR.wr != null ? currR.wr + '% WR' : '—');
  _bt('btKpiCurrentPnl', fmtPnl(currR.pnl || 0), pnlCol(currR.pnl || 0));
  _bt('btKpiWR',      d.test_wr != null ? d.test_wr + '%' : '—');
  _bt('btKpiWRSub',   `${d.test_n} bet test`);
  _bt('btKpiPF',      bestR.profit_factor != null ? bestR.profit_factor.toFixed(2) : '—');
  _bt('btKpiXgb',     d.xgb_cv_acc ? (d.xgb_cv_acc * 100).toFixed(1) + '%' : '—');
  _bt('btKpiXgbSub',  `${d.train_n} bet train`);
  const sk = d.streaks || {};
  _bt('btKpiStreak',  sk.max_win_streak != null ? `×${sk.max_win_streak}W` : '—');
  _bt('btKpiStreakSub', sk.max_loss_streak != null ? `max ${sk.max_loss_streak}L consec.` : 'W / L');

  // ── Strategy table ─────────────────────────────────────────────────────
  const tbody = document.getElementById('btStratBody');
  if (tbody) {
    tbody.innerHTML = Object.entries(strats).map(([name, r]) => {
      const isCurr = name === curr;
      const isBest = name === best;
      const bg = isCurr ? 'background:rgba(224,107,107,0.07)' : (isBest ? 'background:rgba(126,200,164,0.07)' : '');
      const pnlC = pnlCol(r.pnl);
      const badge = isCurr ? '<span class="badge badge-wrong" style="font-size:8px;margin-left:4px">LIVE</span>'
                            : (isBest ? '<span class="badge badge-correct" style="font-size:8px;margin-left:4px">BEST</span>' : '');
      const dot = `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${BT_COLORS[name]||'#555'};margin-right:6px"></span>`;
      return `<tr style="${bg}">
        <td style="padding:6px 8px;font-size:11px">${dot}${name.replace(/^[A-Z]_/,'')}${badge}</td>
        <td style="text-align:right;padding:6px 8px">${r.n}</td>
        <td style="text-align:right;padding:6px 8px">${r.wr}%</td>
        <td style="text-align:right;padding:6px 8px;color:${pnlC}">${fmtPnl(r.pnl)}</td>
        <td style="text-align:right;padding:6px 8px;color:${pnlCol(r.pnl_per_bet)}">${fmtPnl(r.pnl_per_bet)}</td>
        <td style="text-align:right;padding:6px 8px;color:var(--danger)">-$${r.max_dd?.toFixed(4)||'—'}</td>
        <td style="text-align:right;padding:6px 8px;color:${r.profit_factor>=1.5?'var(--accent)':r.profit_factor<1?'var(--danger)':'inherit'}">${r.profit_factor?.toFixed(2)||'—'}</td>
        <td style="text-align:right;padding:6px 8px">${r.sortino?.toFixed(2)||'—'}</td>
        <td style="text-align:right;padding:6px 8px">${r.sharpe?.toFixed(2)||'—'}</td>
      </tr>`;
    }).join('');
  }

  // ── Equity curves SVG ──────────────────────────────────────────────────
  const curves   = d.equity_curves || {};
  const allVals  = Object.values(curves).flat();
  if (allVals.length) {
    const minV = Math.min(0, ...allVals);
    const maxV = Math.max(0, ...allVals);
    const range = maxV - minV || 1;
    const svg = document.getElementById('btEquitySvg');
    const legend = document.getElementById('btEquityLegend');
    if (svg) {
      const W = svg.parentElement?.clientWidth || 600;
      const H = 200;
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      let svgHtml = '';

      // zero line
      const zy = H - ((0 - minV) / range * (H - 20)) - 10;
      svgHtml += `<line x1="0" y1="${zy.toFixed(1)}" x2="${W}" y2="${zy.toFixed(1)}" stroke="#333" stroke-width="1" stroke-dasharray="3,3"/>`;

      Object.entries(curves).forEach(([name, pts]) => {
        if (!pts || pts.length < 2) return;
        const col = BT_COLORS[name] || '#555';
        const n   = pts.length - 1;
        const coords = pts.map((v, i) => {
          const x = (i / n * (W - 20) + 10).toFixed(1);
          const y = (H - ((v - minV) / range * (H - 20)) - 10).toFixed(1);
          return `${x},${y}`;
        });
        const isCurr = name === curr;
        const isBest = name === best;
        const sw = isCurr || isBest ? '2' : '1';
        const op = isCurr || isBest ? '1' : '0.4';
        svgHtml += `<polyline points="${coords.join(' ')}" fill="none" stroke="${col}" stroke-width="${sw}" opacity="${op}" stroke-linejoin="round"/>`;
        // end dot
        const lastX = (W - 10).toFixed(1);
        const lastY = (H - ((pts[pts.length-1] - minV) / range * (H-20)) - 10).toFixed(1);
        svgHtml += `<circle cx="${lastX}" cy="${lastY}" r="3" fill="${col}" opacity="${op}"/>`;
      });

      // Y axis labels
      [minV, 0, maxV].forEach(v => {
        const y = (H - ((v - minV) / range * (H - 20)) - 10).toFixed(1);
        svgHtml += `<text x="4" y="${(parseFloat(y)+3).toFixed(1)}" fill="#555" font-size="9">${v >= 0 ? '+' : ''}$${v.toFixed(2)}</text>`;
      });

      svg.innerHTML = svgHtml;
    }
    if (legend) {
      legend.innerHTML = Object.entries(BT_COLORS).map(([name, col]) => {
        const r = strats[name];
        if (!r) return '';
        const pnl = r.pnl >= 0 ? `+$${r.pnl.toFixed(2)}` : `-$${Math.abs(r.pnl).toFixed(2)}`;
        return `<span style="display:flex;align-items:center;gap:4px">
          <span style="width:20px;height:2px;background:${col};display:inline-block"></span>
          <span style="color:#aaa">${name.replace(/^[A-Z]_/,'')} <span style="color:${pnlCol(r.pnl)}">${pnl}</span></span>
        </span>`;
      }).join('');
    }
  }

  // ── Confidence calibration ─────────────────────────────────────────────
  const calibBody = document.getElementById('btCalibBody');
  if (calibBody && d.confidence_buckets) {
    calibBody.innerHTML = d.confidence_buckets.map(b => {
      const deltaCol = b.delta >= 5 ? 'var(--accent)' : b.delta <= -5 ? 'var(--danger)' : 'var(--muted)';
      const deltaStr = (b.delta >= 0 ? '+' : '') + b.delta.toFixed(1) + '%';
      const ppb = b.pnl_per_bet;
      const ppbCol = ppb >= 0 ? 'var(--accent)' : 'var(--danger)';
      const ppbStr = ppb != null ? (ppb >= 0 ? '+' : '') + '$' + ppb.toFixed(3) : '—';
      return `<tr>
        <td style="padding:4px 6px;font-size:11px;font-family:monospace">${b.bucket}</td>
        <td style="text-align:right;padding:4px 6px">${b.n}</td>
        <td style="text-align:right;padding:4px 6px;color:var(--muted)">${b.exp_wr?.toFixed(1)}%</td>
        <td style="text-align:right;padding:4px 6px">${b.act_wr?.toFixed(1)}%</td>
        <td style="text-align:right;padding:4px 6px;color:${deltaCol}">${deltaStr}</td>
        <td style="text-align:right;padding:4px 6px;color:${ppbCol};font-size:10px">${ppbStr}</td>
      </tr>`;
    }).join('');
  }

  // ── 24h heatmap ────────────────────────────────────────────────────────
  const heatmap = document.getElementById('btHeatmap');
  if (heatmap && d.hourly) {
    heatmap.innerHTML = d.hourly.map(h => {
      let bg, label, title;
      if (h.n === 0) {
        bg = '#1a1a1a'; label = `${h.hour}h`; title = 'no data';
      } else if (h.is_dead) {
        bg = 'rgba(224,107,107,0.35)'; label = `${h.hour}h\n${h.wr}%`; title = `${h.hour}h — DEAD (${h.wr}% WR, n=${h.n})`;
      } else if (h.is_hot) {
        bg = 'rgba(126,200,164,0.35)'; label = `${h.hour}h\n${h.wr}%`; title = `${h.hour}h — HOT (${h.wr}% WR, n=${h.n})`;
      } else {
        const wr = h.wr || 50;
        const intensity = Math.max(0, Math.min(1, (wr - 40) / 30));
        bg = `rgba(74,144,217,${(intensity * 0.4).toFixed(2)})`; label = `${h.hour}h\n${h.wr}%`; title = `${h.hour}h — ${h.wr}% WR (n=${h.n})`;
      }
      const lowMark = h.low_sample ? '*' : '';
      const lines = label.split('\n');
      const pnlStr = h.n > 0 ? (h.pnl >= 0 ? '+' : '') + '$' + h.pnl.toFixed(2) : '';
      const pnlC = h.pnl >= 0 ? 'var(--accent)' : 'var(--danger)';
      return `<div title="${title}" style="background:${bg};border-radius:4px;padding:5px 3px;text-align:center;font-size:9px;line-height:1.3;cursor:default">
        <div style="color:#aaa">${lines[0]}${lowMark}</div>
        ${lines[1] ? `<div style="color:#eee;font-weight:600">${lines[1]}</div>` : ''}
        ${pnlStr ? `<div style="color:${pnlC};font-size:8px;opacity:0.8">${pnlStr}</div>` : ''}
      </div>`;
    }).join('');
  }
}

function _bt(id, text, color) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = text;
  if (color) el.style.color = color;
}


// -- EQUITY HISTORY (real data from /equity-history) --------------------------

async function fetchEquityHistory() {
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/equity-history', { signal: AbortSignal.timeout(8000) });
    if (!res.ok) return;
    const d = await res.json();
    if (!d.history || d.history.length === 0) return;
    const svg = document.getElementById('equitySvg');
    const tag = document.getElementById('equityTag');
    if (!svg) return;
    const capitalBase = d.capital_base || 100;
    const pts = [{ v: capitalBase }];
    d.history.forEach(row => pts.push({ v: row.equity }));
    const totalPnl = d.final_equity - capitalBase;
    const minV  = Math.min(...pts.map(p => p.v));
    const maxV  = Math.max(...pts.map(p => p.v));
    const range = maxV - minV || 0.001;
    const W = 1000, H = 100;
    const toX = i => (i / (pts.length - 1)) * W;
    const toY = v => H - ((v - minV) / range) * (H - 10) - 5;
    const polyPts   = pts.map((p, i) => toX(i).toFixed(1) + ',' + toY(p.v).toFixed(1)).join(' ');
    const areaClose = toX(pts.length - 1).toFixed(1) + ',' + H + ' 0,' + H;
    const color  = totalPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
    const gradId = totalPnl >= 0 ? 'eqGH' : 'eqGHR';
    svg.innerHTML =
      '<defs><linearGradient id="' + gradId + '" x1="0" y1="0" x2="0" y2="1">' +
      '<stop offset="0%" stop-color="' + color + '" stop-opacity="0.3"/>' +
      '<stop offset="100%" stop-color="' + color + '" stop-opacity="0"/>' +
      '</linearGradient></defs>' +
      '<polygon points="' + polyPts + ' ' + areaClose + '" fill="url(#' + gradId + ')"/>' +
      '<polyline points="' + polyPts + '" fill="none" stroke="' + color + '" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>' +
      '<circle cx="' + toX(pts.length-1).toFixed(1) + '" cy="' + toY(pts[pts.length-1].v).toFixed(1) + '" r="3.5" fill="' + color + '"/>';
    if (tag) {
      tag.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2) + ' (' + d.count + ' bets)';
      tag.className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');
    }
  } catch(e) { /* fallback silenzioso */ }
}

// ── TRADING STATS ─────────────────────────────────────────────────────────────

async function fetchTradingStats() {
  const badge = document.getElementById('tsVerdictBadge');
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/trading-stats', { signal: AbortSignal.timeout(8000) });
    if (!res.ok) { if (badge) badge.textContent = 'ERR'; return; }
    const d = await res.json();
    if (!d || !d.data) { if (badge) badge.textContent = 'N/A'; return; }
    const s = d.data;

    const fmtUsd = (v) => {
      if (v == null) return '—';
      const n = parseFloat(v);
      return (n >= 0 ? '+$' : '-$') + Math.abs(n).toFixed(3);
    };
    const fmtPct = (v) => v != null ? parseFloat(v).toFixed(1) + '%' : '—';
    const colorSign = (v) => v != null && parseFloat(v) >= 0 ? 'var(--accent)' : 'var(--danger)';

    // Expectancy
    const expEl = document.getElementById('tsExpectancy');
    if (expEl) {
      expEl.textContent = fmtUsd(s.expectancy_usd);
      expEl.style.color = colorSign(s.expectancy_usd);
    }

    // Expectancy last 20
    const expL20El = document.getElementById('tsExpectancyL20');
    if (expL20El) {
      expL20El.textContent = fmtUsd(s.expectancy_last20_usd);
      expL20El.style.color = colorSign(s.expectancy_last20_usd);
    }

    // Avg Win / Avg Loss ratio
    const ratioEl = document.getElementById('tsWinLossRatio');
    if (ratioEl) {
      const aw = parseFloat(s.avg_win_usd ?? 0);
      const al = Math.abs(parseFloat(s.avg_loss_usd ?? 1));
      const ratio = al > 0 ? (aw / al).toFixed(2) + 'x' : '—';
      ratioEl.textContent = ratio;
    }

    // UP bets
    const upWrEl = document.getElementById('tsUpWr');
    const upPnlEl = document.getElementById('tsUpPnl');
    if (upWrEl) { upWrEl.textContent = fmtPct(s.up_win_rate); }
    if (upPnlEl) {
      const upPnl = parseFloat(s.up_pnl_usd ?? 0);
      upPnlEl.textContent = 'PnL: ' + fmtUsd(s.up_pnl_usd);
      upPnlEl.style.color = upPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
    }

    // DOWN bets
    const dnWrEl = document.getElementById('tsDownWr');
    const dnPnlEl = document.getElementById('tsDownPnl');
    if (dnWrEl) { dnWrEl.textContent = fmtPct(s.down_win_rate); }
    if (dnPnlEl) {
      const dnPnl = parseFloat(s.down_pnl_usd ?? 0);
      dnPnlEl.textContent = 'PnL: ' + fmtUsd(s.down_pnl_usd);
      dnPnlEl.style.color = dnPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
    }

    // Avg PnL per bet
    const avgPnlEl = document.getElementById('tsAvgPnl');
    const avgPnlSubEl = document.getElementById('tsAvgPnlSub');
    if (avgPnlEl) {
      avgPnlEl.textContent = fmtUsd(s.avg_pnl_per_bet);
      avgPnlEl.style.color = colorSign(s.avg_pnl_per_bet);
    }
    if (avgPnlSubEl) {
      avgPnlSubEl.textContent = 'wins: ' + fmtUsd(s.avg_win_usd) + ' / losses: ' + fmtUsd(s.avg_loss_usd);
    }

    // Verdict badge
    if (badge) {
      const verdict = (s.expectancy_verdict || '').toUpperCase();
      badge.textContent = verdict || 'N/A';
      if (verdict.includes('POSITIVO') || verdict.includes('POSITIVE')) {
        badge.className = 'panel-tag tag-green';
      } else if (verdict.includes('NEGATIVO') || verdict.includes('NEGATIVE')) {
        badge.className = 'panel-tag tag-red';
      } else {
        badge.className = 'panel-tag tag-yellow';
      }
    }
  } catch(e) {
    if (badge) badge.textContent = 'ERR';
  }
}

// ── HOURLY WR HEATMAP ───────────────────────────────────────────────────────

async function fetchErrorPatterns() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/error-patterns`, { signal: AbortSignal.timeout(8000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const d = await res.json();
    renderHourlyHeatmap(d);
  } catch(e) { console.warn('fetchErrorPatterns error:', e); }
}

function renderHourlyHeatmap(d) {
  const grid = document.getElementById('hourlyHeatmapGrid');
  const tag  = document.getElementById('heatmapTag');
  if (!grid) return;

  // Build hour map from all_patterns where type === 'hour'
  const hourMap = {};
  (d.all_patterns || []).filter(p => p.type === 'hour').forEach(p => {
    const h = parseInt(p.label.match(/\d+/)?.[0] ?? '-1');
    if (h >= 0) hourMap[h] = p;
  });

  grid.innerHTML = '';
  for (let h = 0; h < 24; h++) {
    const p = hourMap[h];
    const hasData = p && p.n >= 5;
    const wr = hasData ? p.wr : null;
    let bg = 'rgba(255,255,255,0.03)';
    let color = 'var(--muted)';
    let borderColor = 'var(--border)';
    if (hasData) {
      if (wr > 0.55)      { bg = 'rgba(0,255,136,0.10)'; color = 'var(--accent)'; borderColor = 'rgba(0,255,136,0.3)'; }
      else if (wr < 0.45) { bg = 'rgba(255,68,102,0.10)'; color = 'var(--danger)'; borderColor = 'rgba(255,68,102,0.3)'; }
    }
    const cell = document.createElement('div');
    cell.style.cssText = `background:${bg};border:1px solid ${borderColor};padding:6px 4px;text-align:center;border-radius:2px;`;
    cell.innerHTML = `<div style="font-size:8px;color:var(--muted);letter-spacing:1px;">${String(h).padStart(2,'0')}h</div>
      <div style="font-size:10px;font-weight:700;color:${color};margin-top:2px;">${hasData ? Math.round(wr*100)+'%' : '\u2014'}</div>
      ${hasData ? `<div style="font-size:7px;color:var(--muted);">${p.n}n</div>` : ''}`;
    if (hasData) cell.title = `${p.label}: WR ${p.wr_pct}% on ${p.n} bets, PnL $${p.pnl?.toFixed(2)}`;
    grid.appendChild(cell);
  }

  if (tag) {
    const total = d.total_bets || 0;
    tag.textContent = total + ' BETS';
    tag.className = 'panel-tag tag-blue';
  }
}

// Start everything
refresh();
setInterval(refresh, CONFIG.REFRESH_INTERVAL);

fetchLiveBtcPrice();
setInterval(fetchLiveBtcPrice, CONFIG.BTC_REFRESH);

refreshAccountSummary();
setInterval(refreshAccountSummary, CONFIG.ACCT_REFRESH);

fetchEquityHistory();
fetchTradingStats();
fetchErrorPatterns();
fetchTrainingStatus();
fetchBotAlerts();

// ── TRAINING STATUS ────────────────────────────────────────────────────────────

async function fetchTrainingStatus() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/training-status`, { signal: AbortSignal.timeout(10000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const d = await res.json();

    // Status pill
    const pill = document.getElementById('trainStatusPill');
    const txt  = document.getElementById('trainStatusText');
    if (pill && txt) {
      const s = (d.status || '').toLowerCase();
      pill.className = 'train-status-pill ' + s;
      txt.textContent = s === 'recent' ? 'FRESH' : s === 'on_track' ? 'ON TRACK' : 'RETRAIN READY';
    }

    // Bets since + progress bar
    const bets  = d.bets_since_retrain ?? 0;
    const thr   = d.retrain_threshold  ?? 30;
    const pct   = Math.min(100, Math.round(bets / thr * 100));
    const el = document.getElementById('trainBetsSince');
    if (el) el.textContent = bets !== null ? bets : '—';
    const thrEl = document.getElementById('trainBetsThreshold');
    if (thrEl) thrEl.textContent = '/ ' + thr + ' target';
    const fill = document.getElementById('trainProgressFill');
    if (fill) fill.style.width = pct + '%';
    if (pct >= 100) fill.style.background = 'var(--warn)';
    const lbl = document.getElementById('trainProgressLabel');
    if (lbl) lbl.textContent = pct + '% toward next meaningful retrain';

    // Direction accuracy
    const accEl = document.getElementById('trainDirAcc');
    if (accEl) accEl.textContent = d.direction_acc ? d.direction_acc.toFixed(1) + '%' : '—';
    const nEl = document.getElementById('trainTrainN');
    if (nEl) nEl.textContent = d.train_n ? d.train_n + ' signals in dataset' : '—';

    // Dates
    const lastEl = document.getElementById('trainLastDate');
    if (lastEl) lastEl.textContent = d.last_retrain_iso || '—';
    const agoEl = document.getElementById('trainDaysAgo');
    if (agoEl) agoEl.textContent = d.days_since_retrain !== null ? d.days_since_retrain + ' days ago' : '';
    const nextEl = document.getElementById('trainNextDate');
    if (nextEl) nextEl.textContent = d.next_retrain_iso || '—';
  } catch(e) {
    console.warn('fetchTrainingStatus error:', e);
  }
}

// ── BOT ALERTS ────────────────────────────────────────────────────────────────

async function fetchBotAlerts() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/check-status`, { signal: AbortSignal.timeout(8000) });
    if (!res.ok) return;
    const d = await res.json();
    const banner = document.getElementById('botAlertBanner');
    const msg    = document.getElementById('botAlertMsg');
    if (!banner || !msg) return;
    if (d.alert) {
      const openBets  = d.open_bets_supabase || 0;
      const wf02Active = d.wf02_active;
      let detail = d.alert;
      if (!wf02Active && openBets > 0) {
        detail = openBets + ' bet' + (openBets > 1 ? 's' : '') + ' aperta/e senza monitoraggio wf02 — rescue consigliato';
      }
      msg.textContent = detail;
      banner.classList.add('visible');
    } else {
      banner.classList.remove('visible');
    }
  } catch(e) { /* silent */ }
}

// Populate training tab with same /training-status data
function renderTrainingTab(d) {
  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  const bets = d.bets_since_retrain ?? 0;
  const thr  = d.retrain_threshold ?? 30;
  const pct  = Math.min(100, Math.round(bets / thr * 100));

  // CV Accuracy + bar
  const acc = d.direction_acc ?? null;
  set('trn-dirAcc', acc !== null ? acc.toFixed(1) + '%' : '—');
  const accBar = document.getElementById('trn-accBarFill');
  if (accBar) {
    const accPct = acc !== null ? Math.min(100, acc) : 0;
    accBar.style.width = accPct + '%';
    accBar.style.background = accPct >= 70 ? 'var(--accent)' : accPct >= 55 ? 'var(--warn)' : 'var(--danger)';
  }
  set('trn-trainN',  d.train_n ? d.train_n + ' signals' : '—');

  // Progress bar
  set('trn-betsSince', bets !== null ? bets + ' / ' + thr : '—');
  set('trn-betsThr', '/ ' + thr + ' new bets');
  const fill = document.getElementById('trn-progressFill');
  if (fill) { fill.style.width = pct + '%'; fill.style.background = pct >= 100 ? 'var(--warn)' : 'var(--accent)'; }
  set('trn-progressLabel', pct + '% — ' + bets + ' of ' + thr + ' new bets');

  // Dates
  set('trn-lastDate', d.last_retrain_iso || '—');
  set('trn-daysAgo',  d.days_since_retrain !== null ? d.days_since_retrain + ' days ago' : '');
  set('trn-nextDate', d.next_retrain_iso || '—');

  // State badge (trn-stateBadge) with color classes: trained / stale / error
  const badge = document.getElementById('trn-stateBadge');
  const txt   = document.getElementById('trn-statusText');
  if (badge && txt) {
    const s = (d.status || '').toLowerCase();
    // Map internal statuses → badge class + label
    let cls, label;
    if (s === 'recent') {
      cls = 'trained'; label = 'TRAINED';
    } else if (s === 'on_track') {
      cls = 'trained'; label = 'ON TRACK';
    } else if (s === 'retrain_ready') {
      cls = 'stale';   label = 'STALE';
    } else if (s === 'error') {
      cls = 'error';   label = 'ERROR';
    } else {
      cls = 'stale';   label = s.toUpperCase() || 'UNKNOWN';
    }
    badge.className = 'trn-badge ' + cls;
    txt.textContent = label;
  }
  // Keep legacy pill hidden but keep its status class for fetchTrainingStatus compatibility
  const pill = document.getElementById('trn-statusPill');
  if (pill) {
    const s = (d.status || '').toLowerCase();
    pill.className = 'train-status-pill ' + s;
  }

  // Config
  set('trn-confThr',  d.confidence_threshold != null ? d.confidence_threshold.toFixed(2) : '0.65');
  set('trn-baseSize', d.base_size_btc != null ? d.base_size_btc + ' BTC' : '0.002 BTC');
  const xgbEl = document.getElementById('trn-xgbStatus');
  const corrEl = document.getElementById('trn-corrStatus');
  if (xgbEl)  { xgbEl.textContent = d.xgb_loaded != null ? (d.xgb_loaded ? '✅ Loaded' : '❌ Missing') : '—'; xgbEl.style.color = d.xgb_loaded ? 'var(--accent)' : 'var(--danger)'; }
  if (corrEl) { corrEl.textContent = d.correctness_loaded != null ? (d.correctness_loaded ? '✅ Loaded' : '❌ Missing') : '—'; corrEl.style.color = d.correctness_loaded ? 'var(--accent)' : 'var(--danger)'; }
  const deadEl = document.getElementById('trn-deadHours');
  if (deadEl) deadEl.textContent = Array.isArray(d.dead_hours) && d.dead_hours.length ? d.dead_hours.map(h => h + 'h').join(' · ') : 'none';
}

// Force Retrain button handler
async function trnForceRetrain() {
  const btn = document.querySelector('.trn-retrain-btn');
  if (btn) { btn.textContent = '⏳ Reloading...'; btn.disabled = true; }
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/reload-calibration', { method: 'POST', signal: AbortSignal.timeout(15000) });
    const msg = res.ok ? '✅ Calibration reloaded!' : '⚠️ Error ' + res.status;
    alert(msg);
    if (res.ok) await fetchTrainingTab();
  } catch(e) {
    alert('⚠️ Request failed: ' + e.message);
  } finally {
    if (btn) { btn.innerHTML = '&#8635; Force Retrain'; btn.disabled = false; }
  }
}

async function fetchTrainingTab() {
  try {
    const [tsRes, btRes, xgbRes] = await Promise.allSettled([
      fetch(`${CONFIG.RAILWAY_URL}/training-status`, { signal: AbortSignal.timeout(10000) }),
      fetch(`${CONFIG.RAILWAY_URL}/backtest-report`, { signal: AbortSignal.timeout(10000) }),
    ]);
    if (tsRes.status === 'fulfilled' && tsRes.value.ok) {
      const d = await tsRes.value.json();
      renderTrainingTab(d);
      // XGB report is in backtest-report response
      if (btRes.status === 'fulfilled' && btRes.value.ok) {
        const bt = await btRes.value.json();
        const xpre = document.getElementById('trn-xgbReport');
        if (xpre && bt.xgb_report) xpre.textContent = bt.xgb_report;
        const bpre = document.getElementById('trn-backtestReport');
        if (bpre && bt.backtest_report) bpre.textContent = bt.backtest_report;
      }
    }
  } catch(e) { console.warn('fetchTrainingTab error:', e); }
}

// Refresh training status every 5 minutes
setInterval(fetchTrainingStatus, 5 * 60 * 1000);
setInterval(fetchBotAlerts, 3 * 60 * 1000);

// ── COSTS TAB ─────────────────────────────────────────────────────────────────

async function refreshCostsTab() {
  const body = document.getElementById('costBreakdownBody');
  body.innerHTML = 'Loading<span class="loading">...</span>';
  ['costKpiTotalVal','costKpiKrakenVal','costKpiN8nVal','costKpiClaudeApiVal','costKpiClaudeCodeVal','costKpiRailwayVal'].forEach(id => {
    document.getElementById(id).textContent = '—';
  });
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/costs', { signal: AbortSignal.timeout(10000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    renderCosts(data);
  } catch(e) {
    body.innerHTML = `<span style="color:var(--danger);font-size:11px">⚠️ Errore: ${e.message}</span>`;
  }
}

function renderCosts(d) {
  const fmtUsd = v => '$' + (v ?? 0).toFixed(2);
  const ca = d.claude_api || {};
  const cc = d.claude_code || {};

  // KPI
  document.getElementById('costKpiTotalVal').textContent       = fmtUsd(d.total_usd);
  document.getElementById('costKpiTotalSub').textContent       = d.cached ? 'parz. cached' : 'live';
  document.getElementById('costKpiKrakenVal').textContent      = fmtUsd(d.kraken_fees?.total_usd);
  document.getElementById('costKpiKrakenSub').textContent      = `${d.kraken_fees?.trade_count ?? 0} trade · REALE`;
  document.getElementById('costKpiN8nVal').textContent         = (d.n8n?.pct_used ?? 0).toFixed(1) + '%';
  document.getElementById('costKpiN8nSub').textContent         = `${d.n8n?.executions_est ?? 0} / ${d.n8n?.limit ?? 2500} exec`;
  document.getElementById('costKpiClaudeApiVal').textContent   = fmtUsd(ca.cost_usd);
  document.getElementById('costKpiClaudeApiSub').textContent   = `${ca.monthly_calls ?? 0} call · ${ca.model ?? '—'}`.replace('claude-','').replace('-20251001','');
  document.getElementById('costKpiClaudeCodeVal').textContent  = cc.cost_usd > 0 ? fmtUsd(cc.cost_usd) : '—';
  document.getElementById('costKpiClaudeCodeSub').textContent  = cc.cost_usd > 0 ? 'impostato manualmente' : 'set CLAUDE_CODE_MONTHLY_USD';
  document.getElementById('costKpiRailwayVal').textContent     = fmtUsd(d.railway?.cost_usd);
  document.getElementById('costKpiRailwaySub').textContent     = `piano ${d.railway?.plan ?? '—'}`;

  // Breakdown table
  const total = d.total_usd || 1;
  const rows = [
    { name: 'Kraken Fees',    logo: 'KRK', sub: `${d.kraken_fees?.trade_count ?? 0} trade, avg ${fmtUsd(d.kraken_fees?.avg_per_trade)} ciascuno`,
      usd: d.kraken_fees?.total_usd ?? 0, type: 'REALE', color: '#ffaa00' },
    { name: 'n8n Plan',       logo: 'n8n', sub: `${d.n8n?.executions_est ?? 0} exec stimate · piano Starter`,
      usd: d.n8n?.cost_usd ?? 0,          type: 'PIANO', color: '#ff6b35' },
    { name: 'Claude API',     logo: 'CLA', sub: `${ca.monthly_calls ?? 0} call · ${(ca.avg_input_tokens ?? 0)/1000}k in + ${ca.avg_output_tokens ?? 0} out token`,
      usd: ca.cost_usd ?? 0,              type: 'REALE', color: '#aa66ff' },
    { name: 'Claude Code',    logo: 'CLI', sub: cc.cost_usd > 0 ? 'spese sviluppo (sessioni CLI)' : 'aggiungi env CLAUDE_CODE_MONTHLY_USD',
      usd: cc.cost_usd ?? 0,              type: cc.cost_usd > 0 ? 'REALE' : 'ND',    color: '#e5251b' },
    { name: 'Railway',        logo: 'RLY', sub: `piano ${d.railway?.plan ?? '—'}`,
      usd: d.railway?.cost_usd ?? 0,      type: 'PIANO', color: '#8866ff' },
    { name: 'Supabase',       logo: 'SB',  sub: `${d.supabase?.row_count ?? 0} righe · piano free`,
      usd: d.supabase?.cost_usd ?? 0,     type: 'PIANO', color: '#3ecf8e' },
  ];
  const typeColor = { REALE: 'tag-yellow', PIANO: 'tag-blue', STIMA: 'tag-muted', ND: 'tag-muted' };

  const rowHtml = rows.map(r => {
    const pct = Math.min(100, total > 0 ? (r.usd / total) * 100 : 0);
    return `
    <tr>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="svc-logo" style="color:${r.color};background:${r.color}12;border-color:${r.color}30">${r.logo}</span>
          <div>
            <span style="color:var(--text);font-weight:700">${r.name}</span>
            <span style="display:block;font-size:9px;color:var(--muted);margin-top:2px">${r.sub}</span>
          </div>
        </div>
      </td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;color:${r.color};font-size:14px">${fmtUsd(r.usd)}</td>
      <td><span class="cost-type-badge panel-tag ${typeColor[r.type]}">${r.type}</span></td>
      <td>
        <div class="cost-bar-wrap" style="width:100px">
          <div class="cost-bar-fill" style="width:${pct.toFixed(1)}%;background:${r.color}"></div>
        </div>
        <span style="font-size:9px;color:var(--muted);margin-left:6px">${pct.toFixed(0)}%</span>
      </td>
    </tr>`;
  }).join('');

  const modelShort = (ca.model ?? '—').replace('claude-','').replace('-20251001','');
  const prIn  = ca.pricing?.input  ?? 0;
  const prOut = ca.pricing?.output ?? 0;

  document.getElementById('costBreakdownBody').innerHTML = `
    <div class="table-wrap">
      <table class="cost-table">
        <thead><tr><th>Voce</th><th>Costo USD</th><th>Tipo</th><th>Peso</th></tr></thead>
        <tbody>
          ${rowHtml}
          <tr>
            <td style="font-weight:700;color:var(--text)">TOTALE MTD</td>
            <td style="font-family:'Syne',sans-serif;font-weight:800;color:var(--danger);font-size:16px">${fmtUsd(d.total_usd)}</td>
            <td></td><td></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div style="font-size:9px;color:var(--muted);margin-top:12px;padding:0 4px;display:flex;gap:16px;flex-wrap:wrap">
      <span>Modello: <strong style="color:var(--text)">${modelShort}</strong></span>
      <span>Prezzi: <strong style="color:var(--text)">$${prIn}/1M in · $${prOut}/1M out</strong></span>
      <span>Per imposta Claude Code: Railway → <code style="color:var(--blue)">CLAUDE_CODE_MONTHLY_USD=XX</code></span>
    </div>`;
}

// Dry-run banner + health check
fetch(CONFIG.RAILWAY_URL + '/health')
  .then(r => r.json())
  .then(data => {
    if (data.dry_run) {
      document.getElementById('dry-run-banner').style.display = 'block';
    }
    // Store operational config globally
    window._botConfig = {
      baseSize: data.base_size,
      confThreshold: data.confidence_threshold,
      capital: data.capital_usd
    };
    // Show PAUSED indicator if bot is paused
    const pausedEl = document.getElementById('botPausedIndicator');
    if (pausedEl) {
      pausedEl.style.display = data.bot_paused ? 'inline' : 'none';
    }
    // Update botStatusDetail with size/conf info
    const detailEl = document.getElementById('botStatusDetail');
    if (detailEl && data.base_size != null) {
      const confPct = Math.round((data.confidence_threshold || 0.65) * 100);
      const currentText = detailEl.textContent || '';
      detailEl.textContent = currentText + ' · size: ' + data.base_size + ' BTC | conf: ' + confPct + '%';
    }
  })
  .catch(() => {});

// ─── INFO MODAL ───────────────────────────────
(function(){
  const modal = document.getElementById('infoModal');
  const SOURCES_INFO = {
    'KRAKEN':      {cat:'PRICE',       color:'#00aaff', desc:'BTC/USD spot price fetched from Kraken Futures REST API every 6 minutes.'},
    'BINANCE':     {cat:'KLINES',      color:'#3399ee', desc:'5-minute OHLCV candlesticks (last 20) from Binance. Used for trend, momentum and pattern detection.'},
    'COINGECKO':   {cat:'MARKET',      color:'#00d4aa', desc:'Global market data: BTC market cap, 24h volume, dominance %, price change from CoinGecko.'},
    'FUNDING RATE':{cat:'DERIVATIVES', color:'#aa66ff', desc:'Perpetual futures funding rate on Kraken. Positive = longs pay shorts (bearish signal when very high).'},
    'L/S RATIO':   {cat:'DERIVATIVES', color:'#cc88ff', desc:'Long/Short ratio — ratio of long vs short positions open in the market. Signals crowd positioning.'},
    'FEAR & GREED':{cat:'SENTIMENT',   color:'#00ff88', desc:'Crypto Fear & Greed Index (0–100). <25 = Extreme Fear, >75 = Extreme Greed. Contrarian signal.'},
    'CRYPTOCMP':   {cat:'NEWS',        color:'#ff9500', desc:'Latest crypto news from CryptoCompare API. Articles filtered for relevance before passing to AI.'},
    'COINDESK':    {cat:'NEWS',        color:'#ffcc00', desc:'CoinDesk RSS feed — leading crypto media. Top 3 recent headlines passed to the prediction agent.'},
    'SOLE24ORE':   {cat:'NEWS',        color:'#ff6b35', desc:'Sole24Ore Italian financial news RSS. Captures European macro & regulatory sentiment on crypto.'},
    'PATTERNS':    {cat:'MEMORY',      color:'#ff44aa', desc:'Historical signal patterns from Supabase DB. Similar past setups and their outcomes inform the AI.'},
    'CNBC':        {cat:'NEWS',        color:'#e5251b', desc:'CNBC Finance RSS — US financial & markets headlines. Macro context from Wall Street perspective.'},
    'ORDER BOOK':  {cat:'MICROSTRUCTURE', color:'#00ccff', desc:'Order book imbalance calcolato su 5 livelli bid/ask dal Kraken Futures. Segnali: STRONG_BUY_PRESSURE / MILD_BUY / NEUTRAL / MILD_SELL / STRONG_SELL. Utile per rilevare pressione immediata sul prezzo.'},
    'MULTI-TF':    {cat:'TECHNICAL',   color:'#88ddff', desc:'Analisi multi-timeframe 15m e 4h: EMA9, EMA21, RSI14 per ciascuno. MTF Consensus: STRONG_UP (entrambi bullish), STRONG_DOWN (entrambi bearish), MIXED. Riduce il noise del timeframe 1m.'},
  };
  const KPI_INFO = {
    'BTC Price':      {cat:'LIVE DATA',  color:'#00aaff', desc:'Current BTC/USD price, refreshed every 30s from Kraken Futures mark price.'},
    'Win Rate':       {cat:'STATISTICS', color:'#00ff88', desc:'Percentage of resolved bets that ended as wins. Target: >55% for profitability.'},
    'Total PnL':      {cat:'P&L',        color:'#00ff88', desc:'Cumulative profit/loss in USD across all closed bets. Excludes open positions.'},
    'Total Bets':     {cat:'STATISTICS', color:'#00aaff', desc:'Total number of bets taken (bet_taken = true) including open positions.'},
    'Open Bets':      {cat:'LIVE',       color:'#ffaa00', desc:'Currently open positions being monitored by wf02. Each has active SL/TP watching.'},
    'Avg PnL':        {cat:'P&L',        color:'#aa66ff', desc:'Average PnL per closed trade in USD. Positive target for system profitability.'},
    'Avg Confidence': {cat:'MODEL',      color:'#cc88ff', desc:'Average AI confidence score on bets taken. Higher confidence should correlate with better WR.'},
    'Streak':         {cat:'STATISTICS', color:'#ffaa00', desc:'Current consecutive win/loss streak. Useful for detecting model drift.'},
    'Signals':        {cat:'STATISTICS', color:'#00d4aa', desc:'Total signals generated (including skipped). Shows how often the model fires.'},
    'Capital':        {cat:'ACCOUNT',    color:'#00ff88', desc:'Current account equity in USDC on Kraken Futures. Base capital used for bet sizing.'},
  };

  function showModal(e, title, info) {
    if (!info) return;
    document.getElementById('imTitle').textContent = title;
    document.getElementById('imCat').textContent = info.cat;
    document.getElementById('imBody').innerHTML = info.desc;
    modal.style.setProperty('--im-color', info.color);
    const pad = 12;
    let x = e.clientX + pad, y = e.clientY + pad;
    if (x + 340 > window.innerWidth) x = e.clientX - 340;
    if (y + 160 > window.innerHeight) y = e.clientY - 140;
    modal.style.left = x + 'px';
    modal.style.top  = y + 'px';
    modal.classList.add('visible');
  }

  function hideModal() { modal.classList.remove('visible'); }

  // Hover tooltip: segue il cursore, si mostra su src-chip e kpi
  let _ttEl = null;
  document.addEventListener('mousemove', function(e) {
    const chip = e.target.closest('.src-chip');
    const kpi  = e.target.closest('.kpi');
    const newEl = chip || kpi || null;
    if (newEl !== _ttEl) {
      _ttEl = newEl;
      if (!newEl) { hideModal(); return; }
      if (chip) {
        const name = chip.querySelector('.src-name')?.textContent.trim();
        if (name && SOURCES_INFO[name]) showModal(e, name, SOURCES_INFO[name]);
        else hideModal();
      } else {
        const label = kpi.querySelector('.kpi-label');
        if (label) {
          const key = Object.keys(KPI_INFO).find(k => label.textContent.includes(k));
          if (key) showModal(e, key, KPI_INFO[key]); else hideModal();
        } else hideModal();
      }
    } else if (_ttEl) {
      // Aggiorna posizione seguendo il cursore
      const pad = 12;
      let x = e.clientX + pad, y = e.clientY + pad;
      if (x + 340 > window.innerWidth)  x = e.clientX - 340;
      if (y + 160 > window.innerHeight) y = e.clientY - 140;
      modal.style.left = x + 'px';
      modal.style.top  = y + 'px';
    }
  });
  // Click per mobile (tap = show, tap altrove = hide)
  document.addEventListener('click', function(e) {
    const chip = e.target.closest('.src-chip');
    const kpi  = e.target.closest('.kpi');
    if (chip) {
      const name = chip.querySelector('.src-name')?.textContent.trim();
      if (name && SOURCES_INFO[name]) { showModal(e, name, SOURCES_INFO[name]); e.stopPropagation(); return; }
    }
    if (kpi) {
      const label = kpi.querySelector('.kpi-label');
      if (label) {
        const key = Object.keys(KPI_INFO).find(k => label.textContent.includes(k));
        if (key) { showModal(e, key, KPI_INFO[key]); e.stopPropagation(); return; }
      }
    }
    hideModal();
  });
  document.addEventListener('scroll', hideModal, { passive: true });
})();

// ── TASK 1: AI FEEDS carousel — mobile only ───────────────────────────────────
document.addEventListener('DOMContentLoaded', function() {
  if (!window.matchMedia('(max-width: 600px)').matches) return;
  const list = document.querySelector('.sources-list');
  if (!list) return;
  // Duplicate chips for seamless loop
  list.innerHTML += list.innerHTML;
  list.style.animation = 'feedScroll 30s linear infinite';

  // Pause on hover/touch
  list.addEventListener('mouseenter', function() {
    list.style.animationPlayState = 'paused';
  });
  list.addEventListener('mouseleave', function() {
    list.style.animationPlayState = 'running';
  });
  list.addEventListener('touchstart', function() {
    list.style.animationPlayState = 'paused';
  }, { passive: true });
  list.addEventListener('touchend', function() {
    list.style.animationPlayState = 'running';
  }, { passive: true });
});

// ── TASK 2: Story Highlights sync ─────────────────────────────────────────────
function syncStoryHighlights() {
  const map = [
    { src: 'kpiWinRate',  dst: 'storyWR' },
    { src: 'kpiRoi',      dst: 'storyROI' },
    { src: 'kpiFG',       dst: 'storyFG' },
    { src: 'kpiBets',     dst: 'storyBets' },
    { src: 'kpiDrawdown', dst: 'storyDD' },
    { src: 'statStreak',  dst: 'storyStreak' },
  ];
  map.forEach(function(item) {
    const srcEl = document.getElementById(item.src);
    const dstEl = document.getElementById(item.dst);
    if (srcEl && dstEl) {
      const val = srcEl.textContent.trim();
      dstEl.textContent = val || '—';
    }
  });
}
setInterval(syncStoryHighlights, 3000);

// ── TASK 3: Mobile Primary Grid sync ──────────────────────────────────────────
function syncMobilePrimary() {
  // 1. Bot Status
  const botTextEl  = document.getElementById('botStatusText');
  const botSubEl   = document.getElementById('botStatusDetail');
  const mpBotStatus = document.getElementById('mpBotStatus');
  const mpBotSub    = document.getElementById('mpBotSub');
  if (botTextEl && mpBotStatus) {
    const txt = botTextEl.textContent || '';
    mpBotStatus.textContent = txt.includes('ALIVE') ? '✅' : '⚠️';
    if (botSubEl && mpBotSub) {
      mpBotSub.textContent = botSubEl.textContent || '';
    }
  }

  // 2. Today PnL
  const mpTodayPnl = document.getElementById('mpTodayPnl');
  const mpTodaySub = document.getElementById('mpTodaySub');
  if (mpTodayPnl && allData && allData.length) {
    const todayStr = new Date().toISOString().slice(0, 10);
    const todayBets = allData.filter(function(d) {
      return d.bet_taken === true && d.pnl_usd !== null && d.created_at && d.created_at.slice(0, 10) === todayStr;
    });
    const todayPnl = todayBets.reduce(function(s, d) { return s + parseFloat(d.pnl_usd || 0); }, 0);
    const sign = todayPnl >= 0 ? '+' : '';
    mpTodayPnl.textContent = sign + '$' + todayPnl.toFixed(2);
    mpTodayPnl.style.color = todayPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
    if (mpTodaySub) mpTodaySub.textContent = todayBets.length + ' bet' + (todayBets.length !== 1 ? 's' : '') + ' today';
  }

  // 3. Last Signal from signalTable first row
  const mpLastDir    = document.getElementById('mpLastDir');
  const mpLastConf   = document.getElementById('mpLastConf');
  const mpLastResult = document.getElementById('mpLastResult');
  const mpLastTime   = document.getElementById('mpLastTime');
  if (mpLastDir && allData && allData.length) {
    const first = allData[0];
    if (first) {
      const dir = first.direction || '—';
      mpLastDir.textContent = dir === 'UP' ? '▲ UP' : dir === 'DOWN' ? '▼ DOWN' : '—';
      mpLastDir.style.color = dir === 'UP' ? 'var(--accent)' : dir === 'DOWN' ? 'var(--danger)' : 'var(--muted)';
      if (mpLastConf) mpLastConf.textContent = 'conf ' + (first.confidence ? Math.round(parseFloat(first.confidence) * 100) + '%' : '—');
      if (mpLastResult) {
        if (first.correct === true) {
          mpLastResult.textContent = 'WIN';
          mpLastResult.style.color = 'var(--accent)';
        } else if (first.correct === false) {
          mpLastResult.textContent = 'LOSS';
          mpLastResult.style.color = 'var(--danger)';
        } else if (first.bet_taken) {
          mpLastResult.textContent = 'OPEN';
          mpLastResult.style.color = 'var(--warn)';
        } else {
          mpLastResult.textContent = first.classification || '—';
          mpLastResult.style.color = 'var(--muted)';
        }
      }
      if (mpLastTime && first.created_at) {
        const d = new Date(first.created_at);
        mpLastTime.textContent = d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }) + ' ' + d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
      }
    }
  }
}
setInterval(syncMobilePrimary, 5000);

// ── TASK 5: Mobile Bet List rendering ─────────────────────────────────────────
function renderMobileBetList(data) {
  const container = document.getElementById('mobileBetList');
  if (!container) return;
  const dirFilter   = document.getElementById('filterDir').value;
  const classFilter = document.getElementById('filterClass').value;
  const filtered = data.filter(function(d) {
    if (dirFilter   !== 'ALL' && d.direction      !== dirFilter)   return false;
    if (classFilter !== 'ALL' && d.classification !== classFilter) return false;
    return true;
  }).slice(0, 80);

  if (!filtered.length) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:11px;letter-spacing:1px">NO DATA</div>';
    return;
  }

  container.innerHTML = filtered.map(function(d) {
    const dir = d.direction || '—';
    const dirClass = dir === 'UP' ? 'up' : 'down';
    const dirText  = dir === 'UP' ? '▲ UP' : dir === 'DOWN' ? '▼ DOWN' : '—';
    const conf = d.confidence ? Math.round(parseFloat(d.confidence) * 100) + '%' : '—';

    let resultText = '—', resultClass = '';
    const isBet = d.classification === 'BET' && d.bet_taken;
    if (d.correct === true) {
      resultText  = isBet ? '&#x2705; WIN' : '&#x2705; RIGHT';
      resultClass = 'win';
    } else if (d.correct === false) {
      resultText  = isBet ? '&#x274C; LOSS' : '&#x274C; WRONG';
      resultClass = 'loss';
    } else if (isBet) {
      resultText  = '&#x23F3; OPEN';
      resultClass = '';
    } else {
      resultText  = d.classification || '—';
      resultClass = 'skip';
    }

    let cardClass = 'mbet-card';
    if (d.correct === true && isBet) cardClass += ' win';
    else if (d.correct === false && isBet) cardClass += ' loss';
    else if (!isBet) cardClass += ' nobet';

    const pnl = d.pnl_usd !== null && d.pnl_usd !== undefined ? parseFloat(d.pnl_usd) : null;
    const pnlText  = pnl !== null ? (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2) : '—';
    const pnlClass = pnl !== null ? (pnl >= 0 ? 'pos' : 'neg') : '';

    let timeStr = '—';
    if (d.created_at) {
      const dt = new Date(d.created_at);
      timeStr = dt.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }) + ' ' + dt.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    }

    return '<div class="' + cardClass + '">'
      + '<span class="mbet-id">#' + d.id + '</span>'
      + '<span class="mbet-dir ' + dirClass + '">' + dirText + '</span>'
      + '<span class="mbet-conf">' + conf + '</span>'
      + '<span class="mbet-result ' + resultClass + '">' + resultText + '</span>'
      + '<span class="mbet-time">' + timeStr + '</span>'
      + '<span class="mbet-pnl ' + pnlClass + '">' + pnlText + '</span>'
      + '</div>';
  }).join('');
}

/* ── KPI TOOLTIP ─────────────────────────────────────────── */
const KPI_DESCRIPTIONS = {
  kpiPrice:           { label: 'BTC Price',        desc: 'Current BTC price at last bet entry.' },
  kpiTotal:           { label: 'Total Signals',    desc: 'Total signals generated by the AI system (LLM + XGB).' },
  kpiAccuracy:        { label: 'Accuracy',         desc: 'Model accuracy on all closed signals.' },
  kpiPnl:             { label: 'Total PnL',        desc: 'Total realized PnL across all real bets (excluding fees).' },
  kpiRoi:             { label: 'Session ROI',      desc: 'Return on investment since session start (2026-02-24, $100 capital).' },
  kpiWinRate:         { label: 'Win Rate',         desc: 'Win rate on executed bets (BET classification only).' },
  kpiWrNoBet:         { label: 'WR NoBet',         desc: 'Win rate on signals where no bet was taken (theoretical).' },
  kpiFG:              { label: 'Fear & Greed',     desc: 'Fear & Greed Index (0 = Extreme Fear, 100 = Extreme Greed).' },
  kpiBets:            { label: 'Bets Taken',       desc: 'Number of bets taken out of total signals.' },
  kpiDrawdown:        { label: 'Max Drawdown',     desc: 'Worst single trade loss.' },
  kpiExpectancyVal:   { label: 'Expectancy',       desc: 'Expected value per bet = Total PnL / closed bets.' },
  kpiProfitFactorVal: { label: 'Profit Factor',    desc: 'Profit Factor = Gross Wins / Gross Losses (>1.5 is good).' }
};

var _kpiTipOpen = false;
var _kpiTipTimeout = null;

function _positionTooltip(tip, anchor) {
  var rect = anchor.getBoundingClientRect();
  var tipW = 220;
  tip.style.display = 'block';
  var tipH = tip.offsetHeight;
  var left = rect.left;
  var top  = rect.bottom + 8;
  if (left + tipW > window.innerWidth - 8)  left = window.innerWidth - tipW - 8;
  if (left < 8) left = 8;
  if (top + tipH > window.innerHeight - 8)  top = rect.top - tipH - 8;
  tip.style.left = left + 'px';
  tip.style.top  = top  + 'px';
}

function openKpiModal(kpiId, anchorEl) {
  var meta = KPI_DESCRIPTIONS[kpiId];
  if (!meta) return;
  var valEl = document.getElementById(kpiId);
  var val   = valEl ? valEl.textContent.trim() : '—';
  _showTooltip(anchorEl || document.getElementById(kpiId), meta.label, val, meta.desc);
}

function _showTooltip(anchor, label, val, desc) {
  if (_kpiTipTimeout) clearTimeout(_kpiTipTimeout);
  var tip = document.getElementById('kpiTooltip');
  tip.classList.remove('kt-visible');
  var labelEl = label ? '<div class="kt-label">' + label + '</div>' : '';
  var valEl   = val   ? '<div class="kt-val">'   + val   + '</div>' : '';
  var descEl  = desc  ? '<div class="kt-desc">'  + desc  + '</div>' : '';
  tip.innerHTML = labelEl + valEl + descEl;
  _positionTooltip(tip, anchor);
  requestAnimationFrame(function() { requestAnimationFrame(function() { tip.classList.add('kt-visible'); }); });
  _kpiTipOpen = true;
}

function closeKpiModal() {
  var tip = document.getElementById('kpiTooltip');
  tip.classList.remove('kt-visible');
  _kpiTipTimeout = setTimeout(function() { tip.style.display = 'none'; }, 150);
  _kpiTipOpen = false;
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeKpiModal();
});

document.addEventListener('click', function(e) {
  if (!_kpiTipOpen) return;
  var tip = document.getElementById('kpiTooltip');
  if (!tip.contains(e.target) && !e.target.closest('[data-tip]') && !e.target.closest('.kpi-grid .kpi')) {
    closeKpiModal();
  }
});

/* KPI grid tiles */
document.querySelectorAll('.kpi-grid .kpi').forEach(function(tile) {
  tile.addEventListener('click', function(e) {
    e.stopPropagation();
    var valEl = tile.querySelector('[id^="kpi"]');
    if (!valEl) return;
    var kpiId = valEl.id;
    var meta = KPI_DESCRIPTIONS[kpiId];
    if (!meta) return;
    var val = valEl.textContent.trim();
    /* toggle: click same tile again = close */
    var tip = document.getElementById('kpiTooltip');
    if (_kpiTipOpen && tip.querySelector('.kt-label') && tip.querySelector('.kt-label').textContent === meta.label) {
      closeKpiModal(); return;
    }
    _showTooltip(tile, meta.label, val, meta.desc);
  });
});

/* Generic data-tip elements */
document.addEventListener('click', function(e) {
  var el = e.target.closest('[data-tip]');
  if (!el) return;
  e.stopPropagation();
  var tip = document.getElementById('kpiTooltip');
  var title = el.dataset.tipTitle || el.textContent.trim();
  var desc  = el.dataset.tip || '';
  if (_kpiTipOpen && tip.querySelector('.kt-label') && tip.querySelector('.kt-label').textContent === title) {
    closeKpiModal(); return;
  }
  _showTooltip(el, title, '', desc);
}, true);

/* ═══════════════════════════════════════
   WAR ROOM
═══════════════════════════════════════ */
var _warRoomClockInterval = null;

function toggleWarRoom(btn) {
  var body = document.body;
  var active = body.classList.toggle('war-room');
  btn.classList.toggle('wr-active', active);
  localStorage.setItem('warRoomActive', active ? '1' : '0');
  if (active) {
    startWarRoomClock();
  } else {
    stopWarRoomClock();
  }
}

function startWarRoomClock() {
  stopWarRoomClock();
  function tick() {
    var now = new Date();
    var h = String(now.getUTCHours()).padStart(2,'0');
    var m = String(now.getUTCMinutes()).padStart(2,'0');
    var s = String(now.getUTCSeconds()).padStart(2,'0');
    var el = document.getElementById('warRoomClock');
    if (el) el.textContent = h + ':' + m + ':' + s;
  }
  tick();
  _warRoomClockInterval = setInterval(tick, 1000);
}

function stopWarRoomClock() {
  if (_warRoomClockInterval) { clearInterval(_warRoomClockInterval); _warRoomClockInterval = null; }
}

// Restore War Room on page load
(function() {
  if (localStorage.getItem('warRoomActive') === '1') {
    document.body.classList.add('war-room');
    var btn = document.getElementById('warRoomToggle');
    if (btn) btn.classList.add('wr-active');
    startWarRoomClock();
  }
})();

/* ═══════════════════════════════════════
   SIGNAL LOG FILTERS
═══════════════════════════════════════ */
var _signalFilters = { type: 'all', outcome: 'all', direction: 'all' };
var _signalCurrentData = [];
var _origRenderTable = null; // assegnato in DOMContentLoaded

function setSignalFilter(btn, group) {
  // Update active button in group
  var groupBtns = document.querySelectorAll('.filter-btn[data-filter="' + group + '"]');
  groupBtns.forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  _signalFilters[group] = btn.dataset.value;
  applySignalFilters();
}

function applySignalFilters() {
  if (!_signalCurrentData || !_signalCurrentData.length) return;
  var search = (document.getElementById('signal-search') || {}).value || '';
  search = search.toLowerCase().replace(/^[🔍\s]+/, '').trim();

  var filtered = _signalCurrentData.filter(function(d) {
    // Type filter
    var type = _signalFilters.type;
    if (type !== 'all') {
      // bet  = row was actually executed as a real bet
      if (type === 'bet'   && d.bet_taken !== true)                                               return false;
      // skip = explicitly classified SKIP or NO_BET rows where bet was not taken
      if (type === 'skip'  && !(d.classification === 'SKIP' || (d.classification === 'NO_BET' && !d.bet_taken))) return false;
      // nobet = any row where no real bet was placed
      if (type === 'nobet' && d.bet_taken)                                                         return false;
    }
    // Outcome filter
    var outcome = _signalFilters.outcome;
    if (outcome !== 'all') {
      if (outcome === 'win'  && d.correct !== true)                               return false;
      if (outcome === 'loss' && d.correct !== false)                              return false;
      if (outcome === 'open' && !(d.bet_taken && d.correct === null))             return false;
    }
    // Direction filter
    var dir = _signalFilters.direction;
    if (dir !== 'all') {
      var dDir = (d.direction || d.prediction || '').toUpperCase();
      if (dir === 'up'   && dDir !== 'UP')   return false;
      if (dir === 'down' && dDir !== 'DOWN') return false;
    }
    // Search
    if (search) {
      var haystack = [
        String(d.id || ''),
        String(d.confidence || ''),
        String(d.classification || ''),
        String(d.prediction || ''),
        String(d.direction || '')
      ].join(' ').toLowerCase();
      if (haystack.indexOf(search) === -1) return false;
    }
    return true;
  });

  renderTableFiltered(filtered);
}

function renderTableFiltered(filtered) {
  // Chiama _origRenderTable direttamente per evitare la ricorsione:
  // renderTable (patchata) → applySignalFilters → renderTableFiltered → renderTable → loop
  if (!_origRenderTable) return;
  var dirEl   = document.getElementById('filterDir');
  var classEl = document.getElementById('filterClass');
  var origDir   = dirEl   ? dirEl.value   : 'ALL';
  var origClass = classEl ? classEl.value : 'ALL';
  if (dirEl)   dirEl.value   = 'ALL';
  if (classEl) classEl.value = 'ALL';
  _origRenderTable(filtered);
  if (dirEl)   dirEl.value   = origDir;
  if (classEl) classEl.value = origClass;
}

// Hook into the existing renderAll to capture data for our filters
var _origRenderAll = typeof renderAll === 'function' ? renderAll : null;
// Override after DOMContentLoaded since renderAll is defined in the same script
document.addEventListener('DOMContentLoaded', function() {
  // Patch renderTable per catturare _signalCurrentData e applicare i filtri pill
  _origRenderTable = window.renderTable;
  if (_origRenderTable) {
    window.renderTable = function(data) {
      // Aggiorna il dataset completo (MAI sovrascrivere con dati già filtrati)
      _signalCurrentData = data;
      var search = (document.getElementById('signal-search') || {}).value || '';
      search = search.toLowerCase().replace(/^[🔍\s]+/, '').trim();
      var hasFilter = (_signalFilters.type !== 'all' || _signalFilters.outcome !== 'all' || _signalFilters.direction !== 'all' || search !== '');
      if (hasFilter) {
        // applySignalFilters → renderTableFiltered → _origRenderTable (nessuna ricorsione)
        applySignalFilters();
      } else {
        _origRenderTable(data);
      }
    };
  }
});
</script>
<div id="infoModal">
  <div class="im-title" id="imTitle"></div>
  <div class="im-bar"></div>
  <div class="im-cat" id="imCat"></div>
  <div class="im-body" id="imBody"></div>
</div>
<!-- KPI TOOLTIP -->
<div id="kpiTooltip"></div>
</body>
</html>
