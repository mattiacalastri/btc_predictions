<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BTC BOT ¬∑ ASTRA DIGITAL</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080b0f;
    --surface: #0d1117;
    --card: #111820;
    --border: #1e2d3d;
    --accent: #00ff88;
    --blue: #00aaff;
    --text: #e8f0fe;
    --muted: #4a6070;
    --danger: #ff4466;
    --warn: #ffaa00;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.025) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { position: relative; z-index: 1; max-width: 1600px; margin: 0 auto; padding: 20px 24px; }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .logo { font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; color: var(--muted); }
  .logo span { color: var(--accent); }
  h1 { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
  h1 span { color: var(--accent); }

  .header-right { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }

  .btc-live-ticker { display: flex; flex-direction: column; align-items: flex-end; }
  .btc-live-price { font-size: 20px; font-weight: 900; color: var(--accent); font-family: 'Syne', sans-serif; letter-spacing: -0.5px; line-height: 1; transition: color 0.3s; }
  .btc-live-price.up { color: var(--accent); }
  .btc-live-price.down { color: var(--danger); }
  .btc-price-meta { font-size: 9px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 2px; }
  .btc-price-change { font-size: 10px; font-weight: 700; }
  .btc-price-change.pos { color: var(--accent); }
  .btc-price-change.neg { color: var(--danger); }

  .live-badge { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); border: 1px solid rgba(0,255,136,0.3); padding: 5px 12px; border-radius: 2px; background: rgba(0,255,136,0.05); }
  .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 1.5s infinite; }
  .last-update { font-size: 10px; color: var(--muted); letter-spacing: 1px; }

  .bot-status { display: flex; align-items: center; gap: 7px; font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; padding: 5px 12px; border-radius: 2px; border: 1px solid; transition: all 0.4s; }
  .bot-status.alive   { color: var(--accent); border-color: rgba(0,255,136,0.3); background: rgba(0,255,136,0.05); }
  .bot-status.warning { color: var(--warn);   border-color: rgba(255,170,0,0.3); background: rgba(255,170,0,0.05); }
  .bot-status.dead    { color: var(--danger);  border-color: rgba(255,68,102,0.3); background: rgba(255,68,102,0.07); animation: deadPulse 2s infinite; }
  .bot-status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .alive .bot-status-dot   { background: var(--accent); box-shadow: 0 0 5px var(--accent); animation: pulse 1.5s infinite; }
  .warning .bot-status-dot { background: var(--warn);   box-shadow: 0 0 5px var(--warn); animation: pulse 2s infinite; }
  .dead .bot-status-dot    { background: var(--danger); }
  .bot-status-inner { display: flex; flex-direction: column; }
  .bot-status-detail { font-size: 9px; color: var(--muted); letter-spacing: 1px; font-weight: 400; margin-top: 1px; }

  @keyframes pulse    { 0%,100%{opacity:1} 50%{opacity:0.4} }
  @keyframes deadPulse{ 0%,100%{opacity:1} 50%{opacity:0.5} }
  @keyframes blink    { 0%,100%{opacity:1} 50%{opacity:0} }
  .loading { display: inline-block; animation: blink 1s step-end infinite; color: var(--accent); }

  /* KPI GRID */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  @media (max-width: 1300px) { .kpi-grid { grid-template-columns: repeat(5, 1fr); } }
  @media (max-width: 700px)  { .kpi-grid { grid-template-columns: repeat(3, 1fr); } }

  .kpi { background: var(--card); border: 1px solid var(--border); padding: 14px 16px; position: relative; overflow: hidden; transition: border-color 0.2s; min-width: 0; }
  .kpi:hover { border-color: rgba(255,255,255,0.12); }
  .kpi::after { content: ''; position: absolute; top: 0; left: 0; width: 2px; height: 100%; }
  .kpi.green::after  { background: var(--accent); }
  .kpi.red::after    { background: var(--danger); }
  .kpi.yellow::after { background: var(--warn); }
  .kpi.blue::after   { background: var(--blue); }
  .kpi.purple::after { background: #aa66ff; }

  .kpi-label { font-size: 9px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .kpi-value { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
  .kpi-value.green  { color: var(--accent); }
  .kpi-value.red    { color: var(--danger); }
  .kpi-value.yellow { color: var(--warn); }
  .kpi-value.white  { color: var(--text); }
  .kpi-value.blue   { color: var(--blue); }
  .kpi-value.purple { color: #aa66ff; }
  .kpi-sub { font-size: 10px; color: var(--muted); margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* STATS ROW */
  .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--border); margin-bottom: 16px; }
  @media (max-width: 900px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
  .stat-cell { background: var(--card); padding: 14px 18px; text-align: center; }
  .stat-cell-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .stat-cell-val { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; }

  /* MAIN GRID */
  .main-grid { display: grid; grid-template-columns: 1fr 320px; gap: 14px; margin-bottom: 14px; }
  @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }

  /* PANEL */
  .panel { background: var(--card); border: 1px solid var(--border); overflow: hidden; }
  .panel-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 18px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.015); flex-wrap: wrap; gap: 8px; }
  .panel-title { font-size: 10px; font-weight: 700; letter-spacing: 2.5px; text-transform: uppercase; color: var(--muted); }
  .panel-tag { font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; padding: 3px 9px; border-radius: 2px; }
  .tag-green  { background: rgba(0,255,136,0.08);  color: var(--accent); border: 1px solid rgba(0,255,136,0.2); }
  .tag-red    { background: rgba(255,68,102,0.08); color: var(--danger); border: 1px solid rgba(255,68,102,0.2); }
  .tag-yellow { background: rgba(255,170,0,0.08);  color: var(--warn);   border: 1px solid rgba(255,170,0,0.2); }
  .tag-blue   { background: rgba(0,170,255,0.08);  color: var(--blue);   border: 1px solid rgba(0,170,255,0.2); }
  .tag-muted  { background: rgba(74,96,112,0.1);   color: var(--muted);  border: 1px solid rgba(74,96,112,0.2); }

  /* COSTS TAB */
  .cost-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .cost-table th { font-size: 9px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); }
  .cost-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
  .cost-table tr:last-child td { border-bottom: none; font-weight: 700; color: var(--text); }
  .cost-bar-wrap { width: 120px; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; }
  .cost-bar-fill { height: 100%; border-radius: 3px; transition: width 0.4s ease; }
  .cost-type-badge { font-size: 8px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; padding: 2px 6px; border-radius: 2px; display: inline-block; }

  /* TABLE */
  .table-wrap { overflow-x: auto; max-height: 500px; overflow-y: auto; }
  .table-wrap::-webkit-scrollbar { width: 3px; height: 3px; }
  .table-wrap::-webkit-scrollbar-thumb { background: var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 11px; }
  thead th { text-align: left; font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); padding: 9px 12px; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 2; white-space: nowrap; }
  tbody tr { border-bottom: 1px solid rgba(30,45,61,0.4); transition: background 0.12s; }
  tbody tr:hover { background: rgba(255,255,255,0.025); }
  tbody td { padding: 8px 12px; white-space: nowrap; vertical-align: middle; }

  .dir-up   { color: var(--accent); font-weight: 700; }
  .dir-down { color: var(--danger); font-weight: 700; }

  .badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 7px; border-radius: 2px; font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .badge-bet     { background: rgba(0,170,255,0.1);  color: var(--blue); }
  .badge-nobet   { background: rgba(74,96,112,0.15); color: var(--muted); }
  .badge-correct  { background: rgba(0,255,136,0.1);  color: var(--accent); }
  .badge-wrong    { background: rgba(255,68,102,0.1); color: var(--danger); }
  .badge-skip     { background: rgba(74,96,112,0.2);   color: #8ca0b0; border: 1px solid rgba(74,96,112,0.3); }
  .badge-alert    { background: rgba(255,170,0,0.1);   color: var(--warn); border: 1px solid rgba(255,170,0,0.3); }
  .badge-pending  { background: rgba(170,102,255,0.1); color: #aa66ff; border: 1px solid rgba(170,102,255,0.3); }

  #apiErrorBanner {
    display: none;
    align-items: center;
    gap: 10px;
    background: rgba(255,68,102,0.08);
    border: 1px solid rgba(255,68,102,0.3);
    border-radius: 4px;
    padding: 8px 16px;
    margin-bottom: 14px;
    font-size: 11px;
    color: var(--danger);
    letter-spacing: 0.5px;
  }
  #apiErrorBanner.visible { display: flex; }
  #apiErrorBanner .err-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--danger); flex-shrink: 0; animation: pulse 1.5s ease-in-out infinite; }
  #apiErrorBanner .err-dismiss { margin-left: auto; cursor: pointer; opacity: 0.6; font-size: 14px; line-height: 1; }
  #apiErrorBanner .err-dismiss:hover { opacity: 1; }

  .pnl-pos  { color: var(--accent); }
  .pnl-neg  { color: var(--danger); }
  .pnl-null { color: var(--muted); }
  .no-data-row td { text-align: center; color: var(--muted); padding: 28px; font-size: 11px; letter-spacing: 2px; }

  /* SIZE cell */
  .size-val    { color: var(--blue); font-weight: 700; font-size: 10px; display: block; }
  .size-reason { color: var(--muted); font-size: 9px; display: block; margin-top: 2px; letter-spacing: 0.5px; }
  .size-mult   { font-size: 9px; }
  .size-mult.up   { color: var(--accent); }
  .size-mult.down { color: var(--danger); }
  .size-mult.base { color: var(--muted); }

  /* FILTERS */
  .filters-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
  .time-pill { font-family: inherit; font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; padding: 3px 9px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; border-radius: 2px; transition: all 0.15s; }
  .time-pill:hover { color: var(--text); border-color: var(--muted); }
  .time-pill.active { background: var(--accent); border-color: var(--accent); color: #000; }
  select.filter-sel { background: var(--surface); border: 1px solid var(--border); color: var(--text); font-family: inherit; font-size: 9px; padding: 3px 7px; letter-spacing: 1px; cursor: pointer; outline: none; border-radius: 2px; }

  /* CHART */
  .chart-area { padding: 16px 18px; }
  .pnl-chart { display: flex; align-items: flex-end; gap: 2px; height: 90px; margin-bottom: 6px; }
  .bar { flex: 1; border-radius: 1px 1px 0 0; min-width: 6px; transition: opacity 0.15s; cursor: pointer; position: relative; }
  .bar:hover { opacity: 0.75; }
  .bar.pos  { background: var(--accent); }
  .bar.neg  { background: var(--danger); align-self: flex-start; border-radius: 0 0 1px 1px; }
  .bar.zero { background: var(--muted); height: 2px !important; }
  .bar-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--muted); }
  .tooltip { position: absolute; bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%); background: var(--surface); border: 1px solid var(--border); padding: 3px 7px; font-size: 9px; white-space: nowrap; pointer-events: none; z-index: 100; display: none; }
  .bar:hover .tooltip { display: block; }

  /* SIGNAL QUALITY */
  .signal-grid { padding: 14px 18px; display: flex; flex-direction: column; gap: 12px; }
  .signal-row { display: flex; flex-direction: column; gap: 5px; }
  .signal-meta { display: flex; justify-content: space-between; font-size: 9px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
  .signal-label { color: var(--muted); }
  .signal-val   { color: var(--text); }
  .signal-bar-bg   { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .signal-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

  /* CONF DIST */
  .conf-bars { padding: 14px 18px; display: flex; flex-direction: column; gap: 9px; }
  .conf-row { display: flex; align-items: center; gap: 9px; }
  .conf-label   { font-size: 9px; color: var(--muted); width: 42px; text-align: right; }
  .conf-bar-bg  { flex: 1; height: 12px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .conf-bar-fill{ height: 100%; background: var(--blue); transition: width 0.5s ease; }
  .conf-count   { font-size: 9px; color: var(--muted); width: 22px; text-align: right; }

  .equity-svg { width: 100%; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ACCOUNT SUMMARY SECTION
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  .account-summary-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    margin-bottom: 14px;
  }
  @media (max-width: 1200px) { .account-summary-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 600px)  { .account-summary-grid { grid-template-columns: 1fr; } }

  .acct-panel {
    background: var(--card);
    border: 1px solid var(--border);
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .acct-panel:hover { border-color: rgba(255,255,255,0.1); }

  .acct-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(255,255,255,0.015);
  }
  .acct-panel-title {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .acct-panel-title .icon { font-size: 11px; }
  .acct-refresh-ts {
    font-size: 8px;
    color: var(--muted);
    letter-spacing: 0.5px;
  }

  .acct-body { padding: 14px 16px; display: flex; flex-direction: column; gap: 10px; }

  /* Wallet rows */
  .acct-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid rgba(30,45,61,0.5);
  }
  .acct-row:last-child { border-bottom: none; }
  .acct-row-label {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .acct-row-val {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
  }
  .acct-row-val.green  { color: var(--accent); }
  .acct-row-val.red    { color: var(--danger); }
  .acct-row-val.blue   { color: var(--blue); }
  .acct-row-val.yellow { color: var(--warn); }
  .acct-row-val.muted  { color: var(--muted); }

  /* Margin bar */
  .margin-bar-wrap { margin-top: 4px; }
  .margin-bar-label { display: flex; justify-content: space-between; font-size: 8px; color: var(--muted); margin-bottom: 4px; letter-spacing: 1px; text-transform: uppercase; }
  .margin-bar-bg { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .margin-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease, background 0.3s; }

  /* Position badge */
  .position-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border-radius: 2px;
    margin-bottom: 8px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .position-status.flat {
    background: rgba(74,96,112,0.12);
    border: 1px solid rgba(74,96,112,0.3);
    color: var(--muted);
  }
  .position-status.long {
    background: rgba(0,255,136,0.07);
    border: 1px solid rgba(0,255,136,0.25);
    color: var(--accent);
  }
  .position-status.short {
    background: rgba(255,68,102,0.07);
    border: 1px solid rgba(255,68,102,0.25);
    color: var(--danger);
  }
  .position-dot {
    width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
  }
  .position-status.flat  .position-dot { background: var(--muted); }
  .position-status.long  .position-dot { background: var(--accent); box-shadow: 0 0 5px var(--accent); animation: pulse 2s infinite; }
  .position-status.short .position-dot { background: var(--danger); box-shadow: 0 0 5px var(--danger); animation: pulse 2s infinite; }

  /* Fills table */
  .fills-table { width: 100%; border-collapse: collapse; font-size: 10px; }
  .fills-table th {
    text-align: left;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .fills-table td {
    padding: 7px 8px;
    border-bottom: 1px solid rgba(30,45,61,0.3);
    vertical-align: middle;
    white-space: nowrap;
  }
  .fills-table tr:last-child td { border-bottom: none; }
  .fill-buy  { color: var(--accent); font-weight: 700; }
  .fill-sell { color: var(--danger); font-weight: 700; }

  /* BTC Price card big number */
  .btc-mark-big {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: -1px;
    line-height: 1;
    margin-bottom: 4px;
  }
  .btc-price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid rgba(30,45,61,0.4);
  }
  .btc-price-row:last-child { border-bottom: none; }
  .btc-price-row-label { font-size: 9px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  .btc-price-row-val   { font-size: 11px; font-weight: 700; color: var(--text); }

  /* Summary section divider */
  .section-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 6px 0 14px;
  }
  .section-divider-label {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
  }
  .section-divider-line {
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .section-divider-ts {
    font-size: 8px;
    color: var(--muted);
    letter-spacing: 1px;
    white-space: nowrap;
  }

  /* Unrealized PnL indicator in position card */
  .pnl-indicator {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-radius: 2px;
    font-size: 11px;
    font-weight: 700;
  }
  .pnl-indicator.pos { background: rgba(0,255,136,0.07); border: 1px solid rgba(0,255,136,0.2); color: var(--accent); }
  .pnl-indicator.neg { background: rgba(255,68,102,0.07); border: 1px solid rgba(255,68,102,0.2); color: var(--danger); }
  .pnl-indicator.zero { background: rgba(74,96,112,0.1); border: 1px solid rgba(74,96,112,0.2); color: var(--muted); }

  /* Loading skeleton */
  .acct-skeleton {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 14px 16px;
  }
  .skeleton-line {
    height: 14px;
    background: var(--border);
    border-radius: 2px;
    animation: shimmer 1.5s infinite linear;
    background: linear-gradient(90deg, var(--border) 25%, rgba(30,45,61,0.8) 50%, var(--border) 75%);
    background-size: 200% 100%;
  }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  footer { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
  .footer-text { font-size: 9px; color: var(--muted); letter-spacing: 1px; }
  .footer-text span { color: var(--accent); }
  .config-hint { font-size: 9px; color: var(--muted); background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 5px 12px; border-radius: 2px; letter-spacing: 1px; }
  .config-hint code { color: var(--accent); }

  /* CHARTS GRID */
  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
  @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }

  .pnl-bars-large { display: flex; align-items: flex-end; gap: 3px; height: 130px; }

  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-thumb { background: var(--border); }

  /* ‚îÄ‚îÄ TAB SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .tab-nav {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 0 16px; border-bottom: 1px solid var(--border);
    margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
  }
  .tab-buttons { display: flex; gap: 4px; }
  .tab-btn {
    font-family: inherit; font-size: 10px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase; padding: 7px 16px;
    border: 1px solid var(--border); background: transparent;
    color: var(--muted); cursor: pointer; border-radius: 2px; transition: all 0.15s;
  }
  .tab-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.2); }
  .tab-btn.active { background: rgba(0,255,136,0.08); border-color: rgba(0,255,136,0.3); color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ‚îÄ‚îÄ AGENTS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .agents-section-header {
    font-size: 9px; font-weight: 700; letter-spacing: 2.5px;
    text-transform: uppercase; color: var(--muted);
    margin: 20px 0 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .agents-section-header:first-child { margin-top: 0; }
  .wf-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;
  }
  @media (max-width: 1100px) { .wf-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 600px)  { .wf-grid { grid-template-columns: 1fr; } }
  .wf-card {
    background: var(--card); border: 1px solid var(--border);
    padding: 14px 16px; transition: border-color 0.2s;
  }
  .wf-card:hover { border-color: rgba(255,255,255,0.1); }
  .wf-card-name {
    font-size: 11px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 4px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .wf-card-id { font-size: 9px; color: var(--muted); letter-spacing: 0.5px; margin-bottom: 10px; }
  .wf-card-meta { font-size: 10px; color: var(--muted); margin-top: 8px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  .agents-refresh-btn {
    font-family: inherit; font-size: 9px; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; padding: 4px 10px; border: 1px solid var(--border);
    background: transparent; color: var(--muted); cursor: pointer;
    border-radius: 2px; transition: all 0.15s;
  }
  .agents-refresh-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.2); }
  .launchd-table td code { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--blue); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AI SIGNAL SOURCES STRIP
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .sources-strip {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 9px 16px;
    background: var(--card);
    border: 1px solid var(--border);
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  .sources-label {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
    flex-shrink: 0;
    padding-right: 14px;
    border-right: 1px solid var(--border);
    line-height: 1.5;
  }
  .sources-label em { font-style: normal; color: var(--accent); }
  .sources-list {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    flex: 1;
  }
  .src-chip {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 5px 10px 5px 9px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    cursor: default;
    transition: border-color 0.15s, background 0.15s;
    position: relative;
    overflow: hidden;
  }
  .src-chip:hover {
    background: rgba(255,255,255,0.04);
    border-color: var(--src-color, var(--muted));
  }
  .src-chip::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 2px;
    background: var(--src-color, var(--muted));
  }
  .src-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--src-color, var(--muted));
    flex-shrink: 0;
    animation: pulse 2.5s ease-in-out infinite;
  }
  .src-info { display: flex; flex-direction: column; gap: 1px; }
  .src-name {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text);
    white-space: nowrap;
    line-height: 1.2;
  }
  .src-cat {
    font-size: 7px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--src-color, var(--muted));
    opacity: 0.75;
    white-space: nowrap;
    line-height: 1;
  }
  @media (max-width: 900px) { .sources-label { border-right: none; padding-right: 0; } }
</style>
</head>
<body>
  <div id="dry-run-banner" style="display:none; background:#f59e0b; color:#000; text-align:center; padding:10px; font-weight:bold; font-size:14px; letter-spacing:1px;">
  üß™ DRY RUN MODE ‚Äî Nessun trade reale in esecuzione
</div>
<div class="container">

  <header>
    <div>
      <div class="logo">ASTRA DIGITAL ¬∑ <span>BOT ENGINE v2.0</span></div>
      <h1>BTC <span>SIGNAL</span> DASHBOARD</h1>
    </div>
    <div class="header-right">
      <div class="btc-live-ticker">
        <div class="btc-live-price" id="btcLivePrice">‚Äî</div>
        <div class="btc-price-meta">BTC/USD ¬∑ LIVE <span class="btc-price-change" id="btcPriceChange"></span></div>
      </div>
      <span class="last-update" id="lastUpdate">LAST UPDATE: <span class="loading">‚Äî</span></span>
      <div class="live-badge"><div class="live-dot"></div>LIVE DATA</div>
      <div id="botStatus" class="bot-status alive">
        <div class="bot-status-dot"></div>
        <div class="bot-status-inner">
          <div id="botStatusText">BOT ALIVE</div>
          <div class="bot-status-detail" id="botStatusDetail">Checking...</div>
        </div>
      </div>
    </div>
  </header>

  <!-- AI SIGNAL SOURCES -->
  <div class="sources-strip">
    <div class="sources-label">AI FEEDS<br><em>10</em> SOURCES</div>
    <div class="sources-list">
      <div class="src-chip" style="--src-color:#00aaff" title="BTC/USD spot price ‚Äî Kraken Futures">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">KRAKEN</span><span class="src-cat">PRICE</span></div>
      </div>
      <div class="src-chip" style="--src-color:#3399ee" title="BTC OHLCV candlesticks 5m ‚Äî Binance">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">BINANCE</span><span class="src-cat">KLINES</span></div>
      </div>
      <div class="src-chip" style="--src-color:#00d4aa" title="Market cap, volume, dominance ‚Äî CoinGecko">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">COINGECKO</span><span class="src-cat">MARKET</span></div>
      </div>
      <div class="src-chip" style="--src-color:#aa66ff" title="Perpetual funding rate ‚Äî Kraken Futures">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">FUNDING RATE</span><span class="src-cat">DERIVATIVES</span></div>
      </div>
      <div class="src-chip" style="--src-color:#cc88ff" title="Long/Short ratio ‚Äî market positioning">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">L/S RATIO</span><span class="src-cat">DERIVATIVES</span></div>
      </div>
      <div class="src-chip" style="--src-color:#00ff88" title="Crypto Fear &amp; Greed Index (0‚Äì100)">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">FEAR &amp; GREED</span><span class="src-cat">SENTIMENT</span></div>
      </div>
      <div class="src-chip" style="--src-color:#ff9500" title="Latest crypto news feed ‚Äî CryptoCompare">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">CRYPTOCMP</span><span class="src-cat">NEWS</span></div>
      </div>
      <div class="src-chip" style="--src-color:#ffcc00" title="Latest articles RSS ‚Äî CoinDesk">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">COINDESK</span><span class="src-cat">NEWS</span></div>
      </div>
      <div class="src-chip" style="--src-color:#ff6b35" title="Italian financial news RSS ‚Äî Sole24Ore">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">SOLE24ORE</span><span class="src-cat">NEWS</span></div>
      </div>
      <div class="src-chip" style="--src-color:#ff44aa" title="Historical signal patterns ‚Äî Supabase Memory">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">PATTERNS</span><span class="src-cat">MEMORY</span></div>
      </div>
    </div>
  </div>

  <!-- TAB NAVIGATION + GLOBAL TIME FILTER -->
  <div class="tab-nav">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="dashboard" onclick="switchTab(this)">üìä Dashboard</button>
      <button class="tab-btn"        data-tab="agents"    onclick="switchTab(this)">ü§ñ Agents</button>
      <button class="tab-btn"        data-tab="costs"     onclick="switchTab(this)">üí∞ Costs</button>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
      <span style="font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-right:4px">PERIOD</span>
      <button class="time-pill active" data-period="ALL"   onclick="setTimePeriod(this)">ALL</button>
      <button class="time-pill"        data-period="7D"    onclick="setTimePeriod(this)">7D</button>
      <button class="time-pill"        data-period="24H"   onclick="setTimePeriod(this)">24H</button>
      <button class="time-pill"        data-period="TODAY" onclick="setTimePeriod(this)">TODAY</button>
    </div>
  </div>

  <!-- DASHBOARD TAB -->
  <div id="tab-dashboard" class="tab-content active">

  <!-- API error banner -->
  <div id="apiErrorBanner">
    <div class="err-dot"></div>
    <span id="apiErrorMsg">Railway API non raggiungibile ‚Äî dati non aggiornati</span>
    <span class="err-dismiss" onclick="document.getElementById('apiErrorBanner').classList.remove('visible')" title="Dismiss">‚úï</span>
  </div>

  <!-- 9 KPI tiles -->
  <div class="kpi-grid">
    <div class="kpi blue">
      <div class="kpi-label">BTC Price</div>
      <div class="kpi-value blue" id="kpiPrice">‚Äî</div>
      <div class="kpi-sub">Last entry</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Total Signals</div>
      <div class="kpi-value white" id="kpiTotal">‚Äî</div>
      <div class="kpi-sub">All time</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Accuracy</div>
      <div class="kpi-value green" id="kpiAccuracy">‚Äî</div>
      <div class="kpi-sub">Correct pred.</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Total PnL</div>
      <div class="kpi-value green" id="kpiPnl">‚Äî</div>
      <div class="kpi-sub">USD (real bets)</div>
    </div>
    <div class="kpi purple">
      <div class="kpi-label">Session ROI</div>
      <div class="kpi-value purple" id="kpiRoi">‚Äî</div>
      <div class="kpi-sub" id="kpiRoiSub">since 2026-02-24</div>
    </div>
    <div class="kpi yellow">
      <div class="kpi-label">Win Rate</div>
      <div class="kpi-value yellow" id="kpiWinRate">‚Äî</div>
      <div class="kpi-sub">Executed trades</div>
    </div>
    <div class="kpi yellow">
      <div class="kpi-label">WR NoBet</div>
      <div class="kpi-value yellow" id="kpiWrNoBet">‚Äî</div>
      <div class="kpi-sub">Theoretical pred.</div>
    </div>
    <div class="kpi blue">
      <div class="kpi-label">Fear &amp; Greed</div>
      <div class="kpi-value blue" id="kpiFG">‚Äî</div>
      <div class="kpi-sub" id="kpiFGLabel">Loading...</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Bets Taken</div>
      <div class="kpi-value white" id="kpiBets">‚Äî</div>
      <div class="kpi-sub">Out of total</div>
    </div>
    <div class="kpi red">
      <div class="kpi-label">Max Drawdown</div>
      <div class="kpi-value red" id="kpiDrawdown">‚Äî</div>
      <div class="kpi-sub">Single trade</div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-cell">
      <div class="stat-cell-label">Avg Confidence</div>
      <div class="stat-cell-val" id="statConf" style="color:var(--blue)">‚Äî</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Best Trade PnL</div>
      <div class="stat-cell-val" id="statBest" style="color:var(--accent)">‚Äî</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Current Streak</div>
      <div class="stat-cell-val" id="statStreak" style="color:var(--text)">‚Äî</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Avg Entry Slippage</div>
      <div class="stat-cell-val" id="statSlippage" style="color:var(--warn)">‚Äî</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Avg RR Ratio</div>
      <div class="stat-cell-val" id="statRR" style="color:var(--accent)">‚Äî</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CUMULATIVE EQUITY CURVE
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="panel" style="margin-bottom:14px;">
    <div class="panel-header">
      <div class="panel-title">Cumulative Equity Curve (Real Bets)</div>
      <div class="panel-tag tag-green" id="equityTag">LOADING</div>
    </div>
    <div style="padding:16px 18px 10px;">
      <svg id="equitySvg" class="equity-svg" height="110" viewBox="0 0 1000 110" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CHARTS GRID ‚Äî 4 temporal charts
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="charts-grid">

    <!-- Chart 1: Confidence Over Time -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Confidence Over Time</div>
        <div class="panel-tag tag-blue" id="confTag">ALL</div>
      </div>
      <div style="padding:12px 16px 8px;">
        <svg id="confSvg" width="100%" height="110" viewBox="0 0 600 110" preserveAspectRatio="none"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px;">
          <span>oldest</span><span>newest</span>
        </div>
      </div>
    </div>

    <!-- Chart 2: Rolling Win Rate -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Rolling Win Rate (BETs)</div>
        <div style="display:flex;gap:8px;font-size:9px;color:var(--muted);">
          <span style="color:var(--accent);">‚Äî WR-10</span>
          <span style="color:var(--blue);">‚Äî WR-20</span>
          <span style="color:var(--muted);">‚Äî 50%</span>
        </div>
      </div>
      <div style="padding:12px 16px 8px;">
        <svg id="wrSvg" width="100%" height="110" viewBox="0 0 600 110" preserveAspectRatio="none"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px;">
          <span>oldest bet</span><span>newest bet</span>
        </div>
      </div>
    </div>

    <!-- Chart 3: PnL Per Bet Bar Chart (large) -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">PnL per Bet ($)</div>
        <div class="panel-tag tag-muted" id="pnlBarsTag">REAL BETS</div>
      </div>
      <div style="padding:12px 16px 8px;">
        <div class="pnl-bars-large" id="pnlBarsLarge"></div>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:4px;">
          <span>oldest</span><span>newest</span>
        </div>
      </div>
    </div>

    <!-- Chart 4: BTC Price + Predictions Overlay -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">BTC Price vs Predictions</div>
        <div style="display:flex;gap:8px;font-size:9px;">
          <span style="color:var(--accent);">‚óè correct</span>
          <span style="color:var(--danger);">‚óè wrong</span>
          <span style="color:var(--muted);">‚ñ≤‚ñº = direction</span>
        </div>
      </div>
      <div style="padding:12px 16px 8px;">
        <svg id="btcOverlaySvg" width="100%" height="110" viewBox="0 0 600 110" preserveAspectRatio="none"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px;">
          <span>oldest</span><span>newest</span>
        </div>
      </div>
    </div>

  </div><!-- /.charts-grid -->

  <div class="main-grid">

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title" id="signalLogTitle">Signal Log</div>
        <div class="filters-row">
          <select id="filterDir"   class="filter-sel"><option value="ALL">ALL DIR</option><option value="UP">UP</option><option value="DOWN">DOWN</option></select>
          <select id="filterClass" class="filter-sel"><option value="ALL">ALL</option><option value="BET">BETS</option><option value="NO_BET">NO-BET</option></select>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>DATE/TIME</th>
              <th>DIR</th>
              <th>CONF</th>
              <th>ENTRY $</th>
              <th>EXIT $</th>
              <th>RSI</th>
              <th>EMA</th>
              <th>SCORE</th>
              <th>SIZE</th>
              <th>TYPE</th>
              <th>RESULT</th>
              <th>PNL $ / THR%</th>
              <th>FEE $</th>
              <th>SL/TP</th>
            </tr>
          </thead>
          <tbody id="signalTable"></tbody>
        </table>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:14px;">

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">PnL per Trade</div>
          <div class="panel-tag tag-green" id="totalPnlTag">TOTAL: ‚Äî</div>
        </div>
        <div class="chart-area">
          <div class="pnl-chart" id="pnlChart"></div>
          <div class="bar-labels"><span id="chartStart">‚Äî</span><span>PnL USD</span><span id="chartEnd">‚Äî</span></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Signal Quality</div>
          <div class="panel-tag tag-blue">LIVE</div>
        </div>
        <div class="signal-grid" id="signalQuality"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Confidence Distribution</div>
          <div class="panel-tag tag-yellow">HISTOGRAM</div>
        </div>
        <div class="conf-bars" id="confDist"></div>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ACCOUNT SUMMARY SECTION
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section-divider">
    <div class="section-divider-label">Account Summary</div>
    <div class="section-divider-line"></div>
    <div class="section-divider-ts" id="acctTs">Loading...</div>
  </div>

  <div class="account-summary-grid">

    <!-- WALLET -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">üí∞</span>Wallet</div>
        <div class="panel-tag tag-blue" id="acctWalletTag">‚Äî</div>
      </div>
      <div class="acct-body" id="acctWalletBody">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%"></div>
          <div class="skeleton-line" style="width:80%"></div>
          <div class="skeleton-line" style="width:60%"></div>
          <div class="skeleton-line" style="width:90%"></div>
        </div>
      </div>
    </div>

    <!-- POSITION -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">üìç</span>Position</div>
        <div class="panel-tag" id="acctPositionTag" style="background:rgba(74,96,112,0.15);color:var(--muted);border:1px solid rgba(74,96,112,0.3)">FLAT</div>
      </div>
      <div class="acct-body" id="acctPositionBody">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%"></div>
          <div class="skeleton-line" style="width:70%"></div>
          <div class="skeleton-line" style="width:85%"></div>
        </div>
      </div>
    </div>

    <!-- BTC PRICE -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">‚Çø</span>BTC Live</div>
        <div class="panel-tag tag-green" id="acctBtcTag">‚Äî</div>
      </div>
      <div class="acct-body" id="acctBtcBody">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%"></div>
          <div class="skeleton-line" style="width:75%"></div>
          <div class="skeleton-line" style="width:60%"></div>
        </div>
      </div>
    </div>

    <!-- RECENT FILLS -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">üïê</span>Recent Fills</div>
        <div class="panel-tag tag-yellow" id="acctFillsTag">‚Äî</div>
      </div>
      <div id="acctFillsBody" style="padding:0;">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%;margin:14px 16px 0;width:calc(100% - 32px)"></div>
          <div class="skeleton-line" style="width:90%;margin:0 16px;width:calc(90% - 32px)"></div>
          <div class="skeleton-line" style="width:80%;margin:0 16px 14px;width:calc(80% - 32px)"></div>
        </div>
      </div>
    </div>

  </div>
  <!-- END ACCOUNT SUMMARY -->

  <footer>
    <div class="footer-text">ASTRA DIGITAL MARKETING ¬∑ <span>BOT ENGINE</span> ¬∑ AUTO REFRESH 60s</div>
    <div class="config-hint">Table: <code>btc_predictions</code> ¬∑ Capital: <code id="footerCapital">$20 USDC</code> ¬∑ Refresh <code>60s</code></div>
  </footer>

  </div><!-- /#tab-dashboard -->

  <!-- AGENTS TAB -->
  <div id="tab-agents" class="tab-content">

    <!-- n8n Workflows -->
    <div class="agents-section-header">
      <span>n8n Workflows</span>
      <button class="agents-refresh-btn" onclick="refreshAgentsTab()">‚Üª Refresh</button>
    </div>
    <div id="n8nWorkflowsGrid" class="wf-grid">
      <div style="grid-column:1/-1;padding:20px;color:var(--muted);font-size:11px;letter-spacing:1px">
        Premi Refresh per caricare i workflow n8n.
      </div>
    </div>

    <!-- launchd Agents -->
    <div class="agents-section-header"><span>launchd Agents ‚Äî Mac Local</span></div>
    <div class="panel" style="margin-bottom:14px">
      <div class="panel-header">
        <div class="panel-title">Scheduled Tasks</div>
        <div class="panel-tag tag-muted">LOCAL ¬∑ macOS launchd</div>
      </div>
      <div class="table-wrap">
        <table class="launchd-table">
          <thead>
            <tr>
              <th>AGENT</th>
              <th>LABEL</th>
              <th>SCHEDULE</th>
              <th>LOG</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Health Monitor</td>
              <td><code>com.btcbot.health</code></td>
              <td>Every 1h</td>
              <td style="color:var(--muted);font-size:10px">/tmp/btcbot_health.log</td>
              <td><span class="badge badge-correct">ACTIVE</span></td>
            </tr>
            <tr>
              <td>Daily Report</td>
              <td><code>com.btcbot.daily</code></td>
              <td>Daily 07:00</td>
              <td style="color:var(--muted);font-size:10px">/tmp/btcbot_daily.log</td>
              <td><span class="badge badge-correct">ACTIVE</span></td>
            </tr>
            <tr>
              <td>Weekly Analysis</td>
              <td><code>com.btcbot.weekly</code></td>
              <td>Sun 08:00</td>
              <td style="color:var(--muted);font-size:10px">/tmp/btcbot_weekly.log</td>
              <td><span class="badge badge-correct">ACTIVE</span></td>
            </tr>
            <tr>
              <td>Bet Monitor</td>
              <td><code>com.btcbot.monitor_bets</code></td>
              <td>Every 5min</td>
              <td style="color:var(--muted);font-size:10px">/tmp/btcbot_monitor.log</td>
              <td><span class="badge badge-correct">ACTIVE</span></td>
            </tr>
            <tr>
              <td>XGBoost Retrain</td>
              <td><code>com.btcbot.xgb_retrain</code></td>
              <td>Sun 03:00</td>
              <td style="color:var(--muted);font-size:10px">/tmp/btcbot_xgb_retrain.log</td>
              <td><span class="badge badge-correct">ACTIVE</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div><!-- /#tab-agents -->

  <!-- COSTS TAB -->
  <div id="tab-costs" class="tab-content">

    <!-- 4 KPI -->
    <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px">
      <div class="kpi red" id="costKpiTotal">
        <div class="kpi-label">Total Cost MTD</div>
        <div class="kpi-value red" id="costKpiTotalVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiTotalSub">loading...</div>
      </div>
      <div class="kpi yellow" id="costKpiKraken">
        <div class="kpi-label">Kraken Fees (real)</div>
        <div class="kpi-value yellow" id="costKpiKrakenVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiKrakenSub">loading...</div>
      </div>
      <div class="kpi blue" id="costKpiN8n">
        <div class="kpi-label">n8n Executions</div>
        <div class="kpi-value blue" id="costKpiN8nVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiN8nSub">loading...</div>
      </div>
      <div class="kpi purple" id="costKpiLlm">
        <div class="kpi-label">LLM API (est.)</div>
        <div class="kpi-value purple" id="costKpiLlmVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiLlmSub">loading...</div>
      </div>
    </div>

    <!-- Breakdown -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">üí∏ Cost Breakdown</div>
        <button class="agents-refresh-btn" onclick="refreshCostsTab()">‚Üª Refresh</button>
      </div>
      <div id="costBreakdownBody" style="padding:16px">Loading...</div>
    </div>

  </div><!-- /#tab-costs -->

</div><!-- /.container -->
<script>
const CONFIG = {
  RAILWAY_URL: window.RAILWAY_URL || 'https://web-production-e27d0.up.railway.app',
  BTC_REFRESH: 10000,
  LIMIT: 500,
  REFRESH_INTERVAL: 60000,
  ACCT_REFRESH: 30000,
  CAPITAL: 100,
  SESSION_START: '2026-02-24'  // top-up $100 ‚Äî ROI calcolato da questa data
};

let liveWalletEquity = null;   // aggiornato da renderAccountSummary()
let lastTotalPnl = 0;          // aggiornato da renderAll(), usato per ricalcolare ROI live
let lastSessionPnl = 0;        // PnL solo dal SESSION_START ‚Äî per Session ROI live

const SAMPLE_DATA = [];

function showApiError(msg) {
  const banner = document.getElementById('apiErrorBanner');
  if (!banner) return;
  document.getElementById('apiErrorMsg').textContent = msg || 'Railway API non raggiungibile ‚Äî dati non aggiornati';
  banner.classList.add('visible');
}
function hideApiError() {
  const banner = document.getElementById('apiErrorBanner');
  if (banner) banner.classList.remove('visible');
}

// ‚îÄ‚îÄ ACCOUNT SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchAccountSummary() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/account-summary`, {
      signal: AbortSignal.timeout(8000)
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  } catch(e) {
    console.warn('Account summary fetch error:', e);
    showApiError(`Railway /account-summary non raggiungibile (${e.message})`);
    return null;
  }
}

function fmtUsd(v, decimals = 2) {
  const n = Number(v);
  if (!isFinite(n)) return '‚Äî';
  return '$' + n.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function fmtPnlAcct(v, decimals = 4) {
  if (v === null || v === undefined) return '‚Äî';
  const n = parseFloat(v);
  return (n >= 0 ? '+' : '') + '$' + Math.abs(n).toFixed(decimals);
}

function pnlClass(v) {
  if (v === null || v === undefined) return 'muted';
  return parseFloat(v) > 0 ? 'green' : parseFloat(v) < 0 ? 'red' : 'muted';
}

function renderAccountSummary(data) {
  if (!data || data.status !== 'ok') {
    ['acctWalletBody', 'acctPositionBody', 'acctBtcBody'].forEach(id => {
      document.getElementById(id).innerHTML =
        '<div style="padding:16px;color:var(--danger);font-size:10px;letter-spacing:1px">‚ö†Ô∏è FETCH ERROR</div>';
    });
    return;
  }

  // Timestamp
  const ts = data.timestamp ? new Date(data.timestamp).toLocaleTimeString('it-IT') : '‚Äî';
  document.getElementById('acctTs').textContent = 'Updated: ' + ts;

  // ‚îÄ‚îÄ WALLET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const w = data.wallet || {};
  const equity = parseFloat(w.margin_equity || 0);
  if (equity > 0) {
    liveWalletEquity = equity;
    const roiPct = (lastSessionPnl / equity) * 100;
    const roiEl = document.getElementById('kpiRoi');
    if (roiEl) {
      roiEl.textContent = (roiPct >= 0 ? '+' : '') + roiPct.toFixed(2) + '%';
      roiEl.className   = 'kpi-value ' + (roiPct >= 0 ? 'purple' : 'red');
    }
    const roiSubEl = document.getElementById('kpiRoiSub');
    if (roiSubEl) roiSubEl.textContent =
      (lastSessionPnl >= 0 ? '+' : '') + fmtUsd(lastSessionPnl) + ' ¬∑ ' + fmtUsd(equity) + ' eq.';
    const footerCapEl = document.getElementById('footerCapital');
    if (footerCapEl) footerCapEl.textContent = fmtUsd(equity) + ' equity';
  }
  const usdc   = parseFloat(w.usdc_available || 0);
  const marginUsage = parseFloat(w.margin_usage_pct || 0);
  const unrealPnl = parseFloat(w.pnl_unrealized || 0);
  const funding   = parseFloat(w.funding_unrealized || 0);

  // Tag: total equity
  const walletTag = document.getElementById('acctWalletTag');
  walletTag.textContent = fmtUsd(equity);
  walletTag.className = 'panel-tag ' + (equity >= CONFIG.CAPITAL ? 'tag-green' : 'tag-red');

  // Margin bar color
  let marginBarColor = 'var(--accent)';
  if (marginUsage > 70) marginBarColor = 'var(--danger)';
  else if (marginUsage > 40) marginBarColor = 'var(--warn)';

  document.getElementById('acctWalletBody').innerHTML = `
    <div class="acct-row">
      <span class="acct-row-label">USDC Available</span>
      <span class="acct-row-val blue">${fmtUsd(usdc)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">Margin Equity</span>
      <span class="acct-row-val ${equity >= CONFIG.CAPITAL ? 'green' : 'red'}">${fmtUsd(equity)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">Free Margin</span>
      <span class="acct-row-val">${fmtUsd(w.available_margin)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">Portfolio</span>
      <span class="acct-row-val">${fmtUsd(w.portfolio_value)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">P&amp;L Unrealized</span>
      <span class="acct-row-val ${pnlClass(unrealPnl)}">${fmtPnlAcct(unrealPnl)}</span>
    </div>
    <div class="acct-row">
      <span class="acct-row-label">Funding Accum.</span>
      <span class="acct-row-val ${pnlClass(funding)}">${fmtPnlAcct(funding, 6)}</span>
    </div>
    <div class="margin-bar-wrap">
      <div class="margin-bar-label">
        <span>Margin Usage</span>
        <span style="color:${marginBarColor}">${marginUsage.toFixed(2)}%</span>
      </div>
      <div class="margin-bar-bg">
        <div class="margin-bar-fill" style="width:${Math.min(marginUsage,100)}%;background:${marginBarColor}"></div>
      </div>
    </div>
  `;

  // ‚îÄ‚îÄ POSITION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const pos = data.position || {};
  const posTag = document.getElementById('acctPositionTag');

  if (!pos.open) {
    posTag.textContent = 'FLAT';
    posTag.className = 'panel-tag';
    posTag.style.cssText = 'background:rgba(74,96,112,0.15);color:var(--muted);border:1px solid rgba(74,96,112,0.3)';
    document.getElementById('acctPositionBody').innerHTML = `
      <div class="position-status flat">
        <div class="position-dot"></div>
        FLAT ‚Äî No open position
      </div>
    `;
  } else {
    const side = pos.side || 'unknown';
    const pnl  = parseFloat(pos.pnl || 0);
    const pnlPct = parseFloat(pos.pnl_pct || 0);
    posTag.textContent = side.toUpperCase();
    if (side === 'long') {
      posTag.className = 'panel-tag tag-green';
    } else {
      posTag.className = 'panel-tag tag-red';
    }
    posTag.style.cssText = '';

    const pnlIndicatorClass = pnl > 0 ? 'pos' : pnl < 0 ? 'neg' : 'zero';

    document.getElementById('acctPositionBody').innerHTML = `
      <div class="position-status ${side}">
        <div class="position-dot"></div>
        ${side.toUpperCase()} ‚Äî ${pos.size} BTC
      </div>
      <div class="acct-row">
        <span class="acct-row-label">Entry Price</span>
        <span class="acct-row-val">${fmtUsd(pos.entry_price, 2)}</span>
      </div>
      <div class="acct-row">
        <span class="acct-row-label">Size</span>
        <span class="acct-row-val blue">${pos.size} BTC</span>
      </div>
      <div class="pnl-indicator ${pnlIndicatorClass}" style="margin-top:4px;">
        <span style="font-size:9px;letter-spacing:1px;text-transform:uppercase;opacity:0.7">Unrealized P&amp;L</span>
        <span>${fmtPnlAcct(pnl)} (${pnlPct > 0 ? '+' : ''}${pnlPct}%)</span>
      </div>
    `;
  }

  // ‚îÄ‚îÄ BTC PRICE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const btc = data.btc || {};
  const mark = parseFloat(btc.mark_price || 0);
  const last = parseFloat(btc.last_price || 0);
  const fundingRate = parseFloat(btc.funding_rate_pct || 0);
  const oi = btc.open_interest;

  const btcTag = document.getElementById('acctBtcTag');
  btcTag.textContent = mark > 0 ? fmtUsd(mark, 0) : '‚Äî';

  document.getElementById('acctBtcBody').innerHTML = `
    <div class="btc-mark-big">${mark > 0 ? fmtUsd(mark, 2) : '‚Äî'}</div>
    <div style="font-size:8px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px">MARK PRICE</div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Last Price</span>
      <span class="btc-price-row-val">${fmtUsd(last, 2)}</span>
    </div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Funding Rate</span>
      <span class="btc-price-row-val" style="color:${fundingRate > 0 ? 'var(--danger)' : fundingRate < 0 ? 'var(--accent)' : 'var(--muted)'}">
        ${fundingRate > 0 ? '+' : ''}${fundingRate.toFixed(4)}%
      </span>
    </div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Open Interest</span>
      <span class="btc-price-row-val">${oi != null ? parseFloat(oi).toFixed(2) + ' BTC' : '‚Äî'}</span>
    </div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Vol 24h</span>
      <span class="btc-price-row-val">${btc.volume_24h != null ? parseFloat(btc.volume_24h).toLocaleString('en-US', {maximumFractionDigits:0}) : '‚Äî'}</span>
    </div>
  `;

  // ‚îÄ‚îÄ RECENT FILLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const activity = data.recent_activity || {};
  const fills    = activity.fills || [];
  // realized_pnl_recent is now -(sum of fees) since Kraken fills don't return P&L
  const totalFeesCost = Math.abs(parseFloat(activity.realized_pnl_recent || 0));

  const fillsTag = document.getElementById('acctFillsTag');
  fillsTag.textContent = totalFeesCost > 0 ? '-$' + totalFeesCost.toFixed(5) : '+$0.0000';
  fillsTag.className = 'panel-tag ' + (totalFeesCost > 0 ? 'tag-yellow' : 'tag-green');

  if (!fills.length) {
    document.getElementById('acctFillsBody').innerHTML =
      '<div style="padding:18px 16px;color:var(--muted);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;">No recent fills</div>';
    return;
  }

  const rows = fills.map(f => {
    const side     = (f.side || '').toLowerCase();
    const sideClass = side === 'buy' ? 'fill-buy' : 'fill-sell';
    const sideLabel = side === 'buy' ? '‚ñ≤ BUY' : '‚ñº SELL';
    const fillPnl   = f.pnl != null ? parseFloat(f.pnl) : null;
    const fee       = parseFloat(f.fee || 0);
    const ts        = f.timestamp ? new Date(f.timestamp).toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'}) : '‚Äî';
    return `<tr>
      <td><span class="${sideClass}">${sideLabel}</span></td>
      <td style="color:var(--text)">${parseFloat(f.size || 0).toFixed(4)}</td>
      <td style="color:var(--blue)">${fmtUsd(f.price, 0)}</td>
      <td class="${fillPnl != null ? (fillPnl >= 0 ? 'pnl-pos' : 'pnl-neg') : 'pnl-null'}">${fillPnl != null ? fmtPnlAcct(fillPnl, 4) : '‚Äî'}</td>
      <td style="color:${fee > 0 ? 'var(--warn)' : 'var(--muted)'}">${fee > 0 ? '-$' + fee.toFixed(5) : '‚Äî'}</td>
      <td style="color:var(--muted)">${ts}</td>
    </tr>`;
  }).join('');

  document.getElementById('acctFillsBody').innerHTML = `
    <div style="padding:8px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase">Fees Paid (recent)</span>
      <span style="font-size:12px;font-weight:700;font-family:'Syne',sans-serif;color:var(--warn)">${totalFeesCost > 0 ? '-$' + totalFeesCost.toFixed(5) : '+$0.0000'}</span>
    </div>
    <div style="overflow-x:auto;">
      <table class="fills-table">
        <thead>
          <tr>
            <th>Side</th>
            <th>Size</th>
            <th>Price</th>
            <th>P&amp;L</th>
            <th>Fee</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

async function refreshAccountSummary() {
  const data = await fetchAccountSummary();
  if (data) renderAccountSummary(data);
}

// ‚îÄ‚îÄ SIGNALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchData() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/signals?limit=${CONFIG.LIMIT}`, {
      signal: AbortSignal.timeout(10000)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    hideApiError();
    return data;
  } catch(e) {
    console.warn('Fetch failed:', e);
    showApiError(`Railway /signals non raggiungibile (${e.message}) ‚Äî mostro dati precedenti`);
    return SAMPLE_DATA;
  }
}

function fmtTime(ts) {
  return new Date(ts).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
}
function fmtDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }) + ' '
       + d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
}
function fmtPrice(p) {
  if (p === null || p === undefined) return '‚Äî';
  return '$' + parseFloat(p).toLocaleString('en-US', { maximumFractionDigits: 0 });
}
function fmtConf(c) { return (parseFloat(c) * 100).toFixed(0) + '%'; }
function fmtPnl(v) {
  if (v === null || v === undefined) return '‚Äî';
  const n = parseFloat(v);
  return (n >= 0 ? '+' : '') + '$' + n.toFixed(4);
}
function emaLabel(e) {
  if (!e) return '‚Äî';
  return e.includes('bullish') ? 'üü¢ BULL' : 'üî¥ BEAR';
}

function renderEntryCell(d) {
  if (!d.bet_taken || !d.entry_fill_price) return fmtPrice(d.btc_price_entry);
  const slip = (d.entry_slippage !== null && d.entry_slippage !== undefined) ? parseFloat(d.entry_slippage) : null;
  let slipStr = '';
  if (slip !== null && !isNaN(slip) && slip !== 0) {
    const slipColor = Math.abs(slip) > 20 ? 'var(--danger)' : Math.abs(slip) > 5 ? 'var(--warn)' : 'var(--muted)';
    const slipStr2 = (slip >= 0 ? '+' : '-') + '$' + Math.abs(slip).toFixed(1) + ' slip';
    slipStr = `<span style="display:block;font-size:9px;color:${slipColor};margin-top:1px">${slipStr2}</span>`;
  }
  return `<span style="display:block">${fmtPrice(d.entry_fill_price)}</span>${slipStr}`;
}

function renderSizeCell(d) {
  if (!d.bet_size) return '<span style="color:var(--muted)">‚Äî</span>';
  const size = parseFloat(d.bet_size);
  const reason = d.size_reason || '';
  let multClass = 'base';
  let multLabel = '√ó1.0';
  if (reason.includes('win_streak')) {
    multClass = 'up';
    multLabel = reason.includes('high_conf') ? '√ó1.5' : '√ó1.2';
  } else if (reason.includes('loss_streak')) {
    multClass = 'down';
    multLabel = '√ó0.5';
  } else if (reason.includes('drawdown')) {
    multClass = 'down';
    multLabel = '√ó0.25';
  }
  let reasonDisplay = reason
    .replace('_high_conf', '')
    .replace('_low_conf', '')
    .replace('win_streak_', 'W√ó')
    .replace('loss_streak_', 'L√ó')
    .replace('drawdown_protection', 'drawdown')
    .replace('insufficient_history', 'no hist.')
    .replace('base', '‚Äî');
  return `<span class="size-val">${size.toFixed(5)}</span>` +
         `<span class="size-mult ${multClass}">${multLabel} ${reasonDisplay}</span>`;
}

let currentPeriod = 'ALL';
let allData = [];

function setTimePeriod(btn) {
  document.querySelectorAll('.time-pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentPeriod = btn.dataset.period;
  renderAll(allData);
}

function filterByPeriod(data) {
  if (currentPeriod === 'ALL') return data;
  const now = new Date();
  let cutoff;
  if      (currentPeriod === 'TODAY') cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  else if (currentPeriod === '24H')   cutoff = new Date(now - 86400000);
  else if (currentPeriod === '7D')    cutoff = new Date(now - 7 * 86400000);
  return data.filter(d => new Date(d.created_at) >= cutoff);
}

function updateBotStatus(data) {
  if (!data || !data.length) return;
  const latest = data[0];
  if (!latest || !latest.created_at) return;
  const minutesAgo = Math.floor((new Date() - new Date(latest.created_at)) / 60000);
  const el       = document.getElementById('botStatus');
  const textEl   = document.getElementById('botStatusText');
  const detailEl = document.getElementById('botStatusDetail');
  const timeStr  = new Date(latest.created_at).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
  const timeLabel= minutesAgo < 1 ? 'just now' : minutesAgo + ' min ago';
  detailEl.textContent = 'Last: ' + timeStr + ' (' + timeLabel + ')';
  el.className = 'bot-status';
  if      (minutesAgo <= 8)  { el.classList.add('alive');   textEl.textContent = 'BOT ALIVE'; }
  else if (minutesAgo <= 20) { el.classList.add('warning'); textEl.textContent = 'BOT SLOW ‚ö†Ô∏è'; }
  else                       { el.classList.add('dead');    textEl.textContent = 'üö® BOT OFFLINE'; detailEl.textContent = 'No signal for ' + minutesAgo + ' min!'; }
}

let lastBtcPrice = null;
async function fetchLiveBtcPrice() {
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/btc-price', { signal: AbortSignal.timeout(5000) });
    if (!res.ok) throw new Error();
    const data  = await res.json();
    const price = data.mark_price || data.last_price;
    if (!price) return;
    const priceEl  = document.getElementById('btcLivePrice');
    const changeEl = document.getElementById('btcPriceChange');
    if (lastBtcPrice !== null) {
      const diff    = price - lastBtcPrice;
      const diffPct = ((diff / lastBtcPrice) * 100).toFixed(3);
      priceEl.className  = 'btc-live-price ' + (diff >= 0 ? 'up' : 'down');
      changeEl.className = 'btc-price-change ' + (diff >= 0 ? 'pos' : 'neg');
      changeEl.textContent = (diff >= 0 ? '+' : '') + diffPct + '%';
    }
    priceEl.textContent = '$' + price.toLocaleString('it-IT', { maximumFractionDigits: 0 });
    lastBtcPrice = price;
  } catch(e) {
    const priceEl = document.getElementById('btcLivePrice');
    if (priceEl.textContent === '‚Äî' && allData.length) {
      const last = allData.find(d => d.btc_price_entry);
      if (last) priceEl.textContent = '$' + Number(last.btc_price_entry).toLocaleString('it-IT', { maximumFractionDigits: 0 });
    }
  }
}

function renderAll(data) {
  const filtered = filterByPeriod(data);
  const titleEl  = document.getElementById('signalLogTitle');
  titleEl.textContent = currentPeriod === 'ALL'
    ? 'Signal Log'
    : `Signal Log ¬∑ ${filtered.length} signals (${currentPeriod})`;
  render(filtered);
}

function render(data) {
  updateBotStatus(data);
  document.getElementById('lastUpdate').innerHTML =
    `LAST UPDATE: <strong>${new Date().toLocaleTimeString('it-IT')}</strong>`;

  const bets        = data.filter(d => d.classification === 'BET');
  const realBets    = bets.filter(d => d.pnl_usd !== null);
  const closedBets  = bets.filter(d => d.correct !== null);
  const correctBets = closedBets.filter(d => d.correct === true);
  const closed      = data.filter(d => d.correct !== null);
  const correct     = closed.filter(d => d.correct === true);

  const totalPnl   = realBets.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  lastTotalPnl = totalPnl;
  const capitalBase = liveWalletEquity || CONFIG.CAPITAL;

  // Session ROI: solo bets dal top-up $100 (2026-02-24)
  const sessionBets = realBets.filter(d => d.created_at && d.created_at.slice(0, 10) >= CONFIG.SESSION_START);
  const sessionPnl  = sessionBets.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  lastSessionPnl = sessionPnl;
  const roiPct      = (sessionPnl / capitalBase) * 100;
  const avgConf  = data.length ? data.reduce((s, d) => s + parseFloat(d.confidence || 0), 0) / data.length : 0;
  const pnlVals  = realBets.map(d => parseFloat(d.pnl_usd || 0));
  const bestPnl  = pnlVals.length ? Math.max(...pnlVals) : 0;
  const worstPnl = pnlVals.length ? Math.min(...pnlVals) : 0;

  const lastEntry = data.find(d => d.btc_price_entry);
  const lastFG    = lastEntry ? lastEntry.fear_greed_value : null;

  document.getElementById('kpiPrice').textContent   = lastEntry ? fmtPrice(lastEntry.btc_price_entry) : '‚Äî';
  document.getElementById('kpiTotal').textContent   = data.length;

  const accEl = document.getElementById('kpiAccuracy');
  accEl.textContent = closed.length ? Math.round(correct.length / closed.length * 100) + '%' : '‚Äî';

  const pnlEl = document.getElementById('kpiPnl');
  pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(4);
  pnlEl.className   = 'kpi-value ' + (totalPnl >= 0 ? 'green' : 'red');

  const roiEl = document.getElementById('kpiRoi');
  roiEl.textContent = (roiPct >= 0 ? '+' : '') + roiPct.toFixed(2) + '%';
  roiEl.className   = 'kpi-value ' + (roiPct >= 0 ? 'purple' : 'red');
  document.getElementById('kpiRoiSub').textContent =
    (sessionPnl >= 0 ? '+' : '') + fmtUsd(sessionPnl) + ' ¬∑ ' + fmtUsd(capitalBase) + ' eq.';
  document.getElementById('footerCapital').textContent = fmtUsd(capitalBase) + ' equity';

  document.getElementById('kpiWinRate').textContent = closedBets.length ? Math.round(correctBets.length / closedBets.length * 100) + '%' : '‚Äî';
  const noBets        = data.filter(d => d.classification === 'NO_BET');
  const noBetsClosed  = noBets.filter(d => d.correct !== null);
  const noBetsCorrect = noBetsClosed.filter(d => d.correct === true);
  document.getElementById('kpiWrNoBet').textContent = noBetsClosed.length ? Math.round(noBetsCorrect.length / noBetsClosed.length * 100) + '%' : '‚Äî';
  document.getElementById('kpiFG').textContent      = lastFG !== null ? lastFG : '‚Äî';
  document.getElementById('kpiFGLabel').textContent = lastFG !== null
    ? (lastFG < 20 ? 'EXTREME FEAR' : lastFG < 40 ? 'FEAR' : lastFG < 60 ? 'NEUTRAL' : lastFG < 80 ? 'GREED' : 'EXTREME GREED') : '';
  document.getElementById('kpiBets').textContent    = bets.length + '/' + data.length;
  document.getElementById('kpiDrawdown').textContent= worstPnl ? '$' + worstPnl.toFixed(4) : '‚Äî';

  document.getElementById('statConf').textContent  = (avgConf * 100).toFixed(1) + '%';
  document.getElementById('statBest').textContent  = bestPnl  ? '+$' + bestPnl.toFixed(4)  : '‚Äî';
  const closedBetsDesc = bets.filter(d => d.correct !== null);
  let streak = 0, streakType = null;
  if (closedBetsDesc.length) {
    streakType = closedBetsDesc[0].correct ? 'W' : 'L';
    for (const b of closedBetsDesc) {
      if ((b.correct ? 'W' : 'L') === streakType) streak++;
      else break;
    }
  }
  const streakEl = document.getElementById('statStreak');
  streakEl.textContent = streak > 0 ? streakType + '√ó' + streak : '‚Äî';
  streakEl.style.color = streakType === 'W' ? 'var(--accent)' : streakType === 'L' ? 'var(--danger)' : 'var(--muted)';
  const betsWithSlip = realBets.filter(d => d.entry_slippage !== null && d.entry_slippage !== undefined);
  const avgSlip = betsWithSlip.length
    ? betsWithSlip.reduce((s, d) => s + parseFloat(d.entry_slippage || 0), 0) / betsWithSlip.length
    : null;
  const slipEl = document.getElementById('statSlippage');
  slipEl.textContent = avgSlip !== null ? (avgSlip >= 0 ? '+' : '') + '$' + avgSlip.toFixed(2) : '‚Äî';
  slipEl.style.color = avgSlip === null ? 'var(--muted)' : Math.abs(avgSlip) > 20 ? 'var(--danger)' : Math.abs(avgSlip) > 5 ? 'var(--warn)' : 'var(--accent)';
  const betsWithRR = bets.filter(d => d.rr_ratio !== null && d.rr_ratio !== undefined);
  const avgRR = betsWithRR.length
    ? betsWithRR.reduce((s, d) => s + parseFloat(d.rr_ratio || 0), 0) / betsWithRR.length
    : null;
  const rrEl = document.getElementById('statRR');
  rrEl.textContent = avgRR !== null ? avgRR.toFixed(2) + '√ó' : '‚Äî';
  rrEl.style.color = avgRR === null ? 'var(--muted)' : avgRR >= 2 ? 'var(--accent)' : avgRR >= 1.5 ? 'var(--warn)' : 'var(--danger)';

  renderTable(data);

  const chronoBets = [...realBets].reverse();
  renderPnlChart(chronoBets);
  renderSignalQuality(data);
  renderConfDist(data);
  renderEquityCurve(chronoBets, totalPnl);

  // Charts Grid (4 temporal charts)
  const chronoAll = [...data].reverse();
  renderConfidenceOverTime(chronoAll);
  renderRollingWinRate(chronoBets);
  renderPnlBarsLarge(chronoBets);
  renderBtcPredictionsOverlay(chronoAll);

  const tag = document.getElementById('totalPnlTag');
  tag.textContent = 'TOTAL: ' + (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(4);
  tag.className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');
}

function renderTable(data) {
  const dirFilter   = document.getElementById('filterDir').value;
  const classFilter = document.getElementById('filterClass').value;
  const filtered = data.filter(d => {
    if (dirFilter   !== 'ALL' && d.direction      !== dirFilter)   return false;
    if (classFilter !== 'ALL' && d.classification !== classFilter) return false;
    return true;
  });
  const tbody = document.getElementById('signalTable');
  if (!filtered.length) {
    tbody.innerHTML = '<tr class="no-data-row"><td colspan="15">NO DATA</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(d => {
    const dirCls  = d.direction === 'UP' ? 'dir-up' : 'dir-down';
    const dirIcon = d.direction === 'UP' ? '‚Üë' : '‚Üì';
    let betBadge;
    if      (d.classification === 'BET')     betBadge = '<span class="badge badge-bet">BET</span>';
    else if (d.classification === 'SKIP')    betBadge = '<span class="badge badge-skip">SKIP</span>';
    else if (d.classification === 'ALERT')   betBadge = '<span class="badge badge-alert">ALERT</span>';
    else if (d.classification === 'PENDING') betBadge = '<span class="badge badge-pending">PEND</span>';
    else                                     betBadge = '<span class="badge badge-nobet">NO BET</span>';
    const isDry = (d.entry_order_id || '').startsWith('DRY_');
    let resultBadge;
    const isBet = d.classification === 'BET' && d.bet_taken;
    if (d.correct === true) {
      resultBadge = isDry
        ? '<span class="badge" style="background:rgba(0,255,136,0.06);color:rgba(0,255,136,0.6);border:1px solid rgba(0,255,136,0.2)">‚úì SIM WIN</span>'
        : isBet
          ? '<span class="badge badge-correct">‚úì WIN</span>'
          : '<span class="badge badge-correct" style="opacity:0.75">‚úì RIGHT</span>';
    } else if (d.correct === false) {
      resultBadge = isDry
        ? '<span class="badge" style="background:rgba(255,68,102,0.06);color:rgba(255,68,102,0.6);border:1px solid rgba(255,68,102,0.2)">‚úó SIM LOSS</span>'
        : isBet
          ? '<span class="badge badge-wrong">‚úó LOSS</span>'
          : '<span class="badge badge-wrong" style="opacity:0.75">‚úó WRONG</span>';
    } else {
      resultBadge = isBet
        ? '<span style="color:var(--warn);font-size:9px;letter-spacing:1px">‚è≥ OPEN</span>'
        : '<span style="color:var(--muted);font-size:10px;">‚Äî</span>';
    }
    const pnlCls    = d.pnl_usd === null ? 'pnl-null' : parseFloat(d.pnl_usd) >= 0 ? 'pnl-pos' : 'pnl-neg';
    const score     = (d.technical_score !== null && d.technical_score !== undefined) ? parseFloat(d.technical_score).toFixed(1) : '‚Äî';
    const scoreColor= parseFloat(d.technical_score) >= 0 ? 'var(--accent)' : 'var(--danger)';
    // EXIT $: use actual fill price first, fallback to signal exit price
    const exitPrice = d.exit_fill_price ?? d.btc_price_exit;
    // PNL cell: real $ for BETs, theoretical % for NO BETs
    let pnlCell;
    if (d.classification === 'BET') {
      pnlCell = `<span class="${pnlCls}">${fmtPnl(d.pnl_usd)}</span>`;
    } else if (d.pnl_pct !== null && d.pnl_pct !== undefined) {
      const pct = parseFloat(d.pnl_pct);
      const pctCls = pct >= 0 ? 'pnl-pos' : 'pnl-neg';
      const pctSign = pct >= 0 ? '+' : '';
      pnlCell = `<span class="${pctCls}" style="font-style:italic;opacity:0.7;font-size:10px">${pctSign}${pct.toFixed(2)}%</span>`;
    } else {
      pnlCell = `<span class="pnl-null">‚Äî</span>`;
    }
    const TAKER_RATE = 0.00005;
    let feeCell = '<span style="color:var(--muted)">‚Äî</span>';
    if (d.classification === 'BET' && d.bet_taken) {
      const feeVal = (d.fees_total !== null && d.fees_total !== undefined)
        ? parseFloat(d.fees_total)
        : (() => {
            const sz = parseFloat(d.bet_size || 0);
            const ep = parseFloat(d.entry_fill_price || 0);
            const xp = parseFloat(d.exit_fill_price || d.btc_price_exit || 0);
            return sz * (ep + xp) * TAKER_RATE;
          })();
      if (feeVal > 0) feeCell = `<span style="color:var(--warn);font-size:10px">-$${feeVal.toFixed(5)}</span>`;
    }
    return `<tr>
      <td style="color:var(--muted)">${d.id}</td>
      <td style="color:var(--muted)">${fmtDate(d.created_at)}</td>
      <td class="${dirCls}">${dirIcon} ${d.direction}</td>
      <td>${fmtConf(d.confidence)}</td>
      <td>${renderEntryCell(d)}</td>
      <td>${fmtPrice(exitPrice)}</td>
      <td>${d.rsi14 ? parseFloat(d.rsi14).toFixed(1) : '‚Äî'}</td>
      <td>${emaLabel(d.ema_trend)}</td>
      <td style="color:${scoreColor}">${score}</td>
      <td>${renderSizeCell(d)}</td>
      <td>${betBadge}</td>
      <td>${resultBadge}</td>
      <td>${pnlCell}</td>
      <td>${feeCell}</td>
      <td>${d.sl_price || d.tp_price || d.rr_ratio ? `<span style="font-size:9px;color:var(--danger)">SL ${d.sl_price ? fmtPrice(d.sl_price) : '‚Äî'}</span><br><span style="font-size:9px;color:var(--accent)">TP ${d.tp_price ? fmtPrice(d.tp_price) : '‚Äî'}</span><br><span style="font-size:9px;color:var(--muted)">RR ${d.rr_ratio ? parseFloat(d.rr_ratio).toFixed(2) + '√ó' : '‚Äî'}</span>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>
    </tr>`;
  }).join('');
}

function renderPnlChart(chronoBets) {
  if (!chronoBets.length) return;
  const chart  = document.getElementById('pnlChart');
  const maxAbs = Math.max(...chronoBets.map(d => Math.abs(parseFloat(d.pnl_usd || 0))));
  const maxH   = 82;
  chart.innerHTML = chronoBets.map(d => {
    const v   = parseFloat(d.pnl_usd || 0);
    const h   = maxAbs > 0 ? Math.max(2, Math.abs(v) / maxAbs * maxH) : 2;
    const cls = v > 0 ? 'pos' : v < 0 ? 'neg' : 'zero';
    return `<div class="bar ${cls}" style="height:${h}px"><div class="tooltip">${fmtPnl(v)}</div></div>`;
  }).join('');
  const times = chronoBets.map(d => fmtTime(d.created_at));
  document.getElementById('chartStart').textContent = times[0];
  document.getElementById('chartEnd').textContent   = times[times.length - 1];
}

function renderSignalQuality(data) {
  const pct = (arr, fn) => arr.length ? Math.round(arr.filter(fn).length / arr.length * 100) : 0;
  const upClosed  = data.filter(d => d.direction === 'UP'   && d.correct !== null);
  const dnClosed  = data.filter(d => d.direction === 'DOWN' && d.correct !== null);

  const betsWithPnl = data.filter(d => d.classification === 'BET' && d.pnl_usd !== null);
  const grossWin  = betsWithPnl.filter(d => parseFloat(d.pnl_usd) > 0).reduce((s, d) => s + parseFloat(d.pnl_usd), 0);
  const grossLoss = Math.abs(betsWithPnl.filter(d => parseFloat(d.pnl_usd) < 0).reduce((s, d) => s + parseFloat(d.pnl_usd), 0));
  const pf = grossLoss > 0 ? grossWin / grossLoss : grossWin > 0 ? 99 : 0;
  const pfLabel = betsWithPnl.length ? pf.toFixed(2) + 'x' : '‚Äî';

  const totalPnlSig = betsWithPnl.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  const avgPnl = betsWithPnl.length ? totalPnlSig / betsWithPnl.length : 0;
  const avgPnlLabel = betsWithPnl.length ? (avgPnl >= 0 ? '+' : '') + '$' + avgPnl.toFixed(4) : '‚Äî';

  const metrics = [
    { label: 'Profit Factor',        barVal: Math.min(pf / 2 * 100, 100), displayVal: pfLabel,    color: pf >= 1 ? 'var(--accent)' : 'var(--danger)' },
    { label: 'Avg PnL / Trade',      barVal: 50,                           displayVal: avgPnlLabel, color: avgPnl >= 0 ? 'var(--accent)' : 'var(--danger)' },
    { label: 'UP Signal Accuracy',   barVal: pct(upClosed, d => d.correct), displayVal: null,      color: 'var(--accent)' },
    { label: 'DOWN Signal Accuracy', barVal: pct(dnClosed, d => d.correct), displayVal: null,      color: 'var(--danger)' },
    { label: 'Bet Coverage',         barVal: data.length ? Math.round(data.filter(d => d.classification === 'BET').length / data.length * 100) : 0, displayVal: null, color: 'var(--warn)' },
  ];
  document.getElementById('signalQuality').innerHTML = metrics.map(m => `
    <div class="signal-row">
      <div class="signal-meta">
        <span class="signal-label">${m.label}</span>
        <span class="signal-val" style="color:${m.color}">${m.displayVal !== null ? m.displayVal : m.barVal + '%'}</span>
      </div>
      <div class="signal-bar-bg"><div class="signal-bar-fill" style="width:${m.barVal}%;background:${m.color}"></div></div>
    </div>`).join('');
}

function renderConfDist(data) {
  const buckets = [
    { label: '50-54%', min: 0.50, max: 0.55 },
    { label: '55-59%', min: 0.55, max: 0.60 },
    { label: '60-64%', min: 0.60, max: 0.65 },
    { label: '65-69%', min: 0.65, max: 0.70 },
    { label: '70%+',   min: 0.70, max: 1.01 },
  ];
  const counts   = buckets.map(b => ({ ...b, count: data.filter(d => { const c = parseFloat(d.confidence); return c >= b.min && c < b.max; }).length }));
  const maxCount = Math.max(...counts.map(c => c.count), 1);
  document.getElementById('confDist').innerHTML = counts.map(c => `
    <div class="conf-row">
      <div class="conf-label">${c.label}</div>
      <div class="conf-bar-bg"><div class="conf-bar-fill" style="width:${Math.round(c.count / maxCount * 100)}%"></div></div>
      <div class="conf-count">${c.count}</div>
    </div>`).join('');
}

function renderEquityCurve(chronoBets, totalPnl) {
  const svg = document.getElementById('equitySvg');
  if (!chronoBets.length) { svg.innerHTML = ''; return; }
  let cum = 0;
  const points = [{ i: 0, cum: 0 }];
  chronoBets.forEach((d, i) => { cum += parseFloat(d.pnl_usd || 0); points.push({ i: i+1, cum }); });
  const minV = Math.min(...points.map(p => p.cum));
  const maxV = Math.max(...points.map(p => p.cum));
  const range= maxV - minV || 0.001;
  const W = 1000, H = 100;
  const toX = i => (i / (points.length - 1)) * W;
  const toY = v => H - ((v - minV) / range) * (H - 10) - 5;
  const pts  = points.map((p, i) => `${toX(i).toFixed(1)},${toY(p.cum).toFixed(1)}`).join(' ');
  const areaClose = `${toX(points.length-1).toFixed(1)},${H} 0,${H}`;
  const color  = totalPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
  const gradId = totalPnl >= 0 ? 'eqG' : 'eqGR';
  svg.innerHTML = `
    <defs>
      <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pts} ${areaClose}" fill="url(#${gradId})"/>
    <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${toX(points.length-1).toFixed(1)}" cy="${toY(points[points.length-1].cum).toFixed(1)}" r="3.5" fill="${color}"/>`;
  document.getElementById('equityTag').textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(4);
  document.getElementById('equityTag').className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');
}

// ‚îÄ‚îÄ CHARTS GRID FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderConfidenceOverTime(chronoAll) {
  const svg = document.getElementById('confSvg');
  if (!chronoAll.length) { svg.innerHTML = ''; return; }
  const W = 600, H = 100;
  const minConf = 0.50, maxConf = 1.0;
  const toY = c => H - ((c - minConf) / (maxConf - minConf)) * (H - 10) - 5;
  const pts = chronoAll.map((d, i) => {
    const x = (i / Math.max(chronoAll.length - 1, 1)) * W;
    return `${x.toFixed(1)},${toY(parseFloat(d.confidence || 0.5)).toFixed(1)}`;
  }).join(' ');
  const threshY = toY(0.60);
  const avgConf = chronoAll.reduce((s, d) => s + parseFloat(d.confidence || 0.5), 0) / chronoAll.length;
  const lastX = ((chronoAll.length - 1) / Math.max(chronoAll.length - 1, 1)) * W;
  const lastY = toY(parseFloat(chronoAll[chronoAll.length - 1].confidence || 0.5));
  svg.innerHTML = `
    <defs>
      <linearGradient id="confG" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--blue)" stop-opacity="0.25"/>
        <stop offset="100%" stop-color="var(--blue)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pts} ${W},${H} 0,${H}" fill="url(#confG)"/>
    <line x1="0" y1="${threshY.toFixed(1)}" x2="${W}" y2="${threshY.toFixed(1)}" stroke="var(--muted)" stroke-width="0.8" stroke-dasharray="4,3"/>
    <text x="4" y="${(threshY - 3).toFixed(1)}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono,monospace">60%</text>
    <polyline points="${pts}" fill="none" stroke="var(--blue)" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${lastX.toFixed(1)}" cy="${lastY.toFixed(1)}" r="3" fill="var(--blue)"/>`;
  document.getElementById('confTag').textContent = 'AVG ' + (avgConf * 100).toFixed(1) + '%';
}

function renderRollingWinRate(chronoBets) {
  const svg = document.getElementById('wrSvg');
  const closed = chronoBets.filter(d => d.correct !== null);
  if (closed.length < 3) {
    svg.innerHTML = '<text x="10" y="55" fill="var(--muted)" font-size="10" font-family="JetBrains Mono,monospace">Not enough data (need 3+ bets)</text>';
    return;
  }
  const W = 600, H = 100;
  const toX = i => (i / Math.max(closed.length - 1, 1)) * W;
  const toY = pct => H - (pct / 100) * (H - 10) - 5;
  const wr10pts = [], wr20pts = [];
  closed.forEach((d, i) => {
    const s10 = closed.slice(Math.max(0, i - 9), i + 1);
    const s20 = closed.slice(Math.max(0, i - 19), i + 1);
    wr10pts.push(`${toX(i).toFixed(1)},${toY(s10.filter(x => x.correct).length / s10.length * 100).toFixed(1)}`);
    wr20pts.push(`${toX(i).toFixed(1)},${toY(s20.filter(x => x.correct).length / s20.length * 100).toFixed(1)}`);
  });
  const line50Y = toY(50);
  svg.innerHTML = `
    <line x1="0" y1="${line50Y.toFixed(1)}" x2="${W}" y2="${line50Y.toFixed(1)}" stroke="var(--muted)" stroke-width="0.8" stroke-dasharray="4,3"/>
    <text x="4" y="${(line50Y - 3).toFixed(1)}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono,monospace">50%</text>
    <polyline points="${wr20pts.join(' ')}" fill="none" stroke="var(--blue)" stroke-width="1.2" stroke-linejoin="round" opacity="0.6"/>
    <polyline points="${wr10pts.join(' ')}" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linejoin="round"/>
    <circle cx="${toX(closed.length-1).toFixed(1)}" cy="${wr10pts[wr10pts.length-1].split(',')[1]}" r="3" fill="var(--accent)"/>`;
}

function renderPnlBarsLarge(chronoBets) {
  const container = document.getElementById('pnlBarsLarge');
  if (!chronoBets.length) {
    container.innerHTML = '<span style="color:var(--muted);font-size:10px">No data</span>';
    document.getElementById('pnlBarsTag').textContent = 'REAL BETS';
    return;
  }
  const maxAbs = Math.max(...chronoBets.map(d => Math.abs(parseFloat(d.pnl_usd || 0))), 0.0001);
  const maxH = 120;
  container.innerHTML = chronoBets.map(d => {
    const v = parseFloat(d.pnl_usd || 0);
    const h = Math.max(2, Math.abs(v) / maxAbs * maxH);
    const cls = v > 0 ? 'pos' : v < 0 ? 'neg' : 'zero';
    const label = (v >= 0 ? '+' : '') + '$' + v.toFixed(4);
    return `<div class="bar ${cls}" style="height:${h}px;flex:1;min-width:2px;max-width:14px;" title="${label}"><div class="tooltip">${label}</div></div>`;
  }).join('');
  document.getElementById('pnlBarsTag').textContent = chronoBets.length + ' BETS';
}

function renderBtcPredictionsOverlay(chronoAll) {
  const svg = document.getElementById('btcOverlaySvg');
  const pts = chronoAll.filter(d => d.btc_price_entry && parseFloat(d.btc_price_entry) > 0);
  if (pts.length < 2) {
    svg.innerHTML = '<text x="10" y="55" fill="var(--muted)" font-size="10" font-family="JetBrains Mono,monospace">Not enough data</text>';
    return;
  }
  const W = 600, H = 100;
  const prices = pts.map(d => parseFloat(d.btc_price_entry));
  const minP = Math.min(...prices), maxP = Math.max(...prices);
  const range = maxP - minP || 1;
  const toX = i => (i / Math.max(pts.length - 1, 1)) * W;
  const toY = p => H - ((p - minP) / range) * (H - 14) - 7;
  const pricePts = pts.map((d, i) => `${toX(i).toFixed(1)},${toY(parseFloat(d.btc_price_entry)).toFixed(1)}`).join(' ');
  const markers = pts.map((d, i) => {
    if (d.correct === null || d.classification !== 'BET') return '';
    const x = toX(i), y = toY(parseFloat(d.btc_price_entry));
    const color = d.correct ? 'var(--accent)' : 'var(--danger)';
    const isUp = d.direction === 'UP';
    const tri = isUp
      ? `${x.toFixed(1)},${(y-9).toFixed(1)} ${(x-4).toFixed(1)},${(y-1).toFixed(1)} ${(x+4).toFixed(1)},${(y-1).toFixed(1)}`
      : `${x.toFixed(1)},${(y+9).toFixed(1)} ${(x-4).toFixed(1)},${(y+1).toFixed(1)} ${(x+4).toFixed(1)},${(y+1).toFixed(1)}`;
    return `<polygon points="${tri}" fill="${color}" opacity="0.9"/>`;
  }).join('');
  svg.innerHTML = `
    <defs>
      <linearGradient id="btcG" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--muted)" stop-opacity="0.15"/>
        <stop offset="100%" stop-color="var(--muted)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pricePts} ${W},${H} 0,${H}" fill="url(#btcG)"/>
    <polyline points="${pricePts}" fill="none" stroke="var(--muted)" stroke-width="1.2" stroke-linejoin="round" opacity="0.6"/>
    ${markers}`;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function refresh() {
  try { allData = await fetchData(); renderAll(allData); }
  catch(e) { console.error('Render error:', e); }
}

document.getElementById('filterDir').addEventListener('change',   () => renderTable(filterByPeriod(allData)));
document.getElementById('filterClass').addEventListener('change', () => renderTable(filterByPeriod(allData)));

// ‚îÄ‚îÄ TAB SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function switchTab(btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const targetTab = btn.dataset.tab;
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + targetTab).classList.add('active');
  if (targetTab === 'agents') refreshAgentsTab();
  if (targetTab === 'costs')  refreshCostsTab();
}

// ‚îÄ‚îÄ AGENTS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function refreshAgentsTab() {
  const grid = document.getElementById('n8nWorkflowsGrid');
  grid.innerHTML = '<div style="grid-column:1/-1;padding:20px;color:var(--muted);font-size:11px;letter-spacing:1px">Loading n8n workflows<span class="loading">...</span></div>';
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/n8n-status', { signal: AbortSignal.timeout(15000) });
    const data = res.ok ? await res.json() : null;
    renderAgents(data);
  } catch(e) {
    renderAgents(null, e.message);
  }
}

function renderAgents(data, errorMsg) {
  const grid = document.getElementById('n8nWorkflowsGrid');
  if (!data || data.status !== 'ok') {
    const errDetail = errorMsg || (data && data.error) || 'Railway non raggiungibile';
    const hint = (data && data.error && data.error.includes('N8N_API_KEY'))
      ? '<br><span style="font-size:10px;color:var(--muted)">Configura <code style="color:var(--blue)">N8N_API_KEY</code> su Railway per abilitare questo pannello</span>'
      : '';
    grid.innerHTML = `<div style="grid-column:1/-1;padding:24px 16px;color:var(--danger);font-size:11px;letter-spacing:1px">‚ö†Ô∏è n8n status non disponibile: ${errDetail}${hint}</div>`;
    return;
  }
  const wfs = data.workflows || [];
  if (!wfs.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;padding:24px;color:var(--muted);font-size:11px">No workflows found</div>';
    return;
  }
  grid.innerHTML = wfs.map(wf => {
    const isActive = wf.active;
    const lastEx   = wf.last_execution;
    let lastExHtml = '<div class="wf-card-meta" style="color:var(--muted)">No executions</div>';
    if (lastEx) {
      const when = lastEx.started_at ? new Date(lastEx.started_at).toLocaleString('it-IT') : '‚Äî';
      const statusTag = lastEx.status === 'success'
        ? `<span class="panel-tag tag-green" style="font-size:8px">SUCCESS</span>`
        : lastEx.status === 'error'
          ? `<span class="panel-tag tag-red" style="font-size:8px">ERROR</span>`
          : `<span class="panel-tag tag-yellow" style="font-size:8px">${(lastEx.status||'?').toUpperCase()}</span>`;
      lastExHtml = `<div class="wf-card-meta">${statusTag}<span>${when}</span></div>`;
    }
    return `
    <div class="wf-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
        <div class="wf-card-name">${wf.name || '‚Äî'}</div>
        <span class="panel-tag ${isActive ? 'tag-green' : 'tag-muted'}" style="flex-shrink:0;font-size:8px">${isActive ? 'ACTIVE' : 'INACTIVE'}</span>
      </div>
      <div class="wf-card-id">${wf.id}</div>
      ${lastExHtml}
    </div>`;
  }).join('');
}

// Start everything
refresh();
setInterval(refresh, CONFIG.REFRESH_INTERVAL);

fetchLiveBtcPrice();
setInterval(fetchLiveBtcPrice, CONFIG.BTC_REFRESH);

refreshAccountSummary();
setInterval(refreshAccountSummary, CONFIG.ACCT_REFRESH);

// ‚îÄ‚îÄ COSTS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function refreshCostsTab() {
  const body = document.getElementById('costBreakdownBody');
  body.innerHTML = 'Loading<span class="loading">...</span>';
  ['costKpiTotalVal','costKpiKrakenVal','costKpiN8nVal','costKpiLlmVal'].forEach(id => {
    document.getElementById(id).textContent = '‚Äî';
  });
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/costs', { signal: AbortSignal.timeout(10000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    renderCosts(data);
  } catch(e) {
    body.innerHTML = `<span style="color:var(--danger);font-size:11px">‚ö†Ô∏è Errore: ${e.message}</span>`;
  }
}

function renderCosts(d) {
  // KPI
  const fmtUsd = v => '$' + (v ?? 0).toFixed(2);
  document.getElementById('costKpiTotalVal').textContent  = fmtUsd(d.total_usd);
  document.getElementById('costKpiTotalSub').textContent  = d.cached ? 'parzialmente cached' : 'live';
  document.getElementById('costKpiKrakenVal').textContent = fmtUsd(d.kraken_fees?.total_usd);
  document.getElementById('costKpiKrakenSub').textContent = `${d.kraken_fees?.trade_count ?? 0} trade chiusi`;
  document.getElementById('costKpiN8nVal').textContent    = (d.n8n?.pct_used ?? 0).toFixed(1) + '%';
  document.getElementById('costKpiN8nSub').textContent    = `${d.n8n?.executions_est ?? 0} / ${d.n8n?.limit ?? 2500} exec`;
  document.getElementById('costKpiLlmVal').textContent    = fmtUsd(d.llm?.cost_usd);
  document.getElementById('costKpiLlmSub').textContent    = `~${d.llm?.calls_est ?? 0} call ¬∑ ${d.llm?.model ?? '‚Äî'}`;

  // Breakdown table
  const total = d.total_usd || 1;
  const rows = [
    { name: 'Kraken Fees',  usd: d.kraken_fees?.total_usd ?? 0, type: 'REALE',  color: 'var(--warn)' },
    { name: 'n8n Plan',     usd: d.n8n?.cost_usd ?? 0,          type: 'PIANO',  color: 'var(--blue)' },
    { name: 'LLM API',      usd: d.llm?.cost_usd ?? 0,          type: 'STIMA',  color: '#aa66ff' },
    { name: 'Railway',      usd: d.railway?.cost_usd ?? 0,       type: 'PIANO',  color: 'var(--muted)' },
    { name: 'Supabase',     usd: d.supabase?.cost_usd ?? 0,      type: 'PIANO',  color: 'var(--muted)' },
  ];
  const typeColor = { REALE: 'tag-yellow', PIANO: 'tag-blue', STIMA: 'tag-muted' };

  const rowHtml = rows.map(r => {
    const pct = Math.min(100, (r.usd / total) * 100);
    return `
    <tr>
      <td style="color:var(--text)">${r.name}</td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;color:${r.color}">${fmtUsd(r.usd)}</td>
      <td><span class="cost-type-badge panel-tag ${typeColor[r.type]}">${r.type}</span></td>
      <td>
        <div class="cost-bar-wrap">
          <div class="cost-bar-fill" style="width:${pct.toFixed(1)}%;background:${r.color}"></div>
        </div>
        <span style="font-size:10px;color:var(--muted);margin-left:6px">${pct.toFixed(0)}%</span>
      </td>
    </tr>`;
  }).join('');

  document.getElementById('costBreakdownBody').innerHTML = `
    <div class="table-wrap">
      <table class="cost-table">
        <thead><tr><th>Voce</th><th>Costo USD</th><th>Tipo</th><th>Peso</th></tr></thead>
        <tbody>
          ${rowHtml}
          <tr>
            <td>TOTALE</td>
            <td style="font-family:'Syne',sans-serif;font-weight:700;color:var(--danger)">${fmtUsd(d.total_usd)}</td>
            <td></td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div style="font-size:10px;color:var(--muted);margin-top:12px;padding:0 4px">
      Supabase: ${d.supabase?.row_count ?? 0} righe ¬∑ n8n: ${d.n8n?.executions_est ?? 0} exec stimate (wf01 √ó6) ¬∑ Railway: piano ${d.railway?.plan ?? '‚Äî'}
    </div>`;
}

// Dry-run banner + health check
fetch(CONFIG.RAILWAY_URL + '/health')
  .then(r => r.json())
  .then(data => {
    if (data.dry_run) {
      document.getElementById('dry-run-banner').style.display = 'block';
    }
  })
  .catch(() => {});
</script>
</body>
</html>
