<!DOCTYPE html>
<html lang="en">
<head>
<!-- Anti-flicker: hide intro before render if already dismissed -->
<script>if(localStorage.getItem('introDismissed'))document.documentElement.classList.add('intro-dismissed');</script>
<!-- Microsoft Clarity + Sentry ‚Äî caricati SOLO dopo consenso analytics (GDPR) -->
<script>
(function(){
  function loadClarity(){
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window,document,"clarity","script","vnm5ks28uw");
  }
  function loadSentry(){
    var s=document.createElement('script');
    s.src='https://js-de.sentry-cdn.com/c892859215f1e7703459ccf162cd4833.min.js';
    s.crossOrigin='anonymous';
    s.onload=function(){
      if(typeof Sentry!=='undefined'){
        Sentry.onLoad(function(){
          Sentry.init({
            dsn:"https://c892859215f1e7703459ccf162cd4833@o4510954494885888.ingest.de.sentry.io/4510956436783184",
            tracesSampleRate:0.2,
            replaysSessionSampleRate:0,
            replaysOnErrorSampleRate:0.5,
            sendDefaultPii:false,
          });
        });
      }
    };
    document.head.appendChild(s);
  }
  window._loadAnalyticsVendors=function(){
    loadClarity();
    loadSentry();
  };
  if(localStorage.getItem('btcp_ga_consent')==='granted'){
    window._loadAnalyticsVendors();
  }
})();
</script>
<!-- Google Analytics 4 ‚Äî consent-based (GDPR) -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  // Default: deny analytics until user consents
  gtag('consent', 'default', {
    'analytics_storage': 'denied'
  });
  // If user already consented in a previous session, activate immediately
  (function(){
    if (localStorage.getItem('btcp_ga_consent') === 'granted') {
      gtag('consent', 'update', { 'analytics_storage': 'granted' });
      var s = document.createElement('script');
      s.async = true;
      s.src = 'https://www.googletagmanager.com/gtag/js?id=G-K2E2B4FVQ5';
      document.head.appendChild(s);
      gtag('js', new Date());
      gtag('config', 'G-K2E2B4FVQ5');
    }
  })();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
<meta name="googlebot" content="index, follow">
<meta name="bingbot" content="index, follow">

<!-- ‚îÄ‚îÄ Primary SEO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<title>BTC Predictor ¬∑ Autonomous Bitcoin AI Trading Bot ‚Äî Claude + XGBoost + Blockchain</title>
<meta name="description" content="Open-source autonomous Bitcoin trading bot: Claude Sonnet + XGBoost dual-gate prediction (86% direction accuracy). Every signal committed on Polygon PoS blockchain. Live PnL, 13 real-time AI data sources, walk-forward backtesting.">
<meta name="keywords" content="bitcoin trading bot, BTC AI prediction, autonomous crypto trading, XGBoost bitcoin, Claude AI trading bot, Polygon blockchain trading, on-chain audit trail, Kraken futures bot, open source trading bot, BTC futures dashboard">
<meta name="author" content="BTC Predictor ¬∑ Astra Digital Marketing">
<link rel="canonical" href="https://btcpredictor.io/dashboard">

<!-- ‚îÄ‚îÄ Open Graph (LinkedIn, Telegram, Discord, WhatsApp) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://btcpredictor.io/dashboard">
<meta property="og:title" content="BTC Predictor ‚Äî Autonomous Bitcoin Trading Bot ¬∑ AI + Blockchain">
<meta property="og:description" content="Claude Sonnet + XGBoost dual-gate prediction. Every trade committed on Polygon PoS. Open source, live PnL dashboard, 13 real-time AI data sources, walk-forward backtesting.">
<meta property="og:image" content="https://btcpredictor.io/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:site_name" content="BTC Predictor">
<meta property="og:locale" content="it_IT">

<!-- ‚îÄ‚îÄ Twitter / X Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@btcpredictor_io">
<meta name="twitter:creator" content="@btcpredictor_io">
<meta name="twitter:title" content="BTC Predictor ‚Äî Autonomous Bitcoin AI Bot ¬∑ Claude + XGBoost">
<meta name="twitter:description" content="Open-source autonomous BTC trading. Claude + XGBoost dual-gate, 86% direction accuracy, every signal on-chain verified. Live dashboard.">
<meta name="twitter:image" content="https://btcpredictor.io/og-image.png">

<!-- ‚îÄ‚îÄ JSON-LD Structured Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "BTC Predictor",
  "alternateName": "Autonomous Bitcoin AI Trading Bot",
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "Web",
  "url": "https://btcpredictor.io",
  "description": "Open-source autonomous Bitcoin trading bot combining Claude Sonnet + XGBoost (86% direction accuracy) in a dual-gate prediction system. Every signal committed on Polygon PoS for immutable on-chain verification.",
  "author": {
    "@type": "Organization",
    "name": "Astra Digital",
    "url": "https://btcpredictor.io"
  },
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "featureList": [
    "Dual-gate AI prediction (Claude LLM + XGBoost)",
    "On-chain audit trail via Polygon PoS",
    "Walk-forward backtesting (6 strategies)",
    "Real-time PnL dashboard",
    "Telegram commander bot",
    "Autonomous order execution on Kraken Futures"
  ],
  "screenshot": "https://btcpredictor.io/og-image.png",
  "softwareVersion": "2.0",
  "releaseNotes": "https://github.com/mattiacalastri/btc_predictions"
}
</script>

<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='15' fill='%230d0d0d'/%3E%3Ctext x='50' y='72' font-size='70' text-anchor='middle' fill='%2300ff88' font-family='Arial'%3E%E2%82%BF%3C/text%3E%3C/svg%3E">
<link rel="stylesheet" href="/static/style.css?v=__CACHE_BUST__">
</head>
<body>
<div id="topLoader" class="indeterminate"></div>

  <!-- WELCOME INFOBOX ‚Äî first-time visitors, closeable, localStorage, re-openable via "?" -->
  <div class="intro-hero" id="introHero">
    <div class="intro-inner">
      <div class="intro-left">
        <div>
          <div class="intro-badge" data-i18n="badge">WHAT IS THIS?</div>
          <div class="intro-headline" data-i18n="headline">An AI bot that trades Bitcoin ‚Äî with real money.</div>
        </div>
        <div class="intro-desc" data-i18n-html="desc">
          Every 10 minutes, the bot analyses BTC price, news, order flow and sentiment using
          <strong>XGBoost ML + Claude AI</strong>. If both agree on the direction, it opens a real trade on the
          <strong>Kraken</strong> exchange ‚Äî then closes it automatically. No human intervention.
        </div>
        <div class="intro-bullets">
          <div class="intro-bullet" data-i18n-html="bullet1">Started in February 2026 with <strong>$100 USDC</strong> ‚Äî this is real capital, not a simulation</div>
          <div class="intro-bullet" data-i18n-html="bullet2">Every prediction is permanently committed to the <strong>Polygon blockchain</strong> ‚Äî fully verifiable</div>
          <div class="intro-bullet" data-i18n-html="bullet3">Fully <strong>open source</strong> ‚Äî code on GitHub, workflow logic documented</div>
        </div>
        <div class="intro-kpis">
          <div class="intro-kpi">
            <div class="intro-kpi-val" id="introWR">‚Äî</div>
            <div class="intro-kpi-lbl" data-i18n="lbl_wr">Win Rate</div>
          </div>
          <div class="intro-kpi">
            <div class="intro-kpi-val" id="introPnL">‚Äî</div>
            <div class="intro-kpi-lbl" data-i18n="lbl_pnl">Total PnL</div>
          </div>
          <div class="intro-kpi">
            <div class="intro-kpi-val" id="introTrades">‚Äî</div>
            <div class="intro-kpi-lbl" data-i18n="lbl_trades">Closed Trades</div>
          </div>
        </div>
        <div class="intro-dismiss-row">
          <button class="intro-dismiss-btn" onclick="dismissIntro()" data-i18n="cta">Got it, let me explore ‚Üí</button>
          <span class="intro-dismiss-hint" data-i18n-html="hint">You can re-open this anytime with the <strong>?</strong> button in the header</span>
        </div>
        <div id="introLangSwitcher" style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap"></div>
      </div>
      <button class="intro-close" onclick="dismissIntro()" title="Close">‚úï</button>
    </div>
  </div>

  <!-- MINI STATUS BAR -->
  <div class="mini-status-bar" id="miniStatusBar">
    <!-- PIPELINE: core trading flow (01A ‚Üí 01B ‚Üí 02 ‚Üí 08) -->
    <span class="msb-label">PIPELINE</span>
    <span class="msb-item" title="01A ‚Äî Input Fetcher: fetches 16 market data sources ogni 6min"><span class="lsb-robot">ü§ñ</span><span class="status-dot" id="statusWf01a"></span>FEEDS<span class="msb-stxt" id="stxtWf01a"></span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="01B ‚Äî AI Prediction Engine: Claude + XGBoost dual-gate"><span class="lsb-robot">ü§ñ</span><span class="status-dot" id="statusWf01b"></span>BRAIN<span class="msb-stxt" id="stxtWf01b"></span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="02 ‚Äî Trade Desk: SL/TP/timeout exit manager"><span class="lsb-robot">ü§ñ</span><span class="status-dot" id="statusWf02"></span>DESK<span class="msb-stxt" id="stxtWf02"></span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="08 ‚Äî Position Monitor: fires wf02 ogni 3min per ogni posizione aperta"><span class="lsb-robot">ü§ñ</span><span class="status-dot" id="statusWf08"></span>GUARD<span class="msb-stxt" id="stxtWf08"></span></span>
    <!-- COMMS: communication & monitoring agents -->
    <span class="msb-bigsep"></span>
    <span class="msb-label">COMMS</span>
    <span class="msb-item" title="07 ‚Äî Commander: Telegram bot per controllo sistema"><span class="lsb-robot">ü§ñ</span><span class="status-dot" id="statusWf07"></span>CMD<span class="msb-stxt" id="stxtWf07"></span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="09A ‚Äî Social Manager: post automatici dopo ogni trade"><span class="lsb-robot">ü§ñ</span><span class="status-dot" id="statusWf09a"></span>SOC<span class="msb-stxt" id="stxtWf09a"></span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="06 ‚Äî System Watchdog: monitora anomalie sistema ogni 15min"><span class="lsb-robot">ü§ñ</span><span class="status-dot" id="statusWf06"></span>WATCH<span class="msb-stxt" id="stxtWf06"></span></span>
    <!-- INFRA: infrastructure health -->
    <span class="msb-bigsep"></span>
    <span class="msb-label">INFRA</span>
    <span class="msb-item" title="Railway API (Flask backend)"><span class="status-dot" id="statusRailway"></span>API<span class="msb-stxt" id="stxtRailway"></span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="Supabase DB (predictions, signals, bot_state)"><span class="status-dot" id="statusDB"></span>DB<span class="msb-stxt" id="stxtDB"></span></span>
    <!-- BOT -->
    <span class="msb-bigsep"></span>
    <span class="msb-label">Bot</span>
    <span class="msb-item msb-highlight" title="Bot status (running / paused)"><span class="status-dot" id="statusBot"></span><span id="msbBotLabel">‚Äî</span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="Wallet equity on Kraken">üí∞ <span id="msbEquityVal">‚Äî</span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="Kraken exchange reachability"><span class="status-dot" id="statusKraken"></span>Kraken<span class="msb-stxt" id="stxtKraken"></span></span>
    <!-- LIVE -->
    <span class="msb-bigsep"></span>
    <span class="msb-label">Live</span>
    <span class="msb-item" title="Time since last prediction signal"><span class="status-dot" id="statusSignalAge"></span><span id="msbLastSignal">‚Äî</span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="Open positions currently monitored"><span class="status-dot" id="statusOpenPos"></span><span id="msbOpenPosVal">‚Äî open</span></span>
    <span class="msb-sep"></span>
    <span class="msb-item" title="Dry-run mode active?"><span class="status-dot" id="statusDryRun"></span><span id="msbDryRunLabel">‚Äî</span></span>
  </div>

  <div id="dry-run-banner" style="display:none; background:#f59e0b; color:#000; text-align:center; padding:10px; font-weight:bold; font-size:14px; letter-spacing:1px;">
  üß™ DRY RUN MODE ‚Äî Nessun trade reale in esecuzione
</div>
<div class="container">

  <!-- WAR ROOM HEADER (visible only when body.war-room is active) -->
  <div id="warRoomHeader">
    <div id="warRoomTitle">&#9876;&#65039; BTC BOT // WAR ROOM</div>
    <div style="text-align:right;">
      <div id="warRoomClock">00:00:00</div>
      <div id="warRoomClockLabel">UTC</div>
    </div>
  </div>

  <header>
    <div>
      <div class="logo">BTCPREDICTOR.IO ¬∑ <span>OPEN SOURCE ¬∑ AI + BLOCKCHAIN</span></div>
      <h1>AUTONOMOUS BTC <span>PREDICTION ENGINE</span></h1>
      <div style="font-size:11px;color:var(--accent);letter-spacing:1px;margin-top:4px;margin-bottom:6px;font-family:'JetBrains Mono',monospace;font-style:italic;opacity:0.9;">We don't predict the market.<span class="tagline-break"> We read its behavior.</span></div>
      <div style="font-size:10px;color:var(--muted);letter-spacing:1.5px;margin-top:3px;font-family:'JetBrains Mono',monospace;">Claude Sonnet + XGBoost ¬∑ Dual-Gate AI ¬∑ <span style="color:rgba(168,85,247,0.8);">Every prediction committed on-chain BEFORE execution</span></div>
    </div>
    <div class="header-right">
      <div class="btc-live-ticker">
        <div class="btc-live-price" id="btcLivePrice">‚Äî</div>
        <div class="btc-price-meta">BTC/USD ¬∑ LIVE <span class="btc-price-change" id="btcPriceChange"></span></div>
      </div>
      <span class="last-update" id="lastUpdate">LAST UPDATE: <span class="loading">‚Äî</span></span>
      <a href="https://polygonscan.com/address/0xe4661F7dB62644951Eb1F9Fd23DB90e647833a55" target="_blank" class="onchain-badge" title="Every prediction committed to Polygon PoS ‚Äî immutable audit trail">
        <div class="onchain-dot"></div>
        <div class="onchain-badge-inner">
          <span class="onchain-badge-title">POLYGON PoS ¬∑ VERIFIED ‚úì</span>
          <span class="onchain-badge-sub">ON-CHAIN AUDIT TRAIL</span>
        </div>
      </a>
      <div class="live-badge" onclick="showHeaderPopover(this,'live')"><div class="live-dot"></div>LIVE DATA</div>
      <div id="botStatus" class="bot-status alive" onclick="showHeaderPopover(this,'bot')">
        <div class="bot-status-dot"></div>
        <div class="bot-status-inner">
          <div id="botStatusText">BOT ALIVE<span id="botPausedIndicator" style="display:none;color:var(--warn);font-size:9px;font-weight:700;margin-left:6px;">‚è∏ PAUSED</span></div>
          <div class="bot-status-detail" id="botStatusDetail">Checking...</div>
        </div>
      </div>
      <button class="intro-reopen-btn" id="introReopenBtn" onclick="showIntro()" title="What is this? ‚Äî Info for new visitors" style="display:none">? ABOUT</button>
      <button class="tron-menu-btn" id="tronMenuBtn" onclick="toggleTronMenu()" title="Navigation Menu" aria-label="Open navigation menu">
        <svg width="22" height="18" viewBox="0 0 20 16" fill="none"><path d="M0 1h20M0 8h20M0 15h20" stroke="rgba(255,255,255,0.8)" stroke-width="1.8" stroke-linecap="square"/></svg>
      </button>
    </div>
  </header>

  <!-- TELEGRAM CTA -->
  <div class="tg-cta-banner" id="tgCtaBanner">
    <a href="https://t.me/BTCPredictorBot" target="_blank" rel="noopener" class="tg-cta-inner">
      <span class="tg-cta-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="#29b6f6" d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.248-1.97 9.289c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.023c.242-.213-.054-.333-.373-.12l-6.871 4.326-2.962-.924c-.643-.204-.657-.643.136-.953l11.57-4.461c.537-.194 1.006.131.833.932z"/></svg></span>
      <span class="tg-cta-text">Follow the journey ‚Äî <strong>every trade, every mistake</strong>, committed on-chain before execution</span>
      <span class="tg-cta-action">JOIN ON TELEGRAM ‚Üí</span>
    </a>
    <button class="tg-cta-close" onclick="dismissTgCta()" title="Dismiss">‚úï</button>
  </div>

  <!-- AI SIGNAL SOURCES -->
  <div class="sources-header">
    <span class="sources-hdr-label">AI FEEDS</span>
    <span class="sources-hdr-sep">¬∑</span>
    <span class="sources-hdr-count"><em>16</em> SOURCES</span>
  </div>
  <div class="sources-strip">
    <div class="sources-list">
      <div class="src-chip" style="--src-color:#00aaff"
           data-src-modal-title="KRAKEN FUTURES ‚Äî Price"
           data-src-modal-desc="Source: Kraken Futures (PF_XBTUSD)&lt;br&gt;Provides: BTC/USD perpetual futures mark price, margin balance, available equity, wallet value.&lt;br&gt;Used for: account summary, position monitoring, SL/TP checks, trade execution.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">KRAKEN</span><span class="src-cat">PRICE</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#3399ee"
           data-src-modal-title="BINANCE FUTURES ‚Äî Klines"
           data-src-modal-desc="Source: Binance Futures API (fapi.binance.com)&lt;br&gt;Provides: 300 OHLCV candlesticks at 5-minute resolution.&lt;br&gt;Used for: EMA9/EMA21/RSI14 calculation, ATR/ADX volatility, pattern analysis, XGBoost features.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">BINANCE</span><span class="src-cat">KLINES</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#00d4aa"
           data-src-modal-title="COINGECKO ‚Äî Market Data"
           data-src-modal-desc="Source: CoinGecko API (api.coingecko.com)&lt;br&gt;Provides: BTC market cap, 24h volume, price change %, market dominance, ATH distance.&lt;br&gt;Used for: macro market context in the AI prompt.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">COINGECKO</span><span class="src-cat">MARKET</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#aa66ff"
           data-src-modal-title="BINANCE ‚Äî Funding Rate"
           data-src-modal-desc="Source: Binance Futures premiumIndex (fapi.binance.com)&lt;br&gt;Provides: perpetual futures funding rate (refreshed every 8h).&lt;br&gt;Signal: EXTREME_POSITIVE = over-leveraged longs (bearish bias), NEGATIVE = shorts dominant (bullish bias).">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">FUNDING RATE</span><span class="src-cat">DERIVATIVES</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#cc88ff"
           data-src-modal-title="BINANCE ‚Äî Long/Short Ratio"
           data-src-modal-desc="Source: Binance Futures globalLongShortAccountRatio (5m period)&lt;br&gt;Provides: ratio of accounts holding long vs short positions.&lt;br&gt;Signal: EXTREME_LONG (&gt;0.7) = crowded longs, potential reversal; EXTREME_SHORT (&lt;0.3) = crowded shorts.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">L/S RATIO</span><span class="src-cat">DERIVATIVES</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#00ff88"
           data-src-modal-title="ALTERNATIVE.ME ‚Äî Fear &amp; Greed"
           data-src-modal-desc="Source: Alternative.me Crypto Fear &amp; Greed Index (api.alternative.me)&lt;br&gt;Provides: daily sentiment index 0‚Äì100 combining volatility, volume, social media, dominance.&lt;br&gt;Signal: &lt;25 = Extreme Fear (contrarian buy), &gt;75 = Extreme Greed (contrarian sell).">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">FEAR &amp; GREED</span><span class="src-cat">SENTIMENT</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#ff9500"
           data-src-modal-title="CRYPTOCOMPARE ‚Äî News"
           data-src-modal-desc="Source: CryptoCompare News API (min-api.cryptocompare.com)&lt;br&gt;Provides: 2 most recent crypto news articles with title, body, sentiment score.&lt;br&gt;Used for: news sentiment analysis in AI prompt, real-time market narrative.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">CRYPTOCMP</span><span class="src-cat">NEWS</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#ffcc00"
           data-src-modal-title="COINDESK ‚Äî News RSS"
           data-src-modal-desc="Source: CoinDesk RSS feed (feeds.feedburner.com/CoinDesk)&lt;br&gt;Provides: 3 most recent articles from the leading crypto journalism outlet.&lt;br&gt;Used for: institutional narrative, regulatory news, market-moving events.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">COINDESK</span><span class="src-cat">NEWS</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#f7931a"
           data-src-modal-title="BINANCE ‚Äî Open Interest"
           data-src-modal-desc="Source: Binance Futures /fapi/v1/openInterest (BTCUSDT)&lt;br&gt;Provides: total open interest in USD ‚Äî the aggregate value of all outstanding futures contracts.&lt;br&gt;Signal: rising OI in uptrend = trend continuation; falling OI = exhaustion. Combined with price action for conviction scoring.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">OPEN INT.</span><span class="src-cat">DERIVATIVES</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#22d3ee"
           data-src-modal-title="BINANCE ‚Äî Taker Buy/Sell Flow"
           data-src-modal-desc="Source: Binance Futures /fapi/v1/takerlongshortRatio (BTCUSDT, 5m)&lt;br&gt;Provides: ratio of aggressive buy vs sell volume ‚Äî who is hitting the bid/ask.&lt;br&gt;Signal: buy ratio &gt;0.55 = institutional accumulation; &lt;0.45 = distribution. One of the strongest real-time flow signals.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">TAKER FLOW</span><span class="src-cat">FLOW</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#02b875"
           data-src-modal-title="COINTELEGRAPH ‚Äî News RSS"
           data-src-modal-desc="Source: CoinTelegraph RSS feed (cointelegraph.com/rss)&lt;br&gt;Provides: 3 most recent articles from the leading crypto news outlet.&lt;br&gt;Used for: breaking news, regulation updates, institutional moves. High signal-to-noise ratio for BTC price-moving events.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">COINTELEGR.</span><span class="src-cat">NEWS</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#a855f7"
           data-src-modal-title="XGBOOST ‚Äî Internal ML Gate"
           data-src-modal-desc="Source: Internal XGBoost model trained on historical signals&lt;br&gt;Provides: direction (UP/DOWN) and confidence score from 47 engineered features (RSI, EMA, ATR, ADX, funding, CVD, regime label‚Ä¶).&lt;br&gt;Dual-gate: a prediction is executed ONLY when LLM direction = XGBoost direction. Prevents false positives.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">XGBOOST</span><span class="src-cat">ML GATE</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#ff44aa"
           data-src-modal-title="PATTERN MEMORY ‚Äî Supabase"
           data-src-modal-desc="Source: Supabase btc_predictions table (internal)&lt;br&gt;Provides: last 3 similar market conditions from the bot's history ‚Äî direction, confidence, outcome.&lt;br&gt;Used for: self-calibration. The bot learns from its own past decisions (Behavioral Data Engine).">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">PATTERNS</span><span class="src-cat">MEMORY</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#e5251b"
           data-src-modal-title="CNBC ‚Äî Finance RSS"
           data-src-modal-desc="Source: CNBC Finance RSS feed (cnbc.com)&lt;br&gt;Provides: 2 most recent US financial market headlines (equities, Fed, macro data).&lt;br&gt;Used for: cross-asset risk sentiment ‚Äî US market moves often precede BTC moves.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">CNBC</span><span class="src-cat">NEWS</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#00ccff"
           data-src-modal-title="BINANCE ‚Äî Order Book Imbalance"
           data-src-modal-desc="Source: Binance Futures /fapi/v1/depth (5 levels)&lt;br&gt;Provides: bid/ask volume imbalance at ¬±0.3% from mid-price.&lt;br&gt;Signal: imbalance &gt;0.6 = buy-side pressure (bullish), &lt;0.4 = sell-side pressure (bearish). High-frequency microstructure signal.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">ORDER BOOK</span><span class="src-cat">MICROSTRUCTURE</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
      <div class="src-chip" style="--src-color:#88ddff"
           data-src-modal-title="BINANCE ‚Äî Multi-Timeframe Technical"
           data-src-modal-desc="Source: Binance Futures klines (aggregated from 300 candles at 5m)&lt;br&gt;Provides: EMA9/EMA21/RSI14 on 15-minute and 4-hour timeframes. Consensus: STRONG_UP / BULLISH / NEUTRAL / BEARISH / STRONG_DOWN.&lt;br&gt;Used for: multi-timeframe trend alignment ‚Äî confirms or weakens the 5m signal.">
        <div class="src-dot"></div>
        <div class="src-info"><span class="src-name">MULTI-TF</span><span class="src-cat">TECHNICAL</span></div>
        <button class="src-i-btn" onclick="event.stopPropagation();showSrcModal(this.closest('.src-chip'))" title="Info">i</button>
      </div>
    </div>
  </div>

  <!-- Source modal -->
  <div id="srcModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;" onclick="closeSrcModal(event)">
    <div style="background:var(--card);border:1px solid var(--border);padding:22px 26px;max-width:380px;width:90%;position:relative;border-radius:2px;">
      <div id="srcModalColor" style="position:absolute;top:0;left:0;right:0;height:2px;"></div>
      <div style="font-size:10px;font-weight:700;letter-spacing:2px;color:var(--accent);margin-bottom:8px;padding-right:24px;" id="srcModalTitle"></div>
      <div style="font-size:11px;color:var(--text);line-height:1.7;" id="srcModalDesc"></div>
      <button onclick="document.getElementById('srcModal').style.display='none'" style="position:absolute;top:12px;right:14px;background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;line-height:1;">‚úï</button>
    </div>
  </div>

  <!-- Header info popover -->
  <div id="headerPopover">
    <div class="hpop-title" id="hpopTitle">INFO</div>
    <div id="hpopBody"></div>
  </div>

  <!-- TAB NAVIGATION + GLOBAL TIME FILTER -->
  <div class="tab-nav">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="dashboard"   onclick="switchTab(this)">üìä Dashboard</button>
      <button class="tab-btn"        data-tab="agents"      onclick="switchTab(this)">ü§ñ Agents</button>
      <button class="tab-btn"        data-tab="costs"       onclick="switchTab(this)">üí∞ Costs</button>
      <button class="tab-btn"        data-tab="expectancy"  onclick="switchTab(this)">üìà Expectancy</button>
      <button class="tab-btn"        data-tab="training"    onclick="switchTab(this)">üß† Training</button>
      <button class="tab-btn"        data-tab="backtest"    onclick="switchTab(this)">üìä Backtest</button>
    </div>
    <div class="tab-controls" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <span class="period-label" style="font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-right:4px">PERIOD</span>
      <button class="time-pill desktop-period-pill"        data-period="ALL"   onclick="setTimePeriod(this)">ALL</button>
      <button class="time-pill desktop-period-pill"        data-period="7D"    onclick="setTimePeriod(this)">7D</button>
      <button class="time-pill desktop-period-pill"        data-period="3D"    onclick="setTimePeriod(this)">3D</button>
      <button class="time-pill desktop-period-pill"        data-period="24H"   onclick="setTimePeriod(this)">24H</button>
      <button class="time-pill desktop-period-pill active" data-period="TODAY" onclick="setTimePeriod(this)">TODAY</button>
      <div class="tab-controls-sep" style="width:1px;height:20px;background:var(--border);"></div>
      <button class="war-room-btn" id="warRoomToggle" onclick="toggleWarRoom(this)">&#9876;&#65039; War Room</button>
    </div>
  </div>

  <!-- MOBILE PERIOD BAR ‚Äî visible only on mobile, sticky below tab nav -->
  <div class="mobile-period-bar" id="mobilePeriodBar">
    <button class="time-pill"        data-period="ALL"   onclick="setTimePeriod(this)">ALL</button>
    <button class="time-pill"        data-period="7D"    onclick="setTimePeriod(this)">7D</button>
    <button class="time-pill"        data-period="3D"    onclick="setTimePeriod(this)">3D</button>
    <button class="time-pill"        data-period="24H"   onclick="setTimePeriod(this)">24H</button>
    <button class="time-pill active" data-period="TODAY" onclick="setTimePeriod(this)">TODAY</button>
    <div style="flex:1;min-width:4px;"></div>
    <button class="war-room-btn" id="warRoomToggleMobile" onclick="toggleWarRoom(document.getElementById('warRoomToggle'))" style="font-size:8px;padding:5px 8px;white-space:nowrap;">&#9876;&#65039; WAR ROOM</button>
  </div>

  <!-- DASHBOARD TAB -->
  <div id="tab-dashboard" class="tab-content active">

  <!-- API error banner -->
  <div id="apiErrorBanner">
    <div class="err-dot"></div>
    <span id="apiErrorMsg">Railway API non raggiungibile ‚Äî dati non aggiornati</span>
    <span class="err-dismiss" onclick="document.getElementById('apiErrorBanner').classList.remove('visible')" title="Dismiss">‚úï</span>
  </div>

  <!-- Bot alert banner (wf02/orphaned bets) -->
  <div id="botAlertBanner">
    <span style="font-size:14px">‚ö†Ô∏è</span>
    <span id="botAlertMsg">‚Äî</span>
    <span style="margin-left:auto;cursor:pointer;opacity:0.6;" onclick="document.getElementById('botAlertBanner').classList.remove('visible')">‚úï</span>
  </div>

  <!-- ‚¨° LIVE POSITION WIDGET -->
  <div id="livePositionWidget" style="display:none;margin-bottom:16px">
    <div class="lp-tabs" id="lpTabs" style="display:none"></div>
    <div class="live-pos-card">
      <!-- LEFT: position info -->
      <div class="lp-left">
        <div class="lp-header">
          <div class="lp-dot"></div>
          <span class="lp-label">Live Position</span>
        </div>
        <div class="lp-id" id="lpBetId">#‚Äî</div>
        <div class="lp-dir" id="lpDirection">‚Äî</div>
        <div class="lp-conf" id="lpConfidence">‚Äî</div>
        <div class="lp-time" id="lpOpenTime">‚Äî</div>
        <div class="lp-pnl" id="lpPnl">‚Äî</div>
        <div class="lp-size" id="lpSize">‚Äî</div>
        <div class="lp-pyramid-badge" id="lpPyramidBadge" style="display:none">‚¨Ü PYRAMID</div>
      </div>
      <!-- CENTER: price gauge SL ‚Üí TP -->
      <div class="lp-center">
        <div class="lp-gauge-header">
          <span class="lp-gauge-sl" id="lpSlLabel">SL ‚Äî</span>
          <span class="lp-gauge-entry" id="lpEntryLabel">ENTRY ‚Äî</span>
          <span class="lp-gauge-tp" id="lpTpLabel">TP ‚Äî</span>
        </div>
        <div class="lp-gauge-track">
          <div class="lp-gauge-marker entry" id="lpEntryMarker" style="left:40%"></div>
          <div class="lp-gauge-marker live"  id="lpLiveMarker"  style="left:50%"></div>
        </div>
        <div class="lp-gauge-footer">
          <span style="color:var(--danger);font-size:9px">‚óÄ SL</span>
          <div class="lp-current-price" id="lpCurrentPrice">$‚Äî</div>
          <span style="color:var(--accent);font-size:9px">TP ‚ñ∂</span>
        </div>
      </div>
      <!-- RIGHT: AI cube + decision -->
      <div class="lp-right">
        <div class="ai-cube-scene" id="cubeScene">
          <div class="ai-cube" id="aiCube" data-state="neutral">
            <div class="cube-face cube-front">AI</div>
            <div class="cube-face cube-back">XGB</div>
            <div class="cube-face cube-right">HOLD</div>
            <div class="cube-face cube-left">EXIT</div>
            <div class="cube-face cube-top" id="cubeFaceConf">‚Äî%</div>
            <div class="cube-face cube-bottom">BOT</div>
          </div>
        </div>
        <div class="ai-decision">
          <span class="ai-status-dot"></span>
          <span id="aiDecisionText">Monitoring</span>
        </div>
        <div class="ai-think-label">AI Exit Manager</div>
      </div>
    </div>
  </div>

  <!-- TASK 2: Story Highlights (mobile only) -->
  <div class="story-highlights" id="storyHighlights">
    <div class="story-item" data-source="kpiWinRate">
      <div class="story-ring story-ring-yellow" style="color:var(--warn)">WR%</div>
      <div class="story-label">WIN RATE</div>
      <div class="story-val" id="storyWR">‚Äî</div>
    </div>
    <div class="story-item" data-source="kpiPnl">
      <div class="story-ring story-ring-purple" style="color:#aa66ff">P&L</div>
      <div class="story-label">P&amp;L</div>
      <div class="story-val" id="storyROI">‚Äî</div>
    </div>
    <div class="story-item" data-source="kpiFG">
      <div class="story-ring story-ring-blue" style="color:var(--blue)">F/G</div>
      <div class="story-label">FEAR/GREED</div>
      <div class="story-val" id="storyFG">‚Äî</div>
    </div>
    <div class="story-item" data-source="kpiBets">
      <div class="story-ring story-ring-green" style="color:var(--accent)">#BET</div>
      <div class="story-label">BETS</div>
      <div class="story-val" id="storyBets">‚Äî</div>
    </div>
    <div class="story-item" data-source="kpiDrawdown">
      <div class="story-ring story-ring-red" style="color:var(--danger)">DD</div>
      <div class="story-label">DRAWDOWN</div>
      <div class="story-val" id="storyDD">‚Äî</div>
    </div>
    <div class="story-item" data-source="statStreak">
      <div class="story-ring story-ring-orange" style="color:#ff8800">STK</div>
      <div class="story-label">STREAK</div>
      <div class="story-val" id="storyStreak">‚Äî</div>
    </div>
  </div>

  <!-- TASK 3: Mobile Primary Grid (mobile only) -->
  <div class="mobile-primary-grid" id="mobilePrimaryGrid">
    <!-- Box 1: Bot Status -->
    <div class="mp-box mp-primary">
      <div class="mp-label">BOT</div>
      <div class="mp-value" id="mpBotStatus">‚Äî</div>
      <div class="mp-sub" id="mpBotSub">checking...</div>
    </div>
    <!-- Box 2: Today Equity -->
    <div class="mp-box mp-primary">
      <div class="mp-label">TODAY PnL</div>
      <div class="mp-value" id="mpTodayPnl">‚Äî</div>
      <div class="mp-sub" id="mpTodaySub">bets today</div>
    </div>
    <!-- Box 3: Last Signal (medium) -->
    <div class="mp-box mp-secondary">
      <div class="mp-label">LAST SIGNAL</div>
      <div class="mp-last-signal">
        <span id="mpLastDir" style="font-size:18px;font-weight:900;">‚Äî</span>
        <span id="mpLastConf" style="font-size:11px;color:var(--muted);">conf ‚Äî</span>
        <span id="mpLastResult" style="font-size:10px;font-weight:700;">‚Äî</span>
        <span id="mpLastTime" style="font-size:9px;color:var(--muted);">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- TRAINING PHASE BANNER -->
  <div class="training-banner" id="trainingBanner">
    <div class="training-banner-text">
      <strong>üì° Fase di addestramento in corso</strong> ‚Äî I profitti sono nell'ordine dei centesimi.
      <span class="training-banner-detail">Non √® un limite del sistema: √® la raccolta dati che alimenta il modello verso la
      <strong>Prevedibilit√† Perfetta</strong> ‚Äî lo stato in cui ogni segnale converge verso
      la certezza matematica.</span>
      Ci stiamo arrivando.
      <a href="/prevedibilita-perfetta" target="_blank">‚Üí Cos'√® e perch√©</a>
    </div>
    <button class="training-banner-close" onclick="dismissTrainingBanner()" title="Chiudi">‚úï</button>
  </div>

  <!-- Signal Log ‚Äî full width -->
  <div class="panel" id="signalLogPanel" style="margin-bottom:14px;">
    <div class="sl-board-header">
      <div class="sl-board-title">
        <span class="sl-live-dot"></span>
        <span id="signalLogTitle">SIGNAL LOG BOARD</span>
        <span id="nextSignalTimer" class="next-signal-badge"></span>
      </div>
      <div class="sl-board-controls">
        <select id="filterDir"   class="filter-sel"><option value="ALL">ALL PREDICTION</option><option value="UP">‚Üë UP</option><option value="DOWN">‚Üì DOWN</option></select>
        <select id="filterClass" class="filter-sel"><option value="ALL">ALL</option><option value="BET">BET</option><option value="NO_BET">NO-BET</option></select>
      </div>
    </div>
    <div id="slStats" class="sl-stats-bar">
      <div class="sl-stat-item"><div class="sl-stat-label">SIGNALS</div><div class="sl-stat-val" id="slStatTotal">‚Äî</div></div>
      <div class="sl-stat-sep"></div>
      <div class="sl-stat-item"><div class="sl-stat-label">BETS</div><div class="sl-stat-val" id="slStatBets">‚Äî</div></div>
      <div class="sl-stat-sep"></div>
      <div class="sl-stat-item sl-stat-wr"><div class="sl-stat-label">WIN RATE</div><div class="sl-stat-val" id="slStatWR">‚Äî</div></div>
      <div class="sl-stat-sep"></div>
      <div class="sl-stat-item"><div class="sl-stat-label">AVG CONF</div><div class="sl-stat-val" id="slStatConf">‚Äî</div></div>
      <div class="sl-stat-sep"></div>
      <div class="sl-stat-item"><div class="sl-stat-label">AVG PNL/BET</div><div class="sl-stat-val" id="slStatAvgPnl">‚Äî</div></div>
    </div>
    <!-- SIGNAL LOG FILTER BAR -->
    <div class="signal-filters" id="signalFiltersBar">
      <div class="filter-group">
        <button class="filter-btn active" data-filter="type" data-value="all" onclick="setSignalFilter(this,'type')">Tutti</button>
        <button class="filter-btn"        data-filter="type" data-value="bet"   onclick="setSignalFilter(this,'type')">BET</button>
        <button class="filter-btn"        data-filter="type" data-value="skip"  onclick="setSignalFilter(this,'type')">SKIP</button>
        <button class="filter-btn"        data-filter="type" data-value="nobet" onclick="setSignalFilter(this,'type')">NO BET</button>
      </div>
      <div class="filter-group-sep"></div>
      <div class="filter-group">
        <button class="filter-btn active" data-filter="outcome" data-value="all"  onclick="setSignalFilter(this,'outcome')">Tutti</button>
        <button class="filter-btn"        data-filter="outcome" data-value="win"  onclick="setSignalFilter(this,'outcome')">WIN</button>
        <button class="filter-btn"        data-filter="outcome" data-value="loss" onclick="setSignalFilter(this,'outcome')">LOSS</button>
        <button class="filter-btn"        data-filter="outcome" data-value="open" onclick="setSignalFilter(this,'outcome')">Aperte</button>
      </div>
      <div class="filter-group-sep"></div>
      <div class="filter-group">
        <button class="filter-btn active" data-filter="direction" data-value="all"  onclick="setSignalFilter(this,'direction')">Entrambe</button>
        <button class="filter-btn"        data-filter="direction" data-value="up"   onclick="setSignalFilter(this,'direction')">&#8593; UP</button>
        <button class="filter-btn"        data-filter="direction" data-value="down" onclick="setSignalFilter(this,'direction')">&#8595; DOWN</button>
      </div>
      <input type="text" id="signal-search" placeholder="&#128269; Cerca ID, conf..." oninput="applySignalFilters()">
      <button id="historyToggleBtn" class="filter-btn" style="margin-left:auto;opacity:0.7;font-size:9px;letter-spacing:1px;padding:3px 8px;" onclick="toggleHistory(this)">‚è≥ HISTORY</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>DATE/TIME</th>
            <th>PREDICTION</th>
            <th>CONFIDENCE</th>
            <th>ENTRY $</th>
            <th>EXIT $</th>
            <th>RSI</th>
            <th>EMA</th>
            <th>SCORE</th>
            <th>SIZE</th>
            <th>TYPE</th>
            <th>RESULT</th>
            <th>PNL $ / THR%</th>
            <th>FEE $</th>
            <th>SL/TP</th>
            <th title="On-chain audit trail ‚Äî Polygon PoS">‚õì</th>
          </tr>
        </thead>
        <tbody id="signalTable"></tbody>
      </table>
      <div class="mobile-bet-list" id="mobileBetList"></div>
    </div>
  </div>


  <!-- 9 KPI tiles + Satoshi Sculpture -->
  <div class="kpi-grid">
    <div class="kpi blue">
      <div class="kpi-label">BTC Price</div>
      <div class="kpi-value blue" id="kpiPrice">‚Äî</div>
      <div class="kpi-sub">Last entry</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Total Signals</div>
      <div class="kpi-value white" id="kpiTotal">‚Äî</div>
      <div class="kpi-sub" id="kpiTotalSub">All time</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Accuracy</div>
      <div class="kpi-value green" id="kpiAccuracy">‚Äî</div>
      <div class="kpi-sub">Correct pred.</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Total PnL</div>
      <div class="kpi-value green" id="kpiPnl">‚Äî</div>
      <div class="kpi-sub" id="kpiPnlSub">from 2026-02-24</div>
    </div>
    <div class="kpi purple" data-tip-title="APR (Annual Percentage Rate)" data-tip="Annualized return: (Total PnL / Capital) / Active Days √ó 365. More useful than session ROI for daily operations ‚Äî shows the projected annual return rate if current performance holds.">
      <div class="kpi-label">APR <span style="font-size:8px;opacity:0.5;letter-spacing:0.5px">annualized</span></div>
      <div class="kpi-value purple" id="kpiApr">‚Äî</div>
      <div class="kpi-sub" id="kpiAprSub">‚Äî days active</div>
    </div>
    <div class="kpi purple" data-tip-title="Session ROI" data-tip="Return on investment since session start (2026-02-24, $100 capital). Calculated as Total PnL / Capital.">
      <div class="kpi-label">Session ROI</div>
      <div class="kpi-value purple" id="kpiRoi">‚Äî</div>
      <div class="kpi-sub" id="kpiRoiSub">since session start</div>
    </div>
    <div class="kpi yellow">
      <div class="kpi-label">Win Rate</div>
      <div class="kpi-value yellow" id="kpiWinRate">‚Äî</div>
      <div class="kpi-sub">Executed trades</div>
    </div>
    <div class="kpi yellow">
      <div class="kpi-label">Signal WR</div>
      <div class="kpi-value yellow" id="kpiWrNoBet">‚Äî</div>
      <div class="kpi-sub">All predictions verified</div>
    </div>
    <div class="kpi blue">
      <div class="kpi-label">Fear &amp; Greed</div>
      <div class="kpi-value blue" id="kpiFG">‚Äî</div>
      <div class="kpi-sub" id="kpiFGLabel">Loading...</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Bets Taken</div>
      <div class="kpi-value white" id="kpiBets">‚Äî</div>
      <div class="kpi-sub">Out of total</div>
    </div>
    <div class="kpi red">
      <div class="kpi-label">Max Drawdown</div>
      <div class="kpi-value red" id="kpiDrawdown">‚Äî</div>
      <div class="kpi-sub">Single trade</div>
    </div>
    <!-- Mobile-only: 2 extra KPI slots fill the last row on 3-col mobile grid -->
    <div class="kpi mobile-only green" data-tip-title="Expectancy" data-tip="Expected value per bet = total PnL / number of closed bets. Positive = system is profitable long-term.">
      <div class="kpi-label">Expectancy</div>
      <div class="kpi-value white" id="kpiExpectancyVal">‚Äî</div>
      <div class="kpi-sub">avg $/bet</div>
    </div>
    <div class="kpi mobile-only purple" data-tip-title="Profit Factor" data-tip="Profit Factor = gross wins / gross losses. Above 1.0 = system is profitable. &gt;1.5 is considered good.">
      <div class="kpi-label">Profit Factor</div>
      <div class="kpi-value purple" id="kpiProfitFactorVal">‚Äî</div>
      <div class="kpi-sub">wins/losses</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CUMULATIVE EQUITY CURVE
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="panel" id="equityCurvePanel" style="margin-bottom:14px;">
    <div class="panel-header">
      <div class="panel-title">Cumulative Equity Curve (Real Bets)</div>
      <div class="panel-tag tag-green" id="equityTag" data-tip-title="Equity Curve" data-tip="Capital curve over time based on real PnL from every closed bet. Includes trading fees.">LOADING</div>
    </div>
    <div style="padding:16px 18px 10px;">
      <svg id="equitySvg" class="equity-svg" height="110" viewBox="0 0 1000 110" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <!-- TRADING STATS ROW -->
  <div class="stats-row">
    <div class="stat-cell" data-tip-title="Avg Confidence" data-tip="Average confidence (estimated probability) assigned by the AI across all predictions in the selected period. Values >75% indicate high-conviction signals." onclick="showStatExplain(event,'Avg Confidence','% of AI confidence averaged across all bets in the period. The bot only executes trades at ‚â•75% confidence.')">
      <div class="stat-cell-label">Avg Confidence <span class="stat-info-icon">‚ìò</span></div>
      <div class="stat-cell-val" id="statConf" style="color:var(--blue)">‚Äî</div>
    </div>
    <div class="stat-cell" data-tip-title="Best Trade PnL" data-tip="The single trade with the highest gain in USD for the period. Measures the bot&apos;s maximum upside in a single operation." onclick="showStatExplain(event,'Best Trade','Highest single trade profit in USD in the selected period.')">
      <div class="stat-cell-label">Best Trade PnL <span class="stat-info-icon">‚ìò</span></div>
      <div class="stat-cell-val" id="statBest" style="color:var(--accent)">‚Äî</div>
    </div>
    <div class="stat-cell" data-tip-title="Current Streak" data-tip="Active streak: consecutive wins (W) or losses (L) from the last closed bet. A long W-streak signals positive model momentum." onclick="showStatExplain(event,'Current Streak','Consecutive wins (W) or losses (L) from the last closed bet. A long W-streak signals model momentum.')">
      <div class="stat-cell-label">Current Streak <span class="stat-info-icon">‚ìò</span></div>
      <div class="stat-cell-val" id="statStreak" style="color:var(--text)">‚Äî</div>
    </div>
    <div class="stat-cell" data-tip-title="Avg Entry Slippage" data-tip="Average difference between expected and actual execution price. Negative slippage = filled at a worse price than expected. Values &lt;$5 are acceptable." onclick="showStatExplain(event,'Avg Entry Slippage','Average difference between signal price and actual fill. Negative = filled worse than expected. Values under $5 are normal.')">
      <div class="stat-cell-label">Avg Entry Slippage <span class="stat-info-icon">‚ìò</span></div>
      <div class="stat-cell-val" id="statSlippage" style="color:var(--warn)">‚Äî</div>
    </div>
    <div class="stat-cell" data-tip-title="Avg RR Ratio" data-tip="Average Risk/Reward: ratio of expected gain (TP) to risked loss (SL). A value ‚â•2.0x means every $1 risked targets $2+ in return." onclick="showStatExplain(event,'Avg RR Ratio','Average Risk/Reward: TP distance / SL distance. A value ‚â•2.0x means every $1 risked targets $2+ in return.')">
      <div class="stat-cell-label">Avg RR Ratio <span class="stat-info-icon">‚ìò</span></div>
      <div class="stat-cell-val" id="statRR" style="color:var(--accent)">‚Äî</div>
    </div>
    <div class="stat-cell" data-tip-title="Total Fees Paid" data-tip="Total trading fees paid to Kraken across all closed bets. Each trade costs 0.005% √ó size √ó (entry+exit price). Lower is better ‚Äî fees erode PnL over time." onclick="showStatExplain(event,'Total Fees','Total Kraken trading fees: 0.005% √ó size √ó (entry+exit price) per trade. Fees erode PnL ‚Äî track closely.')">
      <div class="stat-cell-label">Total Fees <span class="stat-info-icon">‚ìò</span></div>
      <div class="stat-cell-val" id="statTotalFees" style="color:var(--warn)">‚Äî</div>
    </div>
    <div class="stat-cell" data-tip-title="Total Entry Slippage" data-tip="Cumulative difference between expected signal price and actual fill price across all bets. Negative = filled worse than expected. This is raw price difference (pts), not dollar cost." onclick="showStatExplain(event,'Total Slippage','Cumulative price slippage across all bets (in USD points). Negative = consistently filled worse than expected.')">
      <div class="stat-cell-label">Total Slippage <span class="stat-info-icon">‚ìò</span></div>
      <div class="stat-cell-val" id="statTotalSlippage" style="color:var(--warn)">‚Äî</div>
    </div>
    <div class="stat-cell stat-cell-apr" data-tip-title="APR Today" data-tip="Today's PnL annualized: (Today's PnL / Capital) √ó 365. Daily pulse of performance vs expected annual return." onclick="showStatExplain(event,'APR Today','Today\'s PnL annualized: (today PnL / capital) √ó 365. Daily pulse ‚Äî volatile but useful for trend detection.')">
      <div class="stat-cell-label">APR Today <span class="stat-info-icon">‚ìò</span></div>
      <div class="stat-cell-val" id="statAprToday" style="color:var(--purple)">‚Äî</div>
    </div>
    <div class="stat-cell stat-cell-apr" data-tip-title="APR 7d" data-tip="Last 7-day PnL annualized: (7d PnL / Capital) / 7 √ó 365. Rolling window to smooth daily variance and detect medium-term performance trends." onclick="showStatExplain(event,'APR 7d','Last 7-day PnL annualized. Rolling window smooths daily noise ‚Äî a better estimate of sustained performance than APR Today.')">
      <div class="stat-cell-label">APR 7d <span class="stat-info-icon">‚ìò</span></div>
      <div class="stat-cell-val" id="statApr7d" style="color:var(--purple)">‚Äî</div>
    </div>
    <!-- Mobile-only: fills empty slot in 3-col row 2 -->
    <div class="stat-cell mobile-only" data-tip-title="Best Win Streak" data-tip="Maximum consecutive wins across the entire bet history. Indicates model consistency.">
      <div class="stat-cell-label">Best Streak</div>
      <div class="stat-cell-val" id="statBestStreak" style="color:var(--accent)">‚Äî</div>
    </div>
    <div class="stat-cell mobile-only" data-tip-title="Hit Rate 7d" data-tip="Win rate on bets closed in the last 7 days. Fresh performance indicator ‚Äî detects recent model decay or improvement.">
      <div class="stat-cell-label">Hit Rate 7d</div>
      <div class="stat-cell-val" id="statHitRate7d" style="color:var(--blue)">‚Äî</div>
    </div>
    <div class="stat-cell mobile-only" data-tip-title="Conf: WIN / LOSS" data-tip="Average confidence on winning vs losing bets. A gap > 10% means the AI correctly assigns higher confidence to winning trades ‚Äî good model calibration.">
      <div class="stat-cell-label">Conf: WIN/LOSS</div>
      <div class="stat-cell-val" id="statConfGap" style="color:var(--purple)">‚Äî</div>
    </div>
  </div>

  <!-- CHARTS GRID ‚Äî BTC Price vs Predictions + Rolling Win Rate -->
  <div class="charts-grid">

    <!-- Chart 1: BTC Price + Predictions Overlay -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">BTC Price vs Predictions</div>
        <div style="display:flex;gap:8px;font-size:9px;">
          <span style="color:var(--accent);">‚óè correct</span>
          <span style="color:var(--danger);">‚óè wrong</span>
          <span style="color:var(--muted);">‚ñ≤‚ñº = direction</span>
        </div>
      </div>
      <div style="padding:12px 16px 8px;">
        <svg id="btcOverlaySvg" width="100%" height="110" viewBox="0 0 600 110" preserveAspectRatio="none"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px;">
          <span>oldest</span><span>newest</span>
        </div>
      </div>
    </div>

    <!-- Chart 2: Rolling Win Rate -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Rolling Win Rate (BETs)</div>
        <div style="display:flex;gap:8px;font-size:9px;color:var(--muted);">
          <span style="color:var(--accent);">‚Äî WR-10</span>
          <span style="color:var(--blue);">‚Äî WR-20</span>
          <span style="color:var(--muted);">‚Äî 50%</span>
        </div>
      </div>
      <div style="padding:12px 16px 8px;">
        <svg id="wrSvg" width="100%" height="110" viewBox="0 0 600 110" preserveAspectRatio="none"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px;">
          <span>oldest bet</span><span>newest bet</span>
        </div>
      </div>
    </div>

  </div><!-- /.charts-grid top -->

  <!-- ROLLING WIN RATE FULL-WIDTH -->
  <div class="panel" id="rollingWrFullPanel" style="margin-bottom:14px;">
    <div class="panel-header">
      <div class="panel-title">Rolling Win Rate (20-Bet Window)</div>
      <div class="panel-tag tag-blue" id="rollingWrFullTag">LOADING</div>
    </div>
    <div style="padding:16px 18px 10px;">
      <svg id="rollingWrFullSvg" class="equity-svg" height="110" viewBox="0 0 1000 110" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <!-- CONFIDENCE SCORE FULL-WIDTH -->
  <div class="panel" id="confFullPanel" style="margin-bottom:14px;">
    <div class="panel-header">
      <div class="panel-title">Confidence Score ‚Äî Every Bet</div>
      <div class="panel-tag tag-yellow" id="confFullTag">LOADING</div>
    </div>
    <div style="padding:16px 18px 10px;">
      <svg id="confFullSvg" class="equity-svg" height="110" viewBox="0 0 1000 110" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <div id="dashboardMain">
  <!-- Small panels row: Prediction Galaxy ¬∑ Signal Quality ¬∑ Confidence Distribution -->
  <div id="dashSmallPanels" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px;">

    <div class="panel" id="pnlChartPanel">
      <div class="panel-header">
        <div class="panel-title">Prediction Galaxy ‚ú¶</div>
        <div class="panel-tag tag-blue" id="galaxyTag">CONF √ó PnL</div>
      </div>
      <div style="padding:8px 12px 4px;position:relative;">
        <svg id="galaxySvg" width="100%" height="124" viewBox="-8 -8 336 128" style="overflow:hidden;"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:1px;">
          <span>‚Üê low conf</span><span>confidence</span><span>high conf ‚Üí</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Signal Quality</div>
        <div class="panel-tag tag-blue">LIVE</div>
      </div>
      <div class="signal-grid" id="signalQuality"></div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title" data-tip="How the AI confidence score is distributed across all signals. The vertical dashed line marks the 0.65 threshold ‚Äî only bets above this are executed. Each bar shows bet count and win rate for that confidence bucket.">Confidence Distribution</div>
        <div class="panel-tag tag-yellow">BETs ONLY</div>
      </div>
      <div class="conf-bars" id="confDist"></div>
    </div>

  </div>

  <!-- Lower charts: Confidence Over Time + PnL per Bet -->
  <div class="charts-grid" id="chartsGridLower">

    <!-- Confidence Over Time -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Confidence Over Time</div>
        <div class="panel-tag tag-blue" id="confTag">ALL</div>
      </div>
      <div style="padding:12px 16px 8px;">
        <svg id="confSvg" width="100%" height="110" viewBox="0 0 600 110" preserveAspectRatio="none" overflow="visible"></svg>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px;">
          <span>oldest</span><span>newest</span>
        </div>
      </div>
    </div>

    <!-- PnL Per Bet Bar Chart (large) -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">PnL per Bet ($)</div>
        <div class="panel-tag tag-muted" id="pnlBarsTag">REAL BETS</div>
      </div>
      <div style="padding:12px 16px 8px;">
        <div class="pnl-bars-large" id="pnlBarsLarge"></div>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:4px;">
          <span>oldest</span><span>newest</span>
        </div>
      </div>
    </div>

  </div><!-- /.charts-grid lower -->

  </div><!-- /#dashboardMain -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       AUTO-TRAINING STATUS
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="panel" style="margin-bottom:14px;" id="trainingStatusPanel">
    <div class="panel-header">
      <div>
        <div class="panel-title">Auto-Training &mdash; XGBoost Engine</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px;letter-spacing:0.5px;">Dual-gate AI: XGBoost learns from live bet history. Retrains automatically every Sunday 03:00 UTC. Both XGB + Claude must agree before placing an order.</div>
      </div>
      <div id="trainStatusPill" class="train-status-pill recent" data-tip-title="Auto-Training Status" data-tip="RECENT = retrained &lt;7 days ago. ON TRACK = last train &lt;14 days. RETRAIN READY = &gt;14 days ‚Äî auto-retrain runs every Sunday at 3:00 AM UTC via launchd.">
        <span id="trainStatusDot" style="width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;animation:pulse 2s infinite;"></span>
        <span id="trainStatusText">LOADING</span>
      </div>
    </div>
    <div class="train-panel-grid">
      <div style="display:flex;flex-direction:column;gap:4px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">New Bets Since Retrain</div>
        <div style="display:flex;align-items:baseline;gap:8px;">
          <div style="font-size:28px;font-weight:700;font-family:'Syne',sans-serif;" id="trainBetsSince">‚Äî</div>
          <div style="font-size:11px;color:var(--muted);" id="trainBetsThreshold">/ 30 target</div>
        </div>
        <div class="train-progress-bar">
          <div class="train-progress-fill" id="trainProgressFill" style="width:0%"></div>
        </div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px;" id="trainProgressLabel">0% toward next meaningful retrain</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Direction Accuracy</div>
          <div style="font-size:26px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent);" id="trainDirAcc">‚Äî</div>
          <div style="font-size:9px;color:var(--muted);" id="trainTrainN">‚Äî signals in dataset</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Last Retrain</div>
        <div style="font-size:12px;font-weight:600;color:var(--text);" id="trainLastDate">‚Äî</div>
        <div style="font-size:9px;color:var(--muted);" id="trainDaysAgo">‚Äî</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Next Scheduled</div>
        <div style="font-size:12px;font-weight:600;color:var(--blue);" id="trainNextDate">‚Äî</div>
        <div style="font-size:9px;color:var(--muted);">Sunday 3:00 UTC ¬∑ auto</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TRADING STATS ‚Äî Expectancy & Direction
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="panel" style="margin-bottom:14px;" id="tradingStatsPanel">
    <div class="panel-header">
      <div>
        <div class="panel-title">Trading Stats &mdash; Expectancy</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px;letter-spacing:0.5px;">Expectancy = avg profit per bet. &gt;$0 = edge positive. L20 = last 20 bets trend. WR split reveals UP vs DOWN directional bias.</div>
      </div>
      <div class="panel-tag tag-muted" id="tsVerdictBadge">LOADING</div>
    </div>
    <div style="padding:14px 18px 16px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px 20px;">
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Expectancy</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;" id="tsExpectancy">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);">per bet (all time)</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Expectancy L20</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;" id="tsExpectancyL20">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);">last 20 bets</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Avg Win / Avg Loss</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--warn);" id="tsWinLossRatio">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);">reward/risk ratio</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">UP Bets WR</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--accent);" id="tsUpWr">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);" id="tsUpPnl">PnL: &#8212;</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">DOWN Bets WR</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--danger);" id="tsDownWr">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);" id="tsDownPnl">PnL: &#8212;</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Avg PnL / Bet</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;" id="tsAvgPnl">&#8212;</div>
        <div style="font-size:9px;color:var(--muted);" id="tsAvgPnlSub">wins: &#8212; / losses: &#8212;</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HOURLY WR HEATMAP
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="panel" style="margin-bottom:14px;" id="hourlyHeatmapPanel">
    <div class="panel-header">
      <div class="panel-title">Win Rate per UTC Hour</div>
      <div class="panel-tag tag-muted" id="heatmapTag" data-tip="Hourly performance heatmap. Based on all closed bets ‚Äî shows which UTC hours the bot performs best.">LOADING</div>
    </div>
    <div style="padding:10px 18px 12px;">
      <div id="hourlyHeatmapGrid" style="display:grid;grid-template-columns:repeat(12,1fr);gap:3px;"></div>
      <div style="display:flex;gap:14px;margin-top:6px;font-size:8px;color:var(--muted);">
        <span style="color:var(--accent);">&#9632; &gt;55% WR</span>
        <span style="color:var(--danger);">&#9632; &lt;45% WR</span>
        <span style="color:var(--muted);">&#9632; neutral / no data</span>
        <span style="margin-left:auto;color:var(--muted);">click cell for detail ¬∑ UTC hours 00‚Äì23</span>
      </div>
    </div>
  </div>

  <!-- PAGE BANNERS ‚Äî Row 1: Contributors + Manifesto -->
  <div class="page-banners-grid">

    <!-- Contributors -->
    <div class="page-banner orange">
      <div class="page-banner-ghost">üé©</div>
      <div class="page-banner-body">
        <div class="page-banner-title">I Tanti Padri</div>
        <div class="page-banner-sub">9 menti ¬∑ 8 umani ¬∑ 1 AI ¬∑ ‚àû caff√®</div>
        <div class="page-banner-chips">
          <span class="page-banner-chip">üé© Mattia</span>
          <span class="page-banner-chip">üß† Alessandro</span>
          <span class="page-banner-chip">üîß Riccardo</span>
          <span class="page-banner-chip">ü§ñ Claude</span>
        </div>
      </div>
      <a href="/contributors" class="page-banner-cta" target="_blank">‚Üí la storia</a>
    </div>

    <!-- Manifesto -->
    <div class="page-banner cyan">
      <div class="page-banner-ghost">üìú</div>
      <div class="page-banner-body">
        <div class="page-banner-title">Il Manifesto</div>
        <div class="page-banner-sub">Build in public ¬∑ Behavioral Engine</div>
        <div class="page-banner-chips">
          <span class="page-banner-chip">prevedibilit√†</span>
          <span class="page-banner-chip">abbondanza</span>
          <span class="page-banner-chip">trasparenza</span>
        </div>
      </div>
      <a href="/manifesto" class="page-banner-cta" target="_blank">‚Üí leggi</a>
    </div>

  </div>

  <!-- PAGE BANNERS ‚Äî Row 2: Dual-Gate AI + Prevedibilit√† Perfetta -->
  <div class="page-banners-grid">

    <!-- Dual Gate AI -->
    <div class="page-banner green">
      <div class="ban-scan"></div>
      <div class="page-banner-ghost">‚ö°</div>
      <div class="page-banner-body">
        <div class="page-banner-title">Il Dual-Gate AI</div>
        <div class="page-banner-sub">Claude LLM + XGBoost ¬∑ Due cancelli</div>
        <div class="page-banner-chips">
          <span class="page-banner-chip">Claude Sonnet</span>
          <span class="page-banner-chip">XGBoost</span>
          <span class="page-banner-chip">86% accuracy</span>
        </div>
      </div>
      <a href="/xgboost-spiegato" class="page-banner-cta" target="_blank">‚Üí come funziona</a>
    </div>

    <!-- Prevedibilit√† Perfetta -->
    <div class="page-banner purple">
      <div class="ban-scan" style="animation-delay:2.5s"></div>
      <div class="page-banner-ghost">üîÆ</div>
      <div class="page-banner-body">
        <div class="page-banner-title">Prevedibilit√† Perfetta</div>
        <div class="page-banner-sub">Regime di abbondanza ¬∑ Il percorso</div>
        <div class="page-banner-chips">
          <span class="page-banner-chip">abbondanza</span>
          <span class="page-banner-chip">AI</span>
          <span class="page-banner-chip">il futuro</span>
        </div>
      </div>
      <a href="/prevedibilita-perfetta" class="page-banner-cta" target="_blank">‚Üí scopri</a>
    </div>

  </div>

  <!-- PAGE BANNERS ‚Äî Row 3: AUREO + Investors -->
  <div class="page-banners-grid">

    <!-- AUREO -->
    <div class="page-banner ban-aureo">
      <div class="ban-scan" style="animation-delay:1.2s"></div>
      <div class="page-banner-ghost" style="font-family:serif;font-size:52px;font-weight:700;line-height:1;color:#C9A84C;">A</div>
      <div class="page-banner-body">
        <div class="page-banner-title">AUREO</div>
        <div class="page-banner-sub">Educazione finanziaria italiana ¬∑ Gratuita ¬∑ Verificabile</div>
        <div class="page-banner-chips">
          <span class="page-banner-chip">‚õì on-chain</span>
          <span class="page-banner-chip">free forever</span>
          <span class="page-banner-chip">OCSE 2023</span>
        </div>
      </div>
      <a href="/aureo" class="page-banner-cta" target="_blank">‚Üí scopri</a>
    </div>

    <!-- Investors -->
    <div class="page-banner orange">
      <div class="ban-scan" style="animation-delay:3.8s"></div>
      <div class="page-banner-ghost">üíº</div>
      <div class="page-banner-body">
        <div class="page-banner-title">Investors</div>
        <div class="page-banner-sub">Capital at risk ¬∑ Track record on-chain ¬∑ $100 USDC</div>
        <div class="page-banner-chips">
          <span class="page-banner-chip">live PnL</span>
          <span class="page-banner-chip">Polygon PoS</span>
          <span class="page-banner-chip">early stage</span>
        </div>
      </div>
      <a href="/investors" class="page-banner-cta" target="_blank">‚Üí vedi</a>
    </div>

  </div>

  </div><!-- /#tab-dashboard -->

  <!-- AGENTS TAB -->
  <div id="tab-agents" class="tab-content">

    <div class="tab-intro">
      <div class="tab-intro-icon">ü§ñ</div>
      <div class="tab-intro-text">
        <div class="tab-intro-title">Automation Agents</div>
        <div class="tab-intro-desc">17 n8n workflows orchestrate the entire trading pipeline ‚Äî from data ingestion to AI prediction, trade execution, Telegram notifications, on-chain audit, and social media publishing. The launchd agents run locally on Mac for maintenance, reporting, and orphan bet rescue.</div>
      </div>
    </div>

    <!-- n8n Workflows -->
    <div class="agents-section-header">
      <span>n8n Workflows</span>
      <div style="display:flex;align-items:center;gap:6px">
        <div id="agentStatusFilters" style="display:flex;align-items:center;gap:4px">
          <button class="agent-filter-btn active" data-filter="all"      onclick="filterAgentsByStatus('all')">ALL</button>
          <button class="agent-filter-btn"        data-filter="active"   onclick="filterAgentsByStatus('active')">ACTIVE</button>
          <button class="agent-filter-btn"        data-filter="inactive" onclick="filterAgentsByStatus('inactive')">INACTIVE</button>
          <button class="agent-filter-btn"        data-filter="error"    onclick="filterAgentsByStatus('error')">ERROR</button>
        </div>
        <div style="width:1px;height:16px;background:var(--border)"></div>
        <button class="agents-refresh-btn" onclick="refreshAgentsTab()">‚Üª Refresh</button>
      </div>
    </div>
    <div id="n8nWorkflowsGrid" class="wf-grid">
      <div style="grid-column:1/-1;padding:20px;color:var(--muted);font-size:11px;letter-spacing:1px">
        Premi Refresh per caricare i workflow n8n.
      </div>
    </div>

    <!-- launchd Agents -->
    <div class="agents-section-header"><span>launchd Agents ‚Äî Mac Local</span></div>
    <div class="panel" style="margin-bottom:14px">
      <div class="panel-header">
        <div class="panel-title">Scheduled Tasks</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="panel-tag tag-muted">LOCAL ¬∑ macOS launchd</div>
          <div id="launchdClock" style="font-size:9px;color:var(--muted);font-family:monospace;letter-spacing:1px"></div>
        </div>
      </div>
      <div class="table-wrap">
        <table class="launchd-table">
          <thead>
            <tr>
              <th>AGENT</th>
              <th>LABEL</th>
              <th>SCHEDULE</th>
              <th>NEXT RUN</th>
              <th>LOG</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody id="launchdBody">
            <!-- filled by renderLaunchdTasks() -->
          </tbody>
        </table>
      </div>
    </div>


  </div><!-- /#tab-agents -->

  <!-- BACKTEST TAB -->
  <div id="tab-backtest" class="tab-content">

    <div class="tab-intro">
      <div class="tab-intro-icon">üî¨</div>
      <div class="tab-intro-text">
        <div class="tab-intro-title">Walk-Forward Backtest</div>
        <div class="tab-intro-desc">Out-of-sample simulation across 6 confidence strategies (A‚ÜíF). Each strategy is tested on unseen data to identify the optimal threshold ‚Äî the one that maximizes PnL without overfitting to historical signals.</div>
      </div>
    </div>

    <!-- Launch Backtest -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
      <span id="backtestStatus" style="font-size:11px;color:var(--muted)">Ultimo backtest: caricamento...</span>
    </div>

    <!-- KPI row -->
    <div class="kpi-grid" style="grid-template-columns:repeat(6,1fr);margin-bottom:16px" id="btKpiGrid">
      <div class="kpi" data-tip="Optimal strategy found by the walk-forward backtest.<br>Confidence threshold that maximises PnL.<br>e.g. CONF_062 = minimum confidence 62%."><div class="kpi-label">Best Strategy</div><div class="kpi-value" id="btKpiBest">‚Äî</div><div class="kpi-sub" id="btKpiBestPnl">‚Äî</div></div>
      <div class="kpi" data-tip="Win rate of the current live configuration.<br>FULL_STACK = all signals with no confidence filter applied.<br>Real-time data from Supabase."><div class="kpi-label">Current (FULL_STACK)</div><div class="kpi-value" id="btKpiCurrent">‚Äî</div><div class="kpi-sub" id="btKpiCurrentPnl">‚Äî</div></div>
      <div class="kpi" data-tip="Win rate on the TEST SET (data unseen during training).<br>Measures the true generalisation of the model.<br>N = number of bets in the test set."><div class="kpi-label">Test WR</div><div class="kpi-value" id="btKpiWR">‚Äî</div><div class="kpi-sub" id="btKpiWRSub">‚Äî</div></div>
      <div class="kpi" data-tip="Gross wins √∑ gross losses on the best strategy.<br>&gt;3 = exceptional edge in the backtest.<br>Calculated across all bets in the period."><div class="kpi-label">Profit Factor</div><div class="kpi-value" id="btKpiPF">‚Äî</div><div class="kpi-sub">Best strategy</div></div>
      <div class="kpi" data-tip="XGBoost accuracy in 5-fold cross-validation.<br>Direction model UP/DOWN trained on historical signals.<br>Dual-gate: LLM + XGB must both agree before placing a bet."><div class="kpi-label">XGB CV Acc</div><div class="kpi-value" id="btKpiXgb">‚Äî</div><div class="kpi-sub" id="btKpiXgbSub">train set</div></div>
      <div class="kpi" data-tip="Longest consecutive WIN streak in the backtest.<br>√ó9W = 9 wins in a row (system momentum).<br>Also shows the worst losing streak."><div class="kpi-label">Max Streak</div><div class="kpi-value green" id="btKpiStreak">‚Äî</div><div class="kpi-sub" id="btKpiStreakSub">W / L</div></div>
    </div>

    <!-- Equity curves chart -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Equity Curves ‚Äî Test Set</div>
        <div class="panel-tag tag-muted">per strategia, partendo da $0</div>
      </div>
      <div style="padding:12px 16px 14px">
        <div id="btEquityLegend" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px;font-size:10px"></div>
        <svg id="btEquitySvg" width="100%" height="200" style="display:block;background:#111;border-radius:6px;overflow:visible"></svg>
      </div>
    </div>

    <!-- Strategy table -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Strategy Comparison</div>
        <div class="panel-tag tag-blue">WALK-FORWARD</div>
      </div>
      <div style="overflow-x:auto;padding:0 4px">
        <table style="width:100%;border-collapse:collapse;font-size:11px" id="btStratTable">
          <thead>
            <tr style="color:var(--muted);text-transform:uppercase;font-size:9px;letter-spacing:1px">
              <th style="text-align:left;padding:6px 8px">Strategia</th>
              <th style="text-align:right;padding:6px 8px">N</th>
              <th style="text-align:right;padding:6px 8px">WR%</th>
              <th style="text-align:right;padding:6px 8px">PnL</th>
              <th style="text-align:right;padding:6px 8px">$/bet</th>
              <th style="text-align:right;padding:6px 8px">MaxDD</th>
              <th style="text-align:right;padding:6px 8px">PF</th>
              <th style="text-align:right;padding:6px 8px">Sortino</th>
              <th style="text-align:right;padding:6px 8px">Sharpe</th>
            </tr>
          </thead>
          <tbody id="btStratBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Confidence calibration + Hourly heatmap side by side -->
    <div class="two-col-grid">

      <div class="panel">
        <div class="panel-header"><div class="panel-title">Confidence Calibration</div><div class="panel-tag tag-yellow">CALIBRATION</div></div>
        <div style="padding:0 4px"><table style="width:100%;border-collapse:collapse;font-size:11px">
          <thead>
            <tr style="color:var(--muted);text-transform:uppercase;font-size:9px;letter-spacing:1px">
              <th style="text-align:left;padding:4px 6px">Bucket</th>
              <th style="text-align:right;padding:4px 6px">N</th>
              <th style="text-align:right;padding:4px 6px">ExpWR</th>
              <th style="text-align:right;padding:4px 6px">ActWR</th>
              <th style="text-align:right;padding:4px 6px">Œî</th>
              <th style="text-align:right;padding:4px 6px">$/bet</th>
            </tr>
          </thead>
          <tbody id="btCalibBody"></tbody>
        </table></div>
      </div>

      <div class="panel">
        <div class="panel-header"><div class="panel-title">24h Heatmap ‚Äî Win Rate</div><div class="panel-tag tag-muted">BACKTEST</div></div>
        <div style="padding:12px 16px 14px">
          <div id="btHeatmap" style="display:grid;grid-template-columns:repeat(6,1fr);gap:3px"></div>
          <div style="display:flex;gap:8px;margin-top:8px;font-size:9px;color:var(--muted)">
            <span style="color:var(--accent)">‚ñ† HOT ‚â•60%</span><span style="color:var(--danger)">‚ñ† DEAD &lt;45%</span><span>‚ñ† no data</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Raw text reports (collapsible) -->
    <details style="margin-bottom:12px">
      <summary style="cursor:pointer;font-size:11px;color:var(--muted);padding:6px 0;letter-spacing:1px;text-transform:uppercase">
        ‚ñ∏ Walk-Forward Report (testo grezzo)
        <span id="backtestBadge" style="font-size:10px;font-weight:400;opacity:0.5;margin-left:8px"></span>
      </summary>
      <pre id="backtestReportPre" style="font-size:11px;line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:400px;overflow-y:auto;background:#111;padding:12px;border-radius:6px;color:#ccc;margin-top:8px">Loading...</pre>
    </details>

    <details>
      <summary style="cursor:pointer;font-size:11px;color:var(--muted);padding:6px 0;letter-spacing:1px;text-transform:uppercase">
        ‚ñ∏ XGBoost Model Report
        <span id="xgbBadge" style="font-size:10px;font-weight:400;opacity:0.5;margin-left:8px"></span>
      </summary>
      <pre id="xgbReportPre" style="font-size:11px;line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:500px;overflow-y:auto;background:#111;padding:12px;border-radius:6px;color:#ccc;margin-top:8px">Loading...</pre>
    </details>

  </div><!-- /#tab-backtest -->

  <!-- COSTS TAB -->
  <div id="tab-costs" class="tab-content">

    <div class="tab-intro">
      <div class="tab-intro-icon">üí∏</div>
      <div class="tab-intro-text">
        <div class="tab-intro-title">Operational Costs</div>
        <div class="tab-intro-desc">Real-time breakdown of all costs to run the bot: Kraken trading fees, Anthropic API, n8n VPS, Railway hosting, and Claude Code. Includes one-time build cost ($709.48 Claude Code sessions, Feb 2026). Monthly operational cost: ~$11/mo. Profit only counts after all costs are covered.</div>
      </div>
    </div>

    <!-- 6 KPI -->
    <div class="kpi-grid costs-kpi-grid" style="grid-template-columns:repeat(6,1fr);margin-bottom:16px">
      <div class="kpi red" id="costKpiTotal" data-tip="Total operational cost for the current month.<br>Sum: Kraken fees + AI API + infrastructure.<br>MTD = Month To Date">
        <div class="kpi-label">Total Cost MTD</div>
        <div class="kpi-value red" id="costKpiTotalVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiTotalSub">loading...</div>
      </div>
      <div class="kpi yellow" id="costKpiKraken" data-tip="Trading fees paid to Kraken Futures.<br>Taker fee: 0.005% per fill.<br>Applied on both entry AND exit.">
        <div class="kpi-label">Kraken Fees</div>
        <div class="kpi-value yellow" id="costKpiKrakenVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiKrakenSub">loading...</div>
      </div>
      <div class="kpi blue" id="costKpiN8n" data-tip="n8n VPS (Hostinger KVM1) ‚Äî orchestrates 17 workflows.<br>Unlimited executions ¬∑ self-hosted on Ubuntu 24.04.<br>Migrated from n8n Cloud 2026-02-26.">
        <div class="kpi-label">n8n Plan</div>
        <div class="kpi-value blue" id="costKpiN8nVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiN8nSub">loading...</div>
      </div>
      <div class="kpi purple" id="costKpiClaudeApi" data-tip="Anthropic Claude API cost.<br>Used for: LLM signal generation + email oracle.<br>Model: claude-haiku-4-5 (most cost-efficient).">
        <div class="kpi-label">Claude API</div>
        <div class="kpi-value purple" id="costKpiClaudeApiVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiClaudeApiSub">loading...</div>
      </div>
      <div class="kpi" style="--kc:#e5251b" id="costKpiClaudeCode" data-tip="Claude Code CLI ‚Äî development sessions.<br>One-time build cost: $709.48 (Feb 2026, 409 commits, 29.6k lines added).<br>Monthly dev maintenance: set manually.">
        <div class="kpi-label">Claude Code</div>
        <div class="kpi-value" style="color:#e5251b" id="costKpiClaudeCodeVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiClaudeCodeSub">loading...</div>
      </div>
      <div class="kpi" id="costKpiRailway" data-tip="Railway Hobby Plan: $5/month.<br>Flask + Gunicorn backend + auto-deploy from GitHub.<br>512MB RAM ¬∑ shared CPU ¬∑ deploys on every push.">
        <div class="kpi-label">Railway</div>
        <div class="kpi-value white" id="costKpiRailwayVal">‚Äî</div>
        <div class="kpi-sub" id="costKpiRailwaySub">loading...</div>
      </div>
    </div>

    <!-- Railway Budget Widget -->
    <div style="margin-bottom:16px;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-left:3px solid #8866ff">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <span style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#8866ff">RAILWAY BUDGET ‚Äî Hobby Plan</span>
        <span style="font-size:8px;color:var(--muted)">aggiorna manualmente</span>
      </div>
      <div style="display:flex;gap:28px;align-items:baseline;flex-wrap:wrap">
        <div>
          <div style="font-size:24px;font-weight:800;font-family:'Syne',sans-serif;color:#8866ff" id="rlyCredits" data-credits-base="4.87" data-credits-updated="2026-02-26" data-burn-per-day="0.04">$4.87</div>
          <div style="font-size:8px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px">CREDITS LEFT</div>
        </div>
        <div>
          <div style="font-size:24px;font-weight:800;font-family:'Syne',sans-serif;color:#00ff88" id="rlyBurn">$0.04</div>
          <div style="font-size:8px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px">BURN/DAY</div>
        </div>
        <div>
          <div style="font-size:24px;font-weight:800;font-family:'Syne',sans-serif;color:var(--warn)" id="rlyProj">$1.30</div>
          <div style="font-size:8px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px">PROJ/MONTH</div>
        </div>
      </div>
      <!-- Burn progress: (plan_total - credits_left) / plan_total -->
      <div style="margin-top:12px;height:3px;background:rgba(255,255,255,0.05);border-radius:2px;overflow:hidden">
        <div style="height:100%;width:2.6%;background:linear-gradient(90deg,#8866ff,#00ff88);border-radius:2px"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:4px">
        <span style="font-size:8px;color:var(--muted)">$0.13 used (2.6%)</span>
        <span style="font-size:8px;color:var(--muted)">$5.00 credit/mese</span>
      </div>
    </div>

    <!-- Subscription Expiry Widget -->
    <div id="subscriptionExpiryWidget" style="margin-bottom:16px;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-left:3px solid #00cccc">
      <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#00cccc;margin-bottom:10px">SUBSCRIPTION EXPIRY</div>
      <div id="subscriptionExpiryRows" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>

    <!-- Breakdown -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Cost Breakdown</div>
        <button class="agents-refresh-btn" onclick="refreshCostsTab()">‚Üª Refresh</button>
      </div>
      <div id="costBreakdownBody" style="padding:16px">Loading...</div>
    </div>

  
    <!-- Development History -->
    <div class="panel" style="margin-top:16px;border-left:3px solid #e5251b">
      <div class="panel-header">
        <div class="panel-title">üõ† Development History ‚Äî Build Cost</div>
        <div class="panel-tag" style="background:rgba(229,37,27,0.15);color:#e5251b;border:1px solid rgba(229,37,27,0.3)">ONE-TIME</div>
      </div>
      <div style="padding:16px 20px">

        <!-- Summary row -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
          <div style="display:flex;flex-direction:column;gap:3px">
            <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted)">Total Build Cost</div>
            <div style="font-size:28px;font-weight:800;font-family:'Syne',sans-serif;color:#e5251b">$709.48</div>
            <div style="font-size:9px;color:var(--muted)">Claude Code CLI sessions</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:3px">
            <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted)">Lines of Code</div>
            <div style="font-size:28px;font-weight:800;font-family:'Syne',sans-serif;color:var(--accent)">29,683</div>
            <div style="font-size:9px;color:var(--muted)">added ¬∑ 4,755 removed</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:3px">
            <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted)">Git Commits</div>
            <div style="font-size:28px;font-weight:800;font-family:'Syne',sans-serif;color:var(--warn)">409</div>
            <div style="font-size:9px;color:var(--muted)">main branch</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:3px">
            <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted)">Build Duration</div>
            <div style="font-size:28px;font-weight:800;font-family:'Syne',sans-serif;color:#00cccc">~30d</div>
            <div style="font-size:9px;color:var(--muted)">Feb 2026 ¬∑ from scratch</div>
          </div>
        </div>

        <!-- Session breakdown -->
        <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px">Session Breakdown</div>
        <table class="cost-table">
          <thead>
            <tr>
              <th>Session</th>
              <th>Model</th>
              <th>Cost</th>
              <th>API Time</th>
              <th>Code Changes</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="color:var(--muted);font-size:10px">94969f8e</td>
              <td><span style="font-size:9px;color:#e5251b">claude-sonnet-4-6</span></td>
              <td style="font-weight:700;color:#e5251b">$709.48</td>
              <td style="color:var(--muted);font-size:10px">1d 4h 29m</td>
              <td style="color:var(--accent);font-size:10px">+29,683 / -4,755</td>
              <td style="color:var(--muted);font-size:10px">Full system build ¬∑ Feb 2026</td>
            </tr>
            <tr>
              <td colspan="2" style="color:var(--muted);font-size:10px">Monthly dev maintenance</td>
              <td style="font-weight:700;color:var(--warn)">~$0‚Äì20</td>
              <td colspan="3" style="color:var(--muted);font-size:10px">Bug fixes ¬∑ features ¬∑ optimizations</td>
            </tr>
            <tr>
              <td colspan="2" style="font-weight:700">TOTAL BUILD COST</td>
              <td style="font-weight:700;color:#e5251b">$709.48</td>
              <td colspan="3" style="font-size:10px;color:var(--muted)">one-time ¬∑ operational cost ~$11/mo</td>
            </tr>
          </tbody>
        </table>

        <div style="margin-top:12px;padding:10px 14px;background:rgba(229,37,27,0.05);border:1px solid rgba(229,37,27,0.15);border-radius:4px;font-size:11px;color:var(--muted);line-height:1.6">
          üí° <strong style="color:var(--text)">Build in Public.</strong> This system was built entirely with Claude Code CLI in February 2026, starting from a whiteboard sketch. The $709.48 is the full transparent cost of development ‚Äî no hidden expenses. Monthly operational cost going forward is ~$11/mo (VPS + Railway + domain).
        </div>

        <!-- DONATION SECTION -->
        <div style="margin-top:20px;padding:18px 20px;background:linear-gradient(135deg,rgba(247,147,26,0.05),rgba(0,170,255,0.03));border:1px solid rgba(247,147,26,0.2);border-radius:4px;">
          <div style="display:flex;align-items:flex-start;gap:20px;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <div style="font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--text);margin-bottom:10px;">üôè Support the Build</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.75;margin-bottom:10px;">
                30 days. 409 commits. $709.48 in API calls. Built from a whiteboard sketch to a live trading system ‚Äî line by line, dollar by dollar, all in public.<br>
                If you find value in the radical transparency, the on-chain audit trail, or simply want to keep the server lights on ‚Äî a crypto donation goes directly into operational costs. Every MATIC received is another prediction committed immutably to Polygon. ‚àé
              </div>
              <div style="font-size:9px;letter-spacing:1px;color:var(--muted)">Accepts: <span style="color:var(--accent);font-weight:700">MATIC ¬∑ ETH ¬∑ USDC ¬∑ USDT</span> &nbsp;¬∑&nbsp; Network: <span style="color:var(--blue)">Polygon PoS</span></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:center;">
              <div style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:2px;">Polygon Wallet</div>
              <div style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.03);border:1px solid var(--border);padding:9px 13px;">
                <span style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text);letter-spacing:0.5px;">0x7Ac896‚Ä¶0d51f0</span>
                <button onclick="navigator.clipboard.writeText('0x7Ac896F18ce52a0520dA49C3129520f7B70d51f0');this.textContent='‚úì Copied';setTimeout(()=>this.textContent='‚éò Copy',1500)"
                        style="background:none;border:1px solid var(--border);color:var(--muted);font-size:9px;letter-spacing:1px;padding:4px 9px;cursor:pointer;transition:all 0.15s;white-space:nowrap;"
                        title="Copy full address">‚éò Copy</button>
              </div>
              <a href="https://polygonscan.com/address/0x7Ac896F18ce52a0520dA49C3129520f7B70d51f0"
                 target="_blank" rel="noopener"
                 style="font-size:9px;color:var(--muted);text-decoration:none;letter-spacing:1px;opacity:0.7;">
                View on Polygonscan ‚Üó
              </a>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div><!-- /#tab-costs -->

  <!-- EXPECTANCY TAB -->
  <div id="tab-expectancy" class="tab-content">

    <div class="tab-intro">
      <div class="tab-intro-icon">üìà</div>
      <div class="tab-intro-text">
        <div class="tab-intro-title">Edge Analysis ‚Äî Expectancy</div>
        <div class="tab-intro-desc">Expectancy measures how much the bot earns on average per bet. A positive value confirms a real statistical edge. Rolling L20 shows whether that edge is stable or degrading over the most recent 20 trades.</div>
      </div>
    </div>

    <!-- KPI row -->
    <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px">
      <div class="kpi green" data-tip-title="EXPECTANCY / TRADE" data-tip="Expected profit per closed bet.<br>Formula: E = WR √ó avgWin ‚àí (1‚àíWR) √ó avgLoss<br>Positive = statistically proven edge.<br>$0.08 = on average each bet earns $0.08.">
        <div class="kpi-label">Expectancy / Trade</div>
        <div class="kpi-value green" id="exp-expectancy">‚Äî</div>
        <div class="kpi-sub">E = WR x avgWin - (1-WR) x avgLoss</div>
      </div>
      <div class="kpi yellow" data-tip-title="PROFIT FACTOR" data-tip="Gross wins √∑ gross losses.<br>= 1.0 ‚Üí break even<br>&gt; 1.5 ‚Üí good edge<br>&gt; 2.0 ‚Üí excellent (top-tier systems)">
        <div class="kpi-label">Profit Factor</div>
        <div class="kpi-value yellow" id="exp-profitFactor">‚Äî</div>
        <div class="kpi-sub">gross wins / gross losses</div>
      </div>
      <div class="kpi blue" data-tip-title="KELLY CRITERION" data-tip="Optimal fraction of capital to risk per bet.<br>Formula: K% = WR ‚àí (1‚àíWR) / (avgWin/avgLoss)<br>Use ¬Ω Kelly in practice for lower variance.<br>Shown as theoretical maximum.">
        <div class="kpi-label">Kelly %</div>
        <div class="kpi-value blue" id="exp-kelly">‚Äî</div>
        <div class="kpi-sub">optimal fraction</div>
      </div>
      <div class="kpi purple" data-tip-title="WIN RATE" data-tip="% of closed bets with correct direction prediction.<br>&gt;55% needed for profitability after fees at avg R/R.<br>Rolling L20 shows whether edge is stable or drifting.">
        <div class="kpi-label">Win Rate</div>
        <div class="kpi-value purple" id="exp-winRate">‚Äî</div>
        <div class="kpi-sub" id="exp-winRateSub">executed bets</div>
      </div>
    </div>

    <!-- Expectancy detail panel -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Expectancy &mdash; Formula Breakdown</div>
        <div class="panel-tag" id="exp-verdictBadge" style="background:rgba(74,96,112,0.15);color:var(--muted);border:1px solid rgba(74,96,112,0.3)">LOADING</div>
      </div>
      <div style="padding:18px 20px;display:grid;grid-template-columns:repeat(3,1fr);gap:14px 24px;" id="exp-breakdownGrid">
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Avg Win</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent);" id="exp-avgWin">‚Äî</div>
          <div style="font-size:9px;color:var(--muted);">per winning bet</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Avg Loss</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--danger);" id="exp-avgLoss">‚Äî</div>
          <div style="font-size:9px;color:var(--muted);">per losing bet</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Win/Loss Ratio</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--warn);" id="exp-wlRatio">‚Äî</div>
          <div style="font-size:9px;color:var(--muted);">avgWin / avgLoss</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Total Bets (closed)</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;" id="exp-totalBets">‚Äî</div>
          <div style="font-size:9px;color:var(--muted);">sample size</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Gross Wins</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent);" id="exp-grossWins">‚Äî</div>
          <div style="font-size:9px;color:var(--muted);">sum of profitable trades</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);">Gross Losses</div>
          <div style="font-size:22px;font-weight:700;font-family:'Syne',sans-serif;color:var(--danger);" id="exp-grossLosses">‚Äî</div>
          <div style="font-size:9px;color:var(--muted);">sum of losing trades</div>
        </div>
      </div>
    </div>

    <!-- Direction breakdown -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" style="color:var(--accent)">‚ñ≤ UP Bets</div>
          <div class="panel-tag tag-green" id="exp-upWrBadge">‚Äî</div>
        </div>
        <div style="padding:14px 18px;display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Win Rate</span>
            <span style="font-weight:700;color:var(--accent)" id="exp-upWr">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Total PnL</span>
            <span style="font-weight:700" id="exp-upPnl">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Count</span>
            <span style="font-weight:700" id="exp-upCount">‚Äî</span>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" style="color:var(--danger)">‚ñº DOWN Bets</div>
          <div class="panel-tag tag-red" id="exp-downWrBadge">‚Äî</div>
        </div>
        <div style="padding:14px 18px;display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Win Rate</span>
            <span style="font-weight:700;color:var(--danger)" id="exp-downWr">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Total PnL</span>
            <span style="font-weight:700" id="exp-downPnl">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;font-size:11px">
            <span style="color:var(--muted)">Count</span>
            <span style="font-weight:700" id="exp-downCount">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Expectancy L20 rolling -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Rolling Expectancy &mdash; Last 20 Bets</div>
        <div class="panel-tag tag-blue" id="exp-l20Badge">‚Äî</div>
      </div>
      <div style="padding:14px 20px;display:flex;align-items:baseline;gap:12px;flex-wrap:wrap">
        <div style="font-size:36px;font-weight:800;font-family:'Syne',sans-serif;" id="exp-l20">‚Äî</div>
        <div style="font-size:11px;color:var(--muted);line-height:1.6">
          Expectancy over the last 20 closed bets.<br>
          Positive = system profitable in the short term.
        </div>
      </div>
    </div>

  </div><!-- /#tab-expectancy -->

  <!-- TRAINING TAB -->
  <div id="tab-training" class="tab-content">

    <div class="tab-intro">
      <div class="tab-intro-icon">üß†</div>
      <div class="tab-intro-text">
        <div class="tab-intro-title">XGBoost Model ‚Äî Training & Status</div>
        <div class="tab-intro-desc">The dual-gate prediction engine trains a gradient-boosted classifier on historical signals. Direction model targets UP/DOWN accuracy; correctness model predicts whether the LLM will be right. Both must agree before a bet is placed.</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SECTION 1: Status header ‚îÄ‚îÄ -->
    <div class="panel" style="margin-bottom:16px">
      <div class="panel-header">
        <div class="panel-title">Auto-Training &mdash; XGBoost Engine</div>
        <div style="display:flex;align-items:center;gap:10px">
          <span id="trn-stateBadge" class="trn-badge trained">
            <span style="width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;animation:pulse 2s infinite;display:inline-block;"></span>
            <span id="trn-statusText">LOADING</span>
          </span>
        </div>
      </div>
      <div style="padding:14px 18px 16px">
        <div id="trn-statusPill" class="train-status-pill recent" style="display:none"><span id="trn-statusText2"></span></div>
        <!-- Retrain progress -->
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:6px">
          <span>Bets toward next retrain</span>
          <span id="trn-progressLabel" class="trn-mono" style="font-size:10px">‚Äî</span>
        </div>
        <div class="train-progress-bar">
          <div class="train-progress-fill" id="trn-progressFill" style="width:0%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:4px">
          <span id="trn-betsSince" class="trn-mono" style="font-size:9px">‚Äî</span>
          <span id="trn-betsThr" style="font-size:9px">/ 30 new bets</span>
        </div>
      </div>
    </div>

    <div class="trn-section-sep"></div>

    <!-- ‚îÄ‚îÄ SECTION 2: Key Metric Cards ‚îÄ‚îÄ -->
    <div class="trn-metric-cards">
      <div class="trn-metric-card" style="cursor:pointer" onclick="showStatExplain(event,'Accuracy','% of predictions matching actual BTC direction on the cross-validation test set. XGBoost is trained on historical bet data and evaluated on unseen samples. Target: >60%.')">
        <div class="trn-metric-icon">&#127919;</div>
        <div class="trn-metric-label">CV Accuracy <span class="stat-info-icon">‚ìò</span></div>
        <div class="trn-metric-value green" id="trn-dirAcc">‚Äî</div>
        <div class="trn-acc-bar-wrap">
          <div class="trn-acc-bar-track">
            <div class="trn-acc-bar-fill" id="trn-accBarFill" style="width:0%"></div>
          </div>
        </div>
        <div class="trn-metric-sub" id="trn-trainN">‚Äî signals</div>
      </div>
      <div class="trn-metric-card" style="cursor:pointer" onclick="showStatExplain(event,'Last Trained','Date of the last model retraining. XGBoost learns from new trade history automatically every Sunday at 3:00 AM UTC via a local launchd job.')">
        <div class="trn-metric-icon">&#128197;</div>
        <div class="trn-metric-label">Last Retrain <span class="stat-info-icon">‚ìò</span></div>
        <div class="trn-metric-value" id="trn-lastDate" style="font-size:12px">‚Äî</div>
        <div class="trn-metric-sub" id="trn-daysAgo">‚Äî</div>
      </div>
      <div class="trn-metric-card" style="cursor:pointer" onclick="showStatExplain(event,'Features','Number of data inputs used by XGBoost for each prediction: RSI14, EMA9/21, ATR, ADX, funding rate, L/S ratio, taker ratio, fear &amp; greed, hour cyclical encoding, and more.')">
        <div class="trn-metric-icon">&#9201;</div>
        <div class="trn-metric-label">Next Scheduled <span class="stat-info-icon">‚ìò</span></div>
        <div class="trn-metric-value yellow" id="trn-nextDate" style="font-size:12px">‚Äî</div>
        <div class="trn-metric-sub">Sunday 3:00 UTC</div>
      </div>
      <div class="trn-metric-card" style="cursor:pointer" onclick="showStatExplain(event,'Model','XGBoost Classifier ‚Äî gradient boosting algorithm optimized for binary classification (UP vs DOWN). Uses dual-gate: XGBoost AND Claude must agree before a bet is placed.')">
        <div class="trn-metric-icon">&#128272;</div>
        <div class="trn-metric-label">Confidence Thr. <span class="stat-info-icon">‚ìò</span></div>
        <div class="trn-metric-value" id="trn-confThr">‚Äî</div>
        <div class="trn-metric-sub">min to open bet</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ CALIBRATION STRIP ‚îÄ‚îÄ -->

    <div class="trn-section-sep"></div>

    <!-- ‚îÄ‚îÄ SECTION 3: Models + Pipeline ‚îÄ‚îÄ -->
    <div class="two-col-grid">

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Model Status</div>
          <div class="panel-tag tag-muted">LIVE</div>
        </div>
        <div style="padding:14px 18px;display:flex;flex-direction:column;gap:2px">
          <div class="trn-model-row">
            <span style="color:var(--muted)">XGB Direction</span>
            <span id="trn-xgbStatus" class="trn-mono">‚Äî</span>
          </div>
          <div class="trn-model-row">
            <span style="color:var(--muted)">XGB Correctness</span>
            <span id="trn-corrStatus" class="trn-mono">‚Äî</span>
          </div>
          <div class="trn-model-row">
            <span style="color:var(--muted)">Base Position Size</span>
            <span id="trn-baseSize" class="trn-mono">‚Äî</span>
          </div>
          <div style="padding-top:10px">
            <div style="font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px">Dead Hours UTC</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--warn);letter-spacing:1px" id="trn-deadHours">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Automated Pipeline</div>
          <div class="panel-tag tag-blue">LAUNCHD ¬∑ DOM 3:00 UTC</div>
        </div>
        <div style="padding:14px 18px">
          <div style="font-size:11px;line-height:2;color:var(--text)">
            <span style="color:var(--muted);display:inline-block;width:16px">1.</span><code style="font-size:10px;color:var(--accent)">build_dataset.py</code> ‚Äî refresh dataset from Supabase<br>
            <span style="color:var(--muted);display:inline-block;width:16px">2.</span><code style="font-size:10px;color:var(--accent)">train_xgboost.py</code> ‚Äî retrain XGBoost<br>
            <span style="color:var(--muted);display:inline-block;width:16px">3.</span><code style="font-size:10px;color:var(--accent)">backtest.py</code> ‚Äî walk-forward validation<br>
            <span style="color:var(--muted);display:inline-block;width:16px">4.</span><code style="font-size:10px;color:var(--accent)">analyze_errors.py</code> ‚Äî error pattern analysis<br>
            <span style="color:var(--muted);display:inline-block;width:16px">5.</span><span style="color:var(--blue)">git push ‚Üí Railway auto-deploy</span><br>
            <span style="color:var(--muted);display:inline-block;width:16px">6.</span><span style="color:var(--blue)">/reload-calibration ‚Üí hot reload</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Raw reports -->
    <details style="margin-bottom:12px">
      <summary style="cursor:pointer;font-size:11px;color:var(--muted);padding:6px 0;letter-spacing:1px;text-transform:uppercase">‚ñ∏ XGBoost Model Report</summary>
      <pre id="trn-xgbReport" style="font-size:11px;line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:500px;overflow-y:auto;background:#111;padding:12px;border-radius:6px;color:#ccc;margin-top:8px">Loading...</pre>
    </details>
    <details>
      <summary style="cursor:pointer;font-size:11px;color:var(--muted);padding:6px 0;letter-spacing:1px;text-transform:uppercase">‚ñ∏ Walk-Forward Backtest Report</summary>
      <pre id="trn-backtestReport" style="font-size:11px;line-height:1.6;white-space:pre-wrap;overflow-x:auto;max-height:400px;overflow-y:auto;background:#111;padding:12px;border-radius:6px;color:#ccc;margin-top:8px">Loading...</pre>
    </details>

  </div><!-- /#tab-training -->

</div><!-- /.container -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ACCOUNT SUMMARY SECTION ‚Äî bottom of page
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section-divider" style="margin-bottom:12px;margin-top:24px;max-width:1200px;margin-left:auto;margin-right:auto;padding:0 16px;">
    <div class="section-divider-label" style="font-size:11px;color:var(--accent);letter-spacing:3px;display:flex;align-items:center;gap:7px;">
      <span style="width:7px;height:7px;border-radius:50%;background:var(--accent);display:inline-block;animation:pulse 2s infinite;flex-shrink:0;"></span>
      LIVE ACCOUNT
    </div>
    <div class="section-divider-line"></div>
    <div class="section-divider-ts" id="acctTs" style="font-size:9px;">Loading...</div>
  </div>

  <div class="account-summary-grid" style="max-width:1200px;margin:0 auto 40px;padding:0 16px;">

    <!-- WALLET -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">üí∞</span>Wallet</div>
        <div class="panel-tag tag-blue" id="acctWalletTag">‚Äî</div>
      </div>
      <div class="acct-body" id="acctWalletBody">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%"></div>
          <div class="skeleton-line" style="width:80%"></div>
          <div class="skeleton-line" style="width:60%"></div>
          <div class="skeleton-line" style="width:90%"></div>
        </div>
      </div>
    </div>

    <!-- POSITION -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">üìç</span>Position</div>
        <div class="panel-tag" id="acctPositionTag" style="background:rgba(74,96,112,0.15);color:var(--muted);border:1px solid rgba(74,96,112,0.3)">FLAT</div>
      </div>
      <div class="acct-body" id="acctPositionBody">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%"></div>
          <div class="skeleton-line" style="width:70%"></div>
          <div class="skeleton-line" style="width:85%"></div>
        </div>
      </div>
    </div>

    <!-- BTC PRICE -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">‚Çø</span>BTC Live</div>
        <div class="panel-tag tag-green" id="acctBtcTag">‚Äî</div>
      </div>
      <div class="acct-body" id="acctBtcBody">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%"></div>
          <div class="skeleton-line" style="width:75%"></div>
          <div class="skeleton-line" style="width:60%"></div>
        </div>
      </div>
    </div>

    <!-- RECENT FILLS -->
    <div class="acct-panel">
      <div class="acct-panel-header">
        <div class="acct-panel-title"><span class="icon">üïê</span>Recent Fills</div>
        <div class="panel-tag tag-yellow" id="acctFillsTag">‚Äî</div>
      </div>
      <div id="acctFillsBody" style="padding:0;">
        <div class="acct-skeleton">
          <div class="skeleton-line" style="width:100%;margin:14px 16px 0;width:calc(100% - 32px)"></div>
          <div class="skeleton-line" style="width:90%;margin:0 16px;width:calc(90% - 32px)"></div>
          <div class="skeleton-line" style="width:80%;margin:0 16px 14px;width:calc(80% - 32px)"></div>
        </div>
      </div>
    </div>

  </div>
  <!-- END ACCOUNT SUMMARY -->

<!-- ‚îÄ‚îÄ Brain AI Recalibrate Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="brainOverlay" class="brain-overlay" aria-hidden="true" role="dialog">
  <div class="brain-box">
    <div class="brain-orbit-wrap">
      <div class="brain-ring"></div>
      <div class="brain-ring brain-ring-2"></div>
      <div class="brain-ring brain-ring-3"></div>
      <div class="brain-center">üß†</div>
      <div class="brain-particle"></div>
      <div class="brain-particle"></div>
      <div class="brain-particle"></div>
      <div class="brain-particle"></div>
    </div>
    <div class="brain-lbl">RECALIBRATING<span class="brain-cur">_</span></div>
    <div class="brain-sub" id="brainSubLabel">RELOADING THRESHOLDS FROM LIVE DATA</div>
  </div>
</div>

<footer>
  <div class="footer-text">ASTRA DIGITAL MARKETING ¬∑ <span>BOT ENGINE</span> ¬∑ AUTO REFRESH 60s</div>
  <div class="footer-text" style="font-size:9px">
    ‚õì <span>ON-CHAIN</span> ¬∑ Polygon PoS ¬∑
    <a href="https://polygonscan.com/address/0xe4661F7dB62644951Eb1F9Fd23DB90e647833a55" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;letter-spacing:1px" title="BTCBotAudit.sol ‚Äî immutable prediction audit trail">0xe4661F‚Ä¶833a55 ‚Üó</a>
  </div>
  <div class="config-hint">Table: <code>btc_predictions</code> ¬∑ Capital: <code id="footerCapital">$100 USDC</code> ¬∑ Refresh <code>60s</code></div>
  <div class="footer-text" style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
    <span><span style="font-size:16px">‚úâ</span> <a href="mailto:signal@btcpredictor.io" style="color:var(--accent);text-decoration:none;letter-spacing:1px">signal@btcpredictor.io</a></span>
    <span>
      <a href="https://github.com/mattiacalastri/btc_predictions" target="_blank" rel="noopener" style="color:var(--muted);text-decoration:none;letter-spacing:1px;font-size:9px" title="Open source on GitHub">‚¨° GITHUB ‚Üó</a>
    </span>
    <span style="font-size:9px;color:var(--muted)">
      <a href="/xgboost-spiegato" style="color:var(--muted);text-decoration:none;letter-spacing:1px">HOW IT WORKS</a>
    </span>
    <span style="font-size:9px;color:var(--muted)">
      <a href="/contributors" style="color:var(--muted);text-decoration:none;letter-spacing:1px">CONTRIBUTORS</a>
    </span>
    <span style="font-size:9px">
      <a href="/investors" style="color:var(--btc);text-decoration:none;letter-spacing:1px;font-weight:600">üíº INVESTORS</a>
    </span>
    <span style="font-size:9px;color:var(--muted)">
      <a href="/legal" style="color:var(--muted);text-decoration:none;letter-spacing:1px">LEGAL &amp; PRIVACY</a>
    </span>
  </div>
  <div class="footer-text" style="font-size:8px;color:var(--muted);max-width:640px;line-height:1.7">
    ü§ñ <span style="color:var(--accent);letter-spacing:1px">AI-GENERATED SIGNALS</span> ‚Äî Segnali generati da sistema AI automatico (LLM + XGBoost). Operativit√† su capitale proprio esclusivamente.<br>
    ‚ö† NOT FINANCIAL ADVICE. Questo sistema √® sperimentale e a scopo puramente educativo e informativo. Non costituisce consulenza finanziaria n√© raccomandazione di investimento ai sensi del D.Lgs. 58/1998 (TUF) e della Direttiva MiFID II.
    Performance passate non garantiscono risultati futuri. Il trading di derivati crypto comporta rischio di perdita totale del capitale. Use at your own risk.
  </div>
</footer>

<script>
// ‚îÄ‚îÄ INTRO I18N ‚Äî auto-detect language, apply to welcome intro only ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const INTRO_I18N = {
  en: {
    badge:     'WHAT IS THIS?',
    headline:  'An AI bot that trades Bitcoin \u2014 with real money.',
    desc:      'Every 10 minutes, the bot analyses BTC price, news, order flow and sentiment using <strong>XGBoost ML + Claude AI</strong>. If both agree on the direction, it opens a real trade on the <strong>Kraken</strong> exchange \u2014 then closes it automatically. No human intervention.',
    bullet1:   'Started in February 2026 with <strong>$100 USDC</strong> \u2014 this is real capital, not a simulation',
    bullet2:   'Every prediction is permanently committed to the <strong>Polygon blockchain</strong> \u2014 fully verifiable',
    bullet3:   'Fully <strong>open source</strong> \u2014 code on GitHub, workflow logic documented',
    lbl_wr:    'Win Rate', lbl_pnl: 'Total PnL', lbl_trades: 'Closed Trades',
    cta:       'Got it, let me explore \u2192',
    hint:      'You can re-open this anytime with the <strong>?</strong> button in the header',
  },
  it: {
    badge:     'COSA \u00c8?',
    headline:  'Un bot AI che fa trading su Bitcoin \u2014 con soldi veri.',
    desc:      'Ogni 10 minuti, il bot analizza prezzo BTC, notizie, flusso ordini e sentiment con <strong>XGBoost ML + Claude AI</strong>. Se entrambi concordano sulla direzione, apre un trade reale su <strong>Kraken</strong> \u2014 poi si chiude automaticamente. Nessun intervento umano.',
    bullet1:   'Partito a febbraio 2026 con <strong>$100 USDC</strong> \u2014 capitale reale, non una simulazione',
    bullet2:   'Ogni previsione \u00e8 registrata permanentemente sulla <strong>blockchain Polygon</strong> \u2014 verificabile',
    bullet3:   'Completamente <strong>open source</strong> \u2014 codice su GitHub, logica documentata',
    lbl_wr:    'Win Rate', lbl_pnl: 'PnL Totale', lbl_trades: 'Trade Chiusi',
    cta:       'Capito, voglio esplorare \u2192',
    hint:      'Puoi riaprire questa schermata con il bottone <strong>?</strong> in alto',
  },
  de: {
    badge:     'WAS IST DAS?',
    headline:  'Ein KI-Bot, der Bitcoin handelt \u2014 mit echtem Geld.',
    desc:      'Alle 10 Minuten analysiert der Bot BTC-Preis, Nachrichten, Orderflow und Sentiment mit <strong>XGBoost ML + Claude AI</strong>. Wenn beide \u00fcbereinstimmen, \u00f6ffnet er einen echten Trade auf <strong>Kraken</strong> \u2014 und schlie\u00dft ihn automatisch. Kein menschliches Eingreifen.',
    bullet1:   'Gestartet im Februar 2026 mit <strong>100\u00a0$\u00a0USDC</strong> \u2014 echtes Kapital, keine Simulation',
    bullet2:   'Jede Vorhersage wird dauerhaft auf der <strong>Polygon-Blockchain</strong> gespeichert \u2014 vollst\u00e4ndig verifizierbar',
    bullet3:   'Vollst\u00e4ndig <strong>Open Source</strong> \u2014 Code auf GitHub, Workflow dokumentiert',
    lbl_wr:    'Trefferquote', lbl_pnl: 'Gesamt-PnL', lbl_trades: 'Geschl. Trades',
    cta:       'Verstanden, erkunden \u2192',
    hint:      'Sie k\u00f6nnen dies jederzeit \u00fcber den <strong>?</strong>-Button im Header \u00f6ffnen',
  },
  fr: {
    badge:     'QU\u2019EST-CE QUE C\u2019EST\u00a0?',
    headline:  'Un bot IA qui trade Bitcoin \u2014 avec de l\u2019argent r\u00e9el.',
    desc:      'Toutes les 10 minutes, le bot analyse le prix BTC, les nouvelles, le flux d\u2019ordres et le sentiment avec <strong>XGBoost ML + Claude AI</strong>. S\u2019ils s\u2019accordent, il ouvre un vrai trade sur <strong>Kraken</strong> \u2014 puis le ferme automatiquement. Aucune intervention humaine.',
    bullet1:   'Lanc\u00e9 en f\u00e9vrier 2026 avec <strong>100\u00a0$ USDC</strong> \u2014 capital r\u00e9el, pas une simulation',
    bullet2:   'Chaque pr\u00e9diction est enregistr\u00e9e sur la <strong>blockchain Polygon</strong> \u2014 enti\u00e8rement v\u00e9rifiable',
    bullet3:   'Enti\u00e8rement <strong>open source</strong> \u2014 code sur GitHub, logique document\u00e9e',
    lbl_wr:    'Taux de R\u00e9ussite', lbl_pnl: 'PnL Total', lbl_trades: 'Trades Ferm\u00e9s',
    cta:       'Compris, j\u2019explore \u2192',
    hint:      'Vous pouvez rouvrir ceci avec le bouton <strong>?</strong> dans l\u2019en-t\u00eate',
  },
  es: {
    badge:     '\u00bfQU\u00c9 ES ESTO?',
    headline:  'Un bot de IA que opera en Bitcoin \u2014 con dinero real.',
    desc:      'Cada 10 minutos, el bot analiza precio BTC, noticias, flujo de \u00f3rdenes y sentimiento con <strong>XGBoost ML + Claude AI</strong>. Si ambos coinciden, abre una operaci\u00f3n real en <strong>Kraken</strong> \u2014 luego la cierra autom\u00e1ticamente. Sin intervenci\u00f3n humana.',
    bullet1:   'Iniciado en febrero de 2026 con <strong>100\u00a0$ USDC</strong> \u2014 capital real, no una simulaci\u00f3n',
    bullet2:   'Cada predicci\u00f3n se registra permanentemente en la <strong>blockchain de Polygon</strong> \u2014 totalmente verificable',
    bullet3:   'Completamente <strong>open source</strong> \u2014 c\u00f3digo en GitHub, l\u00f3gica documentada',
    lbl_wr:    'Tasa de \u00c9xito', lbl_pnl: 'PnL Total', lbl_trades: 'Oper. Cerradas',
    cta:       'Entendido, explorar \u2192',
    hint:      'Puedes reabrir esto con el bot\u00f3n <strong>?</strong> en el encabezado',
  },
  pt: {
    badge:     'O QUE \u00c9 ISSO?',
    headline:  'Um bot de IA que opera Bitcoin \u2014 com dinheiro real.',
    desc:      'A cada 10 minutos, o bot analisa pre\u00e7o do BTC, not\u00edcias, fluxo de ordens e sentimento com <strong>XGBoost ML + Claude AI</strong>. Se ambos concordam, abre uma opera\u00e7\u00e3o real na <strong>Kraken</strong> \u2014 depois fecha automaticamente. Sem interven\u00e7\u00e3o humana.',
    bullet1:   'Iniciado em fevereiro de 2026 com <strong>100\u00a0$ USDC</strong> \u2014 capital real, n\u00e3o uma simula\u00e7\u00e3o',
    bullet2:   'Cada previs\u00e3o \u00e9 registrada permanentemente na <strong>blockchain Polygon</strong> \u2014 totalmente verific\u00e1vel',
    bullet3:   'Completamente <strong>open source</strong> \u2014 c\u00f3digo no GitHub, l\u00f3gica documentada',
    lbl_wr:    'Taxa de Acerto', lbl_pnl: 'PnL Total', lbl_trades: 'Oper. Fechadas',
    cta:       'Entendido, explorar \u2192',
    hint:      'Voc\u00ea pode reabrir isso com o bot\u00e3o <strong>?</strong> no cabe\u00e7alho',
  },
  zh: {
    badge:     '\u8fd9\u662f\u4ec0\u4e48\uff1f',
    headline:  '\u4e00\u4e2a\u7528\u771f\u5b9e\u8d44\u91d1\u4ea4\u6613\u6bd4\u7279\u5e01\u7684AI\u673a\u5668\u4eba\u3002',
    desc:      '\u6bcf10\u5206\u949f\uff0c\u673a\u5668\u4eba\u4f7f\u7528 <strong>XGBoost ML + Claude AI</strong> \u5206\u6790BTC\u4ef7\u683c\u3001\u65b0\u95fb\u3001\u8ba2\u5355\u6d41\u548c\u5e02\u573a\u60c5\u7eea\u3002\u5982\u679c\u4e24\u8005\u5bf9\u65b9\u5411\u8fbe\u6210\u4e00\u81f4\uff0c\u5c31\u5728 <strong>Kraken</strong> \u5f00\u4ed3\u2014\u2014\u7136\u540e\u81ea\u52a8\u5e73\u4ed3\u3002\u65e0\u9700\u4eba\u5de5\u5e72\u9884\u3002',
    bullet1:   '2026\u5e742\u6708\u4ee5 <strong>100 USDC</strong> \u542f\u52a8 \u2014 \u771f\u5b9e\u8d44\u91d1\uff0c\u975e\u6a21\u62df',
    bullet2:   '\u6bcf\u4e2a\u9884\u6d4b\u90fd\u6c38\u4e45\u8bb0\u5f55\u5728 <strong>Polygon\u533a\u5757\u94fe</strong> \u4e0a \u2014 \u5b8c\u5168\u53ef\u9a8c\u8bc1',
    bullet3:   '\u5b8c\u5168 <strong>\u5f00\u6e90</strong> \u2014 \u4ee3\u7801\u5728GitHub\uff0c\u5de5\u4f5c\u6d41\u7a0b\u5df1\u8bb0\u5f55',
    lbl_wr:    '\u80dc\u7387', lbl_pnl: '\u603b PnL', lbl_trades: '\u5df2\u5173\u95ed\u4ea4\u6613',
    cta:       '\u660e\u767d\u4e86\uff0c\u53bb\u63a2\u7d22 \u2192',
    hint:      '\u968f\u65f6\u70b9\u51fb\u6807\u9898\u680f\u7684 <strong>?</strong> \u6309\u9215\u91cd\u65b0\u6253\u5f00\u6b64\u9875\u9762',
  },
  ja: {
    badge:     '\u3053\u308c\u306f\u4f55\uff1f',
    headline:  '\u672c\u7269\u306e\u8cc7\u91d1\u3067Bitcoin\u3092\u53d6\u5f15\u3059\u308bAI\u30dc\u30c3\u30c8\u3002',
    desc:      '10\u5206\u3054\u3068\u306b\u3001\u30dc\u30c3\u30c8\u306f <strong>XGBoost ML + Claude AI</strong> \u3092\u4f7f\u7528\u3057\u3066BTC\u4fa1\u683c\u3001\u30cb\u30e5\u30fc\u30b9\u3001\u6ce8\u6587\u30d5\u30ed\u30fc\u3001\u30bb\u30f3\u30c1\u30e1\u30f3\u30c8\u3092\u5206\u6790\u3057\u307e\u3059\u3002\u4e21\u8005\u304c\u5408\u610f\u3059\u308b\u3068\u3001<strong>Kraken</strong> \u3067\u30ea\u30a2\u30eb\u30c8\u30ec\u30fc\u30c9\u3092\u958b\u304d\u2014\u81ea\u52d5\u30af\u30ed\u30fc\u30ba\u3002\u4eba\u9593\u306e\u4ecb\u5165\u306f\u4e0d\u8981\u3002',
    bullet1:   '2026\u5e742\u6708\u306b <strong>100 USDC</strong> \u3067\u30b9\u30bf\u30fc\u30c8 \u2014 \u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3067\u306f\u306a\u304f\u5b9f\u969b\u306e\u8cc7\u91d1',
    bullet2:   '\u3059\u3079\u3066\u306e\u4e88\u6e2c\u306f <strong>Polygon\u30d6\u30ed\u30c3\u30af\u30c1\u30a7\u30fc\u30f3</strong> \u306b\u6c38\u4e45\u8a18\u9332 \u2014 \u5b8c\u5168\u306b\u691c\u8a3c\u53ef\u80fd',
    bullet3:   '\u5b8c\u5168 <strong>\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9</strong> \u2014 GitHub\u306b\u30b3\u30fc\u30c9\u516c\u958b\u3001\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u6587\u66f8\u5316\u6e08',
    lbl_wr:    '\u52dd\u7387', lbl_pnl: '\u7dcf PnL', lbl_trades: '\u30af\u30ed\u30fc\u30ba\u6e08',
    cta:       '\u308f\u304b\u308a\u307e\u3057\u305f\u3001\u63a2\u7d22\u3059\u308b \u2192',
    hint:      '\u30d8\u30c3\u30c0\u30fc\u306e <strong>?</strong> \u30dc\u30bf\u30f3\u3067\u3044\u3064\u3067\u3082\u518d\u8868\u793a\u3067\u304d\u307e\u3059',
  },
  ko: {
    badge:     '\uc774\uac8c \ub079\uc778\uac00\uc694?',
    headline:  '\uc2e4\uc81c \ub3c8\uc73c\ub85c \ube44\ud2b8\ucf54\uc778\uc744 \uac70\ub798\ud558\ub294 AI \ubd07.',
    desc:      '10\ubd84\ub9c8\ub2e4 \ubd07\uc774 <strong>XGBoost ML + Claude AI</strong>\ub97c \uc0ac\uc6a9\ud574 BTC \uac00\uaca9, \ub274\uc2a4, \uc8fc\ubb38 \ud750\ub984, \uc2dc\uc7a5 \uc2ec\ub9ac\ub97c \ubd84\uc11d\ud569\ub2c8\ub2e4. \ub458 \ub2e4 \ubc29\ud5a5\uc5d0 \ub3d9\uc758\ud558\uba74 <strong>Kraken</strong>\uc5d0\uc11c \uc2e4\uc81c \uac70\ub798\ub97c \uac1c\uc2dc\ud558\uace0 \uc790\ub3d9\uc73c\ub85c \uc885\ub8cc\ud569\ub2c8\ub2e4. \uc778\uac04 \uac1c\uc785 \uc5c6\uc74c.',
    bullet1:   '2026\ub144 2\uc6d4 <strong>$100 USDC</strong>\ub85c \uc2dc\uc791 \u2014 \uc2dc\ubbac\ub808\uc774\uc158\uc774 \uc544\ub2cc \uc2e4\uc81c \uc790\ubcf8',
    bullet2:   '\ubaa8\ub4e0 \uc608\uce21\uc740 <strong>Polygon \ube14\ub85d\uccb4\uc778</strong>\uc5d0 \uc601\uad6c\uc801\uc73c\ub85c \uae30\ub85d \u2014 \uc644\uc804\ud788 \uac80\uc99d \uac00\ub2a5',
    bullet3:   '\uc644\uc804 <strong>\uc624\ud508 \uc18c\uc2a4</strong> \u2014 GitHub\uc5d0 \ucf54\ub4dc, \uc6cc\ud06c\ud50c\ub85c \ubb38\uc11c\ud654',
    lbl_wr:    '\uc2b9\ub960', lbl_pnl: '\uc694 PnL', lbl_trades: '\uc885\ub8cc\ub41c \uac70\ub798',
    cta:       '\uc54c\uaca0\uc2b5\ub2c8\ub2e4, \ud0d0\uc0c9\ud558\uae30 \u2192',
    hint:      '\ud5e4\ub354\uc758 <strong>?</strong> \ubc84\ud2bc\uc73c\ub85c \uc5b8\uc81c\ub4e0\uc9c0 \ub2e4\uc2dc \uc5f4 \uc218 \uc788\uc2b5\ub2c8\ub2e4',
  },
  ru: {
    badge:     '\u0427\u0422\u041e \u042d\u0422\u041e?',
    headline:  'AI-\u0431\u043e\u0442, \u0442\u043e\u0440\u0433\u0443\u044e\u0449\u0438\u0439 Bitcoin \u0441 \u0440\u0435\u0430\u043b\u044c\u043d\u044b\u043c\u0438 \u0434\u0435\u043d\u044c\u0433\u0430\u043c\u0438.',
    desc:      '\u041a\u0430\u0436\u0434\u044b\u0435 10 \u043c\u0438\u043d\u0443\u0442 \u0431\u043e\u0442 \u0430\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u0442 \u0446\u0435\u043d\u0443 BTC, \u043d\u043e\u0432\u043e\u0441\u0442\u0438, \u043f\u043e\u0442\u043e\u043a \u043e\u0440\u0434\u0435\u0440\u043e\u0432 \u0438 \u043d\u0430\u0441\u0442\u0440\u043e\u0435\u043d\u0438\u044f \u0441 \u043f\u043e\u043c\u043e\u0449\u044c\u044e <strong>XGBoost ML + Claude AI</strong>. \u0415\u0441\u043b\u0438 \u043e\u0431\u0430 \u0441\u043e\u0433\u043b\u0430\u0441\u043d\u044b \u2014 \u043e\u0442\u043a\u0440\u044b\u0432\u0430\u0435\u0442 \u0440\u0435\u0430\u043b\u044c\u043d\u0443\u044e \u0441\u0434\u0435\u043b\u043a\u0443 \u043d\u0430 <strong>Kraken</strong> \u0438 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0437\u0430\u043a\u0440\u044b\u0432\u0430\u0435\u0442 \u0435\u0451. \u0411\u0435\u0437 \u0443\u0447\u0430\u0441\u0442\u0438\u044f \u0447\u0435\u043b\u043e\u0432\u0435\u043a\u0430.',
    bullet1:   '\u0417\u0430\u043f\u0443\u0449\u0435\u043d \u0432 \u0444\u0435\u0432\u0440\u0430\u043b\u0435 2026 \u0441 <strong>$100 USDC</strong> \u2014 \u0440\u0435\u0430\u043b\u044c\u043d\u044b\u0439 \u043a\u0430\u043f\u0438\u0442\u0430\u043b, \u043d\u0435 \u0441\u0438\u043c\u0443\u043b\u044f\u0446\u0438\u044f',
    bullet2:   '\u041a\u0430\u0436\u0434\u044b\u0439 \u043f\u0440\u043e\u0433\u043d\u043e\u0437 \u043d\u0430\u0432\u0441\u0435\u0433\u0434\u0430 \u0437\u0430\u043f\u0438\u0441\u0430\u043d \u0432 <strong>\u0431\u043b\u043e\u043a\u0447\u0435\u0439\u043d Polygon</strong> \u2014 \u043f\u043e\u043b\u043d\u043e\u0441\u0442\u044c\u044e \u043f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u043c',
    bullet3:   '\u041f\u043e\u043b\u043d\u043e\u0441\u0442\u044c\u044e <strong>open source</strong> \u2014 \u043a\u043e\u0434 \u043d\u0430 GitHub, \u043b\u043e\u0433\u0438\u043a\u0430 \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0430',
    lbl_wr:    '\u041f\u0440\u043e\u0446\u0435\u043d\u0442 \u043f\u043e\u0431\u0435\u0434', lbl_pnl: '\u041e\u0431\u0449\u0438\u0439 PnL', lbl_trades: '\u0417\u0430\u043a\u0440\u044b\u0442\u044b\u0435 \u0441\u0434\u0435\u043b\u043a\u0438',
    cta:       '\u041f\u043e\u043d\u044f\u043b, \u0438\u0441\u0441\u043b\u0435\u0434\u043e\u0432\u0430\u0442\u044c \u2192',
    hint:      '\u041e\u0442\u043a\u0440\u044b\u0442\u044c \u0441\u043d\u043e\u0432\u0430: \u043a\u043d\u043e\u043f\u043a\u0430 <strong>?</strong> \u0432 \u0448\u0430\u043f\u043a\u0435',
  },
  hi: {
    badge:     '\u092f\u0939 \u0915\u094d\u092f\u093e \u0939\u0948?',
    headline:  '\u090f\u0915 AI \u092c\u094b\u091f \u091c\u094b \u0905\u0938\u0932\u0940 \u092a\u0948\u0938\u094b\u0902 \u0938\u0947 Bitcoin \u091f\u094d\u0930\u0947\u0921 \u0915\u0930\u0924\u093e \u0939\u0948\u0964',
    desc:      '\u0939\u0930 10 \u092e\u093f\u0928\u091f \u092e\u0947\u0902, \u092c\u094b\u091f <strong>XGBoost ML + Claude AI</strong> \u0915\u093e \u0909\u092a\u092f\u094b\u0917 \u0915\u0930\u0915\u0947 BTC \u092e\u0942\u0932\u094d\u092f, \u0938\u092e\u093e\u091a\u093e\u0930, \u0911\u0930\u094d\u0921\u0930 \u092b\u094d\u0932\u094b \u0914\u0930 \u092c\u093e\u091c\u093e\u0930 \u092d\u093e\u0935\u0928\u093e \u0915\u093e \u0935\u093f\u0936\u094d\u0932\u0947\u0937\u0923 \u0915\u0930\u0924\u093e \u0939\u0948\u0964 \u0905\u0917\u0930 \u0926\u094b\u0928\u094b\u0902 \u0938\u0939\u092e\u0924 \u0939\u0908\u0902, \u0924\u094b <strong>Kraken</strong> \u092a\u0930 \u0930\u093f\u092f\u0932 \u091f\u094d\u0930\u0947\u0921 \u0916\u094b\u0932\u0924\u093e \u0939\u0948 \u2014 \u092b\u093f\u0930 \u0938\u094d\u0935\u091a\u093e\u0932\u093f\u0924 \u0930\u0942\u092a \u0938\u0947 \u092c\u0902\u0926 \u0915\u0930\u0924\u093e \u0939\u0948\u0964 \u0915\u094b\u0908 \u092e\u093e\u0928\u0935\u0940\u092f \u0939\u0938\u094d\u0924\u0915\u094d\u0937\u0947\u092a \u0928\u0939\u0940\u0902\u0964',
    bullet1:   '\u092b\u0930\u0935\u0930\u0940 2026 \u092e\u0947\u0902 <strong>$100 USDC</strong> \u0938\u0947 \u0936\u0941\u0930\u0942 \u2014 \u0935\u093e\u0938\u094d\u0924\u0935\u093f\u0915 \u092a\u0942\u0902\u091c\u0940, \u0938\u093f\u092e\u0941\u0932\u0947\u0936\u0928 \u0928\u0939\u0940\u0902',
    bullet2:   '\u0939\u0930 \u092d\u0935\u093f\u0937\u094d\u092f\u0935\u093e\u0923\u0940 <strong>Polygon \u092c\u094d\u0932\u0949\u0915\u091a\u0947\u0928</strong> \u092a\u0930 \u0938\u094d\u0925\u093e\u092f\u0940 \u0930\u0942\u092a \u0938\u0947 \u0926\u0930\u094d\u091c \u2014 \u092a\u0942\u0930\u0940 \u0924\u0930\u0939 \u0938\u0924\u094d\u092f\u093e\u092a\u093f\u0924',
    bullet3:   '\u092a\u0942\u0930\u0940 \u0924\u0930\u0939 <strong>open source</strong> \u2014 GitHub \u092a\u0930 \u0915\u094b\u0921, \u0935\u0930\u094d\u0915\u092b\u093c\u094d\u0932\u094b \u0926\u0938\u094d\u0924\u093e\u0935\u0947\u091c\u093c\u0940\u0915\u0943\u0924',
    lbl_wr:    '\u091c\u0940\u0924 \u0926\u0930', lbl_pnl: '\u0915\u0941\u0932 PnL', lbl_trades: '\u092c\u0902\u0926 \u091f\u094d\u0930\u0947\u0921',
    cta:       '\u0938\u092e\u091d \u0917\u092f\u093e, \u090f\u0915\u094d\u0938\u094d\u092a\u094d\u0932\u094b\u0930 \u0915\u0930\u0947\u0902 \u2192',
    hint:      '\u0939\u0947\u0921\u0930 \u092e\u0947\u0902 <strong>?</strong> \u092c\u091f\u0928 \u0938\u0947 \u0915\u092d\u0940 \u092d\u0940 \u092b\u093f\u0930 \u0938\u0947 \u0916\u094b\u0932\u0947\u0902',
  },
  si: {
    badge:     '\u0db8\u0dda \u0db8\u0d9a\u0dda\u0daf?',
    headline:  '\u0dc3\u0dd0\u0db6\u0dcf \u0db8\u0dd4\u0daf\u0dbd\u0dca \u0dc3\u0db8\u0d9c Bitcoin \u0d9c\u0db1\u0dd4\u0daf\u0dd9\u0db1\u0dd4 \u0d9a\u0dbb\u0db1 AI \u0d89\u0dbb\u0dd2\u0dba\u0dd0\u0d9a\u0dca.',
    desc:      '\u0dc3\u0dba\u0dda\u0d9a\u0dca \u0db8\u0dd2\u0db1\u0dd2\u0dad\u0dca\u0dad\u0dd4 10 \u0d9a\u0da7, \u0d89\u0dbb\u0dd2\u0dba \u0db6\u0d9c\u0dd2\u0db4\u0dad\u0dca <strong>XGBoost ML + Claude AI</strong> \u0db6\u0dcf\u0dc5\u0dca\u0dc0\u0dd3\u0db8\u0dda\u0db1\u0dca BTC \u0db8\u0dd2\u0dbd, \u0db4\u0dca\u200d\u0dbb\u0dc0\u0dd3\u0dae\u0dd4, \u0d87\u0dab\u0dc0\u0dd4\u0db8\u0dca \u0db4\u0dca\u200d\u0dbb\u0dc0\u0dcf\u0dc4\u0dba \u0dc4\u0dcf \u0dc4\u0dda\u0dc5\u0dd3\u0db8\u0dca \u0dc0\u0dd2\u0dc2\u0dca\u0dbd\u0dda\u0dc2\u0db1\u0dba \u0d9a\u0dbb\u0dba\u0dd2. \u0daf\u0dd9\u0d9a\u0dda\u0db8\u0dca \u0d91\u0d9a\u0d9c\u0dc2\u0dca \u0dc0\u0dd3\u0dba\u0dcf \u0db1\u0db8\u0dca, <strong>Kraken</strong> \u0dc4\u0dd2\u0daf\u0dd3 \u0dc3\u0dd0\u0db6\u0dcf \u0d9c\u0db1\u0dd4\u0daf\u0dd9\u0db1\u0dd4\u0dc0\u0d9a\u0dca \u0d87\u0dbb\u0db9\u0dca\u0db8\u0dca \u0d9a\u0dbb\u0dcf \u0dc3\u0dca\u0dc0\u0dba\u0d82\u0d9a\u0dca\u200d\u0dbb\u0dd3\u0dba\u0dc0 \u0dc0\u0dc4\u0da7 \u0d9a\u0dbb\u0dba\u0dd2. \u0db8\u0db1\u0dd4\u0dc2\u0dca\u0dc1 \u0db8\u0dd0\u0daf\u0dd2\u0dc4\u0dad\u0dca\u0dc0\u0dd3\u0db8\u0d9a\u0dca \u0db1\u0dd2\u0dba\u0dc1\u0dba\u0dd2.',
    bullet1:   '2026 \u0db4\u0dd9\u0db6\u0dbb\u0dc0\u0dcf\u0dbb\u0dd2\u0dba\u0dda <strong>$100 USDC</strong> \u0dc3\u0db8\u0d9c \u0d87\u0dbb\u0dd9\u0db1\u0dca\u0db6\u0dd3\u0dc4\u0dd2 \u2014 \u0d89\u0dbb\u0dd2\u0dba\u0dca, \u0db4\u0dbb\u0dd3\u0d9a\u0dca\u0dc2\u0dba\u0d9a\u0dca \u0db1\u0d85',
    bullet2:   '\u0dc3\u0dba\u0dda\u0d9a\u0dca \u0d85\u0db1\u0dcf\u0dc0\u0dd9\u0d9a\u0dd2\u0dba\u0d9a\u0dca\u0db8\u0dca <strong>Polygon \u0db6\u0dca\u200d\u0dbd\u0ddd\u0d9a\u0dca\u0da0\u0dba\u0dd2\u0db1\u0dca</strong> \u0dc4\u0dd2 \u0dc3\u0ddc\u0dba \u0dc3\u0dbe\u0daf\u0dba\u0d9a\u0dca\u0d9a\u0dbb\u0dd1 \u2014 \u0dc3\u0db8\u0dca\u0db4\u0dd6\u0dbb\u0dca\u0dab\u0dba\u0dda\u0db1\u0dca \u0dc4\u0dd3\u0dba\u0dbd\u0dca \u0d9a\u0dbb\u0dba \u0dc4\u0dd0\u0d9a\u0dd2\u0dba\u0dd2',
    bullet3:   '\u0dc3\u0db8\u0dca\u0db4\u0dd6\u0dbb\u0dca\u0dab\u0dba\u0dda\u0db1\u0dca <strong>open source</strong> \u2014 GitHub \u0dc4\u0dd2 \u0d9a\u0ddd\u0da9\u0dba, workflow \u0dbd\u0dda\u0d9b\u0db1\u0d9c\u0dad\u0dba\u0dd2',
    lbl_wr:    '\u0da2\u0dba\u0d9c\u0dca\u200d\u0dbb\u0dcf\u0dc4\u0dd3 \u0d85\u0db1\u0dd4\u0db4\u0dcf\u0dad\u0dba', lbl_pnl: '\u0db8\u0dd4\u0dbd\u0dd4 PnL', lbl_trades: '\u0dc0\u0dc3\u0dcf \u0d9c\u0db1\u0dd4\u0daf\u0dd9\u0db1\u0dd4',
    cta:       '\u0dc4\u0dbb\u0dd2, \u0d9c\u0dc0\u0dda\u0dc2\u0db1\u0dcf \u0d9a\u0dbb\u0db8\u0dd4 \u2192',
    hint:      '\u0dc4\u0dd3\u0dc0\u0dcf\u0dbd\u0dea \u0d9a\u0ddc\u0da7\u0dc3\u0dd2\u0db1\u0dca <strong>?</strong> \u0d9a\u0dd2\u0dba\u0dad\u0dca\u0dad\u0db8 \u0db6\u0da7\u0db1\u0dca \u0db8\u0d9f\u0dd2\u0db1\u0dca \u0db1\u0dd0\u0dc5\u0dc5\u0dad \u0dc0\u0dd2\u0dc0\u0dbb\u0dca\u0dad \u0d9a\u0dbd \u0dc4\u0dd0\u0d9a\u0dd2\u0dba\u0dd2',
  },
};

const _INTRO_LANG_LABELS = { en:'EN', it:'IT', de:'DE', fr:'FR', es:'ES', pt:'PT', zh:'‰∏≠Êñá', ja:'Êó•Êú¨Ë™û', ko:'ÌïúÍµ≠Ïñ¥', ru:'RU', hi:'‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', si:'‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω' };
let _introCurrentLang = 'en';

function applyIntroLang(lang) {
  const t = INTRO_I18N[lang] || INTRO_I18N['en'];
  _introCurrentLang = lang;
  document.querySelectorAll('#introHero [data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key] !== undefined) el.textContent = t[key];
  });
  document.querySelectorAll('#introHero [data-i18n-html]').forEach(el => {
    const key = el.getAttribute('data-i18n-html');
    if (t[key] !== undefined) el.innerHTML = t[key];
  });
  // Update switcher active state
  document.querySelectorAll('#introLangSwitcher .ilng-btn').forEach(btn => {
    btn.style.color     = btn.dataset.lang === lang ? 'var(--accent)' : 'var(--muted)';
    btn.style.borderColor = btn.dataset.lang === lang ? 'rgba(0,255,136,0.4)' : 'rgba(255,255,255,0.08)';
  });
}

function initIntroI18n() {
  const raw   = (navigator.language || navigator.userLanguage || 'en').toLowerCase();
  const lang  = raw.split('-')[0];
  const avail = Object.keys(INTRO_I18N);
  const pick  = avail.includes(lang) ? lang : 'en';

  // Build language switcher buttons
  const sw = document.getElementById('introLangSwitcher');
  if (sw) {
    sw.innerHTML = Object.entries(_INTRO_LANG_LABELS).map(([l, lbl]) =>
      `<button class="ilng-btn" data-lang="${l}" onclick="applyIntroLang('${l}')"
        style="font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;letter-spacing:1px;
               background:none;border:1px solid rgba(255,255,255,0.08);color:var(--muted);
               padding:2px 6px;border-radius:2px;cursor:pointer;transition:color 0.15s,border-color 0.15s;"
       >${lbl}</button>`
    ).join('');
  }

  applyIntroLang(pick);
}

// Run immediately (DOM is ready ‚Äî script is deferred inline, elements already parsed)
document.addEventListener('DOMContentLoaded', initIntroI18n);

function escapeHtml(s) {
  if (s == null) return '';
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

const CONFIG = {
  RAILWAY_URL: window.RAILWAY_URL || window.location.origin || 'https://web-production-e27d0.up.railway.app',
  READ_KEY: window.READ_API_KEY || '',
  BTC_REFRESH: 10000,
  LIMIT: 2000,
  REFRESH_INTERVAL: 60000,
  ACCT_REFRESH: 30000,
  CAPITAL: 100,
  SESSION_START: '2026-02-24'  // top-up $100 ‚Äî ROI calcolato da questa data
};

let liveWalletEquity = null;   // aggiornato da renderAccountSummary()
let lastTotalPnl = 0;          // aggiornato da renderAll(), usato per ricalcolare ROI live
let lastSessionPnl = 0;        // PnL solo dal SESSION_START ‚Äî per Session ROI live
let dbTotalCount = 0;          // conteggio reale DB da Supabase count=exact

const SAMPLE_DATA = [];

function showApiError(msg) {
  const banner = document.getElementById('apiErrorBanner');
  if (!banner) return;
  document.getElementById('apiErrorMsg').textContent = msg || 'Railway API non raggiungibile ‚Äî dati non aggiornati';
  banner.classList.add('visible');
}
function hideApiError() {
  const banner = document.getElementById('apiErrorBanner');
  if (banner) banner.classList.remove('visible');
}

// ‚îÄ‚îÄ ACCOUNT SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchAccountSummary() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/account-summary`, {
      signal: AbortSignal.timeout(8000),
      headers: {'X-API-Key': CONFIG.READ_KEY}
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  } catch(e) {
    console.warn('Account summary fetch error:', e);
    showApiError(`Railway /account-summary non raggiungibile (${e.message})`);
    return null;
  }
}

// I-11: shared cache ‚Äî eliminates duplicate /account-summary fetches every 30s
// (refreshAccountSummary + refreshMiniStatusBarLive both ran on the same interval)
let _acctSummaryCache    = null;
let _acctSummaryCachedAt = 0;
async function getAccountSummary() {
  if (_acctSummaryCache && (Date.now() - _acctSummaryCachedAt) < 25000) {
    return _acctSummaryCache;
  }
  const data = await fetchAccountSummary();
  if (data) { _acctSummaryCache = data; _acctSummaryCachedAt = Date.now(); }
  return data;
}

function fmtUsd(v, decimals = 2) {
  const n = Number(v);
  if (!isFinite(n)) return '‚Äî';
  return '$' + n.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function fmtPnlAcct(v, decimals = 4) {
  if (v === null || v === undefined) return '‚Äî';
  const n = parseFloat(v);
  return (n >= 0 ? '+' : '') + '$' + Math.abs(n).toFixed(decimals);
}

function pnlClass(v) {
  if (v === null || v === undefined) return 'muted';
  return parseFloat(v) > 0 ? 'green' : parseFloat(v) < 0 ? 'red' : 'muted';
}

function renderAccountSummary(data) {
  if (!data || data.status !== 'ok') {
    ['acctWalletBody', 'acctPositionBody', 'acctBtcBody'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML =
        '<div style="padding:16px;color:var(--danger);font-size:10px;letter-spacing:1px">‚ö†Ô∏è FETCH ERROR</div>';
    });
    return;
  }

  // Timestamp
  const ts = data.timestamp ? new Date(data.timestamp).toLocaleTimeString('it-IT') : '‚Äî';
  document.getElementById('acctTs').textContent = 'Updated: ' + ts;

  // ‚îÄ‚îÄ WALLET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const w = data.wallet || {};
  const equity = parseFloat(w.margin_equity || 0);
  if (equity > 0) {
    liveWalletEquity = equity;
    // Update APR + ROI sub-labels with live equity context (value set by render())
    const daysAct = Math.max(1, (Date.now() - new Date(CONFIG.SESSION_START + 'T00:00:00Z')) / 86400000);
    const roiPct  = (lastSessionPnl / CONFIG.CAPITAL) * 100;  // I-05: fixed denominator $100, not live equity
    const aprSubEl2 = document.getElementById('kpiAprSub');
    if (aprSubEl2) aprSubEl2.textContent = `${Math.round(daysAct)}d active ¬∑ ${fmtUsd(equity)} eq.`;
    const roiEl2 = document.getElementById('kpiRoi');
    if (roiEl2) { roiEl2.textContent = (roiPct >= 0 ? '+' : '') + roiPct.toFixed(2) + '%'; roiEl2.className = 'kpi-value ' + (roiPct >= 0 ? 'purple' : 'red'); }
    const roiSubEl2 = document.getElementById('kpiRoiSub');
    if (roiSubEl2) roiSubEl2.textContent = `${fmtUsd(lastSessionPnl)} ¬∑ ${Math.round(daysAct)}d`;
    const footerCapEl = document.getElementById('footerCapital');
    if (footerCapEl) footerCapEl.textContent = fmtUsd(equity) + ' equity';
  }
  const usdc   = parseFloat(w.usdc_available || 0);
  const marginUsage = parseFloat(w.margin_usage_pct || 0);
  const unrealPnl = parseFloat(w.pnl_unrealized || 0);
  const funding   = parseFloat(w.funding_unrealized || 0);

  // Tag: total equity
  const walletTag = document.getElementById('acctWalletTag');
  if (walletTag) {
    walletTag.textContent = fmtUsd(equity);
    walletTag.className = 'panel-tag ' + (equity >= CONFIG.CAPITAL ? 'tag-green' : 'tag-red');
  }

  // Margin bar color
  let marginBarColor = 'var(--accent)';
  if (marginUsage > 70) marginBarColor = 'var(--danger)';
  else if (marginUsage > 40) marginBarColor = 'var(--warn)';

  const totalRoiPct = CONFIG.CAPITAL > 0 ? ((equity - CONFIG.CAPITAL) / CONFIG.CAPITAL * 100) : 0;
  const roiColor = totalRoiPct >= 0 ? 'var(--accent)' : 'var(--danger)';
  const walletBody = document.getElementById('acctWalletBody');
  if (!walletBody) return;
  walletBody.style.cssText = 'padding:0;gap:0;';
  walletBody.innerHTML = `
    <!-- Hero equity section -->
    <div style="background:linear-gradient(135deg,rgba(0,255,136,0.07) 0%,rgba(0,255,136,0.02) 100%);border-bottom:1px solid rgba(0,255,136,0.12);padding:16px 16px 13px;position:relative;overflow:hidden;">
      <div style="position:absolute;top:-20px;right:-15px;width:80px;height:80px;background:radial-gradient(circle,rgba(0,255,136,0.1),transparent 70%);pointer-events:none;"></div>
      <div style="font-family:'Syne',sans-serif;font-size:26px;font-weight:700;color:${equity >= CONFIG.CAPITAL ? 'var(--accent)' : 'var(--danger)'};line-height:1;margin-bottom:5px;">${fmtUsd(equity)}</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <span style="font-size:11px;font-weight:700;color:${roiColor};">${totalRoiPct >= 0 ? '+' : ''}${totalRoiPct.toFixed(2)}%</span>
        <span style="font-size:9px;color:var(--muted);">ROI vs $${CONFIG.CAPITAL} base</span>
      </div>
      <div style="display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:3px 9px;border-radius:2px;">
        <div style="width:5px;height:5px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite;flex-shrink:0;"></div>
        <span style="font-size:8px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;">Kraken Futures ¬∑ PF_XBTUSD</span>
      </div>
    </div>
    <!-- Detail rows -->
    <div style="padding:12px 16px;display:flex;flex-direction:column;gap:8px;">
      <div class="acct-row">
        <span class="acct-row-label">USDC Available</span>
        <span class="acct-row-val blue">${fmtUsd(usdc)}</span>
      </div>
      <div class="acct-row">
        <span class="acct-row-label">Free Margin</span>
        <span class="acct-row-val">${fmtUsd(w.available_margin)}</span>
      </div>
      <div class="acct-row">
        <span class="acct-row-label">P&amp;L Unrealized</span>
        <span class="acct-row-val ${pnlClass(unrealPnl)}">${fmtPnlAcct(unrealPnl)}</span>
      </div>
      <div class="acct-row">
        <span class="acct-row-label">Funding Accum.</span>
        <span class="acct-row-val ${pnlClass(funding)}">${fmtPnlAcct(funding, 6)}</span>
      </div>
      <div class="margin-bar-wrap" style="margin-top:4px;">
        <div class="margin-bar-label">
          <span>Margin Usage</span>
          <span style="color:${marginBarColor}">${marginUsage.toFixed(2)}%</span>
        </div>
        <div class="margin-bar-bg">
          <div class="margin-bar-fill" style="width:${Math.min(marginUsage,100)}%;background:${marginBarColor}"></div>
        </div>
      </div>
    </div>
  `;

  // ‚îÄ‚îÄ POSITION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const pos = data.position || {};
  const posTag = document.getElementById('acctPositionTag');

  if (!pos.open) {
    if (posTag) { posTag.textContent = 'FLAT'; posTag.className = 'panel-tag'; posTag.style.cssText = 'background:rgba(74,96,112,0.15);color:var(--muted);border:1px solid rgba(74,96,112,0.3)'; }
    document.getElementById('acctPositionBody').innerHTML = `
      <div class="position-status flat">
        <div class="position-dot"></div>
        FLAT ‚Äî No open position
      </div>
    `;
  } else {
    const side = pos.side || 'unknown';
    const pnl  = parseFloat(pos.pnl || 0);
    const pnlPct = parseFloat(pos.pnl_pct || 0);
    if (posTag) {
      posTag.textContent = side.toUpperCase();
      posTag.className = side === 'long' ? 'panel-tag tag-green' : 'panel-tag tag-red';
      posTag.style.cssText = '';
    }

    const pnlIndicatorClass = pnl > 0 ? 'pos' : pnl < 0 ? 'neg' : 'zero';

    document.getElementById('acctPositionBody').innerHTML = `
      <div class="position-status ${escapeHtml(side)}">
        <div class="position-dot"></div>
        ${escapeHtml(side.toUpperCase())} ‚Äî ${parseFloat(pos.size || 0)} BTC
      </div>
      <div class="acct-row">
        <span class="acct-row-label">Entry Price</span>
        <span class="acct-row-val">${fmtUsd(pos.entry_price, 2)}</span>
      </div>
      <div class="acct-row">
        <span class="acct-row-label">Size</span>
        <span class="acct-row-val blue">${parseFloat(pos.size || 0)} BTC</span>
      </div>
      <div class="pnl-indicator ${pnlIndicatorClass}" style="margin-top:4px;">
        <span style="font-size:9px;letter-spacing:1px;text-transform:uppercase;opacity:0.7">Unrealized P&amp;L</span>
        <span>${fmtPnlAcct(pnl)} (${pnlPct > 0 ? '+' : ''}${pnlPct}%)</span>
      </div>
    `;
  }

  // ‚îÄ‚îÄ BTC PRICE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const btc = data.btc || {};
  const mark = parseFloat(btc.mark_price || 0);
  const last = parseFloat(btc.last_price || 0);
  const fundingRate = parseFloat(btc.funding_rate_pct || 0);
  const oi = btc.open_interest;

  const btcTag = document.getElementById('acctBtcTag');
  if (btcTag) btcTag.textContent = mark > 0 ? fmtUsd(mark, 0) : '‚Äî';

  document.getElementById('acctBtcBody').innerHTML = `
    <div class="btc-mark-big">${mark > 0 ? fmtUsd(mark, 2) : '‚Äî'}</div>
    <div style="font-size:8px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px">MARK PRICE</div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Last Price</span>
      <span class="btc-price-row-val">${fmtUsd(last, 2)}</span>
    </div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Funding Rate</span>
      <span class="btc-price-row-val" style="color:${fundingRate > 0 ? 'var(--danger)' : fundingRate < 0 ? 'var(--accent)' : 'var(--muted)'}">
        ${fundingRate > 0 ? '+' : ''}${fundingRate.toFixed(4)}%
      </span>
    </div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Open Interest</span>
      <span class="btc-price-row-val">${oi != null ? parseFloat(oi).toFixed(2) + ' BTC' : '‚Äî'}</span>
    </div>
    <div class="btc-price-row">
      <span class="btc-price-row-label">Vol 24h</span>
      <span class="btc-price-row-val">${btc.volume_24h != null ? parseFloat(btc.volume_24h).toLocaleString('en-US', {maximumFractionDigits:0}) : '‚Äî'}</span>
    </div>
  `;

  // ‚îÄ‚îÄ RECENT FILLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const activity = data.recent_activity || {};
  const fills    = activity.fills || [];
  // realized_pnl_recent is now -(sum of fees) since Kraken fills don't return P&L
  const totalFeesCost = Math.abs(parseFloat(activity.realized_pnl_recent || 0));

  const fillsTag = document.getElementById('acctFillsTag');
  if (fillsTag) {
    fillsTag.textContent = totalFeesCost > 0 ? '-$' + totalFeesCost.toFixed(5) : '+$0.0000';
    fillsTag.className = 'panel-tag ' + (totalFeesCost > 0 ? 'tag-yellow' : 'tag-green');
  }

  if (!fills.length) {
    document.getElementById('acctFillsBody').innerHTML =
      '<div style="padding:18px 16px;color:var(--muted);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;">No recent fills</div>';
    return;
  }

  const rows = fills.map(f => {
    const side     = (f.side || '').toLowerCase();
    const sideClass = side === 'buy' ? 'fill-buy' : 'fill-sell';
    const sideLabel = side === 'buy' ? '‚ñ≤ BUY' : '‚ñº SELL';
    const fillPnl   = f.pnl != null ? parseFloat(f.pnl) : null;
    const fee       = parseFloat(f.fee || 0);
    const ts        = f.timestamp ? new Date(f.timestamp).toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'}) : '‚Äî';
    return `<tr>
      <td><span class="${sideClass}">${sideLabel}</span></td>
      <td style="color:var(--text)">${parseFloat(f.size || 0).toFixed(4)}</td>
      <td style="color:var(--blue)">${fmtUsd(f.price, 0)}</td>
      <td class="${fillPnl != null ? (fillPnl >= 0 ? 'pnl-pos' : 'pnl-neg') : 'pnl-null'}">${fillPnl != null ? fmtPnlAcct(fillPnl, 4) : '‚Äî'}</td>
      <td style="color:${fee > 0 ? 'var(--warn)' : 'var(--muted)'}">${fee > 0 ? '-$' + fee.toFixed(5) : '‚Äî'}</td>
      <td style="color:var(--muted)">${ts}</td>
    </tr>`;
  }).join('');

  document.getElementById('acctFillsBody').innerHTML = `
    <div style="padding:8px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase">Fees Paid (recent)</span>
      <span style="font-size:12px;font-weight:700;font-family:'Syne',sans-serif;color:var(--warn)">${totalFeesCost > 0 ? '-$' + totalFeesCost.toFixed(5) : '+$0.0000'}</span>
    </div>
    <div style="overflow-x:auto;">
      <table class="fills-table">
        <thead>
          <tr>
            <th>Side</th>
            <th>Size</th>
            <th>Price</th>
            <th>P&amp;L</th>
            <th>Fee</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

async function refreshAccountSummary() {
  const data = await getAccountSummary();
  if (data) renderAccountSummary(data);
}

// ‚îÄ‚îÄ LIVE POSITION WIDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let _liveOpenBet = null;

function renderLivePosition() {
  if (!allData || !allData.length) return;
  const openBets = allData.filter(d => d.bet_taken === true && d.correct === null);
  const widget   = document.getElementById('livePositionWidget');
  const lpTabs   = document.getElementById('lpTabs');
  if (!openBets.length) { widget.style.display = 'none'; _liveOpenBet = null; if(lpTabs) lpTabs.style.display='none'; return; }

  // Select which bet to display (track via dataset)
  let activeIdx = parseInt(widget.dataset.activeTab || '0');
  if (activeIdx >= openBets.length) activeIdx = 0;
  const openBet = openBets[activeIdx];
  _liveOpenBet  = openBet;
  widget.style.display = 'block';

  // Tabs: show only if 2+ open bets
  if (lpTabs) {
    if (openBets.length > 1) {
      lpTabs.style.display = 'flex';
      lpTabs.innerHTML = openBets.map(function(bet, i) {
        const cur2  = lastBtcPrice || parseFloat(bet.entry_fill_price || bet.btc_price_entry || 0);
        const entry2 = parseFloat(bet.entry_fill_price || bet.btc_price_entry || 0);
        const dir2   = bet.direction || 'UP';
        const pnl2   = cur2 && entry2 ? (dir2==='UP' ? (cur2-entry2)*parseFloat(bet.bet_size||0) : (entry2-cur2)*parseFloat(bet.bet_size||0)) : 0;
        const pnlStr = (pnl2>=0?'+':'')+pnl2.toFixed(2);
        const pnlClass = pnl2>=0?'pos':'neg';
        return '<button class="lp-tab-btn'+(i===activeIdx?' active':'')
          +'" onclick="window._switchLpTab('+i+')">'
          +'#'+bet.id+' '+(dir2==='UP'?'‚Üë':'‚Üì')
          +'<span class="lp-tab-pnl '+pnlClass+'">$'+pnlStr+'</span>'
          +'</button>';
      }).join('');
    } else {
      lpTabs.style.display = 'none';
    }
  }

  const entry   = parseFloat(openBet.entry_fill_price || openBet.btc_price_entry || 0);
  const sl      = parseFloat(openBet.sl_price || 0);
  const tp      = parseFloat(openBet.tp_price || 0);
  const conf    = parseFloat(openBet.confidence || 0);
  const dir     = openBet.direction || '‚Äî';
  const size    = parseFloat(openBet.bet_size || 0);
  const cur     = lastBtcPrice || entry;

  const pnlUsd  = cur && entry ? (dir === 'UP' ? (cur - entry) * size : (entry - cur) * size) : 0;
  const pnlPct  = entry ? ((cur - entry) / entry * 100 * (dir === 'UP' ? 1 : -1)).toFixed(2) : '0.00';

  const range     = (sl > 0 && tp > 0) ? tp - sl : 0;
  const entryPct  = range !== 0 ? Math.max(1, Math.min(99, ((entry - sl) / range) * 100)) : 40;
  const livePct   = range !== 0 ? Math.max(1, Math.min(99, ((cur   - sl) / range) * 100)) : 50;

  // DOM updates
  document.getElementById('lpBetId').textContent       = '#' + openBet.id;
  const dirEl = document.getElementById('lpDirection');
  dirEl.textContent  = dir === 'UP' ? '‚Üë LONG UP' : '‚Üì SHORT DOWN';
  dirEl.style.color  = dir === 'UP' ? 'var(--accent)' : 'var(--danger)';
  document.getElementById('lpConfidence').textContent  = Math.round(conf * 100) + '% confidence';
  const totalOpenSize = openBets.reduce((s, b) => s + parseFloat(b.bet_size || 0), 0);
  document.getElementById('lpSize').textContent = size.toFixed(4) + ' BTC ¬∑ ' + totalOpenSize.toFixed(5) + ' total';

  const pyrCount = parseInt(openBet.pyramid_count || 0);
  const pyrEl = document.getElementById('lpPyramidBadge');
  if (pyrEl) {
    if (pyrCount > 0) {
      pyrEl.style.display = 'inline-flex';
      pyrEl.textContent = '‚¨Ü PYRAMID √ó' + pyrCount;
    } else {
      pyrEl.style.display = 'none';
    }
  }

  try {
    const created  = new Date(openBet.created_at);
    const minsOpen = Math.round((Date.now() - created.getTime()) / 60000);
    const hOpen    = Math.floor(minsOpen / 60);
    const mOpen    = minsOpen % 60;
    const durStr   = hOpen > 0 ? hOpen + 'h ' + mOpen + 'm' : minsOpen + 'min';
    document.getElementById('lpOpenTime').textContent  = fmtDate(openBet.created_at) + ' ¬∑ ' + durStr + ' open';
  } catch(e) {}

  const pnlEl = document.getElementById('lpPnl');
  const pos   = pnlUsd >= 0;
  pnlEl.innerHTML = `<span style="color:${pos ? 'var(--accent)' : 'var(--danger)'}">${pos?'+':''}$${pnlUsd.toFixed(3)}</span>&nbsp;<span style="color:var(--muted)">(${pnlPct}%)</span>`;

  if (sl > 0)    document.getElementById('lpSlLabel').textContent    = 'SL $'    + sl.toLocaleString('en-US',{maximumFractionDigits:0});
  if (entry > 0) document.getElementById('lpEntryLabel').textContent = 'ENTRY $' + entry.toLocaleString('en-US',{maximumFractionDigits:0});
  if (tp > 0)    document.getElementById('lpTpLabel').textContent    = 'TP $'    + tp.toLocaleString('en-US',{maximumFractionDigits:0});

  const lpEntry = document.getElementById('lpEntryMarker');
  const lpLive  = document.getElementById('lpLiveMarker');
  if (lpEntry) lpEntry.style.left = entryPct + '%';
  if (lpLive)  lpLive.style.left  = livePct + '%';
  const lpCur = document.getElementById('lpCurrentPrice');
  if (lpCur) lpCur.textContent = cur ? '$' + cur.toLocaleString('en-US',{maximumFractionDigits:0}) : '‚Äî';
  const faceConf = document.getElementById('cubeFaceConf');
  if (faceConf) faceConf.textContent = Math.round(conf * 100) + '%';
  const cube  = document.getElementById('aiCube');
  const state = pnlUsd > 0.05 ? 'profit' : pnlUsd < -0.05 ? 'loss' : 'neutral';
  if (cube) cube.dataset.state = state;

  const aiText = document.getElementById('aiDecisionText');
  if (aiText) {
    if (Math.abs(pnlUsd) < 0.02) aiText.textContent = 'Flat ‚Äî watching';
    else if (pos) aiText.textContent = 'In profit ‚Äî HOLD?';
    else          aiText.textContent = 'In loss ‚Äî evaluating';
  }
}

window._switchLpTab = function(idx) {
  const widget = document.getElementById('livePositionWidget');
  if (widget) widget.dataset.activeTab = idx;
  renderLivePosition();
};

// ‚îÄ‚îÄ SIGNALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let _historyActive = false;

async function fetchData(includeHistory) {
  try {
    const hist = includeHistory ?? _historyActive;
    const url = `${CONFIG.RAILWAY_URL}/signals?limit=${CONFIG.LIMIT}${hist ? '&include_history=true' : ''}`;
    const res = await fetch(url, {
      signal: AbortSignal.timeout(15000),
      headers: {'X-API-Key': CONFIG.READ_KEY}
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    hideApiError();
    const arr = Array.isArray(j) ? j : (j.data || []);
    dbTotalCount = j.total_count || arr.length;
    return arr;
  } catch(e) {
    console.warn('Fetch failed:', e);
    showApiError(`‚ö° The bot's server is waking up ‚Äî showing cached data while it loads. (Usually takes 10‚Äì30s on first visit. ${e.message})`);
    return SAMPLE_DATA;
  }
}

async function toggleHistory(btn) {
  _historyActive = !_historyActive;
  btn.classList.toggle('active', _historyActive);
  btn.style.opacity = _historyActive ? '1' : '0.7';
  btn.textContent = _historyActive ? '‚è≥ HISTORY ON' : '‚è≥ HISTORY';
  const fresh = await fetchData(_historyActive);
  allData = fresh;
  applySignalFilters();
}

function fmtTime(ts) {
  return new Date(ts).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
}
function fmtDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }) + ' '
       + d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
}
function fmtPrice(p) {
  if (p === null || p === undefined) return '‚Äî';
  return '$' + parseFloat(p).toLocaleString('en-US', { maximumFractionDigits: 0 });
}
function fmtConf(c) { return (parseFloat(c) * 100).toFixed(0) + '%'; }
function fmtPnl(v) {
  if (v === null || v === undefined) return '‚Äî';
  const n = parseFloat(v);
  return (n >= 0 ? '+' : '') + '$' + n.toFixed(4);
}
function emaLabel(e) {
  if (!e) return '‚Äî';
  return e.includes('bullish') ? 'üü¢ BULL' : 'üî¥ BEAR';
}

function renderEntryCell(d) {
  if (!d.bet_taken || !d.entry_fill_price) return fmtPrice(d.btc_price_entry);
  const slip = (d.entry_slippage !== null && d.entry_slippage !== undefined) ? parseFloat(d.entry_slippage) : null;
  let slipStr = '';
  if (slip !== null && !isNaN(slip) && slip !== 0) {
    const slipColor = Math.abs(slip) > 20 ? 'var(--danger)' : Math.abs(slip) > 5 ? 'var(--warn)' : 'var(--muted)';
    const slipStr2 = (slip >= 0 ? '+' : '-') + '$' + Math.abs(slip).toFixed(1) + ' slip';
    slipStr = `<span style="display:block;font-size:9px;color:${slipColor};margin-top:1px">${slipStr2}</span>`;
  }
  return `<span style="display:block">${fmtPrice(d.entry_fill_price)}</span>${slipStr}`;
}

function renderSizeCell(d) {
  if (!d.bet_size) return '<span style="color:var(--muted)">‚Äî</span>';
  const size = parseFloat(d.bet_size);
  const reason = d.size_reason || '';
  let multClass = 'base';
  let multLabel = '√ó1.0';
  if (reason.includes('win_streak')) {
    multClass = 'up';
    multLabel = reason.includes('high_conf') ? '√ó1.5' : '√ó1.2';
  } else if (reason.includes('loss_streak')) {
    multClass = 'down';
    multLabel = '√ó0.5';
  } else if (reason.includes('drawdown')) {
    multClass = 'down';
    multLabel = '√ó0.25';
  }
  let reasonDisplay = reason
    .replace('_high_conf', '')
    .replace('_low_conf', '')
    .replace('win_streak_', 'W√ó')
    .replace('loss_streak_', 'L√ó')
    .replace('drawdown_protection', 'drawdown')
    .replace('insufficient_history', 'no hist.')
    .replace('base', '‚Äî');
  return `<span class="size-val">${size.toFixed(5)}</span>` +
         `<span class="size-mult ${multClass}">${multLabel} ${reasonDisplay}</span>`;
}

let currentPeriod = 'TODAY';
let allData = [];

function setTimePeriod(btn) {
  const period = btn.dataset.period;
  // Sincronizza active su tutte le pill (desktop tab-nav + mobile bar)
  document.querySelectorAll('.time-pill').forEach(b => {
    b.classList.toggle('active', b.dataset.period === period);
  });
  currentPeriod = period;
  renderAll(allData);
}

function filterByPeriod(data) {
  if (currentPeriod === 'ALL') return data;
  const now = new Date();
  let cutoff;
  if      (currentPeriod === 'TODAY') cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  else if (currentPeriod === '24H')   cutoff = new Date(now - 86400000);
  else if (currentPeriod === '3D')    cutoff = new Date(now - 3  * 86400000);
  else if (currentPeriod === '7D')    cutoff = new Date(now - 7  * 86400000);
  else if (currentPeriod === '30D')   cutoff = new Date(now - 30 * 86400000);
  return data.filter(d => new Date(d.created_at) >= cutoff);
}

function updateBotStatus(data) {
  if (!data || !data.length) return;
  const latest = data[0];
  if (!latest || !latest.created_at) return;
  const minutesAgo = Math.floor((new Date() - new Date(latest.created_at)) / 60000);
  const el       = document.getElementById('botStatus');
  const textEl   = document.getElementById('botStatusText');
  const detailEl = document.getElementById('botStatusDetail');
  const timeStr  = new Date(latest.created_at).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
  const timeLabel= minutesAgo < 1 ? 'just now' : minutesAgo + ' min ago';
  detailEl.textContent = 'Last: ' + timeStr + ' (' + timeLabel + ')';
  el.className = 'bot-status';
  if      (minutesAgo <= 8)  { el.classList.add('alive');   textEl.textContent = 'BOT ALIVE'; }
  else if (minutesAgo <= 20) { el.classList.add('warning'); textEl.textContent = 'BOT SLOW ‚ö†Ô∏è'; }
  else                       { el.classList.add('dead');    textEl.textContent = 'üö® BOT OFFLINE'; detailEl.textContent = 'No signal for ' + minutesAgo + ' min!'; }
}

let lastBtcPrice = null;
async function fetchLiveBtcPrice() {
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/btc-price', { signal: AbortSignal.timeout(5000) });
    if (!res.ok) throw new Error();
    const data  = await res.json();
    const price = data.mark_price || data.last_price;
    if (!price) return;
    const priceEl  = document.getElementById('btcLivePrice');
    const changeEl = document.getElementById('btcPriceChange');
    if (lastBtcPrice !== null) {
      const diff    = price - lastBtcPrice;
      const diffPct = ((diff / lastBtcPrice) * 100).toFixed(3);
      priceEl.className  = 'btc-live-price ' + (diff >= 0 ? 'up' : 'down');
      changeEl.className = 'btc-price-change ' + (diff >= 0 ? 'pos' : 'neg');
      changeEl.textContent = (diff >= 0 ? '+' : '') + diffPct + '%';
    }
    priceEl.textContent = '$' + price.toLocaleString('en-US', { maximumFractionDigits: 0 });
    lastBtcPrice = price;
    _loader.tick(); // 2/3 ‚Äî price loaded
    const kp = price >= 1000 ? '$' + Math.round(price / 1000) + 'k' : '$' + Math.round(price);
    document.title = '‚Çø ' + kp + ' ¬∑ BTC Bot';
    renderLivePosition(); // aggiorna gauge live ogni volta che arriva un nuovo prezzo
  } catch(e) {
    const priceEl = document.getElementById('btcLivePrice');
    if (priceEl.textContent === '‚Äî' && allData.length) {
      const last = allData.find(d => d.btc_price_entry);
      if (last) priceEl.textContent = '$' + Number(last.btc_price_entry).toLocaleString('it-IT', { maximumFractionDigits: 0 });
    }
    if (priceEl.textContent === '‚Äî') {
      priceEl.textContent = 'ERR';
      priceEl.className = 'btc-live-price down';
    }
    setTimeout(fetchLiveBtcPrice, 30000);
  }
}

function renderAll(data) {
  const filtered = filterByPeriod(data);
  const titleEl  = document.getElementById('signalLogTitle');
  titleEl.textContent = currentPeriod === 'ALL'
    ? 'SIGNAL LOG BOARD'
    : `SIGNAL LOG BOARD ¬∑ ${filtered.length} (${currentPeriod})`;
  _updateSlStats(filtered);
  render(filtered);
  renderLivePosition(); // mostra widget se c'√® posizione aperta
  // Populate intro hero KPIs (populateIntroHero is hoisted ‚Äî safe to call here)
  if (typeof populateIntroHero === 'function') populateIntroHero(data);
}

function _updateSlStats(data) {
  const total   = data.length;
  const bets    = data.filter(d => d.bet_taken).length;
  const closed  = data.filter(d => d.bet_taken && d.correct !== null);
  const wins    = closed.filter(d => d.correct === true).length;
  const wr      = closed.length ? Math.round(wins / closed.length * 100) : null;
  const confs   = data.filter(d => d.confidence).map(d => parseFloat(d.confidence));
  const avgConf = confs.length ? Math.round(confs.reduce((a,b)=>a+b,0)/confs.length*100) : null;
  const pnls    = closed.map(d => parseFloat(d.pnl_usd)).filter(v => !isNaN(v));
  const avgPnl  = pnls.length ? pnls.reduce((a,b)=>a+b,0)/pnls.length : null;

  const et = document.getElementById('slStatTotal');   if (et) et.textContent = total;
  const eb = document.getElementById('slStatBets');    if (eb) eb.textContent = bets;
  const ew = document.getElementById('slStatWR');
  if (ew) {
    ew.textContent = wr !== null ? wr + '%' : '‚Äî';
    ew.style.color = wr !== null ? (wr >= 50 ? 'var(--accent)' : 'var(--danger)') : '';
  }
  const ec = document.getElementById('slStatConf');    if (ec) ec.textContent = avgConf !== null ? avgConf + '%' : '‚Äî';
  const ep = document.getElementById('slStatAvgPnl');
  if (ep) {
    ep.textContent = avgPnl !== null ? (avgPnl >= 0 ? '+$' : '-$') + Math.abs(avgPnl).toFixed(3) : '‚Äî';
    ep.style.color = avgPnl !== null ? (avgPnl >= 0 ? 'var(--accent)' : 'var(--danger)') : '';
  }
}

// ‚îÄ‚îÄ Next Signal countdown timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _nextSignalInterval = null;
function startNextSignalTimer(lastTs) {
  if (_nextSignalInterval) { clearInterval(_nextSignalInterval); _nextSignalInterval = null; }
  const el = document.getElementById('nextSignalTimer');
  if (!el || !lastTs) return;
  const lastMs = new Date(lastTs).getTime();
  function tick() {
    const remaining = (lastMs + 6 * 60 * 1000) - Date.now();
    if (remaining > 0) {
      const m = Math.floor(remaining / 60000);
      const s = Math.floor((remaining % 60000) / 1000);
      el.textContent = `‚è± ${m}m ${String(s).padStart(2,'0')}s`;
      el.className = 'next-signal-badge';
    } else if (remaining > -3 * 60 * 1000) {
      el.textContent = '‚è≥ imminente‚Ä¶';
      el.className = 'next-signal-badge imminent';
    } else {
      el.textContent = '‚ö† ritardo';
      el.className = 'next-signal-badge overdue';
    }
  }
  tick();
  _nextSignalInterval = setInterval(tick, 1000);
}

function render(data) {
  updateBotStatus(data);
  document.getElementById('lastUpdate').innerHTML =
    `LAST UPDATE: <strong>${new Date().toLocaleTimeString('it-IT')}</strong>`;
  // Start next-signal countdown from most recent record
  if (data.length > 0) startNextSignalTimer(data[0].created_at);

  const bets        = data.filter(d => d.classification === 'BET');
  const realBets    = bets.filter(d => d.pnl_usd !== null);
  const closedBets  = bets.filter(d => d.correct !== null);
  const correctBets = closedBets.filter(d => d.correct === true);
  const closed      = data.filter(d => d.correct !== null);
  const correct     = closed.filter(d => d.correct === true);

  const totalPnl   = realBets.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  lastTotalPnl = totalPnl;
  const capitalBase = liveWalletEquity || CONFIG.CAPITAL;

  // Session ROI: solo bets dal top-up $100 (2026-02-24)
  const sessionBets = realBets.filter(d => d.created_at && d.created_at.slice(0, 10) >= CONFIG.SESSION_START);
  const sessionPnl  = sessionBets.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  lastSessionPnl = sessionPnl;
  const roiPct      = (sessionPnl / CONFIG.CAPITAL) * 100;  // I-05: fixed denominator $100, not live equity
  // APR: always computed from full dataset (allData), independent of period chip
  const allRealBets    = allData.filter(d => d.bet_taken && d.pnl_usd !== null);
  const allSessionBets = allRealBets.filter(d => d.created_at && d.created_at.slice(0, 10) >= CONFIG.SESSION_START);
  const sessionPnlFull = allSessionBets.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  const daysActive  = Math.max(1, (Date.now() - new Date(CONFIG.SESSION_START + 'T00:00:00Z')) / 86400000);
  const aprTotal    = (sessionPnlFull / CONFIG.CAPITAL) / daysActive * 365 * 100;
  const todayStr    = new Date().toISOString().slice(0, 10);
  const pnlToday    = allRealBets.filter(d => (d.created_at || '').slice(0, 10) === todayStr).reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  const aprToday    = (pnlToday / CONFIG.CAPITAL) * 365 * 100;
  const cutoff7d    = new Date(Date.now() - 7 * 86400000);
  const pnl7d       = allRealBets.filter(d => new Date(d.created_at) >= cutoff7d).reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  const apr7d       = (pnl7d / CONFIG.CAPITAL) / 7 * 365 * 100;
  const avgConf  = data.length ? data.reduce((s, d) => s + parseFloat(d.confidence || 0), 0) / data.length : 0;
  const pnlVals  = realBets.map(d => parseFloat(d.pnl_usd || 0));
  const bestPnl  = pnlVals.length ? Math.max(...pnlVals) : 0;
  const worstPnl = pnlVals.length ? Math.min(...pnlVals) : 0;

  const lastEntry = (allData.length ? allData : data).find(d => d.btc_price_entry);
  const lastFG    = (lastEntry && lastEntry.fear_greed_value != null) ? lastEntry.fear_greed_value : null;

  document.getElementById('kpiPrice').textContent   = lastEntry ? fmtPrice(lastEntry.btc_price_entry) : '‚Äî';
  const isAllPeriod = currentPeriod === 'ALL';
  const _kpiCount = isAllPeriod
    ? (dbTotalCount > data.length ? dbTotalCount + '+' : (dbTotalCount || data.length))
    : data.length;
  document.getElementById('kpiTotal').textContent   = _kpiCount;
  document.getElementById('kpiTotalSub').textContent = isAllPeriod ? 'All time' : currentPeriod;

  const accEl = document.getElementById('kpiAccuracy');
  accEl.textContent = closed.length ? Math.round(correct.length / closed.length * 100) + '%' : '‚Äî';

  const pnlEl = document.getElementById('kpiPnl');
  pnlEl.textContent = (sessionPnl >= 0 ? '+' : '') + '$' + sessionPnl.toFixed(2);
  pnlEl.className   = 'kpi-value ' + (sessionPnl >= 0 ? 'green' : 'red');

  const aprEl = document.getElementById('kpiApr');
  if (aprEl) {
    aprEl.textContent = (aprTotal >= 0 ? '+' : '') + aprTotal.toFixed(1) + '%';
    aprEl.className   = 'kpi-value ' + (aprTotal >= 0 ? 'purple' : 'red');
  }
  const aprSubEl = document.getElementById('kpiAprSub');
  if (aprSubEl) aprSubEl.textContent = `${Math.round(daysActive)}d active`;
  const roiEl = document.getElementById('kpiRoi');
  if (roiEl) { roiEl.textContent = (roiPct >= 0 ? '+' : '') + roiPct.toFixed(2) + '%'; roiEl.className = 'kpi-value ' + (roiPct >= 0 ? 'purple' : 'red'); }
  const roiSubEl = document.getElementById('kpiRoiSub');
  if (roiSubEl) roiSubEl.textContent = (sessionPnl >= 0 ? '+' : '') + '$' + sessionPnl.toFixed(2) + ' session';
  const aprTodayEl = document.getElementById('statAprToday');
  if (aprTodayEl) aprTodayEl.textContent = (aprToday >= 0 ? '+' : '') + aprToday.toFixed(1) + '%';
  const apr7dEl = document.getElementById('statApr7d');
  if (apr7dEl) apr7dEl.textContent = (apr7d >= 0 ? '+' : '') + apr7d.toFixed(1) + '%';
  document.getElementById('footerCapital').textContent = fmtUsd(capitalBase) + ' equity';

  document.getElementById('kpiWinRate').textContent = closedBets.length ? Math.round(correctBets.length / closedBets.length * 100) + '%' : '‚Äî';
  // Signal WR = WR on ALL verified predictions (bets + no-bets), distinct from Win Rate (bets only)
  document.getElementById('kpiWrNoBet').textContent = closed.length ? Math.round(correct.length / closed.length * 100) + '%' : '‚Äî';
  document.getElementById('kpiFG').textContent      = lastFG !== null ? lastFG : '‚Äî';
  document.getElementById('kpiFGLabel').textContent = lastFG !== null
    ? (lastFG < 20 ? 'EXTREME FEAR' : lastFG < 40 ? 'FEAR' : lastFG < 60 ? 'NEUTRAL' : lastFG < 80 ? 'GREED' : 'EXTREME GREED') : '';
  document.getElementById('kpiBets').textContent    = bets.length + '/' + data.length;
  document.getElementById('kpiDrawdown').textContent= worstPnl ? '$' + worstPnl.toFixed(2) : '‚Äî';

  document.getElementById('statConf').textContent  = (avgConf * 100).toFixed(1) + '%';
  document.getElementById('statBest').textContent  = bestPnl  ? '+$' + bestPnl.toFixed(2)  : '‚Äî';
  const closedBetsDesc = bets.filter(d => d.correct !== null);
  let streak = 0, streakType = null;
  if (closedBetsDesc.length) {
    streakType = closedBetsDesc[0].correct ? 'W' : 'L';
    for (const b of closedBetsDesc) {
      if ((b.correct ? 'W' : 'L') === streakType) streak++;
      else break;
    }
  }
  const streakEl = document.getElementById('statStreak');
  streakEl.textContent = streak > 0 ? streakType + '√ó' + streak : '‚Äî';
  streakEl.style.color = streakType === 'W' ? 'var(--accent)' : streakType === 'L' ? 'var(--danger)' : 'var(--muted)';
  const betsWithSlip = realBets.filter(d => d.entry_slippage !== null && d.entry_slippage !== undefined);
  const avgSlip = betsWithSlip.length
    ? betsWithSlip.reduce((s, d) => s + parseFloat(d.entry_slippage || 0), 0) / betsWithSlip.length
    : null;
  const slipEl = document.getElementById('statSlippage');
  slipEl.textContent = avgSlip !== null ? (avgSlip >= 0 ? '+' : '') + '$' + avgSlip.toFixed(2) : '‚Äî';
  slipEl.style.color = avgSlip === null ? 'var(--muted)' : Math.abs(avgSlip) > 20 ? 'var(--danger)' : Math.abs(avgSlip) > 5 ? 'var(--warn)' : 'var(--accent)';
  // Total fees (from realBets fees_total)
  const totalFeesSum = realBets.reduce((s, d) => s + (d.fees_total ? parseFloat(d.fees_total) : 0), 0);
  const feesEl = document.getElementById('statTotalFees');
  feesEl.textContent = totalFeesSum > 0 ? '-$' + totalFeesSum.toFixed(2) : '‚Äî';
  feesEl.style.color = totalFeesSum > 5 ? 'var(--danger)' : totalFeesSum > 0 ? 'var(--warn)' : 'var(--muted)';

  // Total slippage (sum of price-point differences, not dollar cost)
  const totalSlipSum = betsWithSlip.reduce((s, d) => s + parseFloat(d.entry_slippage || 0), 0);
  const totalSlipEl = document.getElementById('statTotalSlippage');
  totalSlipEl.textContent = betsWithSlip.length ? (totalSlipSum >= 0 ? '+' : '') + '$' + totalSlipSum.toFixed(2) : '‚Äî';
  totalSlipEl.style.color = betsWithSlip.length === 0 ? 'var(--muted)' : totalSlipSum < -200 ? 'var(--danger)' : 'var(--warn)';

  const betsWithRR = bets.filter(d => d.rr_ratio !== null && d.rr_ratio !== undefined);
  const avgRR = betsWithRR.length
    ? betsWithRR.reduce((s, d) => s + parseFloat(d.rr_ratio || 0), 0) / betsWithRR.length
    : null;
  const rrEl = document.getElementById('statRR');
  rrEl.textContent = avgRR !== null ? avgRR.toFixed(2) + '√ó' : '‚Äî';
  rrEl.style.color = avgRR === null ? 'var(--muted)' : avgRR >= 2 ? 'var(--accent)' : avgRR >= 1.5 ? 'var(--warn)' : 'var(--danger)';

  // Mobile-only: Expectancy, Profit Factor, Best Streak
  // I-10: use allData (full history) ‚Äî period-filtered data (e.g. TODAY=2 bets) gives noisy/meaningless values
  const allClosedBets  = allData.filter(d => d.classification === 'BET' && d.correct !== null);
  const allTotalPnl    = allClosedBets.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  const grossWins      = allClosedBets.filter(d => parseFloat(d.pnl_usd) > 0).reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  const grossLoss      = Math.abs(allClosedBets.filter(d => parseFloat(d.pnl_usd) < 0).reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0));
  const expectancy     = allClosedBets.length ? allTotalPnl / allClosedBets.length : null;
  const profitFactor   = grossLoss > 0 ? grossWins / grossLoss : null;
  const expEl = document.getElementById('kpiExpectancyVal');
  if (expEl) {
    expEl.textContent = expectancy !== null ? (expectancy >= 0 ? '+' : '') + '$' + expectancy.toFixed(3) : '‚Äî';
    expEl.className = 'kpi-value ' + (expectancy === null ? 'white' : expectancy >= 0 ? 'green' : 'red');
  }
  const pfEl = document.getElementById('kpiProfitFactorVal');
  if (pfEl) {
    pfEl.textContent = profitFactor !== null ? profitFactor.toFixed(2) : '‚Äî';
    pfEl.className = 'kpi-value ' + (profitFactor === null ? 'purple' : profitFactor >= 1.5 ? 'green' : profitFactor < 1 ? 'red' : 'yellow');
  }
  // Best streak
  let bestStreakW = 0, bestStreakL = 0, curW = 0, curL = 0;
  for (const b of closedBetsDesc) {
    if (b.correct) { curW++; curL = 0; bestStreakW = Math.max(bestStreakW, curW); }
    else           { curL++; curW = 0; bestStreakL = Math.max(bestStreakL, curL); }
  }
  const bsEl = document.getElementById('statBestStreak');
  if (bsEl) {
    bsEl.textContent = bestStreakW > 0 ? 'W√ó' + bestStreakW : '‚Äî';
    bsEl.style.color = 'var(--accent)';
  }

  // Hit Rate 7d
  const cutoff7dHR = new Date(Date.now() - 7 * 86400000);
  const last7dBets = realBets.filter(d => d.correct !== null && d.correct !== undefined && new Date(d.created_at) >= cutoff7dHR);
  const wr7d = last7dBets.length ? Math.round(last7dBets.filter(d => d.correct).length / last7dBets.length * 100) : null;
  const hr7dEl = document.getElementById('statHitRate7d');
  if (hr7dEl) hr7dEl.textContent = wr7d !== null ? wr7d + '%' : '‚Äî';

  // Conf WIN vs LOSS gap
  const winBets  = realBets.filter(d => d.correct === true);
  const lossBets = realBets.filter(d => d.correct === false);
  const avgCW = winBets.length  ? winBets.reduce((s,d)  => s + parseFloat(d.confidence || 0), 0) / winBets.length  : null;
  const avgCL = lossBets.length ? lossBets.reduce((s,d) => s + parseFloat(d.confidence || 0), 0) / lossBets.length : null;
  const confGapEl = document.getElementById('statConfGap');
  if (confGapEl) confGapEl.textContent = (avgCW && avgCL) ? `${Math.round(avgCW*100)}/${Math.round(avgCL*100)}%` : '‚Äî';

  renderTable(data);

  const chronoBets = [...realBets].reverse();
  const chronoAll  = [...data].reverse();

  // I-06: defer all SVG renders to idle time ‚Äî prevents blocking main thread every 60s.
  // Safari polyfill: requestIdleCallback not supported ‚Üí setTimeout(16ms) yields one frame.
  const _ric = window.requestIdleCallback
    ? fn => requestIdleCallback(fn, { timeout: 2000 })
    : fn => setTimeout(fn, 16);

  _ric(() => {
    renderGalaxy(data);
    renderSignalQuality(data);
    renderConfDist(data);
  });
  _ric(() => {
    renderEquityCurve(chronoBets, totalPnl);
    renderRollingWrFull(chronoBets);
    renderConfFull(chronoBets);
  });
  _ric(() => {
    renderConfidenceOverTime(chronoAll);
    renderRollingWinRate(chronoBets);
    renderPnlBarsLarge(chronoBets);
    renderBtcPredictionsOverlay(chronoAll);
  });

  const tag = document.getElementById('totalPnlTag');
  tag.textContent = 'TOTAL: ' + (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
  tag.className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');

  // Mobile sync
  syncStoryHighlights();
  syncMobilePrimary();
  initTooltips();
  repositionSignalLog();
  // renderMobileBetList already called inside renderTable() ‚Äî no duplicate needed
}

function renderTable(data) {
  const dirFilter   = document.getElementById('filterDir').value;
  const classFilter = document.getElementById('filterClass').value;
  const filtered = data.filter(d => {
    if (dirFilter   !== 'ALL' && d.direction      !== dirFilter)   return false;
    if (classFilter !== 'ALL' && d.classification !== classFilter) return false;
    return true;
  });
  const tbody = document.getElementById('signalTable');
  if (!filtered.length) {
    tbody.innerHTML = '<tr class="no-data-row"><td colspan="15">NO DATA</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(d => {
    const dirCls  = d.direction === 'UP' ? 'dir-up' : 'dir-down';
    const dirIcon = d.direction === 'UP' ? '‚Üë' : '‚Üì';
    let betBadge;
    if      (d.classification === 'BET')     betBadge = '<span class="badge badge-bet">BET</span>';
    else if (d.classification === 'SKIP')    betBadge = '<span class="badge badge-skip">SKIP</span>';
    else if (d.classification === 'ALERT')   betBadge = '<span class="badge badge-alert">ALERT</span>';
    else if (d.classification === 'PENDING') betBadge = '<span class="badge badge-pending">PEND</span>';
    else                                     betBadge = '<span class="badge badge-nobet">NO BET</span>';
    const isDry = (d.entry_order_id || '').startsWith('DRY_');
    let resultBadge;
    const isBet = d.classification === 'BET' && d.bet_taken;
    if (d.correct === true) {
      resultBadge = isDry
        ? '<span class="badge" style="background:rgba(0,255,136,0.06);color:rgba(0,255,136,0.6);border:1px solid rgba(0,255,136,0.2)">‚úì SIM WIN</span>'
        : isBet
          ? '<span class="badge badge-correct">‚úì WIN</span>'
          : '<span class="badge badge-correct" style="opacity:0.75">‚úì RIGHT</span>';
    } else if (d.correct === false) {
      resultBadge = isDry
        ? '<span class="badge" style="background:rgba(255,68,102,0.06);color:rgba(255,68,102,0.6);border:1px solid rgba(255,68,102,0.2)">‚úó SIM LOSS</span>'
        : isBet
          ? '<span class="badge badge-wrong">‚úó LOSS</span>'
          : '<span class="badge badge-wrong" style="opacity:0.75">‚úó WRONG</span>';
    } else {
      if (isBet) {
        resultBadge = '<span style="color:var(--warn);font-size:9px;letter-spacing:1px">‚è≥ OPEN</span>';
      } else if (d.ghost_correct === true) {
        resultBadge = '<span title="Ghost outcome: correct direction (not traded)" style="color:rgba(0,255,136,0.55);font-size:10px;letter-spacing:0.5px;font-family:monospace">(‚úì)</span>';
      } else if (d.ghost_correct === false) {
        resultBadge = '<span title="Ghost outcome: wrong direction (not traded)" style="color:rgba(255,68,102,0.55);font-size:10px;letter-spacing:0.5px;font-family:monospace">(‚úó)</span>';
      } else {
        // No ghost result yet ‚Äî show classification as outcome indicator
        if (d.classification === 'SKIP') {
          resultBadge = '<span title="Signal skipped ‚Äî ghost result pending" style="color:var(--muted);font-size:9px;letter-spacing:1px;opacity:0.55">SKIP</span>';
        } else if (d.classification === 'ALERT') {
          resultBadge = '<span title="Alert signal ‚Äî no trade placed" style="color:var(--warn);font-size:9px;letter-spacing:1px;opacity:0.65">ALERT</span>';
        } else if (d.classification === 'PENDING') {
          resultBadge = '<span style="color:var(--muted);font-size:9px;letter-spacing:1px;opacity:0.55">PEND</span>';
        } else {
          resultBadge = '<span title="No trade placed" style="color:var(--muted);font-size:9px;letter-spacing:1px;opacity:0.55">NO BET</span>';
        }
      }
    }
    const pnlCls    = d.pnl_usd === null ? 'pnl-null' : parseFloat(d.pnl_usd) >= 0 ? 'pnl-pos' : 'pnl-neg';
    const score     = (d.technical_score !== null && d.technical_score !== undefined) ? parseFloat(d.technical_score).toFixed(1) : '‚Äî';
    const scoreColor= (d.technical_score !== null && d.technical_score !== undefined) ? (parseFloat(d.technical_score) >= 0 ? 'var(--accent)' : 'var(--danger)') : 'var(--muted)';
    // EXIT $: fill price ‚Üí signal exit ‚Üí ghost exit (per SKIP)
    const exitPrice = d.exit_fill_price ?? d.btc_price_exit ?? d.ghost_exit_price;
    // PNL cell: real $ for BETs, theoretical % for NO BETs
    let pnlCell;
    if (d.classification === 'BET') {
      pnlCell = `<span class="${pnlCls}">${fmtPnl(d.pnl_usd)}</span>`;
    } else if (d.pnl_pct !== null && d.pnl_pct !== undefined) {
      const pct = parseFloat(d.pnl_pct);
      const pctCls = pct >= 0 ? 'pnl-pos' : 'pnl-neg';
      const pctSign = pct >= 0 ? '+' : '';
      pnlCell = `<span class="${pctCls}" style="font-style:italic;opacity:0.7;font-size:10px">${pctSign}${pct.toFixed(2)}%</span>`;
    } else {
      pnlCell = `<span class="pnl-null">‚Äî</span>`;
    }
    const TAKER_RATE = 0.00005;
    let feeCell = '<span style="color:var(--muted)">‚Äî</span>';
    if (d.classification === 'BET' && d.bet_taken) {
      const feeVal = (d.fees_total !== null && d.fees_total !== undefined)
        ? parseFloat(d.fees_total)
        : (() => {
            const sz = parseFloat(d.bet_size || 0);
            const ep = parseFloat(d.entry_fill_price || 0);
            const xp = parseFloat(d.exit_fill_price || d.btc_price_exit || 0);
            return sz * (ep + xp) * TAKER_RATE;
          })();
      if (feeVal > 0) feeCell = `<span style="color:var(--warn);font-size:10px">-$${feeVal.toFixed(5)}</span>`;
    }
    const preTag = d._source === 'pre_day0'
      ? ' <span title="Pre-Day0 historical bet" style="font-size:8px;letter-spacing:1px;color:var(--muted);opacity:0.6;vertical-align:middle;border:1px solid var(--muted);border-radius:2px;padding:0 3px">PRE</span>'
      : '';
    return `<tr class="${d.direction === 'UP' ? 'sl-up' : 'sl-down'}${d._source === 'pre_day0' ? ' sl-pre-day0' : ''}">
      <td style="color:var(--muted)">${d.id}${preTag}</td>
      <td style="color:var(--muted)">${fmtDate(d.created_at)}</td>
      <td class="${dirCls}">${dirIcon} ${escapeHtml(d.direction)}</td>
      <td>${fmtConf(d.confidence)}</td>
      <td>${renderEntryCell(d)}</td>
      <td>${fmtPrice(exitPrice)}</td>
      <td>${d.rsi14 ? parseFloat(d.rsi14).toFixed(1) : '‚Äî'}</td>
      <td>${emaLabel(d.ema_trend)}</td>
      <td style="color:${scoreColor}">${score}</td>
      <td>${renderSizeCell(d)}</td>
      <td>${betBadge}</td>
      <td>${resultBadge}</td>
      <td>${pnlCell}</td>
      <td>${feeCell}</td>
      <td>${d.sl_price || d.tp_price || d.rr_ratio ? `<span style="font-size:9px;color:var(--danger)">SL ${d.sl_price ? fmtPrice(d.sl_price) : '‚Äî'}</span><br><span style="font-size:9px;color:var(--accent)">TP ${d.tp_price ? fmtPrice(d.tp_price) : '‚Äî'}</span><br><span style="font-size:9px;color:var(--muted)">RR ${d.rr_ratio ? parseFloat(d.rr_ratio).toFixed(2) + '√ó' : '‚Äî'}</span>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>
      <td style="text-align:center">${d.onchain_commit_tx && /^(0x)?[0-9a-fA-F]{64}$/.test(d.onchain_commit_tx) ? `<a href="https://polygonscan.com/tx/0x${d.onchain_commit_tx.replace(/^0x/,'')}" target="_blank" rel="noopener" title="Verified on Polygon PoS" style="text-decoration:none;font-size:13px">‚õìÔ∏è</a>` : '<span style="color:var(--muted);font-size:9px">‚Äî</span>'}</td>
    </tr>`;
  }).join('');
  renderMobileBetList(data);
}

/* ‚îÄ‚îÄ Source chip modal ‚îÄ‚îÄ */
function showSrcModal(chip) {
  const modal = document.getElementById('srcModal');
  const color = getComputedStyle(chip).getPropertyValue('--src-color').trim() || '#00ff88';
  document.getElementById('srcModalTitle').textContent = chip.dataset.srcModalTitle || '';
  document.getElementById('srcModalDesc').innerHTML  = chip.dataset.srcModalDesc  || ''; // safe: hardcoded in HTML attributes
  document.getElementById('srcModalColor').style.background = color;
  modal.style.display = 'flex';
}
function closeSrcModal(e) {
  if (e.target === document.getElementById('srcModal')) document.getElementById('srcModal').style.display = 'none';
}

// ‚îÄ‚îÄ HEADER BADGE POPOVERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _hpopContent = {
  live: {
    title: 'LIVE DATA FEED',
    rows: [
      { key: 'BTC Price',   val: 'Kraken Futures mark price ¬∑ refreshes every 10s' },
      { key: 'Signals',     val: 'Dashboard polls Railway backend every 60s' },
      { key: 'Account',     val: 'Wallet equity + positions ¬∑ refreshes every 30s' },
      { key: 'Sources',     val: '16 AI feeds: Binance, CoinGecko, F&G, news, order book, OI, taker flow‚Ä¶' },
      { key: 'On-Chain',    val: 'Each prediction committed to Polygon PoS in real-time' },
    ]
  },
  bot: {
    title: 'BOT STATUS',
    rows: [
      { dot: 'var(--accent)', key: 'üü¢ ALIVE',   val: 'Last signal < 8 min ago ‚Äî system healthy' },
      { dot: 'var(--warn)',   key: 'üü° SLOW',    val: 'Last signal 8‚Äì20 min ‚Äî possible delay' },
      { dot: 'var(--danger)', key: 'üî¥ OFFLINE', val: 'No signal > 20 min ‚Äî check n8n wf01' },
      { key: 'Cycle',        val: 'wf01 fires every 6 min: fetch ‚Üí Claude AI ‚Üí XGBoost ‚Üí dual-gate ‚Üí place/skip' },
      { key: 'Threshold',    val: 'Both Claude (conf ‚â• 0.75) AND XGBoost must agree ‚Äî or bet is skipped' },
    ]
  }
};

let _hpopActive = null;
function showHeaderPopover(el, type) {
  const pop = document.getElementById('headerPopover');
  if (_hpopActive === type && pop.style.display === 'block') {
    pop.style.display = 'none'; _hpopActive = null; return;
  }
  _hpopActive = type;
  const cfg = _hpopContent[type];
  document.getElementById('hpopTitle').textContent = cfg.title;
  document.getElementById('hpopBody').innerHTML = cfg.rows.map(r =>
    `<div class="hpop-row">${r.dot ? `<div class="hpop-dot" style="background:${r.dot};box-shadow:0 0 4px ${r.dot}"></div>` : ''}<span class="hpop-key">${r.key}&nbsp;&nbsp;</span><span class="hpop-val">${r.val}</span></div>`
  ).join('');
  // Position below the clicked badge
  const rect = el.getBoundingClientRect();
  pop.style.display = 'block';
  const pw = pop.offsetWidth;
  let left = rect.left;
  if (left + pw > window.innerWidth - 12) left = window.innerWidth - pw - 12;
  pop.style.left = left + 'px';
  pop.style.top  = (rect.bottom + 8) + 'px';
}
document.addEventListener('click', function(e) {
  const pop = document.getElementById('headerPopover');
  if (!pop || pop.style.display !== 'block') return;
  if (!pop.contains(e.target) && !e.target.closest('.live-badge') && !e.target.closest('#botStatus')) {
    pop.style.display = 'none'; _hpopActive = null;
  }
});


/* ‚îÄ‚îÄ Signal log mobile repositioning ‚îÄ‚îÄ */
function repositionSignalLog() {
  const panel    = document.getElementById('signalLogPanel');
  const kpiGrid  = document.querySelector('.kpi-grid');
  const statsRow = document.querySelector('.stats-row');
  const dashMain = document.getElementById('dashboardMain');
  if (!panel || !kpiGrid || !statsRow || !dashMain) return;
  if (window.innerWidth <= 900) {
    // Move before stats-row (between kpi-grid and stats-row)
    if (panel.parentElement !== kpiGrid.parentElement || panel.nextElementSibling !== statsRow) {
      kpiGrid.parentElement.insertBefore(panel, statsRow);
    }
  } else {
    // Restore inside dashboardMain after charts-grid
    const chartsGrid = dashMain.querySelector('.charts-grid');
    if (panel.parentElement !== dashMain) {
      if (chartsGrid && chartsGrid.nextSibling) {
        dashMain.insertBefore(panel, chartsGrid.nextSibling);
      } else {
        dashMain.appendChild(panel);
      }
    }
  }
}
window.addEventListener('resize', repositionSignalLog);

function initTooltips() {
  let tip = document.getElementById('globalTip');
  if (!tip) {
    tip = document.createElement('div');
    tip.id = 'globalTip';
    tip.style.cssText = 'position:fixed;background:rgba(8,12,25,0.97);border:1px solid rgba(0,255,136,0.25);color:#99aabb;font-size:9px;font-family:JetBrains Mono,monospace;letter-spacing:0.5px;padding:6px 11px;border-radius:2px;pointer-events:none;display:none;z-index:9999;max-width:240px;line-height:1.6;white-space:normal;';
    document.body.appendChild(tip);
  }
  // I-03: event delegation ‚Äî 3 listeners on document (registered once) replace
  // N√ó3 listeners on individual [data-tip] elements re-added every 60s render.
  if (document._tooltipsInit) return;
  document._tooltipsInit = true;
  document.addEventListener('mouseover', e => {
    const el = e.target.closest('[data-tip]');
    if (el) { tip.textContent = el.dataset.tip; tip.style.display = 'block'; }
  });
  document.addEventListener('mousemove', e => {
    if (tip.style.display !== 'none') {
      tip.style.left = Math.min(e.clientX + 14, window.innerWidth - 255) + 'px';
      tip.style.top  = Math.max(e.clientY - 48, 4) + 'px';
    }
  });
  document.addEventListener('mouseout', e => {
    const el = e.target.closest('[data-tip]');
    if (el && !el.contains(e.relatedTarget)) tip.style.display = 'none';
  });
}

function renderGalaxy(data) {
  const svg = document.getElementById('galaxySvg');
  if (!svg) return;

  // Only real closed bets with both confidence and pnl
  const bets = data.filter(d =>
    d.classification === 'BET' &&
    d.pnl_usd !== null && d.pnl_usd !== undefined &&
    d.confidence !== null
  );
  if (!bets.length) { svg.innerHTML = '<text x="160" y="56" text-anchor="middle" fill="#555" font-size="11">No data</text>'; return; }

  const W = 320, H = 112;
  const PAD = { l: 28, r: 10, t: 10, b: 10 };
  const plotW = W - PAD.l - PAD.r;
  const plotH = H - PAD.t - PAD.b;

  // Scales
  const confs  = bets.map(d => parseFloat(d.confidence));
  const pnls   = bets.map(d => parseFloat(d.pnl_usd));
  const sizes  = bets.map(d => parseFloat(d.bet_size || 0.002));

  const confMin = Math.min(...confs), confMax = Math.max(...confs, 0.85);
  const pnlAbs  = Math.max(...pnls.map(Math.abs), 0.5);
  const sizeMin = Math.min(...sizes), sizeMax = Math.max(...sizes);

  const cx = c => PAD.l + ((c - confMin) / (confMax - confMin || 1)) * plotW;
  const cy = v => PAD.t + plotH / 2 - (v / pnlAbs) * (plotH / 2 - 6);
  const cr = s => {
    const t = sizeMax > sizeMin ? (s - sizeMin) / (sizeMax - sizeMin) : 0.5;
    return 3 + t * 4.5; // radius 3‚Äì7.5px
  };

  // Threshold line at conf=0.75 and pnl=0
  const threshX = cx(0.75);
  const midY    = cy(0);

  let html = '';

  // Subtle grid lines
  html += `<line x1="${PAD.l}" y1="${midY}" x2="${W - PAD.r}" y2="${midY}" stroke="#ffffff18" stroke-width="1" stroke-dasharray="3,3"/>`;
  if (threshX > PAD.l && threshX < W - PAD.r)
    html += `<line x1="${threshX}" y1="${PAD.t}" x2="${threshX}" y2="${H - PAD.b}" stroke="#ffffff18" stroke-width="1" stroke-dasharray="3,3"/>`;

  // Axis labels
  html += `<text x="${PAD.l - 2}" y="${midY + 3}" text-anchor="end" fill="#444" font-size="8">$0</text>`;
  html += `<text x="${PAD.l - 2}" y="${PAD.t + 8}" text-anchor="end" fill="#1a6b3a" font-size="7">+</text>`;
  html += `<text x="${PAD.l - 2}" y="${H - PAD.b}" text-anchor="end" fill="#6b1a1a" font-size="7">‚àí</text>`;

  // Quadrant labels (very subtle)
  const qAlpha = '22';
  if (threshX > PAD.l + 20) {
    html += `<text x="${PAD.l + 2}" y="${PAD.t + 9}" fill="#ffffff${qAlpha}" font-size="7">LOW</text>`;
    html += `<text x="${PAD.l + 2}" y="${H - PAD.b - 2}" fill="#ffffff${qAlpha}" font-size="7">LOW</text>`;
  }
  html += `<text x="${W - PAD.r - 2}" y="${PAD.t + 9}" text-anchor="end" fill="#00ff88${qAlpha}" font-size="7">WIN ‚ú¶</text>`;
  html += `<text x="${W - PAD.r - 2}" y="${H - PAD.b - 2}" text-anchor="end" fill="#ff4d4d${qAlpha}" font-size="7">LOSS ‚ú¶</text>`;

  // Draw stars ‚Äî open bets last so they're on top
  const closed = bets.filter(d => d.correct !== null);
  const open   = bets.filter(d => d.correct === null);

  [...closed, ...open].forEach(d => {
    const x   = cx(parseFloat(d.confidence));
    const y   = cy(parseFloat(d.pnl_usd));
    const r   = cr(parseFloat(d.bet_size || 0.002));
    const win = d.correct === true;
    const los = d.correct === false;
    const opn = d.correct === null;

    const fill    = opn ? '#888' : win ? '#00ff88' : '#ff4d4d';
    // Use SVG stroke instead of CSS drop-shadow ‚Äî drop-shadow with overflow:visible caused full-page red flicker
    const strokeC = opn ? 'none' : win ? '#00ff8855' : '#ff4d4d55';
    const strokeW = opn ? 0 : (r * 0.8).toFixed(1);
    const opacity = opn ? 0.5 : 0.82;
    const pnlV  = parseFloat(d.pnl_usd);
    const conf  = parseFloat(d.confidence);
    const dir   = d.direction || '';
    const dt    = d.created_at ? d.created_at.slice(0, 16).replace('T', ' ') : '';

    // Tooltip content encoded in data attrs, rendered by JS mouseover
    const tip = `${dir} conf=${(conf*100).toFixed(0)}% pnl=${pnlV >= 0 ? '+' : ''}$${Math.abs(pnlV).toFixed(2)} size=${d.bet_size} ${dt}`;

    html += `<circle
      cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="${r.toFixed(1)}"
      fill="${fill}" opacity="${opacity}"
      stroke="${strokeC}" stroke-width="${strokeW}"
      style="cursor:pointer;"
      data-gtip="${escapeHtml(tip)}"
    />`;
  });

  // Count tag
  const nWin = closed.filter(d => d.correct === true).length;
  const nLos = closed.filter(d => d.correct === false).length;
  const galaxyTagEl = document.getElementById('galaxyTag');
  if (galaxyTagEl) galaxyTagEl.textContent = `${nWin}W ¬∑ ${nLos}L`;

  svg.innerHTML = html;

  // Tooltip on hover (reuse existing .tooltip-float if present, else create)
  let tipEl = document.getElementById('galaxyTip');
  if (!tipEl) {
    tipEl = document.createElement('div');
    tipEl.id = 'galaxyTip';
    tipEl.style.cssText = 'position:fixed;background:#1a1a2e;border:1px solid #333;color:#eee;font-size:10px;padding:4px 8px;border-radius:6px;pointer-events:none;display:none;z-index:9999;white-space:nowrap;';
    document.body.appendChild(tipEl);
  }
  svg.querySelectorAll('circle').forEach(el => {
    el.addEventListener('mouseenter', e => {
      tipEl.textContent = el.dataset.gtip;
      tipEl.style.display = 'block';
    });
    el.addEventListener('mousemove', e => {
      tipEl.style.left = (e.clientX + 12) + 'px';
      tipEl.style.top  = (e.clientY - 28) + 'px';
    });
    el.addEventListener('mouseleave', () => { tipEl.style.display = 'none'; });
  });
}

function renderSignalQuality(data) {
  const pct = (arr, fn) => arr.length ? Math.round(arr.filter(fn).length / arr.length * 100) : 0;
  const upClosed  = data.filter(d => d.direction === 'UP'   && d.correct !== null);
  const dnClosed  = data.filter(d => d.direction === 'DOWN' && d.correct !== null);

  const betsWithPnl = data.filter(d => d.classification === 'BET' && d.pnl_usd !== null);
  const grossWin  = betsWithPnl.filter(d => parseFloat(d.pnl_usd) > 0).reduce((s, d) => s + parseFloat(d.pnl_usd), 0);
  const grossLoss = Math.abs(betsWithPnl.filter(d => parseFloat(d.pnl_usd) < 0).reduce((s, d) => s + parseFloat(d.pnl_usd), 0));
  const pf = grossLoss > 0 ? grossWin / grossLoss : grossWin > 0 ? 99 : 0;
  const pfLabel = betsWithPnl.length ? pf.toFixed(2) + 'x' : '‚Äî';

  const totalPnlSig = betsWithPnl.reduce((s, d) => s + parseFloat(d.pnl_usd || 0), 0);
  const avgPnl = betsWithPnl.length ? totalPnlSig / betsWithPnl.length : 0;
  const avgPnlLabel = betsWithPnl.length ? (avgPnl >= 0 ? '+' : '') + '$' + avgPnl.toFixed(4) : '‚Äî';

  const metrics = [
    { label: 'Profit Factor',        barVal: Math.min(pf / 2 * 100, 100), displayVal: pfLabel,    color: pf >= 1 ? 'var(--accent)' : 'var(--danger)',
      tip: 'Gross wins √∑ gross losses.<br>‚â•2.0 = excellent system quality.<br>Measures structural profitability.' },
    { label: 'Avg PnL / Trade',      barVal: 50,                           displayVal: avgPnlLabel, color: avgPnl >= 0 ? 'var(--accent)' : 'var(--danger)',
      tip: 'Average P&amp;L per executed BET.<br>Positive = real edge confirmed.<br>Includes trading fees.' },
    { label: 'UP Signal Accuracy',   barVal: pct(upClosed, d => d.correct), displayVal: null,      color: 'var(--accent)',
      tip: 'Win rate on LONG (bullish) predictions.<br>Closed BETs with direction=UP only.' },
    { label: 'DOWN Signal Accuracy', barVal: pct(dnClosed, d => d.correct), displayVal: null,      color: 'var(--danger)',
      tip: 'Win rate on SHORT (bearish) predictions.<br>Historically harder to predict accurately.' },
    { label: 'Bet Coverage',         barVal: data.length ? Math.round(data.filter(d => d.classification === 'BET').length / data.length * 100) : 0, displayVal: null, color: 'var(--warn)',
      tip: '% of signals converted into real BETs.<br>Low = high selective threshold.<br>High = more bets but less filtered.' },
  ];
  document.getElementById('signalQuality').innerHTML = metrics.map(m => `
    <div class="signal-row" data-tip="${m.tip}">
      <div class="signal-meta">
        <span class="signal-label">${m.label}</span>
        <span class="signal-val" style="color:${m.color}">${m.displayVal !== null ? m.displayVal : m.barVal + '%'}</span>
      </div>
      <div class="signal-bar-bg"><div class="signal-bar-fill" style="width:${m.barVal}%;background:${m.color}"></div></div>
    </div>`).join('');
}

function renderConfDist(data) {
  const buckets = [
    { label: '50-54%', min: 0.50, max: 0.55, above: false },
    { label: '55-59%', min: 0.55, max: 0.60, above: false },
    { label: '60-64%', min: 0.60, max: 0.65, above: false },
    { label: '65-74%', min: 0.65, max: 0.75, above: false },
    { label: '75-79%', min: 0.75, max: 0.80, above: true  },
    { label: '80%+',   min: 0.80, max: 1.01, above: true  },
  ];
  // Use only BETs (executed signals) for distribution + win rate
  const bets = data.filter(d => d.classification === 'BET' && d.confidence !== null);
  const counts = buckets.map(b => {
    const rows   = bets.filter(d => { const c = parseFloat(d.confidence); return c >= b.min && c < b.max; });
    const closed = rows.filter(d => d.correct !== null);
    const wins   = closed.filter(d => d.correct === true).length;
    const wr     = closed.length > 0 ? Math.round(wins / closed.length * 100) : null;
    return { ...b, count: rows.length, wr };
  });
  const maxCount = Math.max(...counts.map(c => c.count), 1);
  const barColors = ['#3a5060', '#4a6070', '#5a7080', '#ffaa00', '#00ff88'];

  let html = '';
  counts.forEach((c, i) => {
    // Insert threshold divider before first above-threshold bucket
    if (i === 3) {
      html += `<div class="conf-thresh-line"><span class="conf-thresh-label">‚ñ≤ min threshold 0.75</span></div>`;
    }
    const wrLabel = c.wr !== null ? c.wr + '%' : '‚Äî';
    const wrColor = c.wr === null ? 'var(--muted)' : c.wr >= 60 ? 'var(--accent)' : c.wr >= 50 ? 'var(--warn)' : 'var(--danger)';
    const glowStyle = c.above && c.count > 0 ? `box-shadow:0 0 5px ${barColors[i]}55;` : '';
    const tip = `${c.label}: ${c.count} bet${c.count !== 1 ? 's' : ''} ¬∑ WR ${wrLabel}${c.above ? ' ¬∑ above threshold ‚ú¶' : ' ¬∑ below min threshold'}`;
    html += `<div class="conf-row" data-tip="${tip}">
      <div class="conf-label">${c.label}</div>
      <div class="conf-bar-bg"><div class="conf-bar-fill" style="width:${Math.round(c.count / maxCount * 100)}%;background:${barColors[i]};${glowStyle}"></div></div>
      <div class="conf-count" style="color:${c.above ? 'var(--text)' : 'var(--muted)'}">${c.count}</div>
      <div class="conf-wr" style="color:${wrColor}">${wrLabel}</div>
    </div>`;
  });
  document.getElementById('confDist').innerHTML = html;
}

function renderEquityCurve(chronoBets, totalPnl) {
  const svg = document.getElementById('equitySvg');
  if (!chronoBets.length) { svg.innerHTML = ''; return; }
  let cum = 0;
  const points = [{ i: 0, cum: 0 }];
  chronoBets.forEach((d, i) => { cum += parseFloat(d.pnl_usd || 0); points.push({ i: i+1, cum }); });
  const minV = Math.min(...points.map(p => p.cum));
  const maxV = Math.max(...points.map(p => p.cum));
  const range= maxV - minV || 0.001;
  const W = 1000, H = 100;
  const toX = i => (i / (points.length - 1)) * W;
  const toY = v => H - ((v - minV) / range) * (H - 10) - 5;
  const pts  = points.map((p, i) => `${toX(i).toFixed(1)},${toY(p.cum).toFixed(1)}`).join(' ');
  const areaClose = `${toX(points.length-1).toFixed(1)},${H} 0,${H}`;
  const color  = totalPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
  const gradId = totalPnl >= 0 ? 'eqG' : 'eqGR';
  svg.innerHTML = `
    <defs>
      <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pts} ${areaClose}" fill="url(#${gradId})"/>
    <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${toX(points.length-1).toFixed(1)}" cy="${toY(points[points.length-1].cum).toFixed(1)}" r="3.5" fill="${color}"/>`;
  document.getElementById('equityTag').textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
  document.getElementById('equityTag').className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');

  // Interactive crosshair on hover
  const CAPITAL = 100;
  let eqTip = document.getElementById('equityTip');
  if (!eqTip) {
    eqTip = document.createElement('div');
    eqTip.id = 'equityTip';
    eqTip.style.cssText = 'position:fixed;background:rgba(8,12,25,0.95);border:1px solid rgba(0,255,136,0.3);color:#eee;font-size:10px;font-family:JetBrains Mono,monospace;padding:5px 10px;border-radius:2px;pointer-events:none;display:none;z-index:9999;white-space:nowrap;';
    document.body.appendChild(eqTip);
  }
  // Create hover dot element in SVG (reuse or create)
  let eqDot = svg.querySelector('.eq-hover-dot');
  if (!eqDot) {
    eqDot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    eqDot.setAttribute('class', 'eq-hover-dot');
    eqDot.setAttribute('r', '5');
    eqDot.setAttribute('stroke', 'rgba(0,0,0,0.6)');
    eqDot.setAttribute('stroke-width', '1.5');
    eqDot.style.display = 'none';
    eqDot.style.pointerEvents = 'none';
    svg.appendChild(eqDot);
  }
  function eqHandlePointer(clientX, clientY) {
    const rect = svg.getBoundingClientRect();
    const mx = clientX - rect.left;
    const pct = Math.max(0, Math.min(1, mx / rect.width));
    const idx = Math.round(pct * (points.length - 1));
    const pt  = points[idx];
    if (!pt) return;
    const svgX = toX(idx);
    const svgY = toY(pt.cum);
    const dotColor = pt.cum >= 0 ? '#00ff88' : '#ff4466';
    eqDot.setAttribute('cx', svgX.toFixed(1));
    eqDot.setAttribute('cy', svgY.toFixed(1));
    eqDot.setAttribute('fill', dotColor);
    eqDot.style.display = '';
    const pnlSign = pt.cum >= 0 ? '+' : '';
    const pnlPct  = CAPITAL > 0 ? (pt.cum / CAPITAL * 100).toFixed(1) : '‚Äî';
    const pctSign = pt.cum >= 0 ? '+' : '';
    eqTip.innerHTML = `Bet #${idx} &nbsp;|&nbsp; <span style="color:${dotColor}">${pnlSign}$${pt.cum.toFixed(2)}</span> <span style="color:#888">(${pctSign}${pnlPct}%)</span>`;
    eqTip.style.display = 'block';
    eqTip.style.left = Math.min(clientX + 14, window.innerWidth - 220) + 'px';
    eqTip.style.top  = Math.max(10, clientY - 56) + 'px';
  }
  // I-02: remove old listeners before re-adding (prevents accumulation every 60s render)
  if (svg._eqMove) {
    svg.removeEventListener('mousemove', svg._eqMove);
    svg.removeEventListener('touchstart', svg._eqTouchStart);
    svg.removeEventListener('touchmove', svg._eqTouchMove);
    svg.removeEventListener('touchend', svg._eqTouchEnd);
    svg.removeEventListener('mouseleave', svg._eqLeave);
  }
  svg._eqMove       = e => eqHandlePointer(e.clientX, e.clientY);
  svg._eqTouchStart = e => { e.preventDefault(); eqHandlePointer(e.touches[0].clientX, e.touches[0].clientY); };
  svg._eqTouchMove  = e => { e.preventDefault(); eqHandlePointer(e.touches[0].clientX, e.touches[0].clientY); };
  svg._eqTouchEnd   = () => { eqTip.style.display = 'none'; eqDot.style.display = 'none'; };
  svg._eqLeave      = () => { eqTip.style.display = 'none'; eqDot.style.display = 'none'; };
  svg.addEventListener('mousemove', svg._eqMove);
  svg.addEventListener('touchstart', svg._eqTouchStart, { passive: false });
  svg.addEventListener('touchmove',  svg._eqTouchMove,  { passive: false });
  svg.addEventListener('touchend',   svg._eqTouchEnd);
  svg.addEventListener('mouseleave', svg._eqLeave);
  svg.style.cursor = 'crosshair';
  svg.style.touchAction = 'none';
}

function renderRollingWrFull(chronoBets) {
  const svg = document.getElementById('rollingWrFullSvg');
  if (!svg) return;
  const WINDOW = 20;
  const closed = chronoBets.filter(d => d.correct !== null);
  if (closed.length < WINDOW) {
    svg.innerHTML = '<text x="10" y="55" fill="var(--muted)" font-size="10" font-family="JetBrains Mono,monospace">Need ' + WINDOW + '+ closed bets</text>';
    const t = document.getElementById('rollingWrFullTag'); if (t) { t.textContent = 'WAIT'; t.className = 'panel-tag tag-blue'; }
    return;
  }
  const W = 1000, H = 100;
  const toX = i => (i / Math.max(closed.length - 1, 1)) * W;
  const toY = pct => H - (pct / 100) * (H - 10) - 5;
  const wrVals = [], wrPts = [];
  closed.forEach((d, i) => {
    const slice = closed.slice(Math.max(0, i - WINDOW + 1), i + 1);
    const v = slice.filter(x => x.correct).length / slice.length * 100;
    wrVals.push(v);
    wrPts.push(`${toX(i).toFixed(1)},${toY(v).toFixed(1)}`);
  });
  const pts = wrPts.join(' ');
  const color = '#00d4ff';
  const line50Y = toY(50), line65Y = toY(65);
  const lastV = wrVals[wrVals.length - 1];
  const areaClose = `${toX(closed.length-1).toFixed(1)},${H} 0,${H}`;
  svg.innerHTML = `
    <defs><linearGradient id="wrFG" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${color}" stop-opacity="0.22"/>
      <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
    </linearGradient></defs>
    <line x1="0" y1="${line65Y.toFixed(1)}" x2="${W}" y2="${line65Y.toFixed(1)}" stroke="rgba(0,212,255,0.28)" stroke-width="0.8" stroke-dasharray="4,3"/>
    <text x="4" y="${(line65Y-3).toFixed(1)}" fill="rgba(0,212,255,0.4)" font-size="8" font-family="JetBrains Mono,monospace">65%</text>
    <line x1="0" y1="${line50Y.toFixed(1)}" x2="${W}" y2="${line50Y.toFixed(1)}" stroke="rgba(255,255,255,0.1)" stroke-width="0.8" stroke-dasharray="4,3"/>
    <text x="4" y="${(line50Y-3).toFixed(1)}" fill="rgba(255,255,255,0.18)" font-size="8" font-family="JetBrains Mono,monospace">50%</text>
    <polygon points="${pts} ${areaClose}" fill="url(#wrFG)"/>
    <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${toX(closed.length-1).toFixed(1)}" cy="${toY(lastV).toFixed(1)}" r="3.5" fill="${color}"/>`;
  const tagEl = document.getElementById('rollingWrFullTag');
  tagEl.textContent = lastV.toFixed(0) + '% WR-20';
  tagEl.className = 'panel-tag ' + (lastV >= 65 ? 'tag-green' : lastV >= 50 ? 'tag-blue' : 'tag-red');
  // Hover crosshair
  let wrFTip = document.getElementById('wrFTip');
  if (!wrFTip) { wrFTip = document.createElement('div'); wrFTip.id = 'wrFTip'; wrFTip.style.cssText = 'position:fixed;background:rgba(8,12,25,0.95);border:1px solid rgba(0,212,255,0.3);color:#eee;font-size:10px;font-family:JetBrains Mono,monospace;padding:5px 10px;border-radius:2px;pointer-events:none;display:none;z-index:9999;white-space:nowrap;'; document.body.appendChild(wrFTip); }
  let wrFDot = svg.querySelector('.wrf-hover-dot');
  if (!wrFDot) { wrFDot = document.createElementNS('http://www.w3.org/2000/svg','circle'); wrFDot.setAttribute('class','wrf-hover-dot'); wrFDot.setAttribute('r','5'); wrFDot.setAttribute('stroke','rgba(0,0,0,0.6)'); wrFDot.setAttribute('stroke-width','1.5'); wrFDot.style.display='none'; wrFDot.style.pointerEvents='none'; svg.appendChild(wrFDot); }
  function wrFHandle(cx,cy) {
    const rect=svg.getBoundingClientRect(); const pct=Math.max(0,Math.min(1,(cx-rect.left)/rect.width)); const idx=Math.round(pct*(closed.length-1)); const v=wrVals[idx]; if(v===undefined)return;
    const dotColor=v>=65?'#00ff88':v>=50?'#00d4ff':'#ff4466';
    wrFDot.setAttribute('cx',toX(idx).toFixed(1)); wrFDot.setAttribute('cy',toY(v).toFixed(1)); wrFDot.setAttribute('fill',dotColor); wrFDot.style.display='';
    wrFTip.innerHTML='Bet #'+(idx+1)+'&nbsp;|&nbsp;<span style="color:'+dotColor+'">WR-20: '+v.toFixed(1)+'%</span>';
    wrFTip.style.display='block'; wrFTip.style.left=Math.min(cx+14,window.innerWidth-200)+'px'; wrFTip.style.top=Math.max(10,cy-56)+'px';
  }
  // I-02: remove old listeners before re-adding
  if (svg._wrFMove) {
    svg.removeEventListener('mousemove', svg._wrFMove);
    svg.removeEventListener('touchstart', svg._wrFTouchStart);
    svg.removeEventListener('touchmove', svg._wrFTouchMove);
    svg.removeEventListener('touchend', svg._wrFTouchEnd);
    svg.removeEventListener('mouseleave', svg._wrFLeave);
  }
  svg._wrFMove       = e=>wrFHandle(e.clientX,e.clientY);
  svg._wrFTouchStart = e=>{e.preventDefault();wrFHandle(e.touches[0].clientX,e.touches[0].clientY);};
  svg._wrFTouchMove  = e=>{e.preventDefault();wrFHandle(e.touches[0].clientX,e.touches[0].clientY);};
  svg._wrFTouchEnd   = ()=>{wrFTip.style.display='none';wrFDot.style.display='none';};
  svg._wrFLeave      = ()=>{wrFTip.style.display='none';wrFDot.style.display='none';};
  svg.addEventListener('mousemove', svg._wrFMove);
  svg.addEventListener('touchstart', svg._wrFTouchStart, {passive:false});
  svg.addEventListener('touchmove',  svg._wrFTouchMove,  {passive:false});
  svg.addEventListener('touchend',   svg._wrFTouchEnd);
  svg.addEventListener('mouseleave', svg._wrFLeave);
  svg.style.cursor='crosshair'; svg.style.touchAction='none';
}

function renderConfFull(chronoBets) {
  const svg = document.getElementById('confFullSvg');
  if (!svg) return;
  if (!chronoBets.length) { svg.innerHTML = ''; return; }
  const W = 1000, H = 100;
  const minConf = 0.5, maxConf = 1.0;
  const toX = i => (i / Math.max(chronoBets.length - 1, 1)) * W;
  const toY = v => H - ((v - minConf) / (maxConf - minConf)) * (H - 10) - 5;
  const confVals = chronoBets.map(d => parseFloat(d.confidence || 0.5));
  const pts = confVals.map((v, i) => `${toX(i).toFixed(1)},${toY(v).toFixed(1)}`).join(' ');
  const color = '#f7931a';
  const avgConf = confVals.reduce((s, v) => s + v, 0) / confVals.length;
  const thresh65Y = toY(0.65);
  const areaClose = `${toX(chronoBets.length-1).toFixed(1)},${H} 0,${H}`;
  const lastX = toX(chronoBets.length-1).toFixed(1);
  const lastY = toY(confVals[confVals.length-1]).toFixed(1);
  svg.innerHTML = `
    <defs><linearGradient id="cfFG" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="${color}" stop-opacity="0.2"/>
      <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
    </linearGradient></defs>
    <line x1="0" y1="${thresh65Y.toFixed(1)}" x2="${W}" y2="${thresh65Y.toFixed(1)}" stroke="rgba(247,147,26,0.28)" stroke-width="0.8" stroke-dasharray="4,3"/>
    <text x="4" y="${(thresh65Y-3).toFixed(1)}" fill="rgba(247,147,26,0.4)" font-size="8" font-family="JetBrains Mono,monospace">65%</text>
    <polygon points="${pts} ${areaClose}" fill="url(#cfFG)"/>
    <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${lastX}" cy="${lastY}" r="3.5" fill="${color}"/>`;
  const tagEl = document.getElementById('confFullTag');
  tagEl.textContent = 'AVG ' + (avgConf * 100).toFixed(1) + '%';
  tagEl.className = 'panel-tag ' + (avgConf >= 0.70 ? 'tag-green' : 'tag-yellow');
  // Hover crosshair
  let cfTip = document.getElementById('cfTip');
  if (!cfTip) { cfTip = document.createElement('div'); cfTip.id = 'cfTip'; cfTip.style.cssText = 'position:fixed;background:rgba(8,12,25,0.95);border:1px solid rgba(247,147,26,0.3);color:#eee;font-size:10px;font-family:JetBrains Mono,monospace;padding:5px 10px;border-radius:2px;pointer-events:none;display:none;z-index:9999;white-space:nowrap;'; document.body.appendChild(cfTip); }
  let cfDot = svg.querySelector('.cf-hover-dot');
  if (!cfDot) { cfDot = document.createElementNS('http://www.w3.org/2000/svg','circle'); cfDot.setAttribute('class','cf-hover-dot'); cfDot.setAttribute('r','5'); cfDot.setAttribute('stroke','rgba(0,0,0,0.6)'); cfDot.setAttribute('stroke-width','1.5'); cfDot.style.display='none'; cfDot.style.pointerEvents='none'; svg.appendChild(cfDot); }
  function cfHandle(cx,cy) {
    const rect=svg.getBoundingClientRect(); const pct=Math.max(0,Math.min(1,(cx-rect.left)/rect.width)); const idx=Math.round(pct*(chronoBets.length-1)); const v=confVals[idx]; if(v===undefined)return;
    cfDot.setAttribute('cx',toX(idx).toFixed(1)); cfDot.setAttribute('cy',toY(v).toFixed(1)); cfDot.setAttribute('fill',color); cfDot.style.display='';
    cfTip.innerHTML='Bet #'+(idx+1)+'&nbsp;|&nbsp;<span style="color:'+color+'">Conf: '+(v*100).toFixed(1)+'%</span>';
    cfTip.style.display='block'; cfTip.style.left=Math.min(cx+14,window.innerWidth-200)+'px'; cfTip.style.top=Math.max(10,cy-56)+'px';
  }
  // I-02: remove old listeners before re-adding
  if (svg._cfMove) {
    svg.removeEventListener('mousemove', svg._cfMove);
    svg.removeEventListener('touchstart', svg._cfTouchStart);
    svg.removeEventListener('touchmove', svg._cfTouchMove);
    svg.removeEventListener('touchend', svg._cfTouchEnd);
    svg.removeEventListener('mouseleave', svg._cfLeave);
  }
  svg._cfMove       = e=>cfHandle(e.clientX,e.clientY);
  svg._cfTouchStart = e=>{e.preventDefault();cfHandle(e.touches[0].clientX,e.touches[0].clientY);};
  svg._cfTouchMove  = e=>{e.preventDefault();cfHandle(e.touches[0].clientX,e.touches[0].clientY);};
  svg._cfTouchEnd   = ()=>{cfTip.style.display='none';cfDot.style.display='none';};
  svg._cfLeave      = ()=>{cfTip.style.display='none';cfDot.style.display='none';};
  svg.addEventListener('mousemove', svg._cfMove);
  svg.addEventListener('touchstart', svg._cfTouchStart, {passive:false});
  svg.addEventListener('touchmove',  svg._cfTouchMove,  {passive:false});
  svg.addEventListener('touchend',   svg._cfTouchEnd);
  svg.addEventListener('mouseleave', svg._cfLeave);
  svg.style.cursor='crosshair'; svg.style.touchAction='none';
}

// ‚îÄ‚îÄ CHARTS GRID FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderConfidenceOverTime(chronoAll) {
  const svg = document.getElementById('confSvg');
  if (!chronoAll.length) { svg.innerHTML = ''; return; }
  const W = 600, H = 100;
  const minConf = 0.50, maxConf = 1.0;
  const toY = c => H - ((c - minConf) / (maxConf - minConf)) * (H - 10) - 5;
  const pts = chronoAll.map((d, i) => {
    const x = (i / Math.max(chronoAll.length - 1, 1)) * W;
    return `${x.toFixed(1)},${toY(parseFloat(d.confidence || 0.5)).toFixed(1)}`;
  }).join(' ');
  const threshY = toY(0.60);
  const avgConf = chronoAll.reduce((s, d) => s + parseFloat(d.confidence || 0.5), 0) / chronoAll.length;
  const lastX = ((chronoAll.length - 1) / Math.max(chronoAll.length - 1, 1)) * W;
  const lastY = toY(parseFloat(chronoAll[chronoAll.length - 1].confidence || 0.5));
  svg.innerHTML = `
    <defs>
      <linearGradient id="confG" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--blue)" stop-opacity="0.25"/>
        <stop offset="100%" stop-color="var(--blue)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pts} ${W},${H} 0,${H}" fill="url(#confG)"/>
    <line x1="0" y1="${threshY.toFixed(1)}" x2="${W}" y2="${threshY.toFixed(1)}" stroke="var(--muted)" stroke-width="0.8" stroke-dasharray="4,3"/>
    <text x="4" y="${(threshY - 3).toFixed(1)}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono,monospace">60%</text>
    <polyline points="${pts}" fill="none" stroke="var(--blue)" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${lastX.toFixed(1)}" cy="${lastY.toFixed(1)}" r="3" fill="var(--blue)"/>`;
  document.getElementById('confTag').textContent = 'AVG ' + (avgConf * 100).toFixed(1) + '%';
}

function renderRollingWinRate(chronoBets) {
  const svg = document.getElementById('wrSvg');
  const closed = chronoBets.filter(d => d.correct !== null);
  if (closed.length < 3) {
    svg.innerHTML = '<text x="10" y="55" fill="var(--muted)" font-size="10" font-family="JetBrains Mono,monospace">Not enough data (need 3+ bets)</text>';
    return;
  }
  const W = 600, H = 100;
  const toX = i => (i / Math.max(closed.length - 1, 1)) * W;
  const toY = pct => H - (pct / 100) * (H - 10) - 5;
  const wr10vals = [], wr20vals = [], wr10pts = [], wr20pts = [];
  closed.forEach((d, i) => {
    const s10 = closed.slice(Math.max(0, i - 9), i + 1);
    const s20 = closed.slice(Math.max(0, i - 19), i + 1);
    const v10 = s10.filter(x => x.correct).length / s10.length * 100;
    const v20 = s20.filter(x => x.correct).length / s20.length * 100;
    wr10vals.push(v10); wr20vals.push(v20);
    wr10pts.push(`${toX(i).toFixed(1)},${toY(v10).toFixed(1)}`);
    wr20pts.push(`${toX(i).toFixed(1)},${toY(v20).toFixed(1)}`);
  });
  const line50Y = toY(50);
  svg.innerHTML = `
    <line x1="0" y1="${line50Y.toFixed(1)}" x2="${W}" y2="${line50Y.toFixed(1)}" stroke="var(--muted)" stroke-width="0.8" stroke-dasharray="4,3"/>
    <text x="4" y="${(line50Y - 3).toFixed(1)}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono,monospace">50%</text>
    <polyline points="${wr20pts.join(' ')}" fill="none" stroke="var(--blue)" stroke-width="1.2" stroke-linejoin="round" opacity="0.6"/>
    <polyline points="${wr10pts.join(' ')}" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linejoin="round"/>
    <circle cx="${toX(closed.length-1).toFixed(1)}" cy="${wr10pts[wr10pts.length-1].split(',')[1]}" r="3" fill="var(--accent)"/>`;

  // Add hover dot to SVG
  const wrDot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  wrDot.setAttribute('r', '5');
  wrDot.setAttribute('stroke', 'rgba(0,0,0,0.6)');
  wrDot.setAttribute('stroke-width', '1.5');
  wrDot.style.display = 'none';
  wrDot.style.pointerEvents = 'none';
  svg.appendChild(wrDot);

  // Tooltip (reuse or create)
  let wrTip = document.getElementById('wrTip');
  if (!wrTip) {
    wrTip = document.createElement('div');
    wrTip.id = 'wrTip';
    wrTip.style.cssText = 'position:fixed;background:rgba(8,12,25,0.95);border:1px solid rgba(0,255,136,0.3);color:#eee;font-size:10px;font-family:JetBrains Mono,monospace;padding:5px 10px;border-radius:2px;pointer-events:none;display:none;z-index:9999;white-space:nowrap;';
    document.body.appendChild(wrTip);
  }
  function wrHandlePointer(clientX, clientY) {
    const rect = svg.getBoundingClientRect();
    const mx = clientX - rect.left;
    const pct = Math.max(0, Math.min(1, mx / rect.width));
    const idx = Math.round(pct * (closed.length - 1));
    const v10 = wr10vals[idx], v20 = wr20vals[idx];
    if (v10 === undefined) return;
    const x = toX(idx), y = toY(v10);
    const dotColor = v10 >= 50 ? 'var(--accent)' : 'var(--danger)';
    wrDot.setAttribute('cx', x.toFixed(1));
    wrDot.setAttribute('cy', y.toFixed(1));
    wrDot.setAttribute('fill', dotColor);
    wrDot.style.display = '';
    wrTip.innerHTML = `Bet #${idx+1} &nbsp;|&nbsp; WR10: <span style="color:${dotColor}">${v10.toFixed(1)}%</span> &nbsp; WR20: <span style="color:var(--blue)">${v20.toFixed(1)}%</span>`;
    wrTip.style.display = 'block';
    wrTip.style.left = Math.min(clientX + 14, window.innerWidth - 240) + 'px';
    wrTip.style.top  = Math.max(10, clientY - 56) + 'px';
  }
  // I-02: remove old listeners before re-adding
  if (svg._wrMove) {
    svg.removeEventListener('mousemove', svg._wrMove);
    svg.removeEventListener('touchstart', svg._wrTouchStart);
    svg.removeEventListener('touchmove', svg._wrTouchMove);
    svg.removeEventListener('touchend', svg._wrTouchEnd);
    svg.removeEventListener('mouseleave', svg._wrLeave);
  }
  svg._wrMove       = e => wrHandlePointer(e.clientX, e.clientY);
  svg._wrTouchStart = e => { e.preventDefault(); wrHandlePointer(e.touches[0].clientX, e.touches[0].clientY); };
  svg._wrTouchMove  = e => { e.preventDefault(); wrHandlePointer(e.touches[0].clientX, e.touches[0].clientY); };
  svg._wrTouchEnd   = () => { wrTip.style.display = 'none'; wrDot.style.display = 'none'; };
  svg._wrLeave      = () => { wrTip.style.display = 'none'; wrDot.style.display = 'none'; };
  svg.addEventListener('mousemove', svg._wrMove);
  svg.addEventListener('touchstart', svg._wrTouchStart, { passive: false });
  svg.addEventListener('touchmove',  svg._wrTouchMove,  { passive: false });
  svg.addEventListener('touchend',   svg._wrTouchEnd);
  svg.addEventListener('mouseleave', svg._wrLeave);
  svg.style.cursor = 'crosshair';
  svg.style.touchAction = 'none';
}

function renderPnlBarsLarge(chronoBets) {
  const container = document.getElementById('pnlBarsLarge');
  if (!chronoBets.length) {
    container.innerHTML = '<span style="color:var(--muted);font-size:10px">No data</span>';
    document.getElementById('pnlBarsTag').textContent = 'REAL BETS';
    return;
  }
  const maxAbs = Math.max(...chronoBets.map(d => Math.abs(parseFloat(d.pnl_usd || 0))), 0.0001);
  const maxH = 120;
  const n = chronoBets.length;
  const minW = n > 400 ? 1 : n > 150 ? 2 : 3;
  const maxW = n > 400 ? 3 : n > 150 ? 6 : 14;
  container.innerHTML = chronoBets.map(d => {
    const v = parseFloat(d.pnl_usd || 0);
    const h = Math.max(2, Math.abs(v) / maxAbs * maxH);
    const cls = v > 0 ? 'pos' : v < 0 ? 'neg' : 'zero';
    const label = (v >= 0 ? '+' : '') + '$' + v.toFixed(4);
    return `<div class="bar ${cls}" style="height:${h}px;flex:1;min-width:${minW}px;max-width:${maxW}px;" title="${label}"><div class="tooltip">${label}</div></div>`;
  }).join('');
  document.getElementById('pnlBarsTag').textContent = chronoBets.length + ' BETS';
}

function renderBtcPredictionsOverlay(chronoAll) {
  const svg = document.getElementById('btcOverlaySvg');
  const pts = chronoAll.filter(d => d.btc_price_entry && parseFloat(d.btc_price_entry) > 0);
  if (pts.length < 2) {
    svg.innerHTML = '<text x="10" y="55" fill="var(--muted)" font-size="10" font-family="JetBrains Mono,monospace">Not enough data</text>';
    return;
  }
  const W = 600, H = 100;
  const prices = pts.map(d => parseFloat(d.btc_price_entry));
  const minP = Math.min(...prices), maxP = Math.max(...prices);
  const range = maxP - minP || 1;
  const toX = i => (i / Math.max(pts.length - 1, 1)) * W;
  const toY = p => H - ((p - minP) / range) * (H - 14) - 7;
  const pricePts = pts.map((d, i) => `${toX(i).toFixed(1)},${toY(parseFloat(d.btc_price_entry)).toFixed(1)}`).join(' ');
  const markers = pts.map((d, i) => {
    if (d.classification !== 'BET') return '';
    const x = toX(i), y = toY(parseFloat(d.btc_price_entry));
    // I-08: open bets (correct===null) shown in amber; closed bets green/red as before
    const isOpen  = d.correct === null;
    const color   = isOpen ? 'var(--warn)' : (d.correct ? 'var(--accent)' : 'var(--danger)');
    const isUp    = d.direction === 'UP';
    const tri = isUp
      ? `${x.toFixed(1)},${(y-9).toFixed(1)} ${(x-4).toFixed(1)},${(y-1).toFixed(1)} ${(x+4).toFixed(1)},${(y-1).toFixed(1)}`
      : `${x.toFixed(1)},${(y+9).toFixed(1)} ${(x-4).toFixed(1)},${(y+1).toFixed(1)} ${(x+4).toFixed(1)},${(y+1).toFixed(1)}`;
    const pnlStr  = isOpen ? '‚Äî' : ((parseFloat(d.pnl_usd || 0) >= 0 ? '+' : '') + '$' + parseFloat(d.pnl_usd || 0).toFixed(2));
    const conf    = d.confidence ? (parseFloat(d.confidence) * 100).toFixed(0) + '%' : '‚Äî';
    const escDir  = escapeHtml(d.direction || '‚Äî');
    const outcome = isOpen ? '‚è≥ OPEN' : (d.correct ? '‚úì WIN' : '‚úó LOSS');
    const dataAttrs = `data-btc-x="${x.toFixed(1)}" data-btc-y="${y.toFixed(1)}" data-btc-color="${color}" data-btc-label="${escDir} ${conf} ¬∑ ${pnlStr} ¬∑ ${outcome}"`;
    const opacity = isOpen ? '1' : '0.9';
    return `<polygon points="${tri}" fill="${color}" opacity="${opacity}"/>
<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="10" fill="transparent" class="btc-hit" ${dataAttrs}/>`;
  }).join('');
  svg.innerHTML = `
    <defs>
      <linearGradient id="btcG" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--muted)" stop-opacity="0.15"/>
        <stop offset="100%" stop-color="var(--muted)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pricePts} ${W},${H} 0,${H}" fill="url(#btcG)"/>
    <polyline points="${pricePts}" fill="none" stroke="var(--muted)" stroke-width="1.2" stroke-linejoin="round" opacity="0.6"/>
    ${markers}`;

  // Tooltip (reuse or create)
  let btcTip = document.getElementById('btcTip');
  if (!btcTip) {
    btcTip = document.createElement('div');
    btcTip.id = 'btcTip';
    btcTip.style.cssText = 'position:fixed;background:rgba(8,12,25,0.95);border:1px solid rgba(0,255,136,0.3);color:#eee;font-size:10px;font-family:JetBrains Mono,monospace;padding:5px 10px;border-radius:2px;pointer-events:none;display:none;z-index:9999;white-space:nowrap;';
    document.body.appendChild(btcTip);
  }
  svg.querySelectorAll('.btc-hit').forEach(el => {
    function btcShowTip(clientX, clientY) {
      const label = el.getAttribute('data-btc-label');
      const col   = el.getAttribute('data-btc-color');
      btcTip.innerHTML = `<span style="color:${col}">${escapeHtml(label)}</span>`;
      btcTip.style.display = 'block';
      btcTip.style.left = Math.min(clientX + 14, window.innerWidth - 240) + 'px';
      btcTip.style.top  = Math.max(10, clientY - 56) + 'px';
    }
    el.addEventListener('mouseenter', e => btcShowTip(e.clientX, e.clientY));
    el.addEventListener('mousemove',  e => btcShowTip(e.clientX, e.clientY));
    el.addEventListener('mouseleave', () => { btcTip.style.display = 'none'; });
    el.addEventListener('touchstart', e => { e.preventDefault(); btcShowTip(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
    el.addEventListener('touchend',   () => setTimeout(() => { btcTip.style.display = 'none'; }, 1500));
  });
  svg.style.touchAction = 'none';
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let _dashboardFirstLoad = true;
async function refresh() {
  const _t0 = performance.now();
  try {
    allData = await fetchData();
    renderAll(allData);
    populateIntroHero(allData);
    _loader.tick(); // 1/3 ‚Äî signals loaded
    if (_dashboardFirstLoad) {
      _dashboardFirstLoad = false;
      trackEvent('dashboard_loaded', { load_ms: Math.round(performance.now() - _t0) });
    }
  }
  catch(e) { console.error('Render error:', e); }
}

document.getElementById('filterDir').addEventListener('change',   (e) => { trackEvent('signal_filter', { filter_type: 'direction', value: e.target.value }); if (typeof applySignalFilters === 'function') applySignalFilters(); else renderTable(filterByPeriod(allData)); });
document.getElementById('filterClass').addEventListener('change', (e) => { trackEvent('signal_filter', { filter_type: 'classification', value: e.target.value }); if (typeof applySignalFilters === 'function') applySignalFilters(); else renderTable(filterByPeriod(allData)); });

// ‚îÄ‚îÄ TOP LOADING BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _loader = {
  el: null, total: 3, done: 0,
  init() { this.el = document.getElementById('topLoader'); },
  tick() {
    if (!this.el) return;
    this.done++;
    const pct = Math.min(95, Math.round((this.done / this.total) * 100));
    this.el.classList.remove('indeterminate');
    this.el.style.width = pct + '%';
    if (this.done >= this.total) setTimeout(() => {
      this.el.style.width = '100%';
      this.el.classList.add('done');
    }, 200);
  }
};
document.addEventListener('DOMContentLoaded', () => _loader.init());

// ‚îÄ‚îÄ TRAINING BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const banner = document.getElementById('trainingBanner');
  if (!banner) return;
  if (localStorage.getItem('trainingBannerDismissed') === '1') {
    banner.classList.add('hidden');
  }
})();
function dismissTrainingBanner() {
  const banner = document.getElementById('trainingBanner');
  if (banner) banner.classList.add('hidden');
  try { localStorage.setItem('trainingBannerDismissed', '1'); } catch(e) {}
}

// ‚îÄ‚îÄ GA4 CUSTOM EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function trackEvent(name, params) {
  if (typeof gtag !== 'undefined' && localStorage.getItem('btcp_ga_consent') === 'granted') {
    gtag('event', name, params || {});
  }
}

// Scroll depth ‚Äî fires once at 25/50/75/90%
(function() {
  var thresholds = [25, 50, 75, 90], fired = {};
  window.addEventListener('scroll', function() {
    var pct = Math.round((window.scrollY + window.innerHeight) / document.body.scrollHeight * 100);
    thresholds.forEach(function(t) {
      if (!fired[t] && pct >= t) { fired[t] = true; trackEvent('scroll_depth', { depth_pct: t }); }
    });
  }, { passive: true });
})();

// ‚îÄ‚îÄ TAB SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function switchTab(btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const targetTab = btn.dataset.tab;
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  const tabEl = document.getElementById('tab-' + targetTab);
  if (tabEl) tabEl.classList.add('active');
  trackEvent('tab_view', { tab_name: targetTab });
  if (targetTab === 'agents')     refreshAgentsTab();
  if (targetTab === 'costs')      refreshCostsTab();
  if (targetTab === 'backtest')   fetchBacktestReport();
  if (targetTab === 'training')   fetchTrainingTab();
  if (targetTab === 'expectancy') fetchExpectancyTab();
}

// ‚îÄ‚îÄ EXPECTANCY TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchExpectancyTab() {
  try {
    // I-12: use allData if already in memory ‚Äî avoids redundant /signals fetch
    // on every Expectancy tab switch (allData loaded at startup by render()).
    // Fallback: fetch /signals if allData is empty (first load race condition).
    let signals = [];
    if (allData && allData.length > 0) {
      signals = allData;
    } else {
      try {
        const sigRes = await fetch(`${CONFIG.RAILWAY_URL}/signals?limit=${CONFIG.LIMIT}`,
          { signal: AbortSignal.timeout(12000), headers: {'X-API-Key': CONFIG.READ_KEY} });
        if (sigRes.ok) {
          const j = await sigRes.json();
          signals = (Array.isArray(j) ? j : (j.data || j.signals || []));
        }
      } catch(e) {}
    }

    const closedBets = signals.filter(s =>
      s.classification === 'BET' && s.bet_taken &&
      s.correct !== null && s.correct !== undefined
    );

    const wins   = closedBets.filter(s => s.correct === true);
    const losses = closedBets.filter(s => s.correct === false);
    const n      = closedBets.length;
    const wr     = n > 0 ? wins.length / n : 0;

    const grossWins   = wins.reduce((acc, s) => acc + parseFloat(s.pnl_usd || 0), 0);
    const grossLosses = Math.abs(losses.reduce((acc, s) => acc + parseFloat(s.pnl_usd || 0), 0));
    const avgWin  = wins.length   > 0 ? grossWins   / wins.length   : 0;
    const avgLoss = losses.length > 0 ? grossLosses / losses.length : 0;
    const expectancy = wr * avgWin - (1 - wr) * avgLoss;
    const pf = grossLosses > 0 ? grossWins / grossLosses : (grossWins > 0 ? 999 : 0);
    // Kelly: WR - (1-WR)/WL_ratio
    const wlRatio = avgLoss > 0 ? avgWin / avgLoss : 0;
    const kelly   = wlRatio > 0 ? (wr - (1 - wr) / wlRatio) * 100 : 0;

    // Last 20 bets expectancy ‚Äî closedBets is id.desc (newest first), slice(0,20) = most recent 20
    const last20 = closedBets.slice(0, 20);
    const l20w   = last20.filter(s => s.correct === true);
    const l20l   = last20.filter(s => s.correct === false);
    const l20n   = last20.length;
    const l20wr  = l20n > 0 ? l20w.length / l20n : 0;
    const l20aw  = l20w.length > 0 ? l20w.reduce((a, s) => a + parseFloat(s.pnl_usd || 0), 0) / l20w.length : 0;
    const l20al  = l20l.length > 0 ? Math.abs(l20l.reduce((a, s) => a + parseFloat(s.pnl_usd || 0), 0)) / l20l.length : 0;
    const l20exp = l20wr * l20aw - (1 - l20wr) * l20al;

    // Direction breakdown
    const upBets   = closedBets.filter(s => s.direction === 'UP');
    const downBets = closedBets.filter(s => s.direction === 'DOWN');
    const upWins   = upBets.filter(s => s.correct === true).length;
    const downWins = downBets.filter(s => s.correct === true).length;
    const upWr     = upBets.length   > 0 ? upWins   / upBets.length   : 0;
    const downWr   = downBets.length > 0 ? downWins / downBets.length : 0;
    const upPnl    = upBets.reduce((a, s) => a + parseFloat(s.pnl_usd || 0), 0);
    const downPnl  = downBets.reduce((a, s) => a + parseFloat(s.pnl_usd || 0), 0);

    // Render KPI row
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    const setHtml = (id, val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; };
    const fmtE = v => (v >= 0 ? '+' : '') + '$' + Math.abs(v).toFixed(3);

    set('exp-expectancy',   fmtE(expectancy));
    const expEl = document.getElementById('exp-expectancy');
    if (expEl) expEl.className = 'kpi-value ' + (expectancy >= 0 ? 'green' : 'red');

    set('exp-profitFactor', pf >= 999 ? '‚àû' : pf.toFixed(2));
    set('exp-kelly',        (kelly > 0 ? kelly.toFixed(1) : '0.0') + '%');
    set('exp-winRate',      (wr * 100).toFixed(1) + '%');
    set('exp-winRateSub',   n + ' closed bets');

    // Verdict badge
    const badge = document.getElementById('exp-verdictBadge');
    if (badge) {
      if (expectancy > 0.05)       { badge.className = 'panel-tag tag-green'; badge.textContent = 'POSITIVE EV'; }
      else if (expectancy >= -0.01){ badge.className = 'panel-tag tag-yellow'; badge.textContent = 'BREAK EVEN'; }
      else                         { badge.className = 'panel-tag tag-red';    badge.textContent = 'NEGATIVE EV'; }
    }

    // Breakdown
    set('exp-avgWin',     '$' + avgWin.toFixed(3));
    set('exp-avgLoss',    '$' + avgLoss.toFixed(3));
    set('exp-wlRatio',    wlRatio > 0 ? wlRatio.toFixed(2) + 'x' : '‚Äî');
    set('exp-totalBets',  n);
    set('exp-grossWins',  '$' + grossWins.toFixed(2));
    set('exp-grossLosses','$' + grossLosses.toFixed(2));

    // Direction
    set('exp-upWr',    (upWr * 100).toFixed(1) + '%');
    set('exp-upPnl',   (upPnl >= 0 ? '+' : '') + '$' + upPnl.toFixed(2));
    set('exp-upCount', upBets.length + ' bets');
    const upWrBadge = document.getElementById('exp-upWrBadge');
    if (upWrBadge) upWrBadge.textContent = (upWr * 100).toFixed(1) + '%';

    set('exp-downWr',    (downWr * 100).toFixed(1) + '%');
    set('exp-downPnl',   (downPnl >= 0 ? '+' : '') + '$' + downPnl.toFixed(2));
    set('exp-downCount', downBets.length + ' bets');
    const downWrBadge = document.getElementById('exp-downWrBadge');
    if (downWrBadge) downWrBadge.textContent = (downWr * 100).toFixed(1) + '%';

    // L20
    set('exp-l20', fmtE(l20exp));
    const l20El = document.getElementById('exp-l20');
    if (l20El) l20El.style.color = l20exp >= 0 ? 'var(--accent)' : 'var(--danger)';
    const l20Badge = document.getElementById('exp-l20Badge');
    if (l20Badge) {
      l20Badge.textContent = 'LAST 20: ' + fmtE(l20exp);
      l20Badge.className = 'panel-tag ' + (l20exp >= 0 ? 'tag-green' : 'tag-red');
    }

  } catch(e) {
    console.warn('fetchExpectancyTab error:', e);
  }
}

// ‚îÄ‚îÄ AGENTS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ launchd tasks config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LAUNCHD_TASKS = [
  { icon:'üíì', name:'Health Monitor',  label:'com.btcbot.health',       schedule:'every_1h',   log:'/tmp/btcbot_health.log' },
  { icon:'üìä', name:'Daily Report',    label:'com.btcbot.daily',         schedule:'daily_0700', log:'/tmp/btcbot_daily.log' },
  { icon:'üìà', name:'Weekly Analysis', label:'com.btcbot.weekly',        schedule:'sun_0800',   log:'/tmp/btcbot_weekly.log' },
  { icon:'üëÅ', name:'Bet Monitor',     label:'com.btcbot.monitor_bets',  schedule:'every_5m',   log:'/tmp/btcbot_monitor.log' },
  { icon:'ü§ñ', name:'XGB Retrain',     label:'com.btcbot.xgb_retrain',   schedule:'sun_0300',   log:'/tmp/btcbot_xgb_retrain.log' },
  { icon:'üíæ', name:'n8n Backup',      label:'com.btcbot.n8n_backup',    schedule:'sun_0930',   log:'/tmp/btcbot_n8n_backup.log' },
];

function _launchdScheduleLabel(s) {
  return { every_5m:'Every 5min', every_1h:'Every 1h', daily_0700:'Daily 07:00 UTC+1', sun_0800:'Sun 08:00 UTC+1', sun_0300:'Sun 03:00 UTC+1', sun_0930:'Sun 09:30 UTC+1' }[s] || s;
}

function _launchdNextRun(schedule) {
  const now = new Date();
  let next  = new Date(now);
  if (schedule === 'every_5m') {
    const ms = (5 - (now.getMinutes() % 5)) * 60000 - now.getSeconds() * 1000 - now.getMilliseconds();
    next = new Date(now.getTime() + ms);
  } else if (schedule === 'every_1h') {
    next.setMinutes(0, 0, 0);
    next = new Date(next.getTime() + 3600000);
  } else if (schedule === 'daily_0700') {
    next.setHours(7, 0, 0, 0);
    if (next <= now) next.setDate(next.getDate() + 1);
  } else if (schedule === 'sun_0800') {
    // I-09: same pattern as daily_0700 ‚Äî set target time, add 7d if already passed
    next.setDate(next.getDate() + (7 - now.getDay()) % 7); next.setHours(8, 0, 0, 0);
    if (next <= now) next.setDate(next.getDate() + 7);
  } else if (schedule === 'sun_0300') {
    next.setDate(next.getDate() + (7 - now.getDay()) % 7); next.setHours(3, 0, 0, 0);
    if (next <= now) next.setDate(next.getDate() + 7);
  } else if (schedule === 'sun_0930') {
    next.setDate(next.getDate() + (7 - now.getDay()) % 7); next.setHours(9, 30, 0, 0);
    if (next <= now) next.setDate(next.getDate() + 7);
  }
  const diff = next - now;
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  const s = Math.floor((diff % 60000) / 1000);
  if (h > 47) return 'in ' + Math.ceil(h / 24) + 'd';
  if (h > 0)  return 'in ' + h + 'h ' + m + 'm';
  if (m > 0)  return 'in ' + m + 'm ' + s + 's';
  return 'in ' + s + 's';
}

function renderLaunchdTasks() {
  const tbody = document.getElementById('launchdBody');
  if (!tbody) return;
  tbody.innerHTML = LAUNCHD_TASKS.map(t => `
    <tr>
      <td><span style="margin-right:6px">${t.icon}</span>${t.name}</td>
      <td><code style="font-size:9px;color:var(--blue)">${t.label}</code></td>
      <td style="color:var(--muted);font-size:10px">${_launchdScheduleLabel(t.schedule)}</td>
      <td style="font-family:monospace;font-size:10px;color:var(--accent)" class="launchd-next" data-schedule="${t.schedule}">${_launchdNextRun(t.schedule)}</td>
      <td style="color:var(--muted);font-size:10px">${t.log}</td>
      <td><span class="badge badge-correct">ACTIVE</span></td>
    </tr>`).join('');
}

// Live countdown + clock for launchd
setInterval(() => {
  document.querySelectorAll('.launchd-next').forEach(el => {
    el.textContent = _launchdNextRun(el.dataset.schedule);
  });
  const clk = document.getElementById('launchdClock');
  if (clk) clk.textContent = new Date().toLocaleTimeString('it-IT');
}, 1000);

function filterAgentsByStatus(status) {
  document.querySelectorAll('.agent-filter-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.filter === status));
  document.querySelectorAll('#n8nWorkflowsGrid .wf-card').forEach(card => {
    const active = card.dataset.active === 'true';
    const st     = card.dataset.status || 'none';
    const isErr  = st === 'error' || st === 'crashed';
    const show   = status === 'all'
                || (status === 'active'   && active)
                || (status === 'inactive' && !active)
                || (status === 'error'    && isErr);
    card.style.display = show ? '' : 'none';
  });
}

async function refreshAgentsTab() {
  const grid = document.getElementById('n8nWorkflowsGrid');
  grid.innerHTML = '<div style="grid-column:1/-1;padding:20px;color:var(--muted);font-size:11px;letter-spacing:1px">Loading n8n workflows<span class="loading">...</span></div>';
  renderLaunchdTasks();
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/n8n-status', { signal: AbortSignal.timeout(15000) });
    const data = res.ok ? await res.json() : null;
    renderAgents(data);
  } catch(e) {
    renderAgents(null, e.message);
  }
}

function _agentRelTime(iso) {
  if (!iso) return '‚Äî';
  const diff = Date.now() - new Date(iso).getTime();
  const s = Math.floor(diff / 1000);
  if (s < 60)  return s + 's ago';
  const m = Math.floor(s / 60);
  if (m < 60)  return m + 'm ago';
  const h = Math.floor(m / 60);
  if (h < 24)  return h + 'h ago';
  return Math.floor(h / 24) + 'd ago';
}

// Agent personality map ‚Äî keyed on 2-digit workflow prefix
const _WF_META = {
  '00':  { code: 'ERR', role: 'Error Notifier',        accent: '#ff4444', name: '00_Error_Notifier',              emoji: 'üö®', desc: 'Error notifications via Telegram',    trigger: 'On workflow error' },
  '01':  { code: 'SIG', role: 'Signal Generator',      accent: '#00ff88' },
  '02':  { code: 'TRD', role: 'Position Monitor',      accent: '#00aaff' },
  '03':  { code: 'BAL', role: 'Balance Guardian',      accent: '#ffaa00' },
  '04':  { code: 'LLM', role: 'LLM Analyst',           accent: '#aa66ff' },
  '05':  { code: 'VRF', role: 'Result Auditor',        accent: '#00ff88' },
  '06':  { code: 'MNT', role: 'System Janitor',        accent: '#4a6070' },
  '07':  { code: 'CMD', role: 'Command Center',        accent: '#00ccff' },
  '08':  { code: 'MON', role: 'Position Watchdog',     accent: '#ffaa00' },
  '09':  { code: 'SOC', role: 'Social Media',          accent: '#ff6fd8' },
  '09A': { code: 'SOC', role: 'Social Media Manager',  accent: '#ff6fd8', name: '09A_BTC_Social_Media_Manager',    emoji: 'üì±', desc: 'AI Social Media Manager',             trigger: 'Triggered by wf02' },
  '09B': { code: 'PUB', role: 'Social Publisher',      accent: '#ff6fd8', name: '09B_BTC_Social_Publisher',        emoji: 'üì§', desc: 'Social post publisher helper',        trigger: 'Called by 09A' },
  '10':  { code: 'ANA', role: 'Analytics & Reports',   accent: '#4a9fff' },
  '11':  { code: 'CNT', role: 'Channel Content',        accent: '#ff9f4a' },
  '12':  { code: 'EML', role: 'Email Handler',           accent: '#4affea' },
};

function renderAgents(data, errorMsg) {
  const grid = document.getElementById('n8nWorkflowsGrid');
  if (!data || data.status !== 'ok') {
    const errDetail = errorMsg || (data && data.error) || 'Railway non raggiungibile';
    const hint = (data && data.error && data.error.includes('N8N_API_KEY'))
      ? '<br><span style="font-size:10px;color:var(--muted)">Configura <code style="color:var(--blue)">N8N_API_KEY</code> su Railway per abilitare questo pannello</span>'
      : '';
    grid.innerHTML = `<div style="grid-column:1/-1;padding:24px 16px;color:var(--danger);font-size:11px;letter-spacing:1px">‚ö†Ô∏è n8n status non disponibile: ${escapeHtml(errDetail)}${hint}</div>`;
    return;
  }
  const wfs = data.workflows || [];
  if (!wfs.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;padding:24px;color:var(--muted);font-size:11px">No workflows found</div>';
    return;
  }
  grid.innerHTML = wfs.map(wf => {
    const isActive     = wf.active;
    const lastEx       = wf.last_execution;
    const status       = lastEx?.status || null;
    const execHistory  = wf.exec_history || [];
    const successRate  = wf.success_rate;

    // Agent personality ‚Äî try 3-char prefix (e.g. '09A') before falling back to 2-char ('09')
    const name3  = (wf.name || '').substring(0, 3);
    const name2  = (wf.name || '').substring(0, 2);
    const meta   = _WF_META[name3] || _WF_META[name2] || { code: 'BOT', role: 'Automation Agent', accent: '#4a6070' };

    // Health color ‚Äî use var(--accent) for success (var(--green) doesn't exist)
    let borderCol, dotCol, dotGlow;
    if (!isActive) {
      borderCol = '#2a2a2a'; dotCol = '#444'; dotGlow = '';
    } else if (status === 'success') {
      borderCol = meta.accent; dotCol = meta.accent; dotGlow = `0 0 6px ${meta.accent}88`;
    } else if (status === 'crashed' || status === 'error') {
      borderCol = 'var(--danger)'; dotCol = 'var(--danger)'; dotGlow = '0 0 6px var(--danger)';
    } else {
      borderCol = 'var(--warn)'; dotCol = 'var(--warn)'; dotGlow = '0 0 4px var(--warn)';
    }

    // Status badge
    let statusBadge = '<span style="font-size:9px;color:var(--muted)">‚Äî</span>';
    if (status === 'success')
      statusBadge = `<span class="panel-tag tag-green" style="font-size:8px;padding:2px 6px">‚úì SUCCESS</span>`;
    else if (status === 'crashed')
      statusBadge = `<span class="panel-tag tag-red" style="font-size:8px;padding:2px 6px">‚ö° CRASHED</span>`;
    else if (status === 'error')
      statusBadge = `<span class="panel-tag tag-red" style="font-size:8px;padding:2px 6px">‚úó ERROR</span>`;
    else if (status)
      statusBadge = `<span class="panel-tag tag-yellow" style="font-size:8px;padding:2px 6px">${status.toUpperCase()}</span>`;

    // Sparkline ‚Äî last 5 executions as colored squares (fixed: use #00ff88 not var(--green))
    let sparkline = '';
    if (execHistory.length) {
      const dots = execHistory.map(s => {
        const col = s === 'success' ? '#00ff88' : (s === 'crashed' || s === 'error') ? 'var(--danger)' : '#2a3a4a';
        return `<span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${col};box-shadow:${s==='success'?'0 0 4px rgba(0,255,136,0.4)':'none'}" title="${s}"></span>`;
      }).join('');
      const srLabel = successRate != null
        ? `<span style="font-size:9px;color:${successRate>=80?'#00ff88':successRate>=50?'var(--warn)':'var(--danger)'};">${successRate}%</span>`
        : '';
      sparkline = `<div style="display:flex;gap:3px;align-items:center;margin-top:8px">${dots}${srLabel ? '<span style="margin-left:5px">'+srLabel+'</span>' : ''}</div>`;
    }

    const relT = lastEx?.started_at ? _agentRelTime(lastEx.started_at) : 'No executions';
    const absT = lastEx?.started_at ? new Date(lastEx.started_at).toLocaleString('it-IT') : '';

    return `
    <div class="wf-card" data-active="${isActive}" data-status="${status || 'none'}" style="border-left:3px solid ${borderCol};padding-left:12px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <div style="display:flex;align-items:center;gap:7px;min-width:0">
          <span style="width:7px;height:7px;border-radius:50%;background:${dotCol};box-shadow:${dotGlow};flex-shrink:0"></span>
          <div class="wf-card-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(wf.name || '‚Äî')}</div>
        </div>
        <span class="panel-tag ${isActive ? 'tag-green' : 'tag-muted'}" style="flex-shrink:0;font-size:8px">${isActive ? 'ACTIVE' : 'INACTIVE'}</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:5px">
        <span style="font-size:6px;font-weight:800;letter-spacing:1px;color:${meta.accent};background:${meta.accent}18;border:1px solid ${meta.accent}35;padding:2px 5px;border-radius:2px">${meta.code}</span>
        <span style="font-size:8px;color:var(--muted);letter-spacing:0.5px">${meta.role}</span>
      </div>
      <div class="wf-card-id" style="margin-top:4px">${wf.id}</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        ${statusBadge}
        <span style="font-size:10px;color:var(--muted);cursor:default" title="${absT}">${relT}</span>
      </div>
      ${sparkline}
    </div>`;
  }).join('');
}


// ‚îÄ‚îÄ Backtest report syntax highlighting ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// escapeHtml() is defined near the top of this script block (superset of the old 3-char version)

function syntaxHighlight(text) {
  return text.split('\n').map(line => {
    // Decorator lines (ASCII box-drawing) ‚Äî visible dim border
    if (/[‚ïê‚îÄ‚ïî‚ïö‚ïó‚ïù‚ïë‚ï†‚ï£‚ï¶‚ï©‚ï¨]/.test(line)) {
      return `<span style="color:#2a3f55">${line}</span>`;
    }
    // Trophy / star / "Miglior" lines ‚Äî gold bold
    if (/[üèÜ‚òÖ]|Miglior/.test(line)) {
      return `<span style="color:#ffbb00;font-weight:700">${line}</span>`;
    }
    // Section headers like [1/5] [2/5] etc.
    if (/\[\d+\/\d+\]/.test(line)) {
      return `<span style="color:#00aaff">${line}</span>`;
    }
    // Win / positive lines
    if (/\+|\bWIN\b|‚ñ≤|%\]/.test(line)) {
      return `<span style="color:#00ff88">${line}</span>`;
    }
    // Loss / error / negative lines
    if (/-\$|\bLOSS\b|\bERROR\b|‚ö†/.test(line)) {
      return `<span style="color:#ff4466">${line}</span>`;
    }
    // Lines containing percentage numbers ‚Äî yellow
    if (/\d+(\.\d+)?%/.test(line)) {
      return `<span style="color:#ffaa00">${line}</span>`;
    }
    return line;
  }).join('\n');
}

async function fetchBacktestReport() {
  // ‚îÄ‚îÄ Text reports (raw) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const preBT   = document.getElementById('backtestReportPre');
  const badgeBT = document.getElementById('backtestBadge');
  const preXGB  = document.getElementById('xgbReportPre');
  const badgeXGB = document.getElementById('xgbBadge');

  Promise.all([
    fetch(CONFIG.RAILWAY_URL + '/backtest-report', { signal: AbortSignal.timeout(8000) }).then(r => r.ok ? r.json() : null).catch(() => null),
    fetch(CONFIG.RAILWAY_URL + '/xgb-report',      { signal: AbortSignal.timeout(8000) }).then(r => r.ok ? r.json() : null).catch(() => null),
    fetch(CONFIG.RAILWAY_URL + '/backtest-data',   { signal: AbortSignal.timeout(8000) }).then(r => r.ok ? r.json() : null).catch(() => null),
  ]).then(([btTxt, xgbTxt, btData]) => {
    if (preBT)  { if (btTxt)  { preBT.innerHTML = syntaxHighlight(escapeHtml(btTxt.report || 'Vuoto.')); if (badgeBT) badgeBT.textContent = btTxt.lines + ' righe'; } else preBT.textContent = 'Report non disponibile.'; }
    if (preXGB) { if (xgbTxt) { preXGB.innerHTML = syntaxHighlight(escapeHtml(xgbTxt.report || 'Vuoto.')); if (badgeXGB) badgeXGB.textContent = xgbTxt.lines + ' righe'; } else preXGB.textContent = 'Report non disponibile.'; }

    if (btData) renderBacktestDashboard(btData);
    // Update "last backtest" timestamp from report
    const statusEl = document.getElementById('backtestStatus');
    if (statusEl) {
      if (btTxt && btTxt.ok) {
        statusEl.textContent = 'Dati disponibili (' + (btTxt.lines || '?') + ' righe). Premi per rieseguire.';
      } else {
        statusEl.textContent = 'Nessun backtest eseguito. Premi il pulsante per avviarne uno.';
      }
    }
  });
}

let _backtestCooldownTimer = null;

async function triggerBacktest() {
  const btn      = document.getElementById('btnRunBacktest');
  const statusEl = document.getElementById('backtestStatus');
  if (!btn || !statusEl || btn.disabled) return;

  btn.disabled = true;
  btn.style.opacity = '0.5';
  btn.style.cursor  = 'not-allowed';
  statusEl.textContent = 'Avvio backtest...';

  try {
    const resp = await fetch(CONFIG.RAILWAY_URL + '/run-backtest', {
      method: 'POST',
      signal: AbortSignal.timeout(15000),
    });
    const data = await resp.json();

    if (resp.status === 429) {
      const remaining = data.cooldown_remaining || 3600;
      _startBacktestCooldown(remaining, statusEl, btn);
      return;
    }

    if (data.ok) {
      statusEl.textContent = data.message || 'Backtest avviato. I dati si aggiorneranno a breve.';
      _startBacktestCooldown(3600, statusEl, btn);
      // Auto-reload results after 60s
      setTimeout(() => { fetchBacktestReport(); }, 65000);
    } else {
      statusEl.textContent = 'Errore: ' + (data.message || 'unknown');
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor  = 'pointer';
    }
  } catch (e) {
    statusEl.textContent = 'Errore di rete: ' + e.message;
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.style.cursor  = 'pointer';
  }
}

function _startBacktestCooldown(seconds, statusEl, btn) {
  if (_backtestCooldownTimer) clearInterval(_backtestCooldownTimer);
  let remaining = seconds;
  btn.disabled = true;
  btn.style.opacity = '0.4';
  btn.style.cursor  = 'not-allowed';

  _backtestCooldownTimer = setInterval(() => {
    remaining--;
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    if (statusEl) statusEl.textContent = 'Cooldown: ' + m + 'm ' + s + 's ‚Äî riprova pi√π tardi.';
    if (remaining <= 0) {
      clearInterval(_backtestCooldownTimer);
      _backtestCooldownTimer = null;
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor  = 'pointer';
      if (statusEl) statusEl.textContent = 'Pronto. Premi per rieseguire il backtest.';
    }
  }, 1000);
}

// ‚îÄ‚îÄ Backtest dashboard rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const BT_COLORS = {
  A_BASELINE:  '#555',
  B_CONF_062:  '#4a90d9',
  C_CONF_065:  '#7ec8a4',
  D_DEAD_HOURS:'#e6b86a',
  E_XGB_GATE:  '#c97cd9',
  F_FULL_STACK:'#e06b6b',
};

function renderBacktestDashboard(d) {
  const strats = d.strategies || {};
  const best   = d.best_strategy;
  const curr   = 'F_FULL_STACK';
  const bestR  = strats[best]  || {};
  const currR  = strats[curr]  || {};

  // ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const pnlCol = v => v >= 0 ? 'var(--accent)' : 'var(--danger)';
  const fmtPnl = v => (v >= 0 ? '+' : '') + '$' + Number(v).toFixed(4);

  _bt('btKpiBest',    best?.replace(/^[A-Z]_/, '') || '‚Äî');
  _bt('btKpiBestPnl', fmtPnl(bestR.pnl || 0), pnlCol(bestR.pnl || 0));
  _bt('btKpiCurrent', currR.wr != null ? currR.wr + '% WR' : '‚Äî');
  _bt('btKpiCurrentPnl', fmtPnl(currR.pnl || 0), pnlCol(currR.pnl || 0));
  _bt('btKpiWR',      d.test_wr != null ? d.test_wr + '%' : '‚Äî');
  _bt('btKpiWRSub',   `${d.test_n} bet test`);
  _bt('btKpiPF',      bestR.profit_factor != null ? bestR.profit_factor.toFixed(2) : '‚Äî');
  _bt('btKpiXgb',     d.xgb_cv_acc ? (d.xgb_cv_acc * 100).toFixed(1) + '%' : '‚Äî');
  _bt('btKpiXgbSub',  `${d.train_n} bet train`);
  const sk = d.streaks || {};
  _bt('btKpiStreak',  sk.max_win_streak != null ? `√ó${sk.max_win_streak}W` : '‚Äî');
  _bt('btKpiStreakSub', sk.max_loss_streak != null ? `max ${sk.max_loss_streak}L consec.` : 'W / L');

  // ‚îÄ‚îÄ Strategy table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const tbody = document.getElementById('btStratBody');
  if (tbody) {
    tbody.innerHTML = Object.entries(strats).map(([name, r]) => {
      const isCurr = name === curr;
      const isBest = name === best;
      const bg = isCurr ? 'background:rgba(224,107,107,0.07)' : (isBest ? 'background:rgba(126,200,164,0.07)' : '');
      const pnlC = pnlCol(r.pnl);
      const badge = isCurr ? '<span class="badge badge-wrong" style="font-size:8px;margin-left:4px">LIVE</span>'
                            : (isBest ? '<span class="badge badge-correct" style="font-size:8px;margin-left:4px">BEST</span>' : '');
      const dot = `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${BT_COLORS[name]||'#555'};margin-right:6px"></span>`;
      return `<tr style="${bg}">
        <td style="padding:6px 8px;font-size:11px">${dot}${name.replace(/^[A-Z]_/,'')}${badge}</td>
        <td style="text-align:right;padding:6px 8px">${r.n}</td>
        <td style="text-align:right;padding:6px 8px">${r.wr}%</td>
        <td style="text-align:right;padding:6px 8px;color:${pnlC}">${fmtPnl(r.pnl)}</td>
        <td style="text-align:right;padding:6px 8px;color:${pnlCol(r.pnl_per_bet)}">${fmtPnl(r.pnl_per_bet)}</td>
        <td style="text-align:right;padding:6px 8px;color:var(--danger)">-$${r.max_dd?.toFixed(4)||'‚Äî'}</td>
        <td style="text-align:right;padding:6px 8px;color:${r.profit_factor>=1.5?'var(--accent)':r.profit_factor<1?'var(--danger)':'inherit'}">${r.profit_factor?.toFixed(2)||'‚Äî'}</td>
        <td style="text-align:right;padding:6px 8px">${r.sortino?.toFixed(2)||'‚Äî'}</td>
        <td style="text-align:right;padding:6px 8px">${r.sharpe?.toFixed(2)||'‚Äî'}</td>
      </tr>`;
    }).join('');
  }

  // ‚îÄ‚îÄ Equity curves SVG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const curves   = d.equity_curves || {};
  const allVals  = Object.values(curves).flat();
  if (allVals.length) {
    const minV = Math.min(0, ...allVals);
    const maxV = Math.max(0, ...allVals);
    const range = maxV - minV || 1;
    const svg = document.getElementById('btEquitySvg');
    const legend = document.getElementById('btEquityLegend');
    if (svg) {
      const W = svg.parentElement?.clientWidth || 600;
      const H = 200;
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      let svgHtml = '';

      // zero line
      const zy = H - ((0 - minV) / range * (H - 20)) - 10;
      svgHtml += `<line x1="0" y1="${zy.toFixed(1)}" x2="${W}" y2="${zy.toFixed(1)}" stroke="#333" stroke-width="1" stroke-dasharray="3,3"/>`;

      Object.entries(curves).forEach(([name, pts]) => {
        if (!pts || pts.length < 2) return;
        const col = BT_COLORS[name] || '#555';
        const n   = pts.length - 1;
        const coords = pts.map((v, i) => {
          const x = (i / n * (W - 20) + 10).toFixed(1);
          const y = (H - ((v - minV) / range * (H - 20)) - 10).toFixed(1);
          return `${x},${y}`;
        });
        const isCurr = name === curr;
        const isBest = name === best;
        const sw = isCurr || isBest ? '2' : '1';
        const op = isCurr || isBest ? '1' : '0.4';
        svgHtml += `<polyline points="${coords.join(' ')}" fill="none" stroke="${col}" stroke-width="${sw}" opacity="${op}" stroke-linejoin="round"/>`;
        // end dot
        const lastX = (W - 10).toFixed(1);
        const lastY = (H - ((pts[pts.length-1] - minV) / range * (H-20)) - 10).toFixed(1);
        svgHtml += `<circle cx="${lastX}" cy="${lastY}" r="3" fill="${col}" opacity="${op}"/>`;
      });

      // Y axis labels
      [minV, 0, maxV].forEach(v => {
        const y = (H - ((v - minV) / range * (H - 20)) - 10).toFixed(1);
        svgHtml += `<text x="4" y="${(parseFloat(y)+3).toFixed(1)}" fill="#555" font-size="9">${v >= 0 ? '+' : ''}$${v.toFixed(2)}</text>`;
      });

      svg.innerHTML = svgHtml;

      // ‚îÄ‚îÄ Hover tooltip for backtest equity curves ‚îÄ‚îÄ
      let btEqTip = document.getElementById('btEqTip');
      if (!btEqTip) {
        btEqTip = document.createElement('div');
        btEqTip.id = 'btEqTip';
        btEqTip.style.cssText = 'position:fixed;background:rgba(6,10,16,0.97);border:1px solid rgba(0,255,136,0.25);color:#eee;font-size:10px;font-family:JetBrains Mono,monospace;padding:7px 12px;border-radius:3px;pointer-events:none;display:none;z-index:9998;white-space:nowrap;min-width:140px;box-shadow:0 4px 20px rgba(0,0,0,0.5);';
        document.body.appendChild(btEqTip);
      }
      let btEqLine = svg.querySelector('.bt-eq-crosshair');
      if (!btEqLine) {
        btEqLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        btEqLine.setAttribute('class', 'bt-eq-crosshair');
        btEqLine.setAttribute('stroke', 'rgba(255,255,255,0.2)');
        btEqLine.setAttribute('stroke-width', '1');
        btEqLine.setAttribute('stroke-dasharray', '3,3');
        btEqLine.setAttribute('y1', '0');
        btEqLine.setAttribute('y2', String(H));
        btEqLine.style.display = 'none';
        btEqLine.style.pointerEvents = 'none';
        svg.appendChild(btEqLine);
      }
      function btEqHandlePointer(clientX, clientY) {
        const rect = svg.getBoundingClientRect();
        const mx   = clientX - rect.left;
        const pct  = Math.max(0, Math.min(1, mx / rect.width));
        // Compute per-strategy values at this X position
        let rows = '';
        Object.entries(curves).forEach(([name, pts]) => {
          if (!pts || pts.length < 2) return;
          const n    = pts.length - 1;
          const idx  = Math.round(pct * n);
          const val  = pts[idx];
          const col  = BT_COLORS[name] || '#888';
          const sign = val >= 0 ? '+' : '';
          const isCurr = name === curr;
          const fw = isCurr ? '700' : '400';
          rows += `<div style="display:flex;justify-content:space-between;gap:16px;font-weight:${fw}">` +
            `<span style="color:${col}">${name.replace(/^[A-Z]_/,'')}</span>` +
            `<span style="color:${val >= 0 ? '#00ff88' : '#ff4466'}">${sign}$${val.toFixed(2)}</span>` +
            `</div>`;
        });
        const betIdx = Math.round(pct * (Math.max(...Object.values(curves).map(p => p?.length || 0)) - 1));
        btEqTip.innerHTML = `<div style="font-size:9px;color:var(--muted);margin-bottom:5px;letter-spacing:1px">BET ~${betIdx}</div>${rows}`;
        btEqTip.style.display = 'block';
        btEqTip.style.left = Math.min(clientX + 14, window.innerWidth - 160) + 'px';
        btEqTip.style.top  = Math.max(10, clientY - 60) + 'px';
        // crosshair line
        const svgX = (pct * (W - 20) + 10).toFixed(1);
        btEqLine.setAttribute('x1', svgX);
        btEqLine.setAttribute('x2', svgX);
        btEqLine.style.display = '';
      }
      svg.addEventListener('mousemove',  e => btEqHandlePointer(e.clientX, e.clientY));
      svg.addEventListener('touchmove',  e => { e.preventDefault(); btEqHandlePointer(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
      svg.addEventListener('mouseleave', () => { btEqTip.style.display = 'none'; btEqLine.style.display = 'none'; });
      svg.addEventListener('touchend',   () => { btEqTip.style.display = 'none'; btEqLine.style.display = 'none'; });
      svg.style.cursor = 'crosshair';
    }
    if (legend) {
      legend.innerHTML = Object.entries(BT_COLORS).map(([name, col]) => {
        const r = strats[name];
        if (!r) return '';
        const pnl = r.pnl >= 0 ? `+$${r.pnl.toFixed(2)}` : `-$${Math.abs(r.pnl).toFixed(2)}`;
        return `<span style="display:flex;align-items:center;gap:4px">
          <span style="width:20px;height:2px;background:${col};display:inline-block"></span>
          <span style="color:#aaa">${name.replace(/^[A-Z]_/,'')} <span style="color:${pnlCol(r.pnl)}">${pnl}</span></span>
        </span>`;
      }).join('');
    }
  }

  // ‚îÄ‚îÄ Confidence calibration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const calibBody = document.getElementById('btCalibBody');
  if (calibBody && d.confidence_buckets) {
    calibBody.innerHTML = d.confidence_buckets.map(b => {
      const deltaCol = b.delta >= 5 ? 'var(--accent)' : b.delta <= -5 ? 'var(--danger)' : 'var(--muted)';
      const deltaStr = (b.delta >= 0 ? '+' : '') + b.delta.toFixed(1) + '%';
      const ppb = b.pnl_per_bet;
      const ppbCol = ppb >= 0 ? 'var(--accent)' : 'var(--danger)';
      const ppbStr = ppb != null ? (ppb >= 0 ? '+' : '') + '$' + ppb.toFixed(3) : '‚Äî';
      return `<tr>
        <td style="padding:4px 6px;font-size:11px;font-family:monospace">${b.bucket}</td>
        <td style="text-align:right;padding:4px 6px">${b.n}</td>
        <td style="text-align:right;padding:4px 6px;color:var(--muted)">${b.exp_wr?.toFixed(1)}%</td>
        <td style="text-align:right;padding:4px 6px">${b.act_wr?.toFixed(1)}%</td>
        <td style="text-align:right;padding:4px 6px;color:${deltaCol}">${deltaStr}</td>
        <td style="text-align:right;padding:4px 6px;color:${ppbCol};font-size:10px">${ppbStr}</td>
      </tr>`;
    }).join('');
  }

  // ‚îÄ‚îÄ 24h heatmap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const heatmap = document.getElementById('btHeatmap');
  if (heatmap && d.hourly) {
    heatmap.innerHTML = d.hourly.map(h => {
      let bg, label, title;
      if (h.n === 0) {
        bg = '#1a1a1a'; label = `${h.hour}h`; title = 'no data';
      } else if (h.is_dead) {
        bg = 'rgba(255,55,85,0.55)'; label = `${h.hour}h\n${h.wr}%`; title = `${h.hour}h ‚Äî DEAD (${h.wr}% WR, n=${h.n})`;
      } else if (h.is_hot) {
        bg = 'rgba(0,255,136,0.35)'; label = `${h.hour}h\n${h.wr}%`; title = `${h.hour}h ‚Äî HOT (${h.wr}% WR, n=${h.n})`;
      } else {
        const wr = h.wr || 50;
        const intensity = Math.max(0, Math.min(1, (wr - 40) / 30));
        bg = `rgba(80,160,255,${(0.1 + intensity * 0.45).toFixed(2)})`; label = `${h.hour}h\n${h.wr}%`; title = `${h.hour}h ‚Äî ${h.wr}% WR (n=${h.n})`;
      }
      const lowMark = h.low_sample ? '*' : '';
      const lines = label.split('\n');
      const pnlStr = h.n > 0 ? (h.pnl >= 0 ? '+' : '') + '$' + h.pnl.toFixed(2) : '';
      const pnlC = h.pnl >= 0 ? 'var(--accent)' : 'var(--danger)';
      return `<div title="${title}" style="background:${bg};border-radius:4px;padding:5px 3px;text-align:center;font-size:9px;line-height:1.3;cursor:default">
        <div style="color:rgba(255,255,255,0.6);font-size:8px">${lines[0]}${lowMark}</div>
        ${lines[1] ? `<div style="color:#fff;font-weight:700;font-size:10px">${lines[1]}</div>` : ''}
        ${pnlStr ? `<div style="color:${pnlC};font-size:8px;opacity:0.8">${pnlStr}</div>` : ''}
      </div>`;
    }).join('');
  }
}

function _bt(id, text, color) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = text;
  if (color) el.style.color = color;
}


// -- EQUITY HISTORY (real data from /equity-history) --------------------------

async function fetchEquityHistory() {
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/equity-history', { signal: AbortSignal.timeout(8000), headers: {'X-API-Key': CONFIG.READ_KEY} });
    if (!res.ok) return;
    const d = await res.json();
    if (!d.history || d.history.length === 0) return;
    const svg = document.getElementById('equitySvg');
    const tag = document.getElementById('equityTag');
    if (!svg) return;
    const capitalBase = d.capital_base || 100;
    const pts = [{ v: capitalBase }];
    d.history.forEach(row => pts.push({ v: row.equity }));
    const totalPnl = d.final_equity - capitalBase;
    const minV  = Math.min(...pts.map(p => p.v));
    const maxV  = Math.max(...pts.map(p => p.v));
    const range = maxV - minV || 0.001;
    const W = 1000, H = 100;
    const toX = i => (i / (pts.length - 1)) * W;
    const toY = v => H - ((v - minV) / range) * (H - 10) - 5;
    const polyPts   = pts.map((p, i) => toX(i).toFixed(1) + ',' + toY(p.v).toFixed(1)).join(' ');
    const areaClose = toX(pts.length - 1).toFixed(1) + ',' + H + ' 0,' + H;
    const color  = totalPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
    const gradId = totalPnl >= 0 ? 'eqGH' : 'eqGHR';
    svg.innerHTML =
      '<defs><linearGradient id="' + gradId + '" x1="0" y1="0" x2="0" y2="1">' +
      '<stop offset="0%" stop-color="' + color + '" stop-opacity="0.3"/>' +
      '<stop offset="100%" stop-color="' + color + '" stop-opacity="0"/>' +
      '</linearGradient></defs>' +
      '<polygon points="' + polyPts + ' ' + areaClose + '" fill="url(#' + gradId + ')"/>' +
      '<polyline points="' + polyPts + '" fill="none" stroke="' + color + '" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>' +
      '<circle cx="' + toX(pts.length-1).toFixed(1) + '" cy="' + toY(pts[pts.length-1].v).toFixed(1) + '" r="3.5" fill="' + color + '"/>';
    if (tag) {
      tag.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2) + ' (' + d.count + ' bets)';
      tag.className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');
    }
  } catch(e) { /* fallback silenzioso */ }
}

// ‚îÄ‚îÄ TRADING STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchTradingStats() {
  const badge = document.getElementById('tsVerdictBadge');
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/trading-stats', { signal: AbortSignal.timeout(8000) });
    if (!res.ok) { if (badge) badge.textContent = 'ERR'; return; }
    const d = await res.json();
    if (!d || !d.data) { if (badge) badge.textContent = 'N/A'; return; }
    const s = d.data;

    const fmtUsd = (v) => {
      if (v == null) return '‚Äî';
      const n = parseFloat(v);
      return (n >= 0 ? '+$' : '-$') + Math.abs(n).toFixed(3);
    };
    const fmtPct = (v) => v != null ? parseFloat(v).toFixed(1) + '%' : '‚Äî';
    const colorSign = (v) => v != null && parseFloat(v) >= 0 ? 'var(--accent)' : 'var(--danger)';

    // Expectancy
    const expEl = document.getElementById('tsExpectancy');
    if (expEl) {
      expEl.textContent = fmtUsd(s.expectancy_usd);
      expEl.style.color = colorSign(s.expectancy_usd);
    }

    // Expectancy last 20
    const expL20El = document.getElementById('tsExpectancyL20');
    if (expL20El) {
      expL20El.textContent = fmtUsd(s.expectancy_last20_usd);
      expL20El.style.color = colorSign(s.expectancy_last20_usd);
    }

    // Avg Win / Avg Loss ratio
    const ratioEl = document.getElementById('tsWinLossRatio');
    if (ratioEl) {
      const aw = parseFloat(s.avg_win_usd ?? 0);
      const al = Math.abs(parseFloat(s.avg_loss_usd ?? 1));
      const ratio = al > 0 ? (aw / al).toFixed(2) + 'x' : '‚Äî';
      ratioEl.textContent = ratio;
    }

    // UP bets
    const upWrEl = document.getElementById('tsUpWr');
    const upPnlEl = document.getElementById('tsUpPnl');
    if (upWrEl) { upWrEl.textContent = fmtPct(s.up_win_rate); }
    if (upPnlEl) {
      const upPnl = parseFloat(s.up_pnl_usd ?? 0);
      upPnlEl.textContent = 'PnL: ' + fmtUsd(s.up_pnl_usd);
      upPnlEl.style.color = upPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
    }

    // DOWN bets
    const dnWrEl = document.getElementById('tsDownWr');
    const dnPnlEl = document.getElementById('tsDownPnl');
    if (dnWrEl) { dnWrEl.textContent = fmtPct(s.down_win_rate); }
    if (dnPnlEl) {
      const dnPnl = parseFloat(s.down_pnl_usd ?? 0);
      dnPnlEl.textContent = 'PnL: ' + fmtUsd(s.down_pnl_usd);
      dnPnlEl.style.color = dnPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
    }

    // Avg PnL per bet
    const avgPnlEl = document.getElementById('tsAvgPnl');
    const avgPnlSubEl = document.getElementById('tsAvgPnlSub');
    if (avgPnlEl) {
      avgPnlEl.textContent = fmtUsd(s.avg_pnl_per_bet);
      avgPnlEl.style.color = colorSign(s.avg_pnl_per_bet);
    }
    if (avgPnlSubEl) {
      avgPnlSubEl.textContent = 'wins: ' + fmtUsd(s.avg_win_usd) + ' / losses: ' + fmtUsd(s.avg_loss_usd);
    }

    // Verdict badge
    if (badge) {
      const verdict = (s.expectancy_verdict || '').toUpperCase();
      badge.textContent = verdict || 'N/A';
      if (verdict.includes('POSITIVO') || verdict.includes('POSITIVE')) {
        badge.className = 'panel-tag tag-green';
      } else if (verdict.includes('NEGATIVO') || verdict.includes('NEGATIVE')) {
        badge.className = 'panel-tag tag-red';
      } else {
        badge.className = 'panel-tag tag-yellow';
      }
    }
  } catch(e) {
    if (badge) badge.textContent = 'ERR';
  }
}

// ‚îÄ‚îÄ HOURLY WR HEATMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchErrorPatterns() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/error-patterns`, { signal: AbortSignal.timeout(8000) });
    if (!res.ok) {
      // No data yet ‚Äî show empty heatmap with placeholder cells
      renderHourlyHeatmap({ all_patterns: [], total_bets: 0 });
      return;
    }
    const d = await res.json();
    renderHourlyHeatmap(d);
  } catch(e) {
    console.warn('fetchErrorPatterns error:', e);
    renderHourlyHeatmap({ all_patterns: [], total_bets: 0 });
  }
}

function renderHourlyHeatmap(d) {
  const grid = document.getElementById('hourlyHeatmapGrid');
  const tag  = document.getElementById('heatmapTag');
  if (!grid) return;

  // Build hour map from all_patterns where type === 'hour'
  const hourMap = {};
  (d.all_patterns || []).filter(p => p.type === 'hour').forEach(p => {
    const h = parseInt(p.label.match(/\d+/)?.[0] ?? '-1');
    if (h >= 0) hourMap[h] = p;
  });

  grid.innerHTML = '';
  for (let h = 0; h < 24; h++) {
    const p = hourMap[h];
    const hasData = p && p.n >= 5;
    const wr = hasData ? p.wr : null;
    let bg = 'rgba(255,255,255,0.03)';
    let color = 'var(--muted)';
    let borderColor = 'var(--border)';
    if (hasData) {
      if (wr > 0.55)      { bg = 'rgba(0,255,136,0.10)'; color = 'var(--accent)'; borderColor = 'rgba(0,255,136,0.3)'; }
      else if (wr < 0.45) { bg = 'rgba(255,68,102,0.10)'; color = 'var(--danger)'; borderColor = 'rgba(255,68,102,0.3)'; }
    }
    const cell = document.createElement('div');
    cell.style.cssText = `background:${bg};border:1px solid ${borderColor};padding:3px 2px;text-align:center;border-radius:2px;cursor:${hasData?'pointer':'default'};`;
    cell.innerHTML = `<div style="font-size:7px;color:var(--muted);letter-spacing:0.5px;line-height:1.3;">${String(h).padStart(2,'0')}h</div>
      <div style="font-size:9px;font-weight:700;color:${color};line-height:1.3;">${hasData ? Math.round(wr*100)+'%' : '\u2014'}</div>`;
    if (hasData) cell.title = `${String(h).padStart(2,'0')}:00 UTC ‚Äî WR ${p.wr_pct}% ¬∑ ${p.n} bets ¬∑ PnL $${p.pnl?.toFixed(2)}`;
    grid.appendChild(cell);
  }

  if (tag) {
    const total = d.total_bets || 0;
    if (total === 0) {
      tag.textContent = 'NO DATA';
      tag.className = 'panel-tag tag-muted';
    } else {
      tag.textContent = total + ' BETS';
      tag.className = 'panel-tag tag-blue';
    }
  }
}

// Start everything
refresh();
setInterval(refresh, CONFIG.REFRESH_INTERVAL);

fetchLiveBtcPrice();
setInterval(fetchLiveBtcPrice, CONFIG.BTC_REFRESH);

refreshAccountSummary();
setInterval(refreshAccountSummary, CONFIG.ACCT_REFRESH);

fetchEquityHistory();
fetchTradingStats();
fetchErrorPatterns();
fetchTrainingStatus();
fetchBotAlerts();

// ‚îÄ‚îÄ TRAINING STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchTrainingStatus() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/training-status`, { signal: AbortSignal.timeout(10000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const d = await res.json();

    // Status pill
    const pill = document.getElementById('trainStatusPill');
    const txt  = document.getElementById('trainStatusText');
    if (pill && txt) {
      const s = (d.status || '').toLowerCase();
      pill.className = 'train-status-pill ' + s;
      txt.textContent = s === 'recent' ? 'FRESH' : s === 'on_track' ? 'ON TRACK' : 'RETRAIN READY';
    }

    // Bets since + progress bar
    const bets  = d.bets_since_retrain ?? 0;
    const thr   = d.retrain_threshold  ?? 30;
    const pct   = Math.min(100, Math.round(bets / thr * 100));
    const el = document.getElementById('trainBetsSince');
    if (el) el.textContent = bets !== null ? bets : '‚Äî';
    const thrEl = document.getElementById('trainBetsThreshold');
    if (thrEl) thrEl.textContent = '/ ' + thr + ' target';
    const fill = document.getElementById('trainProgressFill');
    if (fill) fill.style.width = pct + '%';
    if (pct >= 100) fill.style.background = 'var(--warn)';
    const lbl = document.getElementById('trainProgressLabel');
    if (lbl) lbl.textContent = pct + '% toward next meaningful retrain';

    // Direction accuracy
    const accEl = document.getElementById('trainDirAcc');
    if (accEl) accEl.textContent = d.direction_acc ? d.direction_acc.toFixed(1) + '%' : '‚Äî';
    const nEl = document.getElementById('trainTrainN');
    if (nEl) nEl.textContent = d.train_n ? d.train_n + ' signals in dataset' : '‚Äî';

    // Dates
    const lastEl = document.getElementById('trainLastDate');
    if (lastEl) lastEl.textContent = d.last_retrain_iso || '‚Äî';
    const agoEl = document.getElementById('trainDaysAgo');
    if (agoEl) agoEl.textContent = d.days_since_retrain !== null ? d.days_since_retrain + ' days ago' : '';
    const nextEl = document.getElementById('trainNextDate');
    if (nextEl) nextEl.textContent = d.next_retrain_iso || '‚Äî';
  } catch(e) {
    console.warn('fetchTrainingStatus error:', e);
  }
}

// ‚îÄ‚îÄ BOT ALERTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchBotAlerts() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/check-status`, { signal: AbortSignal.timeout(8000) });
    if (!res.ok) return;
    const d = await res.json();
    const banner = document.getElementById('botAlertBanner');
    const msg    = document.getElementById('botAlertMsg');
    if (!banner || !msg) return;
    if (d.alert) {
      const openBets  = d.open_bets_supabase || 0;
      const wf02Active = d.wf02_active;
      let detail = d.alert;
      if (!wf02Active && openBets > 0) {
        detail = openBets + ' bet' + (openBets > 1 ? 's' : '') + ' aperta/e senza monitoraggio wf02 ‚Äî rescue consigliato';
      }
      msg.textContent = detail;
      banner.classList.add('visible');
    } else {
      banner.classList.remove('visible');
    }
  } catch(e) { /* silent */ }
}

// Populate training tab with same /training-status data
function renderTrainingTab(d) {
  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  const bets = d.bets_since_retrain ?? 0;
  const thr  = d.retrain_threshold ?? 30;
  const pct  = Math.min(100, Math.round(bets / thr * 100));

  // CV Accuracy + bar
  const acc = d.direction_acc ?? null;
  set('trn-dirAcc', acc !== null ? acc.toFixed(1) + '%' : '‚Äî');
  const accBar = document.getElementById('trn-accBarFill');
  if (accBar) {
    const accPct = acc !== null ? Math.min(100, acc) : 0;
    accBar.style.width = accPct + '%';
    accBar.style.background = accPct >= 70 ? 'var(--accent)' : accPct >= 55 ? 'var(--warn)' : 'var(--danger)';
  }
  set('trn-trainN',  d.train_n ? d.train_n + ' signals' : '‚Äî');

  // Progress bar
  set('trn-betsSince', bets !== null ? bets + ' / ' + thr : '‚Äî');
  set('trn-betsThr', '/ ' + thr + ' new bets');
  const fill = document.getElementById('trn-progressFill');
  if (fill) { fill.style.width = pct + '%'; fill.style.background = pct >= 100 ? 'var(--warn)' : 'var(--accent)'; }
  set('trn-progressLabel', pct + '% ‚Äî ' + bets + ' of ' + thr + ' new bets');

  // Calibration button: enable based on rate-limit cooldown, NOT on XGBoost bet counter
  const retrainBtn  = document.getElementById('trnRetrainBtn');
  const retrainHint = document.getElementById('trnRetrainHint');
  if (retrainBtn) {
    const cooldown = d.calibration_cooldown_remaining_secs ?? 0;
    const isRateLimited = cooldown > 0;
    retrainBtn.disabled = isRateLimited;
    if (isRateLimited) {
      retrainBtn.classList.remove('ready');
      const mins = Math.ceil(cooldown / 60);
      if (retrainHint) retrainHint.innerHTML = `üîí Rate limited &mdash; disponibile tra <strong style="color:var(--warn)">${mins}min</strong>`;
    } else {
      retrainBtn.classList.add('ready');
      if (retrainHint) retrainHint.innerHTML = 'Aggiorna conf threshold + dead hours dai dati live.<br><span style="color:rgba(255,170,0,0.6)">‚ö† Non √® un retrain XGBoost ‚Äî indipendente dal counter 39/30</span>';
    }
  }

  // Dates
  set('trn-lastDate', d.last_retrain_iso || '‚Äî');
  set('trn-daysAgo',  d.days_since_retrain !== null ? d.days_since_retrain + ' days ago' : '');
  set('trn-nextDate', d.next_retrain_iso || '‚Äî');

  // State badge (trn-stateBadge) with color classes: trained / stale / error
  const badge = document.getElementById('trn-stateBadge');
  const txt   = document.getElementById('trn-statusText');
  if (badge && txt) {
    const s = (d.status || '').toLowerCase();
    // Map internal statuses ‚Üí badge class + label
    let cls, label;
    if (s === 'recent') {
      cls = 'trained'; label = 'TRAINED';
    } else if (s === 'on_track') {
      cls = 'trained'; label = 'ON TRACK';
    } else if (s === 'retrain_ready') {
      cls = 'stale';   label = 'STALE';
    } else if (s === 'error') {
      cls = 'error';   label = 'ERROR';
    } else {
      cls = 'stale';   label = s.toUpperCase() || 'UNKNOWN';
    }
    badge.className = 'trn-badge ' + cls;
    txt.textContent = label;
  }
  // Keep legacy pill hidden but keep its status class for fetchTrainingStatus compatibility
  const pill = document.getElementById('trn-statusPill');
  if (pill) {
    const s = (d.status || '').toLowerCase();
    pill.className = 'train-status-pill ' + s;
  }

  // Config
  set('trn-confThr',  d.confidence_threshold != null ? d.confidence_threshold.toFixed(2) : '0.75');
  set('trn-baseSize', d.base_size_btc != null ? d.base_size_btc + ' BTC' : '0.002 BTC');
  const xgbEl = document.getElementById('trn-xgbStatus');
  const corrEl = document.getElementById('trn-corrStatus');
  if (xgbEl)  { xgbEl.textContent = d.xgb_loaded != null ? (d.xgb_loaded ? '‚úÖ Loaded' : '‚ùå Missing') : '‚Äî'; xgbEl.style.color = d.xgb_loaded ? 'var(--accent)' : 'var(--danger)'; }
  if (corrEl) { corrEl.textContent = d.correctness_loaded != null ? (d.correctness_loaded ? '‚úÖ Loaded' : '‚ùå Missing') : '‚Äî'; corrEl.style.color = d.correctness_loaded ? 'var(--accent)' : 'var(--danger)'; }
  const deadEl = document.getElementById('trn-deadHours');
  if (deadEl) deadEl.textContent = Array.isArray(d.dead_hours) && d.dead_hours.length ? d.dead_hours.map(h => h + 'h').join(' ¬∑ ') : 'none';
}

// Force Recalibrate button handler ‚Äî calls /force-retrain (public, 1h rate limit)
async function trnForceRetrain() {
  const btn     = document.getElementById('trnRetrainBtn');
  const overlay = document.getElementById('brainOverlay');
  const sub     = document.getElementById('brainSubLabel');
  const hint    = document.getElementById('trnRetrainHint');
  if (btn)     { btn.disabled = true; btn.classList.remove('ready'); btn.innerHTML = '<span style="font-size:15px;line-height:1">‚è≥</span><span>Running‚Ä¶</span>'; }
  if (overlay) { overlay.setAttribute('aria-hidden', 'false'); overlay.classList.add('visible'); }
  if (sub)     { sub.textContent = 'RELOADING THRESHOLDS FROM LIVE DATA'; sub.style.color = ''; }

  let success = false;
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/force-retrain', {
      method: 'POST', signal: AbortSignal.timeout(25000)
    });
    if (sub) {
      if (res.ok) {
        success = true;
        sub.innerHTML = '‚úÖ CALIBRATION COMPLETE ‚Äî tap to close';
        sub.style.color = 'var(--accent)';
      } else if (res.status === 429) {
        const d = await res.json().catch(() => ({}));
        const mins = d.next_allowed_in_seconds ? Math.ceil(d.next_allowed_in_seconds / 60) : '?';
        sub.innerHTML = `‚è≥ RATE LIMITED ‚Äî prossima run tra ${mins}min`;
        sub.style.color = 'var(--warn)';
      } else {
        sub.innerHTML = '‚ö†Ô∏è ERROR ' + res.status;
        sub.style.color = 'var(--danger)';
      }
    }
    // Tap-to-dismiss: resolves after 5s OR on overlay click
    await Promise.race([
      new Promise(r => setTimeout(r, success ? 5000 : 4000)),
      new Promise(r => { if (overlay) overlay.addEventListener('click', r, { once: true }); })
    ]);
    if (success) await fetchTrainingTab();
  } catch(e) {
    if (sub) { sub.textContent = '‚ö†Ô∏è REQUEST FAILED ‚Äî verifica Railway'; sub.style.color = 'var(--danger)'; }
    await new Promise(r => setTimeout(r, 3000));
  } finally {
    if (overlay) { overlay.classList.remove('visible'); overlay.setAttribute('aria-hidden', 'true'); }
    if (sub)     { sub.textContent = 'RELOADING THRESHOLDS FROM LIVE DATA'; sub.style.color = ''; }
    if (btn) {
      btn.innerHTML = '<span style="font-size:15px;line-height:1">üß†</span><span>Force Recalibrate</span>';
      if (success) {
        // Show "last run" timestamp for 30s, then re-check threshold
        const ts = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        btn.innerHTML = `<span style="font-size:15px;line-height:1">‚úÖ</span><span>Done ¬∑ ${ts}</span>`;
        btn.disabled = true;
        if (hint) { hint.innerHTML = `<span style="color:var(--accent)">‚úÖ Calibrazione completata alle ${ts}</span> ‚Äî prossima disponibile tra ~1h`; }
        setTimeout(() => {
          if (btn) {
            btn.innerHTML = '<span style="font-size:15px;line-height:1">üß†</span><span>Force Recalibrate</span>';
            btn.disabled = true; // stays locked for 1h ‚Äî rate limit in server
          }
        }, 30000);
      } else {
        // Re-enable only if threshold still met (for non-success cases like network error)
        const betsEl = document.getElementById('trn-betsSince');
        const bets   = parseInt(betsEl?.textContent) || 0;
        const thr    = parseInt(document.getElementById('trn-betsThr')?.textContent) || 30;
        if (bets >= thr) { btn.disabled = false; btn.classList.add('ready'); }
      }
    }
  }
}

async function fetchTrainingTab() {
  try {
    const [tsRes, btRes, xgbRes] = await Promise.allSettled([
      fetch(`${CONFIG.RAILWAY_URL}/training-status`, { signal: AbortSignal.timeout(10000) }),
      fetch(`${CONFIG.RAILWAY_URL}/backtest-report`, { signal: AbortSignal.timeout(10000) }),
    ]);
    if (tsRes.status === 'fulfilled' && tsRes.value.ok) {
      const d = await tsRes.value.json();
      renderTrainingTab(d);
      // XGB report is in backtest-report response
      if (btRes.status === 'fulfilled' && btRes.value.ok) {
        const bt = await btRes.value.json();
        const xpre = document.getElementById('trn-xgbReport');
        if (xpre && bt.xgb_report) xpre.textContent = bt.xgb_report;
        const bpre = document.getElementById('trn-backtestReport');
        if (bpre && bt.backtest_report) bpre.textContent = bt.backtest_report;
      }
    }
  } catch(e) { console.warn('fetchTrainingTab error:', e); }
}

// Refresh training status every 5 minutes
setInterval(fetchTrainingStatus, 5 * 60 * 1000);
setInterval(fetchBotAlerts, 3 * 60 * 1000);

// ‚îÄ‚îÄ COSTS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function refreshCostsTab() {
  const body = document.getElementById('costBreakdownBody');
  body.innerHTML = 'Loading<span class="loading">...</span>';
  ['costKpiTotalVal','costKpiKrakenVal','costKpiN8nVal','costKpiClaudeApiVal','costKpiClaudeCodeVal','costKpiRailwayVal'].forEach(id => {
    document.getElementById(id).textContent = '‚Äî';
  });
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/costs', { signal: AbortSignal.timeout(10000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    renderCosts(data);
  } catch(e) {
    body.innerHTML = `<span style="color:var(--danger);font-size:11px">‚ö†Ô∏è Errore: ${escapeHtml(e.message)}</span>`;
  }
}

function renderCosts(d) {
  const fmtUsd = v => '$' + (v ?? 0).toFixed(2);
  const ca = d.claude_api || {};
  const cc = d.claude_code || {};

  // KPI
  document.getElementById('costKpiTotalVal').textContent       = fmtUsd(d.total_usd);
  document.getElementById('costKpiTotalSub').textContent       = d.cached ? 'parz. cached' : 'live';
  document.getElementById('costKpiKrakenVal').textContent      = fmtUsd(d.kraken_fees?.total_usd);
  document.getElementById('costKpiKrakenSub').textContent      = `${d.kraken_fees?.trade_count ?? 0} trade ¬∑ REALE`;
  document.getElementById('costKpiN8nVal').textContent         = d.n8n?.cost_usd != null ? '$' + (d.n8n.cost_usd).toFixed(2) : '‚Ç¨4.99';
  document.getElementById('costKpiN8nSub').textContent         = d.n8n?.executions_est ? `${d.n8n.executions_est} exec ¬∑ VPS` : 'VPS ¬∑ unlimited exec';
  document.getElementById('costKpiClaudeApiVal').textContent   = fmtUsd(ca.cost_usd);
  document.getElementById('costKpiClaudeApiSub').textContent   = `${ca.monthly_calls ?? 0} call ¬∑ ${ca.model ?? '‚Äî'}`.replace('claude-','').replace('-20251001','');
  document.getElementById('costKpiClaudeCodeVal').textContent  = cc.cost_usd > 0 ? fmtUsd(cc.cost_usd) : '‚Äî';
  document.getElementById('costKpiClaudeCodeSub').textContent  = cc.cost_usd > 0 ? 'impostato manualmente' : 'set CLAUDE_CODE_MONTHLY_USD';
  document.getElementById('costKpiRailwayVal').textContent     = fmtUsd(d.railway?.cost_usd);
  document.getElementById('costKpiRailwaySub').textContent     = `piano ${d.railway?.plan ?? '‚Äî'} ¬∑ auto-renew`;

  // Email expiry warning (‚ö†Ô∏è if < 30 days)
  const em = d.hostinger_email || {};
  const emailExpiry = em.expires ? new Date(em.expires) : null;
  const emailDaysLeft = emailExpiry ? Math.ceil((emailExpiry - new Date()) / 86400000) : null;
  const emailWarning = emailDaysLeft !== null && emailDaysLeft < 30 ? ` ‚ö†Ô∏è ${emailDaysLeft}d` : '';

  // Domain expiry info
  const domExpiry = d.domain?.expires ? new Date(d.domain.expires) : null;
  const domDaysLeft = domExpiry ? Math.ceil((domExpiry - new Date()) / 86400000) : null;
  const domSub = domDaysLeft !== null ? `Hostinger ¬∑ scade in ${domDaysLeft}d` : 'Hostinger ¬∑ 1 year';

  // Breakdown table
  const total = d.total_usd || 1;
  const rows = [
    { name: 'Kraken Fees',    logo: 'KRK', sub: `${d.kraken_fees?.trade_count ?? 0} trade, avg ${fmtUsd(d.kraken_fees?.avg_per_trade)} ciascuno`,
      usd: d.kraken_fees?.total_usd ?? 0, type: 'REALE', color: '#ffaa00' },
    { name: 'Hostinger VPS', logo: 'HST', sub: `${d.hostinger_vps?.plan ?? 'KVM1'} ¬∑ n8n self-hosted ¬∑ unlimited exec`,
      usd: d.hostinger_vps?.cost_usd ?? 0, type: 'PIANO', color: '#ff6b35' },
    { name: 'btcpredictor.io', logo: '.io', sub: domSub,
      usd: d.domain?.cost_usd ?? 0,        type: 'PIANO', color: '#00aaff' },
    { name: `Email signal@${emailWarning}`, logo: '‚úâ', sub: `${em.plan ?? 'Starter Email'} ¬∑ ${em.expires ?? ''}`,
      usd: em.cost_usd ?? 0,               type: 'PIANO', color: emailDaysLeft !== null && emailDaysLeft < 30 ? '#ff4444' : '#00cccc' },
    { name: 'Claude API',     logo: 'CLA', sub: `${ca.monthly_calls ?? 0} call ¬∑ ${(ca.avg_input_tokens ?? 0)/1000}k in + ${ca.avg_output_tokens ?? 0} out token`,
      usd: ca.cost_usd ?? 0,              type: 'REALE', color: '#aa66ff' },
    { name: 'Claude Code',    logo: 'CLI', sub: cc.cost_usd > 0 ? 'spese sviluppo (sessioni CLI)' : 'aggiungi env CLAUDE_CODE_MONTHLY_USD',
      usd: cc.cost_usd ?? 0,              type: cc.cost_usd > 0 ? 'REALE' : 'ND',    color: '#e5251b' },
    { name: 'Railway',        logo: 'RLY', sub: `piano ${d.railway?.plan ?? '‚Äî'} ¬∑ auto-renew mensile`,
      usd: d.railway?.cost_usd ?? 0,      type: 'PIANO', color: '#8866ff' },
    { name: 'Supabase',       logo: 'SB',  sub: `${d.supabase?.row_count ?? 0} righe ¬∑ piano free`,
      usd: d.supabase?.cost_usd ?? 0,     type: 'PIANO', color: '#3ecf8e' },
  ];
  const typeColor = { REALE: 'tag-yellow', PIANO: 'tag-blue', STIMA: 'tag-muted', ND: 'tag-muted' };

  const rowHtml = rows.map(r => {
    const pct = Math.min(100, total > 0 ? (r.usd / total) * 100 : 0);
    return `
    <tr>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="svc-logo" style="color:${r.color};background:${r.color}12;border-color:${r.color}30">${r.logo}</span>
          <div>
            <span style="color:var(--text);font-weight:700">${r.name}</span>
            <span style="display:block;font-size:9px;color:var(--muted);margin-top:2px">${r.sub}</span>
          </div>
        </div>
      </td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;color:${r.color};font-size:14px">${fmtUsd(r.usd)}</td>
      <td><span class="cost-type-badge panel-tag ${typeColor[r.type]}">${r.type}</span></td>
      <td>
        <div class="cost-bar-wrap" style="width:100px">
          <div class="cost-bar-fill" style="width:${pct.toFixed(1)}%;background:${r.color}"></div>
        </div>
        <span style="font-size:9px;color:var(--muted);margin-left:6px">${pct.toFixed(0)}%</span>
      </td>
    </tr>`;
  }).join('');

  const modelShort = (ca.model ?? '‚Äî').replace('claude-','').replace('-20251001','');
  const prIn  = ca.pricing?.input  ?? 0;
  const prOut = ca.pricing?.output ?? 0;

  document.getElementById('costBreakdownBody').innerHTML = `
    <div class="table-wrap">
      <table class="cost-table">
        <thead><tr><th>Voce</th><th>Costo USD</th><th>Tipo</th><th>Peso</th></tr></thead>
        <tbody>
          ${rowHtml}
          <tr>
            <td style="font-weight:700;color:var(--text)">TOTALE MTD</td>
            <td style="font-family:'Syne',sans-serif;font-weight:800;color:var(--danger);font-size:16px">${fmtUsd(d.total_usd)}</td>
            <td></td><td></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div style="font-size:9px;color:var(--muted);margin-top:12px;padding:0 4px;display:flex;gap:16px;flex-wrap:wrap">
      <span>Modello: <strong style="color:var(--text)">${modelShort}</strong></span>
      <span>Prezzi: <strong style="color:var(--text)">$${prIn}/1M in ¬∑ $${prOut}/1M out</strong></span>
      <span>Claude Code: spese sessioni CLI development</span>
    </div>`;
}

// ‚îÄ‚îÄ SUBSCRIPTION EXPIRY WIDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const _SUBSCRIPTIONS = [
  { icon: '‚úâÔ∏è', name: 'Email signal@btcpredictor.io', expires: '2026-03-27', note: 'Starter Business Email ¬∑ Hostinger', warn: true },
  { icon: 'üåê', name: 'btcpredictor.io domain',       expires: '2027-02-25', note: '.io ¬∑ Hostinger ¬∑ incl. Privacy',  warn: false },
  { icon: 'üñ•Ô∏è', name: 'Hostinger VPS (n8n)',          expires: null,         note: 'KVM1 ¬∑ ‚Ç¨4.99/mo ¬∑ auto-renew',    warn: false },
  { icon: 'üöÇ', name: 'Railway',                       expires: null,         note: 'Hobby $5/mo ¬∑ auto-renew',        warn: false },
];

function renderSubscriptionExpiry() {
  const container = document.getElementById('subscriptionExpiryRows');
  if (!container) return;
  const now = new Date();

  container.innerHTML = _SUBSCRIPTIONS.map(sub => {
    let daysLeft = null, color = 'var(--muted)', badge = '', barWidth = 0;
    if (sub.expires) {
      const exp = new Date(sub.expires);
      daysLeft = Math.ceil((exp - now) / 86400000);
      const totalDays = Math.ceil((exp - new Date(now.getFullYear(), 0, 1)) / 86400000);
      barWidth = Math.max(0, Math.min(100, (1 - daysLeft / 365) * 100));
      if      (daysLeft < 14)  { color = '#ff4444'; badge = `<span style="background:#ff444422;color:#ff4444;border:1px solid #ff444440;font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700">‚ö†Ô∏è ${daysLeft}d</span>`; }
      else if (daysLeft < 30)  { color = '#ffaa00'; badge = `<span style="background:#ffaa0022;color:#ffaa00;border:1px solid #ffaa0040;font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700">‚ö° ${daysLeft}d</span>`; }
      else if (daysLeft < 90)  { color = '#ffdd44'; badge = `<span style="font-size:9px;color:#ffdd44;font-weight:700">${daysLeft}d</span>`; }
      else                     { color = '#00ff88'; badge = `<span style="font-size:9px;color:#00ff88">${daysLeft}d</span>`; }
    } else {
      badge = `<span style="font-size:9px;color:var(--muted)">auto-renew</span>`;
      barWidth = 0;
    }
    return `
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:14px;width:20px;text-align:center">${sub.icon}</span>
        <div style="flex:1;min-width:0">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
            <span style="font-size:11px;font-weight:700;color:var(--text)">${sub.name}</span>
            ${badge}
          </div>
          <div style="font-size:9px;color:var(--muted);margin-bottom:4px">${sub.note}${sub.expires ? ' ¬∑ scade ' + sub.expires : ''}</div>
          ${sub.expires ? `<div style="height:2px;background:rgba(255,255,255,0.05);border-radius:2px;overflow:hidden"><div style="height:100%;width:${barWidth.toFixed(1)}%;background:${color};border-radius:2px;transition:width 0.3s"></div></div>` : ''}
        </div>
      </div>`;
  }).join('');
}

// Render on tab open + refresh every minute
renderSubscriptionExpiry();
setInterval(renderSubscriptionExpiry, 60000);

// Dry-run banner + health check
fetch(CONFIG.RAILWAY_URL + '/health')
  .then(r => r.json())
  .then(data => {
    if (data.dry_run) {
      const dryBanner = document.getElementById('dry-run-banner');
      if (dryBanner) dryBanner.style.display = 'block';
    }
    // Store operational config globally
    window._botConfig = {
      baseSize: data.base_size,
      confThreshold: data.confidence_threshold,
      capital: data.capital_usd
    };
    // Show PAUSED indicator if bot is paused
    const pausedEl = document.getElementById('botPausedIndicator');
    if (pausedEl) {
      pausedEl.style.display = data.bot_paused ? 'inline' : 'none';
    }
    // Update botStatusDetail with size/conf info
    const detailEl = document.getElementById('botStatusDetail');
    if (detailEl && data.base_size != null) {
      const confPct = Math.round((data.confidence_threshold || 0.75) * 100);
      const currentText = detailEl.textContent || '';
      detailEl.textContent = currentText + ' ¬∑ üéØ Confidence: ' + confPct + '%';
    }
  })
  .catch(() => {})
  .finally(() => { _loader.tick(); }); // 3/3 ‚Äî health loaded

// ‚îÄ‚îÄ‚îÄ INFO MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
  const modal = document.getElementById('infoModal');
  const SOURCES_INFO = {
    'KRAKEN':      {cat:'PRICE',       color:'#00aaff', desc:'BTC/USD spot price fetched from Kraken Futures REST API every 6 minutes.'},
    'BINANCE':     {cat:'KLINES',      color:'#3399ee', desc:'5-minute OHLCV candlesticks (last 20) from Binance. Used for trend, momentum and pattern detection.'},
    'COINGECKO':   {cat:'MARKET',      color:'#00d4aa', desc:'Global market data: BTC market cap, 24h volume, dominance %, price change from CoinGecko.'},
    'FUNDING RATE':{cat:'DERIVATIVES', color:'#aa66ff', desc:'Perpetual futures funding rate on Kraken. Positive = longs pay shorts (bearish signal when very high).'},
    'L/S RATIO':   {cat:'DERIVATIVES', color:'#cc88ff', desc:'Long/Short ratio ‚Äî ratio of long vs short positions open in the market. Signals crowd positioning.'},
    'FEAR & GREED':{cat:'SENTIMENT',   color:'#00ff88', desc:'Crypto Fear & Greed Index (0‚Äì100). <25 = Extreme Fear, >75 = Extreme Greed. Contrarian signal.'},
    'CRYPTOCMP':   {cat:'NEWS',        color:'#ff9500', desc:'Latest crypto news from CryptoCompare API. Articles filtered for relevance before passing to AI.'},
    'COINDESK':    {cat:'NEWS',        color:'#ffcc00', desc:'CoinDesk RSS feed ‚Äî leading crypto media. Top 3 recent headlines passed to the prediction agent.'},
    'OPEN INT.':   {cat:'DERIVATIVES', color:'#f7931a', desc:'Binance Futures Open Interest (BTCUSDT). Rising OI in trend = conviction; falling OI = exhaustion signal.'},
    'TAKER FLOW':  {cat:'FLOW',        color:'#22d3ee', desc:'Binance Futures taker buy/sell ratio (5m). Shows who hits the bid/ask ‚Äî aggressive buyers vs sellers.'},
    'COINTELEGR.': {cat:'NEWS',        color:'#02b875', desc:'CoinTelegraph RSS ‚Äî top 3 crypto headlines. High signal-to-noise for BTC price-moving events.'},
    'XGBOOST':     {cat:'ML GATE',     color:'#a855f7', desc:'Internal XGBoost model (47 features). Dual-gate: bets execute ONLY when LLM + XGBoost agree on direction.'},
    'PATTERNS':    {cat:'MEMORY',      color:'#ff44aa', desc:'Historical signal patterns from Supabase DB. Similar past setups and their outcomes inform the AI.'},
    'CNBC':        {cat:'NEWS',        color:'#e5251b', desc:'CNBC Finance RSS ‚Äî US financial & markets headlines. Macro context from Wall Street perspective.'},
    'ORDER BOOK':  {cat:'MICROSTRUCTURE', color:'#00ccff', desc:'Order book imbalance calcolato su 5 livelli bid/ask dal Kraken Futures. Segnali: STRONG_BUY_PRESSURE / MILD_BUY / NEUTRAL / MILD_SELL / STRONG_SELL. Utile per rilevare pressione immediata sul prezzo.'},
    'MULTI-TF':    {cat:'TECHNICAL',   color:'#88ddff', desc:'Analisi multi-timeframe 15m e 4h: EMA9, EMA21, RSI14 per ciascuno. MTF Consensus: STRONG_UP (entrambi bullish), STRONG_DOWN (entrambi bearish), MIXED. Riduce il noise del timeframe 1m.'},
  };
  const KPI_INFO = {
    'BTC Price':      {cat:'LIVE DATA',  color:'#00aaff', desc:'Current BTC/USD price, refreshed every 30s from Kraken Futures mark price.'},
    'Win Rate':       {cat:'STATISTICS', color:'#00ff88', desc:'Percentage of resolved bets that ended as wins. Target: >55% for profitability.'},
    'Total PnL':      {cat:'P&L',        color:'#00ff88', desc:'Cumulative profit/loss in USD across all closed bets. Excludes open positions.'},
    'Total Bets':     {cat:'STATISTICS', color:'#00aaff', desc:'Total number of bets taken (bet_taken = true) including open positions.'},
    'Open Bets':      {cat:'LIVE',       color:'#ffaa00', desc:'Currently open positions being monitored by wf02. Each has active SL/TP watching.'},
    'Avg PnL':        {cat:'P&L',        color:'#aa66ff', desc:'Average PnL per closed trade in USD. Positive target for system profitability.'},
    'Avg Confidence': {cat:'MODEL',      color:'#cc88ff', desc:'Average AI confidence score on bets taken. Higher confidence should correlate with better WR.'},
    'Streak':         {cat:'STATISTICS', color:'#ffaa00', desc:'Current consecutive win/loss streak. Useful for detecting model drift.'},
    'Signals':        {cat:'STATISTICS', color:'#00d4aa', desc:'Total signals generated (including skipped). Shows how often the model fires.'},
    'Capital':        {cat:'ACCOUNT',    color:'#00ff88', desc:'Current account equity in USDC on Kraken Futures. Base capital used for bet sizing.'},
  };

  function showModal(e, title, info) {
    if (!info) return;
    document.getElementById('imTitle').textContent = title;
    document.getElementById('imCat').textContent = info.cat;
    document.getElementById('imBody').innerHTML = info.desc;
    modal.style.setProperty('--im-color', info.color);
    const pad = 12;
    let x = e.clientX + pad, y = e.clientY + pad;
    if (x + 340 > window.innerWidth) x = e.clientX - 340;
    if (y + 160 > window.innerHeight) y = e.clientY - 140;
    modal.style.left = x + 'px';
    modal.style.top  = y + 'px';
    modal.classList.add('visible');
  }

  function hideModal() { modal.classList.remove('visible'); }

  /* ‚îÄ‚îÄ CHART INFO POPUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  window.CHART_INFO = {
    'Cumulative Equity': { cat:'PERFORMANCE', color:'#00ff88', desc:'Capital curve built from real PnL of every closed bet. Steady upward trend = positive edge. Drawdowns visible as dips. Click any point to inspect that trade.' },
    'BTC Price vs Predictions': { cat:'TECHNICAL', color:'#3399ee', desc:'BTC price action overlaid with AI prediction markers. ‚ñ≤ Green = UP prediction (correct if price rose). ‚ñº Red = DOWN prediction. Diamonds = high-confidence bets taken. Shows if predictions align with price movement.' },
    'Rolling Win Rate': { cat:'STATISTICS', color:'#ffbb00', desc:'Rolling 10-bet and 20-bet win rate curves. Target > 55% for profitability at 1:1 RR. Downward trend = potential model decay. Dashed line = overall WR.' },
    'Prediction Galaxy': { cat:'ML ANALYSIS', color:'#aa66ff', desc:'Scatter plot: X-axis = confidence (0.75‚Äì1.0), Y-axis = PnL per bet. Cluster top-right = high-confidence wins. Bottom-left = low-confidence losses. Useful to detect if model calibration is working.' },
    'BTC Regime & Confidence': { cat:'ML ANALYSIS', color:'#aa66ff', desc:'Confidence levels over time with BTC price context. Spikes = model conviction. Low-confidence periods may correlate with choppy/ranging market conditions.' },
    'Rolling Rate & Bets': { cat:'STATISTICS', color:'#ffbb00', desc:'Rolling win rate (line) and individual bet outcomes (bars). Green bars = WIN, red bars = LOSS. Width proportional to bet size. Shows performance consistency over time.' },
    'Cumulative Equity Curve': { cat:'PERFORMANCE', color:'#00ff88', desc:'Capital curve built from real PnL of every closed bet. Steady upward trend = positive edge. Drawdowns visible as dips.' },
    'Cumulative Equity Curve (Real Bets)': { cat:'PERFORMANCE', color:'#00ff88', desc:'Capital curve built from real PnL of every closed bet. Steady upward trend = positive edge. Drawdowns visible as dips.' },
    'Signal Log': { cat:'DATA', color:'#00d4aa', desc:'Complete log of all signals generated. Includes bets taken, skipped signals (low confidence or macro block), and no-bet classifications. Use filters to drill down.' },
  };

  window.showChartInfo = function(title) {
    const info = window.CHART_INFO[title];
    if (!info) return;
    const titleEl = document.getElementById('imTitle');
    const catEl   = document.getElementById('imCat');
    const bodyEl  = document.getElementById('imBody');
    if (titleEl) titleEl.textContent = title;
    if (catEl)   { catEl.textContent = info.cat; catEl.style.setProperty('--im-color', info.color); }
    if (bodyEl)  bodyEl.textContent  = info.desc;
    modal.style.setProperty('--im-color', info.color);
    // Center positioning
    modal.style.left      = '50%';
    modal.style.top       = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.classList.add('visible');
  };

  // Hover tooltip: segue il cursore, si mostra su src-chip e kpi
  let _ttEl = null;
  document.addEventListener('mousemove', function(e) {
    const chip = e.target.closest('.src-chip');
    const kpi  = e.target.closest('.kpi');
    const newEl = chip || kpi || null;
    if (newEl !== _ttEl) {
      _ttEl = newEl;
      if (!newEl) { hideModal(); return; }
      if (chip) {
        const name = chip.querySelector('.src-name')?.textContent.trim();
        if (name && SOURCES_INFO[name]) showModal(e, name, SOURCES_INFO[name]);
        else hideModal();
      } else {
        const label = kpi.querySelector('.kpi-label');
        if (label) {
          const key = Object.keys(KPI_INFO).find(k => label.textContent.includes(k));
          if (key) showModal(e, key, KPI_INFO[key]); else hideModal();
        } else hideModal();
      }
    } else if (_ttEl) {
      // Aggiorna posizione seguendo il cursore
      const pad = 12;
      let x = e.clientX + pad, y = e.clientY + pad;
      if (x + 340 > window.innerWidth)  x = e.clientX - 340;
      if (y + 160 > window.innerHeight) y = e.clientY - 140;
      modal.style.left = x + 'px';
      modal.style.top  = y + 'px';
    }
  });
  // Click per mobile (tap = show, tap altrove = hide)
  document.addEventListener('click', function(e) {
    const chip = e.target.closest('.src-chip');
    const kpi  = e.target.closest('.kpi');
    if (chip) {
      const name = chip.querySelector('.src-name')?.textContent.trim();
      if (name && SOURCES_INFO[name]) { showModal(e, name, SOURCES_INFO[name]); e.stopPropagation(); return; }
    }
    if (kpi) {
      const label = kpi.querySelector('.kpi-label');
      if (label) {
        const key = Object.keys(KPI_INFO).find(k => label.textContent.includes(k));
        if (key) { showModal(e, key, KPI_INFO[key]); e.stopPropagation(); return; }
      }
    }
    hideModal();
  });
  document.addEventListener('scroll', hideModal, { passive: true });
})();

// ‚îÄ‚îÄ AI FEEDS carousel ‚Äî infinite scroll, mouse drag + touch (all screen sizes) ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
  const strip = document.querySelector('.sources-strip');
  const list  = document.querySelector('.sources-list');
  if (!strip || !list) return;

  // Duplicate chips for seamless loop
  list.innerHTML += list.innerHTML;

  const SPEED = 0.4; // px per frame
  let paused      = false;
  let offsetX     = 0;
  let halfW       = 0;
  let touchStartX = 0, touchBase = 0;
  let mouseDown   = false, mouseStartX = 0, mouseBase = 0;

  function tick() {
    if (!paused) {
      offsetX -= SPEED;
      if (offsetX <= -halfW) offsetX += halfW;
    }
    list.style.transform = 'translateX(' + offsetX + 'px)';
    requestAnimationFrame(tick);
  }

  // Touch swipe
  strip.addEventListener('touchstart', function(e) {
    paused = true; touchStartX = e.touches[0].clientX; touchBase = offsetX;
  }, { passive: true });
  strip.addEventListener('touchmove', function(e) {
    var dx = e.touches[0].clientX - touchStartX;
    offsetX = touchBase + dx;
    if (offsetX > 0) offsetX -= halfW;
    if (offsetX <= -halfW) offsetX += halfW;
  }, { passive: true });
  strip.addEventListener('touchend', function() { touchBase = offsetX; paused = false; }, { passive: true });

  // Mouse drag (desktop)
  strip.addEventListener('mousedown', function(e) {
    if (e.target.closest('.src-i-btn')) return;
    mouseDown = true; mouseStartX = e.clientX; mouseBase = offsetX;
    strip.style.cursor = 'grabbing';
    e.preventDefault();
  });
  document.addEventListener('mousemove', function(e) {
    if (!mouseDown) return;
    var dx = e.clientX - mouseStartX;
    offsetX = mouseBase + dx;
    if (offsetX > 0) offsetX -= halfW;
    if (offsetX <= -halfW) offsetX += halfW;
  });
  document.addEventListener('mouseup', function() {
    if (!mouseDown) return;
    mouseDown = false; mouseBase = offsetX;
    strip.style.cursor = '';
  });

  // Pause auto-scroll on hover (not during drag)
  strip.addEventListener('mouseenter', function() { if (!mouseDown) paused = true; });
  strip.addEventListener('mouseleave', function() { paused = false; mouseDown = false; strip.style.cursor = ''; });

  requestAnimationFrame(function() {
    halfW = list.scrollWidth / 2;
    requestAnimationFrame(tick);
  });
});

// ‚îÄ‚îÄ AI Cube: touch + mouse rotation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const cube  = document.getElementById('aiCube');
  const scene = document.getElementById('cubeScene');
  if (!cube || !scene) return;

  // Prendi controllo: disabilita CSS animation, usiamo RAF
  cube.style.animation = 'none';
  scene.style.cursor = 'grab';

  let rotX = 15, rotY = 0;   // rotazione corrente in gradi
  let dragging  = false;
  let startX    = 0, startY = 0;
  let baseRX    = 15, baseRY = 0;

  // Auto-rotate: ~stessa velocit√† dell'animazione CSS originale (9s = 40¬∞/s)
  const AUTO_SPEED = 40 / 60; // gradi per frame a 60fps

  function tick() {
    if (!dragging) {
      rotX += AUTO_SPEED;
      rotY += AUTO_SPEED;
    }
    cube.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
    requestAnimationFrame(tick);
  }

  // ‚îÄ‚îÄ Touch (mobile) ‚îÄ‚îÄ
  scene.addEventListener('touchstart', function(e) {
    dragging = true;
    startX   = e.touches[0].clientX;
    startY   = e.touches[0].clientY;
    baseRX   = rotX;
    baseRY   = rotY;
  }, { passive: true });

  scene.addEventListener('touchmove', function(e) {
    const dx = e.touches[0].clientX - startX;
    const dy = e.touches[0].clientY - startY;
    rotX = baseRX - dy * 0.6;
    rotY = baseRY + dx * 0.6;
  }, { passive: true });

  scene.addEventListener('touchend', function() {
    dragging = false;
  }, { passive: true });

  // ‚îÄ‚îÄ Mouse (desktop) ‚îÄ‚îÄ
  scene.addEventListener('mousedown', function(e) {
    dragging = true;
    startX   = e.clientX;
    startY   = e.clientY;
    baseRX   = rotX;
    baseRY   = rotY;
    scene.style.cursor = 'grabbing';
    e.preventDefault();
  });

  window.addEventListener('mousemove', function(e) {
    if (!dragging) return;
    var dx = e.clientX - startX;
    var dy = e.clientY - startY;
    rotX = baseRX - dy * 0.6;
    rotY = baseRY + dx * 0.6;
  });

  window.addEventListener('mouseup', function() {
    if (!dragging) return;
    dragging = false;
    scene.style.cursor = 'grab';
  });

  requestAnimationFrame(tick);
})();

// ‚îÄ‚îÄ TASK 2: Story Highlights sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncStoryHighlights() {
  const map = [
    { src: 'kpiWinRate',  dst: 'storyWR' },
    { src: 'kpiPnl',      dst: 'storyROI' },
    { src: 'kpiFG',       dst: 'storyFG' },
    { src: 'kpiBets',     dst: 'storyBets' },
    { src: 'kpiDrawdown', dst: 'storyDD' },
    { src: 'statStreak',  dst: 'storyStreak' },
  ];
  map.forEach(function(item) {
    const srcEl = document.getElementById(item.src);
    const dstEl = document.getElementById(item.dst);
    if (srcEl && dstEl) {
      const val = srcEl.textContent.trim();
      dstEl.textContent = val || '‚Äî';
    }
  });
}
setInterval(syncStoryHighlights, 3000);

// ‚îÄ‚îÄ TASK 3: Mobile Primary Grid sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncMobilePrimary() {
  // 1. Bot Status
  const botTextEl  = document.getElementById('botStatusText');
  const botSubEl   = document.getElementById('botStatusDetail');
  const mpBotStatus = document.getElementById('mpBotStatus');
  const mpBotSub    = document.getElementById('mpBotSub');
  if (botTextEl && mpBotStatus) {
    const txt = botTextEl.textContent || '';
    mpBotStatus.textContent = txt.includes('ALIVE') ? '‚úÖ' : '‚ö†Ô∏è';
    if (botSubEl && mpBotSub) {
      mpBotSub.textContent = botSubEl.textContent || '';
    }
  }

  // 2. Today PnL
  const mpTodayPnl = document.getElementById('mpTodayPnl');
  const mpTodaySub = document.getElementById('mpTodaySub');
  if (mpTodayPnl && allData && allData.length) {
    const todayStr = new Date().toISOString().slice(0, 10);
    const todayBets = allData.filter(function(d) {
      return d.bet_taken === true && d.pnl_usd !== null && d.created_at && d.created_at.slice(0, 10) === todayStr;
    });
    const todayPnl = todayBets.reduce(function(s, d) { return s + parseFloat(d.pnl_usd || 0); }, 0);
    const sign = todayPnl >= 0 ? '+' : '';
    mpTodayPnl.textContent = sign + '$' + todayPnl.toFixed(2);
    mpTodayPnl.style.color = todayPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
    if (mpTodaySub) mpTodaySub.textContent = todayBets.length + ' bet' + (todayBets.length !== 1 ? 's' : '') + ' today';
  }

  // 3. Last Signal from signalTable first row
  const mpLastDir    = document.getElementById('mpLastDir');
  const mpLastConf   = document.getElementById('mpLastConf');
  const mpLastResult = document.getElementById('mpLastResult');
  const mpLastTime   = document.getElementById('mpLastTime');
  if (mpLastDir && allData && allData.length) {
    const first = allData[0];
    if (first) {
      const dir = first.direction || '‚Äî';
      mpLastDir.textContent = dir === 'UP' ? '‚ñ≤ UP' : dir === 'DOWN' ? '‚ñº DOWN' : '‚Äî';
      mpLastDir.style.color = dir === 'UP' ? 'var(--accent)' : dir === 'DOWN' ? 'var(--danger)' : 'var(--muted)';
      if (mpLastConf) mpLastConf.textContent = 'conf ' + (first.confidence ? Math.round(parseFloat(first.confidence) * 100) + '%' : '‚Äî');
      if (mpLastResult) {
        if (first.correct === true) {
          mpLastResult.textContent = 'WIN';
          mpLastResult.style.color = 'var(--accent)';
        } else if (first.correct === false) {
          mpLastResult.textContent = 'LOSS';
          mpLastResult.style.color = 'var(--danger)';
        } else if (first.bet_taken) {
          mpLastResult.textContent = 'OPEN';
          mpLastResult.style.color = 'var(--warn)';
        } else {
          mpLastResult.textContent = first.classification || '‚Äî';
          mpLastResult.style.color = 'var(--muted)';
        }
      }
      if (mpLastTime && first.created_at) {
        const d = new Date(first.created_at);
        mpLastTime.textContent = d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }) + ' ' + d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
      }
    }
  }
}
setInterval(syncMobilePrimary, 5000);

// ‚îÄ‚îÄ TASK 5: Mobile Bet List rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMobileBetList(data) {
  const container = document.getElementById('mobileBetList');
  if (!container) return;
  const dirFilter   = document.getElementById('filterDir').value;
  const classFilter = document.getElementById('filterClass').value;
  const filtered = data.filter(function(d) {
    if (dirFilter   !== 'ALL' && d.direction      !== dirFilter)   return false;
    if (classFilter !== 'ALL' && d.classification !== classFilter) return false;
    return true;
  }).slice(0, 80);

  if (!filtered.length) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:11px;letter-spacing:1px">NO DATA</div>';
    return;
  }

  container.innerHTML = filtered.map(function(d) {
    const dir      = d.direction || '‚Äî';
    const dirClass = dir === 'UP' ? 'up' : dir === 'DOWN' ? 'down' : 'neutral';
    const dirText  = dir === 'UP' ? '‚ñ≤ UP' : dir === 'DOWN' ? '‚ñº DOWN' : '‚Äî';
    const confRaw  = d.confidence ? parseFloat(d.confidence) : 0;
    const confPct  = confRaw ? Math.round(confRaw * 100) : 0;
    const isBet    = d.classification === 'BET' && d.bet_taken;

    // Status chip
    let statusText, statusClass;
    if (d.correct === true && isBet)       { statusText = '‚úì WIN';    statusClass = 'win';  }
    else if (d.correct === false && isBet) { statusText = '‚úï LOSS';   statusClass = 'loss'; }
    else if (isBet)                        { statusText = '‚è≥ OPEN';  statusClass = 'open'; }
    else if (d.classification === 'ALERT') { statusText = '‚ö° ALERT'; statusClass = 'alert'; }
    else                                   { statusText = d.classification || 'SKIP'; statusClass = 'skip'; }

    // Card class
    let cardClass = 'mbet-card';
    if (d.correct === true && isBet)       cardClass += ' win';
    else if (d.correct === false && isBet) cardClass += ' loss';
    else if (isBet && !d.correct)          cardClass += ' open-bet';
    else                                   cardClass += ' nobet';

    // PnL
    const pnl     = (d.pnl_usd !== null && d.pnl_usd !== undefined) ? parseFloat(d.pnl_usd) : null;
    const pnlText = pnl !== null ? (pnl >= 0 ? '+' : '') + '$' + Math.abs(pnl).toFixed(2) : null;
    const pnlClass = pnl !== null ? (pnl >= 0 ? 'pos' : 'neg') : '';

    // Time
    let timeStr = '‚Äî';
    if (d.created_at) {
      const dt = new Date(d.created_at);
      timeStr = dt.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit'})
               + ' ' + dt.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
    }

    // Entry price
    const entryPrice = parseFloat(d.entry_fill_price || d.btc_price_entry || 0);
    const entryText  = entryPrice > 0 ? '$' + Math.round(entryPrice).toLocaleString('en-US') : null;

    // Bet size
    const sizeRaw  = parseFloat(d.bet_size || 0);
    const sizeText = sizeRaw > 0 ? sizeRaw.toFixed(3) + ' ‚Çø' : null;

    // Duration
    let durText = null;
    if (d.duration_minutes && parseFloat(d.duration_minutes) > 0) {
      const mins = Math.round(parseFloat(d.duration_minutes));
      durText = mins < 60 ? mins + 'm' : Math.round(mins/60) + 'h';
    }

    // XGB alignment chip
    let xgbChip = '';
    if (d.xgb_direction) {
      const agree = d.xgb_direction === dir;
      xgbChip = '<span class="mbet-chip ' + (agree ? 'agree' : 'disagree') + '">XGB '
              + (agree ? '‚úì' : '‚úó') + ' ' + d.xgb_direction + '</span>';
    }

    // MTF chip
    let mtfChip = '';
    if (d.mtf_consensus) {
      const mtf = d.mtf_consensus.replace('MTF_','').replace('_CONSENSUS','');
      const mtfClass = mtf.includes('BULL') ? 'bull' : mtf.includes('BEAR') ? 'bear' : '';
      mtfChip = '<span class="mbet-chip ' + mtfClass + '">MTF ' + mtf + '</span>';
    }

    // Pyramid chip
    const pyramidChip = (d.pyramid_count > 0)
      ? '<span class="mbet-chip pyra">‚ñ≤ PYR √ó' + d.pyramid_count + '</span>'
      : '';

    // ‚îÄ‚îÄ Build HTML ‚îÄ‚îÄ
    // Row 1: header
    let html = '<div class="' + cardClass + '">';
    html += '<div class="mbet-header">'
      + '<span class="mbet-dir ' + dirClass + '">' + dirText + '</span>'
      + '<span class="mbet-id">#' + d.id + '</span>'
      + '<span class="mbet-time">' + timeStr + '</span>'
      + '<span class="mbet-status-chip ' + statusClass + '">' + statusText + '</span>'
      + '</div>';

    // Row 2: confidence bar
    html += '<div class="mbet-conf-row">'
      + '<div class="mbet-conf-track"><div class="mbet-conf-fill ' + dirClass + '" style="width:' + confPct + '%"></div></div>'
      + '<span class="mbet-conf-pct">' + (confPct ? confPct + '%' : '‚Äî') + '</span>'
      + '</div>';

    // Row 3: details (bets only, or if we have entry price)
    if (isBet || entryText) {
      const items = [];
      if (entryText) items.push({ label:'ENTRY', val: entryText, cls: '' });
      if (pnlText)   items.push({ label:'PNL',   val: pnlText,   cls: pnlClass });
      else if (sizeText) items.push({ label:'SIZE', val: sizeText, cls: 'muted' });
      if (durText)   items.push({ label:'DURATION', val: durText, cls: 'muted' });

      if (items.length) {
        html += '<div class="mbet-details">';
        items.forEach(function(it) {
          html += '<div class="mbet-detail-item">'
            + '<span class="mbet-detail-label">' + it.label + '</span>'
            + '<span class="mbet-detail-val ' + it.cls + '">' + it.val + '</span>'
            + '</div>';
        });
        html += '</div>';
      }
    }

    // Row 4: chips (XGB + MTF + pyramid) ‚Äî only when something to show
    const chipsHtml = xgbChip + mtfChip + pyramidChip;
    if (chipsHtml) {
      html += '<div class="mbet-chips">' + chipsHtml + '</div>';
    }

    html += '</div>';
    return html;
  }).join('');
}

/* ‚îÄ‚îÄ KPI TOOLTIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const KPI_DESCRIPTIONS = {
  kpiPrice:           { label: 'BTC Price',        desc: 'Current BTC price at last bet entry.' },
  kpiTotal:           { label: 'Total Signals',    desc: 'Total signals generated by the AI system (LLM + XGB).' },
  kpiAccuracy:        { label: 'Accuracy',         desc: 'Model accuracy on all closed signals.' },
  kpiPnl:             { label: 'Total PnL',        desc: 'Total realized PnL across all real bets (excluding fees).' },
  kpiRoi:             { label: 'Session ROI',      desc: 'Return on investment since session start (2026-02-24, $100 capital).' },
  kpiWinRate:         { label: 'Win Rate',         desc: 'Win rate on executed bets (BET classification only).' },
  kpiWrNoBet:         { label: 'Signal WR',         desc: 'Win rate on ALL verified predictions ‚Äî bets + skipped + no-bet. Broader than Win Rate which counts executed bets only.' },
  kpiFG:              { label: 'Fear & Greed',     desc: 'Fear & Greed Index (0 = Extreme Fear, 100 = Extreme Greed).' },
  kpiBets:            { label: 'Bets Taken',       desc: 'Number of bets taken out of total signals.' },
  kpiDrawdown:        { label: 'Max Drawdown',     desc: 'Worst single trade loss.' },
  kpiExpectancyVal:   { label: 'Expectancy',       desc: 'Expected value per bet = Total PnL / closed bets.' },
  kpiProfitFactorVal: { label: 'Profit Factor',    desc: 'Profit Factor = Gross Wins / Gross Losses (>1.5 is good).' }
};

var _kpiTipOpen = false;
var _kpiTipTimeout = null;

function _positionTooltip(tip, anchor) {
  var rect = anchor.getBoundingClientRect();
  var tipW = 220;
  tip.style.display = 'block';
  var tipH = tip.offsetHeight;
  var left = rect.left;
  var top  = rect.bottom + 8;
  if (left + tipW > window.innerWidth - 8)  left = window.innerWidth - tipW - 8;
  if (left < 8) left = 8;
  if (top + tipH > window.innerHeight - 8)  top = rect.top - tipH - 8;
  tip.style.left = left + 'px';
  tip.style.top  = top  + 'px';
}

function openKpiModal(kpiId, anchorEl) {
  var meta = KPI_DESCRIPTIONS[kpiId];
  if (!meta) return;
  var valEl = document.getElementById(kpiId);
  var val   = valEl ? valEl.textContent.trim() : '‚Äî';
  _showTooltip(anchorEl || document.getElementById(kpiId), meta.label, val, meta.desc);
}

function _showTooltip(anchor, label, val, desc) {
  if (_kpiTipTimeout) clearTimeout(_kpiTipTimeout);
  var tip = document.getElementById('kpiTooltip');
  tip.classList.remove('kt-visible');
  var labelEl = label ? '<div class="kt-label">' + label + '</div>' : '';
  var valEl   = val   ? '<div class="kt-val">'   + val   + '</div>' : '';
  var descEl  = desc  ? '<div class="kt-desc">'  + desc  + '</div>' : '';
  tip.innerHTML = labelEl + valEl + descEl;
  _positionTooltip(tip, anchor);
  requestAnimationFrame(function() { requestAnimationFrame(function() { tip.classList.add('kt-visible'); }); });
  _kpiTipOpen = true;
}

function closeKpiModal() {
  var tip = document.getElementById('kpiTooltip');
  tip.classList.remove('kt-visible');
  _kpiTipTimeout = setTimeout(function() { tip.style.display = 'none'; }, 150);
  _kpiTipOpen = false;
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeKpiModal();
});

document.addEventListener('click', function(e) {
  if (!_kpiTipOpen) return;
  var tip = document.getElementById('kpiTooltip');
  if (!tip.contains(e.target) && !e.target.closest('[data-tip]') && !e.target.closest('.kpi-grid .kpi')) {
    closeKpiModal();
  }
});

/* KPI grid tiles */
document.querySelectorAll('.kpi-grid .kpi').forEach(function(tile) {
  tile.addEventListener('click', function(e) {
    e.stopPropagation();
    var valEl = tile.querySelector('[id^="kpi"]');
    if (!valEl) return;
    var kpiId = valEl.id;
    var meta = KPI_DESCRIPTIONS[kpiId];
    if (!meta) return;
    var val = valEl.textContent.trim();
    /* toggle: click same tile again = close */
    var tip = document.getElementById('kpiTooltip');
    if (_kpiTipOpen && tip.querySelector('.kt-label') && tip.querySelector('.kt-label').textContent === meta.label) {
      closeKpiModal(); return;
    }
    _showTooltip(tile, meta.label, val, meta.desc);
  });
});

/* Generic data-tip elements */
document.addEventListener('click', function(e) {
  var el = e.target.closest('[data-tip]');
  if (!el) return;
  e.stopPropagation();
  var tip = document.getElementById('kpiTooltip');
  var title = el.dataset.tipTitle || el.textContent.trim();
  var desc  = el.dataset.tip || '';
  if (_kpiTipOpen && tip.querySelector('.kt-label') && tip.querySelector('.kt-label').textContent === title) {
    closeKpiModal(); return;
  }
  _showTooltip(el, title, '', desc);
}, true);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WAR ROOM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var _warRoomClockInterval = null;

function toggleWarRoom(btn) {
  var body = document.body;
  var active = body.classList.toggle('war-room');
  btn.classList.toggle('wr-active', active);
  localStorage.setItem('warRoomActive', active ? '1' : '0');
  trackEvent('war_room_toggle', { state: active ? 'on' : 'off' });
  if (active) {
    startWarRoomClock();
  } else {
    stopWarRoomClock();
  }
}

function startWarRoomClock() {
  stopWarRoomClock();
  function tick() {
    var now = new Date();
    var h = String(now.getUTCHours()).padStart(2,'0');
    var m = String(now.getUTCMinutes()).padStart(2,'0');
    var s = String(now.getUTCSeconds()).padStart(2,'0');
    var el = document.getElementById('warRoomClock');
    if (el) el.textContent = h + ':' + m + ':' + s;
  }
  tick();
  _warRoomClockInterval = setInterval(tick, 1000);
}

function stopWarRoomClock() {
  if (_warRoomClockInterval) { clearInterval(_warRoomClockInterval); _warRoomClockInterval = null; }
}

// Restore War Room on page load
(function() {
  if (localStorage.getItem('warRoomActive') === '1') {
    document.body.classList.add('war-room');
    var btn = document.getElementById('warRoomToggle');
    if (btn) btn.classList.add('wr-active');
    startWarRoomClock();
  }
  // Hide Telegram CTA if dismissed
  if (localStorage.getItem('tgCtaDismissed') === '1') {
    var _tgBanner = document.getElementById('tgCtaBanner');
    if (_tgBanner) _tgBanner.style.display = 'none';
  }
})();

function dismissTgCta() {
  var el = document.getElementById('tgCtaBanner');
  if (el) el.style.display = 'none';
  localStorage.setItem('tgCtaDismissed', '1');
}

// ‚îÄ‚îÄ RAILWAY BUDGET ‚Äî dynamic days left & credits ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  var daysEl    = document.getElementById('rlyDays');
  var creditsEl = document.getElementById('rlyCredits');
  var today     = new Date();
  today.setHours(0, 0, 0, 0);

  if (daysEl && daysEl.dataset.nextBilling) {
    var billing   = new Date(daysEl.dataset.nextBilling + 'T00:00:00');
    var daysLeft  = Math.ceil((billing - today) / 86400000);
    daysEl.textContent = daysLeft > 0 ? daysLeft : '‚Äî';
    if (daysLeft <= 3)       daysEl.style.color = 'var(--danger)';
    else if (daysLeft <= 7)  daysEl.style.color = 'var(--warn)';
  }

  if (creditsEl && creditsEl.dataset.creditsBase) {
    var base      = parseFloat(creditsEl.dataset.creditsBase);
    var updated   = new Date(creditsEl.dataset.creditsUpdated + 'T00:00:00');
    var burn      = parseFloat(creditsEl.dataset.burnPerDay || '0.04');
    var elapsed   = Math.max(0, Math.floor((today - updated) / 86400000));
    var remaining = Math.max(0, base - elapsed * burn).toFixed(2);
    creditsEl.textContent = '$' + remaining;
    if (parseFloat(remaining) < 1.0) creditsEl.style.color = 'var(--danger)';
    else if (parseFloat(remaining) < 2.0) creditsEl.style.color = 'var(--warn)';
  }
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIGNAL LOG FILTERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var _signalFilters = { type: 'all', outcome: 'all', direction: 'all' };
var _signalCurrentData = [];
var _origRenderTable = null; // assegnato in DOMContentLoaded

function setSignalFilter(btn, group) {
  // Update active button in group
  var groupBtns = document.querySelectorAll('.filter-btn[data-filter="' + group + '"]');
  groupBtns.forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  _signalFilters[group] = btn.dataset.value;
  applySignalFilters();
}

function applySignalFilters() {
  if (!_signalCurrentData || !_signalCurrentData.length) return;
  var search = (document.getElementById('signal-search') || {}).value || '';
  search = search.toLowerCase().replace(/^[üîç\s]+/, '').trim();

  var filtered = _signalCurrentData.filter(function(d) {
    // Type filter
    var type = _signalFilters.type;
    if (type !== 'all') {
      // bet  = row was actually executed as a real bet
      if (type === 'bet'   && d.bet_taken !== true)                                               return false;
      // skip = explicitly classified SKIP or NO_BET rows where bet was not taken
      if (type === 'skip'  && !(d.classification === 'SKIP' || (d.classification === 'NO_BET' && !d.bet_taken))) return false;
      // nobet = any row where no real bet was placed
      if (type === 'nobet' && d.bet_taken)                                                         return false;
    }
    // Outcome filter
    var outcome = _signalFilters.outcome;
    if (outcome !== 'all') {
      if (outcome === 'win'  && d.correct !== true)                               return false;
      if (outcome === 'loss' && d.correct !== false)                              return false;
      if (outcome === 'open' && !(d.bet_taken && d.correct === null))             return false;
    }
    // Direction filter
    var dir = _signalFilters.direction;
    if (dir !== 'all') {
      var dDir = (d.direction || d.prediction || '').toUpperCase();
      if (dir === 'up'   && dDir !== 'UP')   return false;
      if (dir === 'down' && dDir !== 'DOWN') return false;
    }
    // Search
    if (search) {
      var haystack = [
        String(d.id || ''),
        String(d.confidence || ''),
        String(d.classification || ''),
        String(d.prediction || ''),
        String(d.direction || '')
      ].join(' ').toLowerCase();
      if (haystack.indexOf(search) === -1) return false;
    }
    return true;
  });

  renderTableFiltered(filtered);
}

function renderTableFiltered(filtered) {
  // Chiama _origRenderTable direttamente per evitare la ricorsione:
  // renderTable (patchata) ‚Üí applySignalFilters ‚Üí renderTableFiltered ‚Üí renderTable ‚Üí loop
  if (!_origRenderTable) return;
  var dirEl   = document.getElementById('filterDir');
  var classEl = document.getElementById('filterClass');
  var origDir   = dirEl   ? dirEl.value   : 'ALL';
  var origClass = classEl ? classEl.value : 'ALL';
  if (dirEl)   dirEl.value   = 'ALL';
  if (classEl) classEl.value = 'ALL';
  _origRenderTable(filtered);
  if (dirEl)   dirEl.value   = origDir;
  if (classEl) classEl.value = origClass;
}

// Hook into the existing renderAll to capture data for our filters
var _origRenderAll = typeof renderAll === 'function' ? renderAll : null;
// Override after DOMContentLoaded since renderAll is defined in the same script
document.addEventListener('DOMContentLoaded', function() {
  // Chart info click handlers
  document.querySelectorAll('.panel-title').forEach(function(el) {
    if (window.CHART_INFO && window.CHART_INFO[el.textContent.trim()]) {
      el.style.cursor = 'pointer';
      el.title = 'Click for info';
      el.addEventListener('click', function() { window.showChartInfo(el.textContent.trim()); });
    }
  });
});

document.addEventListener('DOMContentLoaded', function() {
  // Popola launchd tasks immediatamente (non solo al tab switch)
  renderLaunchdTasks();
  // Patch renderTable per catturare _signalCurrentData e applicare i filtri pill
  _origRenderTable = window.renderTable;
  if (_origRenderTable) {
    window.renderTable = function(data) {
      // Aggiorna il dataset completo (MAI sovrascrivere con dati gi√† filtrati)
      _signalCurrentData = data;
      var search = (document.getElementById('signal-search') || {}).value || '';
      search = search.toLowerCase().replace(/^[üîç\s]+/, '').trim();
      var hasFilter = (_signalFilters.type !== 'all' || _signalFilters.outcome !== 'all' || _signalFilters.direction !== 'all' || search !== '');
      if (hasFilter) {
        // applySignalFilters ‚Üí renderTableFiltered ‚Üí _origRenderTable (nessuna ricorsione)
        applySignalFilters();
      } else {
        _origRenderTable(data);
      }
    };
  }
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   WELCOME INFOBOX ‚Äî show on first visit, re-openable via "?" button
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
(function() {
  var dismissed = localStorage.getItem('introDismissed');
  var h = document.getElementById('introHero');
  var reopenBtn = document.getElementById('introReopenBtn');
  if (dismissed) {
    if (h) { h.style.display = 'none'; h.setAttribute('aria-hidden', 'true'); }
    if (reopenBtn) reopenBtn.style.display = '';
  }
  // No auto-dismiss ‚Äî user should read and close manually
})();

function dismissIntro() {
  var h = document.getElementById('introHero');
  var reopenBtn = document.getElementById('introReopenBtn');
  if (!h) return;
  localStorage.setItem('introDismissed', '1');
  h.style.transition = 'opacity 0.35s, max-height 0.4s, padding 0.4s, margin 0.4s';
  h.style.opacity = '0';
  h.style.maxHeight = '0';
  h.style.padding = '0';
  h.style.overflow = 'hidden';
  if (reopenBtn) { reopenBtn.style.opacity = '0'; reopenBtn.style.transition = 'opacity 0.3s'; }
  setTimeout(function() {
    if (h) { h.style.display = 'none'; h.setAttribute('aria-hidden', 'true'); h.classList.remove('intro-overlay'); }
    document.body.classList.remove('intro-open');
    if (reopenBtn) { reopenBtn.style.display = ''; reopenBtn.style.opacity = '1'; reopenBtn.textContent = '? ABOUT'; reopenBtn.onclick = showIntro; }
    // First-time tutorial
    if (typeof startTutorial === 'function' && localStorage.getItem('btcp_tutorial_done') !== '1') {
      setTimeout(startTutorial, 300);
    }
  }, 420);
}

function showIntro() {
  var h = document.getElementById('introHero');
  var reopenBtn = document.getElementById('introReopenBtn');
  if (!h) return;
  localStorage.removeItem('introDismissed');
  document.documentElement.classList.remove('intro-dismissed');
  h.classList.add('intro-overlay');
  document.body.classList.add('intro-open');
  h.style.display = '';
  h.removeAttribute('aria-hidden');
  h.style.transition = 'none';
  h.style.opacity = '0';
  h.style.maxHeight = '';
  h.style.padding = '';
  h.style.overflow = '';
  if (reopenBtn) { reopenBtn.style.display = ''; reopenBtn.textContent = '‚úï CLOSE'; reopenBtn.onclick = dismissIntro; }
  void h.offsetHeight;
  h.style.transition = 'opacity 0.28s';
  h.style.opacity = '1';
  if (allData && allData.length) populateIntroHero(allData);
}

function populateIntroHero(data) {
  // data = allData array from /signals
  if (!data || !data.length) return;
  var closed = data.filter(function(d) { return d.bet_taken && d.correct !== null && d.correct !== undefined && d.pnl_usd !== null; });
  var wins = closed.filter(function(d) { return d.correct === true; });
  var wrEl = document.getElementById('introWR');
  var pnlEl = document.getElementById('introPnL');
  var trEl = document.getElementById('introTrades');
  var wr = closed.length ? Math.round(wins.length / closed.length * 100) + '%' : null;
  var totalPnl = closed.reduce(function(s,d) { return s + parseFloat(d.pnl_usd||0); }, 0);
  var pnlStr = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
  if (wrEl && wr) wrEl.textContent = wr;
  if (trEl) trEl.textContent = closed.length;
  if (pnlEl) {
    pnlEl.textContent = pnlStr;
    pnlEl.style.color = totalPnl >= 0 ? 'inherit' : 'var(--danger)';
  }
  // Cache in localStorage ‚Äî instant display on next page load (no flash of "‚Äî")
  if (closed.length) {
    try {
      localStorage.setItem('_introKpi', JSON.stringify({ wr: wr, pnl: pnlStr, trades: closed.length, ts: Date.now() }));
    } catch(e) {}
  }
}
// Restore intro KPIs from cache immediately ‚Äî runs before API responds
(function() {
  try {
    var c = JSON.parse(localStorage.getItem('_introKpi') || 'null');
    if (c && (Date.now() - c.ts) < 86400000) { // max 24h stale
      var w = document.getElementById('introWR');
      var p = document.getElementById('introPnL');
      var t = document.getElementById('introTrades');
      if (w && c.wr) w.textContent = c.wr;
      if (p && c.pnl) p.textContent = c.pnl;
      if (t && c.trades !== undefined) t.textContent = c.trades;
    }
  } catch(e) {}
})();

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   MINI STATUS BAR ‚Äî Agents + Bot + Live
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
var _msbLastSignalTs = null;

function _msbSet(dotId, txtId, color, txt) {
  var d = document.getElementById(dotId);
  var t = document.getElementById(txtId);
  if (d) d.className = 'status-dot ' + color;
  if (t) { t.textContent = '(' + txt + ')'; t.className = 'msb-stxt msb-stxt-' + color; }
}
function updateMiniStatusBar(agentsData, railwayOk) {
  _msbSet('statusRailway', 'stxtRailway', railwayOk ? 'green' : 'red', railwayOk ? 'OK' : 'ERR');
  var unknownDots = ['statusWf01a','statusWf01b','statusWf02','statusWf08',
                     'statusWf07','statusWf09a','statusWf06'];
  var unknownTxts = ['stxtWf01a','stxtWf01b','stxtWf02','stxtWf08',
                     'stxtWf07','stxtWf09a','stxtWf06'];
  if (!agentsData || agentsData.status !== 'ok') {
    var c = railwayOk ? 'yellow' : 'red', t = railwayOk ? '?' : 'ERR';
    unknownDots.forEach(function(d, i) { _msbSet(d, unknownTxts[i], c, t); });
    return;
  }
  var wfs = agentsData.workflows || [];
  var now = Date.now();
  // Max acceptable staleness per workflow (ms): scheduled workflows stale if not run within 2x period
  var maxStaleness = {
    'statusWf01a': 8  * 60000,  // 01A fires every 6min ‚Üí stale after 8min
    'statusWf01b': 8  * 60000,  // 01B fires per 01A ‚Üí same
    'statusWf08':  10 * 60000,  // 08 fires every 3min ‚Üí stale after 10min
    'statusWf06':  75 * 60000,  // 06 watchdog runs hourly ‚Üí stale after 75min
  };
  var targets = {
    'statusWf01a': { prefixes: ['01A'], txt: 'stxtWf01a' },
    'statusWf01b': { prefixes: ['01B'], txt: 'stxtWf01b' },
    'statusWf02':  { prefixes: ['02'],  txt: 'stxtWf02'  },
    'statusWf08':  { prefixes: ['08'],  txt: 'stxtWf08'  },
    'statusWf07':  { prefixes: ['07'],  txt: 'stxtWf07'  },
    'statusWf09a': { prefixes: ['09A'], txt: 'stxtWf09a' },
    'statusWf06':  { prefixes: ['06'],  txt: 'stxtWf06'  },
  };
  Object.keys(targets).forEach(function(dotId) {
    var cfg = targets[dotId];
    var match = wfs.find(function(wf) {
      return cfg.prefixes.some(function(p) { return (wf.name||'').startsWith(p); });
    });
    if (!match) { _msbSet(dotId, cfg.txt, 'yellow', '?'); return; }
    var isActive = match.active;
    var last = match.last_execution && match.last_execution.status;
    var lastTs = match.last_execution && (match.last_execution.stopped_at || match.last_execution.started_at);
    if (!isActive) { _msbSet(dotId, cfg.txt, 'red', 'OFF'); return; }
    if (last === 'crashed' || last === 'error') { _msbSet(dotId, cfg.txt, 'red', 'ERR'); return; }
    // Staleness check for scheduled workflows
    if (maxStaleness[dotId] && lastTs) {
      try {
        var ageSec = (now - new Date(lastTs).getTime());
        if (ageSec > maxStaleness[dotId]) { _msbSet(dotId, cfg.txt, 'yellow', 'STALE'); return; }
      } catch(e) {}
    }
    if (last === 'success') { _msbSet(dotId, cfg.txt, 'green', 'OK'); }
    else                    { _msbSet(dotId, cfg.txt, 'yellow', '‚Ä¶'); }
  });
}

function tickSignalAge() {
  if (!_msbLastSignalTs) return;
  var el = document.getElementById('msbLastSignal');
  var dot = document.getElementById('statusSignalAge');
  if (!el) return;
  var diffMs = Date.now() - _msbLastSignalTs.getTime();
  var diffMin = Math.floor(diffMs / 60000);
  if (diffMin < 1) { el.textContent = 'just now'; }
  else if (diffMin < 60) { el.textContent = diffMin + 'm ago'; }
  else { el.textContent = Math.floor(diffMin / 60) + 'h ago'; }
  if (dot) {
    dot.className = 'status-dot ' + (diffMin < 15 ? 'green' : diffMin < 30 ? 'yellow' : 'red');
  }
}

function refreshMiniStatusBarLive() {
  /* ‚îÄ‚îÄ /health: bot status, equity, dry-run, Kraken ‚îÄ‚îÄ */
  fetch(CONFIG.RAILWAY_URL + '/health', { signal: AbortSignal.timeout(20000) })
    .then(function(r) { return r.ok ? r.json() : null; })
    .then(function(h) {
      if (!h) return;
      var botDot   = document.getElementById('statusBot');
      var botLabel = document.getElementById('msbBotLabel');
      var krakenDot = document.getElementById('statusKraken');
      var equityEl  = document.getElementById('msbEquityVal');
      var dryDot   = document.getElementById('statusDryRun');
      var dryLabel = document.getElementById('msbDryRunLabel');
      if (botDot && botLabel) {
        if (h.bot_paused) {
          botDot.className = 'status-dot yellow';
          botLabel.textContent = 'PAUSED';
          botLabel.style.color = 'var(--warn)';
        } else {
          botDot.className = 'status-dot green';
          botLabel.textContent = 'RUNNING';
          botLabel.style.color = 'var(--accent)';
        }
      }
      if (equityEl && h.wallet_equity != null) {
        var eq = Number(h.wallet_equity);
        equityEl.textContent = '$' + eq.toFixed(2);
        equityEl.style.color = eq >= 100 ? 'var(--accent)' : 'var(--danger)';
      }
      if (krakenDot) {
        _msbSet('statusKraken', 'stxtKraken', h.wallet_equity > 0 ? 'green' : 'yellow', h.wallet_equity > 0 ? 'OK' : '?');
      }
      if (dryDot && dryLabel) {
        if (h.dry_run) {
          dryDot.className = 'status-dot yellow';
          dryLabel.textContent = 'DRY RUN';
          dryLabel.style.color = 'var(--warn)';
        } else {
          dryDot.className = 'status-dot green';
          dryLabel.textContent = 'LIVE';
          dryLabel.style.color = 'var(--accent)';
        }
      }
      // DB (Supabase) status ‚Äî directly from health response
      if (h.supabase_ok === true)       { _msbSet('statusDB', 'stxtDB', 'green',  'OK');  }
      else if (h.supabase_ok === false) { _msbSet('statusDB', 'stxtDB', 'red',    'ERR'); }
      else                              { _msbSet('statusDB', 'stxtDB', 'yellow', '?');   }
    })
    .catch(function() {
      var d = document.getElementById('statusBot');
      if (d) d.className = 'status-dot red';
      var k = document.getElementById('statusKraken');
      if (k) k.className = 'status-dot red';
      _msbSet('statusDB', 'stxtDB', 'red', 'ERR');
    });

  /* ‚îÄ‚îÄ /signals?limit=1: last prediction age ‚îÄ‚îÄ */
  fetch(CONFIG.RAILWAY_URL + '/signals?limit=1', { signal: AbortSignal.timeout(8000), headers: {'X-API-Key': CONFIG.READ_KEY} })
    .then(function(r) { return r.ok ? r.json() : null; })
    .then(function(data) {
      var signals = (data && data.data) ? data.data : (Array.isArray(data) ? data : null);
      if (signals && signals.length > 0 && signals[0].created_at) {
        _msbLastSignalTs = new Date(signals[0].created_at);
        tickSignalAge();
      }
    })
    .catch(function() {});

  /* ‚îÄ‚îÄ /account-summary: open positions (I-11: shared cache, no duplicate fetch) ‚îÄ‚îÄ */
  getAccountSummary().then(function(data) {
    if (!data) return;
    var openBets = data.open_bets || [];
    var n = openBets.length;
    var posLabel = document.getElementById('msbOpenPosVal');
    var posDot   = document.getElementById('statusOpenPos');
    if (posLabel) posLabel.textContent = n + ' open';
    if (posDot) {
      posDot.className = n > 0 ? 'status-dot green' : 'status-dot';
      if (n > 1) posDot.className = 'status-dot yellow';
    }
  }).catch(function() {});
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   FIX 5 + FIX 6 ‚Äî STAT / TRAINING CLICK-TO-EXPLAIN TOOLTIP
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
// Create tooltip element
(function() {
  var tip = document.createElement('div');
  tip.id = 'statTooltip';
  tip.innerHTML = '<div class="st-title" id="stTipTitle"></div><div id="stTipBody"></div>';
  document.body.appendChild(tip);
})();

function showStatExplain(e, title, desc) {
  e.stopPropagation();
  var tip = document.getElementById('statTooltip');
  document.getElementById('stTipTitle').textContent = title;
  document.getElementById('stTipBody').innerHTML = desc;
  tip.style.display = 'block';
  var pad = 14;
  var x = e.clientX + pad;
  var y = e.clientY + pad;
  if (x + 270 > window.innerWidth) x = e.clientX - 270;
  if (y + 120 > window.innerHeight) y = e.clientY - 100;
  tip.style.left = x + 'px';
  tip.style.top  = y + 'px';
}
document.addEventListener('click', function() {
  var tip = document.getElementById('statTooltip');
  if (tip) tip.style.display = 'none';
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   FIX 4 ‚Äî APPLE WALLET POSITION STACK
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderPositionStack(openBets) {
  var body = document.getElementById('acctPositionBody');
  var tag  = document.getElementById('acctPositionTag');
  if (!body || !openBets || openBets.length < 2) return; // only activate for 2+ open bets
  var layers = openBets.slice(0, 3).map(function(bet, i) {
    var dir = (bet.direction || bet.prediction || '').toUpperCase();
    var conf = bet.confidence ? Math.round(parseFloat(bet.confidence) * 100) + '%' : '‚Äî';
    var ts = bet.created_at ? new Date(bet.created_at).toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'}) : '‚Äî';
    var dirColor = dir === 'UP' ? 'var(--accent)' : 'var(--danger)';
    return '<div class="stack-layer">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">' +
        '<span style="font-size:11px;font-weight:700;color:' + dirColor + '">' + dir + '</span>' +
        '<span style="font-size:9px;color:var(--warn)">' + conf + '</span>' +
      '</div>' +
      '<div style="font-size:9px;color:var(--muted)">' +
        '#' + (bet.id||'‚Äî') + ' ¬∑ ' + ts +
      '</div>' +
    '</div>';
  }).join('');
  body.innerHTML = '<div class="position-stack" id="positionStack" onclick="togglePositionStack(this)">' +
    layers +
    '<div class="stack-expand-hint" id="stackHint">‚ñº ' + openBets.length + ' open ¬∑ tap to expand</div>' +
  '</div>';
  if (tag) {
    tag.textContent = openBets.length + ' OPEN';
    tag.className = 'panel-tag tag-yellow';
    tag.style.cssText = '';
  }
}

function togglePositionStack(el) {
  el.classList.toggle('expanded');
  var hint = document.getElementById('stackHint');
  if (hint) hint.textContent = el.classList.contains('expanded') ? '‚ñ≤ collapse' : '‚ñº ' + document.querySelectorAll('#positionStack .stack-layer').length + ' open ¬∑ tap to expand';
}

/* ‚îÄ‚îÄ Hook into existing renderAll to populate intro hero + stack ‚îÄ‚îÄ */
(function() {
  var _origRefreshFn = window.refresh;
  if (typeof _origRefreshFn === 'function') {
    window.refresh = async function() {
      await _origRefreshFn.apply(this, arguments);
      // After render, populate intro hero + apple wallet
      if (allData && allData.length) {
        populateIntroHero(allData);
        var openBets = allData.filter(function(d) {
          return d.bet_taken && !d.actual_direction && (d.pnl_usd === null || d.pnl_usd === undefined);
        });
        if (openBets.length >= 2) renderPositionStack(openBets);
      }
    };
  }
})();

// Hook into renderAgents to update mini status bar
var _origRenderAgentsFn = window.renderAgents;
if (typeof renderAgents === 'function') {
  var _origRA = renderAgents;
  window.renderAgents = function(data, errorMsg) {
    _origRA.apply(this, arguments);
    updateMiniStatusBar(data, true);
  };
}

// Railway health sets Railway dot green on success
(function() {
  var origFetch = window.fetch;
  // Simpler: piggyback on the existing /health fetch result
  // We'll set Railway dot green after health fetch succeeds (done in health fetch block below)
})();

// After page load: populate all status bar sections
window.addEventListener('load', function() {
  // Railway dot: green immediately (page loaded = API reachable)
  _msbSet('statusRailway', 'stxtRailway', 'green', 'OK');

  // Agents section: n8n workflow status
  fetch(CONFIG.RAILWAY_URL + '/n8n-status', { signal: AbortSignal.timeout(12000) })
    .then(function(r) { return r.ok ? r.json() : null; })
    .then(function(data) { updateMiniStatusBar(data, true); })
    .catch(function() { updateMiniStatusBar(null, true); });

  // Bot + Live sections: health + signals + positions
  refreshMiniStatusBarLive();

  // Refresh live section every 30s
  setInterval(refreshMiniStatusBarLive, 30000);

  // Tick signal age every 10s
  setInterval(tickSignalAge, 10000);
});
</script>
<div id="infoModal">
  <div class="im-title" id="imTitle"></div>
  <div class="im-bar"></div>
  <div class="im-cat" id="imCat"></div>
  <div class="im-body" id="imBody"></div>
</div>
<!-- KPI TOOLTIP -->
<div id="kpiTooltip"></div>

  <!-- GDPR Cookie Banner -->
  <div id="cookieBanner" class="hidden">
    <div class="cookie-text">
      ‚ö° BTCPREDICTOR.IO usa <strong>Google Analytics</strong>, <strong>Microsoft Clarity</strong> (session replay) e <strong>Sentry</strong> (error monitoring) per migliorare il servizio. Nessun dato di trading o finanziario viene condiviso. Nessun cookie di profilazione.
      <div style="margin-top:5px;">
        <a href="/legal" style="color:var(--accent);text-decoration:none;">Privacy Policy ‚Üó</a>
        &nbsp;¬∑&nbsp;
        <a href="https://policies.google.com/privacy" target="_blank" rel="noopener" style="color:var(--muted);text-decoration:none;font-size:9px;">Google</a>
        &nbsp;¬∑&nbsp;
        <a href="https://privacy.microsoft.com/en-us/privacystatement" target="_blank" rel="noopener" style="color:var(--muted);text-decoration:none;font-size:9px;">Microsoft</a>
        &nbsp;¬∑&nbsp;
        <a href="https://sentry.io/privacy/" target="_blank" rel="noopener" style="color:var(--muted);text-decoration:none;font-size:9px;">Sentry</a>
      </div>
    </div>
    <div class="cookie-actions">
      <button class="btn-cookie-decline" onclick="cookieDecline()">RIFIUTA</button>
      <button class="btn-cookie-accept" onclick="cookieAccept()">ACCETTA</button>
    </div>
  </div>

  <script>
  (function() {
    var consent = localStorage.getItem('btcp_ga_consent');
    if (!consent) {
      // Show banner after 1.5s (non-invasive)
      setTimeout(function() {
        var b = document.getElementById('cookieBanner');
        if (b) b.classList.remove('hidden');
      }, 1500);
    }
  })();

  window.cookieAccept = function() {
    localStorage.setItem('btcp_ga_consent', 'granted');
    document.getElementById('cookieBanner').classList.add('hidden');
    // Load GA4
    gtag('consent', 'update', { 'analytics_storage': 'granted' });
    var s = document.createElement('script');
    s.async = true;
    s.src = 'https://www.googletagmanager.com/gtag/js?id=G-K2E2B4FVQ5';
    s.onload = function() {
      gtag('js', new Date());
      gtag('config', 'G-K2E2B4FVQ5');
      gtag('event', 'consent_accepted', { method: 'cookie_banner' });
    };
    document.head.appendChild(s);
    // Load Clarity + Sentry (gated)
    if (window._loadAnalyticsVendors) window._loadAnalyticsVendors();
  };

  window.cookieDecline = function() {
    localStorage.setItem('btcp_ga_consent', 'denied');
    document.getElementById('cookieBanner').classList.add('hidden');
  };
  </script>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TRON/MATRIX NAVIGATION DRAWER
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tronMenuBackdrop" onclick="toggleTronMenu(false)"></div>
  <div id="tronMenuDrawer" role="navigation" aria-label="Main navigation">
    <div class="tron-menu-content">

      <!-- Header -->
      <div class="tron-menu-header">
        <div class="tron-menu-logo">
          BTCPREDICTOR.IO
          <span>AUTONOMOUS TRADING ENGINE</span>
        </div>
        <button class="tron-menu-close" onclick="toggleTronMenu(false)" aria-label="Close menu">‚úï</button>
      </div>

      <!-- Dashboard Views (tabs) -->
      <div class="tron-menu-section">
        <div class="tron-menu-section-label">DASHBOARD VIEWS</div>
        <div class="tron-menu-item" data-tab="dashboard" onclick="tronMenuSwitchTab('dashboard')">
          <span class="tron-menu-item-emoji">üìä</span>
          <span class="tron-menu-item-text">Dashboard</span>
          <span class="tron-menu-item-badge live">LIVE</span>
        </div>
        <div class="tron-menu-item" data-tab="agents" onclick="tronMenuSwitchTab('agents')">
          <span class="tron-menu-item-emoji">ü§ñ</span>
          <span class="tron-menu-item-text">Agents</span>
        </div>
        <div class="tron-menu-item" data-tab="costs" onclick="tronMenuSwitchTab('costs')">
          <span class="tron-menu-item-emoji">üí∞</span>
          <span class="tron-menu-item-text">Costs &amp; Fees</span>
        </div>
        <div class="tron-menu-item" data-tab="training" onclick="tronMenuSwitchTab('training')">
          <span class="tron-menu-item-emoji">üß†</span>
          <span class="tron-menu-item-text">ML Training</span>
        </div>
        <div class="tron-menu-item" data-tab="expectancy" onclick="tronMenuSwitchTab('expectancy')">
          <span class="tron-menu-item-emoji">üìà</span>
          <span class="tron-menu-item-text">Expectancy</span>
        </div>
        <div class="tron-menu-item" data-tab="backtest" onclick="tronMenuSwitchTab('backtest')">
          <span class="tron-menu-item-emoji">üîÅ</span>
          <span class="tron-menu-item-text">Backtest</span>
        </div>
      </div>

      <!-- External Pages -->
      <div class="tron-menu-section">
        <div class="tron-menu-section-label">PAGES</div>
        <a class="tron-menu-item" href="/xgboost-spiegato">
          <span class="tron-menu-item-emoji">‚ö°</span>
          <span class="tron-menu-item-text">Dual-Gate AI</span>
          <span class="tron-menu-item-badge ext">‚Üó</span>
        </a>
        <a class="tron-menu-item" href="/contributors">
          <span class="tron-menu-item-emoji">üé©</span>
          <span class="tron-menu-item-text">I Tanti Padri</span>
          <span class="tron-menu-item-badge ext">‚Üó</span>
        </a>
        <a class="tron-menu-item" href="/investors">
          <span class="tron-menu-item-emoji">üíº</span>
          <span class="tron-menu-item-text">Investors</span>
          <span class="tron-menu-item-badge ext">‚Üó</span>
        </a>
        <a class="tron-menu-item" href="/aureo" style="border-left:2px solid rgba(201,168,76,0.4);">
          <span class="tron-menu-item-emoji">üèõ</span>
          <span class="tron-menu-item-text" style="color:#C9A84C;">AUREO</span>
          <span class="tron-menu-item-badge ext" style="color:#C9A84C;">‚Üó</span>
        </a>
        <a class="tron-menu-item" href="/manifesto">
          <span class="tron-menu-item-emoji">üìú</span>
          <span class="tron-menu-item-text">Manifesto</span>
          <span class="tron-menu-item-badge ext">‚Üó</span>
        </a>
        <a class="tron-menu-item" href="/prevedibilita-perfetta">
          <span class="tron-menu-item-emoji">üéØ</span>
          <span class="tron-menu-item-text">Prevedibilit√† Perfetta</span>
          <span class="tron-menu-item-badge ext">‚Üó</span>
        </a>
      </div>

      <!-- Tech Stack Badges -->
      <div class="tron-menu-section">
        <div class="tron-menu-section-label">TECH STACK</div>
        <div class="tron-badges-grid">
          <div class="tron-badge-chip c-orange">‚Çø BITCOIN</div>
          <div class="tron-badge-chip c-cyan">AI ¬∑ LLM</div>
          <div class="tron-badge-chip c-purple">XGBOOST ML</div>
          <div class="tron-badge-chip c-green">ON-CHAIN ‚úì</div>
          <div class="tron-badge-chip c-cyan">POLYGON PoS</div>
          <div class="tron-badge-chip c-orange">KRAKEN</div>
          <div class="tron-badge-chip c-green">OPEN SOURCE</div>
          <div class="tron-badge-chip c-purple">SUPABASE</div>
          <div class="tron-badge-chip c-cyan">n8n FLOWS</div>
          <div class="tron-badge-chip c-red">REAL MONEY</div>
          <div class="tron-badge-chip c-orange">TELEGRAM BOT</div>
          <div class="tron-badge-chip c-green">DUAL-GATE</div>
          <div class="tron-badge-chip c-cyan">WEB3</div>
          <div class="tron-badge-chip c-purple">BEHAVIORAL ENGINE</div>
        </div>
      </div>

      <!-- Footer -->
      <div class="tron-menu-footer">
        <div>BTCPREDICTOR.IO &nbsp;¬∑&nbsp; v2.0 &nbsp;¬∑&nbsp; $100 USDC LIVE</div>
        <div class="tron-menu-footer-links">
          <a href="https://github.com/mattiacalastri/btc_predictions" target="_blank" rel="noopener" class="tron-menu-footer-link gh" title="Open source on GitHub">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
            GITHUB
          </a>
          <a href="https://polygonscan.com/address/0xe4661F7dB62644951Eb1F9Fd23DB90e647833a55" target="_blank" rel="noopener" class="tron-menu-footer-link poly" title="On-chain audit ‚Äî Polygon PoS">
            <svg width="11" height="11" viewBox="0 0 38.4 33.5" fill="currentColor"><path d="M29 10.2a2.7 2.7 0 00-2.7 0L21 13.4l-3.7 2.1-5.3 3.2a2.7 2.7 0 01-2.7 0L5.5 16a2.7 2.7 0 01-1.3-2.3v-5.2A2.7 2.7 0 015.5 6l3.6-2.1a2.7 2.7 0 012.7 0L15.4 6a2.7 2.7 0 011.3 2.3v3.2l3.7-2.2V6a2.7 2.7 0 00-1.3-2.3L12.2.5a2.7 2.7 0 00-2.7 0L2.6 4a2.7 2.7 0 00-1.3 2.3v7.1A2.7 2.7 0 002.6 16l7 4a2.7 2.7 0 002.7 0l5.3-3 3.7-2.2 5.3-3a2.7 2.7 0 012.7 0l3.6 2.1a2.7 2.7 0 011.3 2.3v5.2a2.7 2.7 0 01-1.3 2.3l-3.5 2a2.7 2.7 0 01-2.7 0L23 23.5a2.7 2.7 0 01-1.3-2.3v-3.2l-3.7 2.2v3.2a2.7 2.7 0 001.3 2.3l7 4a2.7 2.7 0 002.7 0l7-4a2.7 2.7 0 001.3-2.3v-7.1a2.7 2.7 0 00-1.3-2.3z"/></svg>
            POLYGON
          </a>
          <a href="https://t.me/BTCPredictorBot" target="_blank" rel="noopener" class="tron-menu-footer-link tg" title="Telegram Bot ‚Äî live signals">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.023c.242-.213-.054-.333-.373-.12L7.26 13.746l-2.956-.924c-.643-.204-.657-.643.136-.953l11.57-4.461c.537-.194 1.006.131.884.813z"/></svg>
            TELEGRAM
          </a>
        </div>
        <div class="tron-menu-wallet" id="walletCopyBtn" onclick="(function(){navigator.clipboard.writeText('0x7Ac896F18ce52a0520dA49C3129520f7B70d51f0');var c=document.getElementById('walletCopied');c.style.display='inline';setTimeout(function(){c.style.display='none'},1800);})()" title="Copia indirizzo wallet ‚Äî Polygon PoS ¬∑ Donazioni">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="rgba(247,147,26,0.7)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
          <span class="tron-menu-wallet-label">‚¨° WALLET</span>
          <span class="tron-menu-wallet-addr">0x7Ac896F18ce52a0520dA49C3129520f7B70d51f0</span>
          <span class="tron-menu-wallet-copied" id="walletCopied">‚úì COPIATO</span>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       FIRST-TIME TUTORIAL OVERLAY (4 steps)
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tutorialOverlay">
    <div id="tutorialSpotlight"></div>
    <div id="tutorialCallout">
      <div class="tut-step-header">
        <div class="tut-step-num" id="tutStepNum">1</div>
        <div class="tut-step-title" id="tutStepTitle">KPI Grid</div>
      </div>
      <div class="tut-step-text" id="tutStepText">Real-time metrics: Win Rate, PnL, APR, Drawdown. Updated every time a trade closes.</div>
      <div class="tut-controls">
        <div class="tut-progress" id="tutProgress">1 / 4</div>
        <div class="tut-btn-group">
          <button class="tut-btn tut-btn-skip" onclick="skipTutorial()">SKIP ALL</button>
          <button class="tut-btn tut-btn-next" id="tutNextBtn" onclick="advanceTutorial()">NEXT ‚Üí</button>
        </div>
      </div>
    </div>
  </div>
  <button id="tutSkipFixed" onclick="skipTutorial()">‚úï</button>

  <script>
  // ‚îÄ‚îÄ TRON MENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleTronMenu(forceOpen) {
    var drawer   = document.getElementById('tronMenuDrawer');
    var backdrop = document.getElementById('tronMenuBackdrop');
    var isOpen   = (forceOpen !== undefined) ? forceOpen : !drawer.classList.contains('open');
    drawer.classList.toggle('open', isOpen);
    backdrop.classList.toggle('open', isOpen);
    document.body.style.overflow = isOpen ? 'hidden' : '';

    if (isOpen) {
      // Sync active tab highlight
      var activeTabBtn = document.querySelector('.tab-btn.active');
      if (activeTabBtn) {
        var activeTabName = activeTabBtn.getAttribute('data-tab');
        document.querySelectorAll('#tronMenuDrawer .tron-menu-item[data-tab]').forEach(function(el) {
          el.classList.toggle('active', el.getAttribute('data-tab') === activeTabName);
        });
      }
    }
  }

  function tronMenuSwitchTab(tabName) {
    toggleTronMenu(false);
    var btn = document.querySelector('.tab-btn[data-tab="' + tabName + '"]');
    if (btn) {
      btn.click();
      btn.scrollIntoView({ inline: 'center', behavior: 'smooth' });
    }
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      toggleTronMenu(false);
      const tutOvl = document.getElementById('tutorialOverlay');
      if (tutOvl && tutOvl.classList.contains('tut-active')) skipTutorial();
    }
  });

  // ‚îÄ‚îÄ TUTORIAL SPOTLIGHT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var TUT_STEPS = [
    {
      sel: '.kpi-grid',
      title: 'KPI Grid',
      text: 'Real-time metrics: Win Rate, PnL, APR, Drawdown. Updated automatically every trade close.',
      pos: 'below'
    },
    {
      sel: '#signalLogPanel',
      title: 'Live Signal Log',
      text: 'Every 10-min AI prediction from Claude + XGBoost. Filter by direction, outcome, type.',
      pos: 'above'
    },
    {
      sel: '#warRoomToggle',
      title: 'War Room Mode',
      text: 'Full-screen neon monitoring. Ultra-wide layout, live chart, real-time updates every 4h.',
      pos: 'below'
    },
    {
      sel: '#tgCtaBanner',
      title: 'Live Alerts',
      text: 'Receive every signal and trade result directly on Telegram. Free, instant, transparent.',
      pos: 'below'
    }
  ];

  var _tutStep = 0;

  function startTutorial() {
    if (localStorage.getItem('btcp_tutorial_done') === '1') return;
    _tutStep = 0;
    document.getElementById('tutorialOverlay').classList.add('tut-active');
    document.getElementById('tutSkipFixed').style.display = 'flex';
    _tutRender(_tutStep);
  }

  function _tutRender(n) {
    var step = TUT_STEPS[n];
    var target = document.querySelector(step.sel);
    if (!target) { advanceTutorial(); return; }

    // Update text content first (before scroll)
    document.getElementById('tutStepNum').textContent   = n + 1;
    document.getElementById('tutStepTitle').textContent = step.title;
    document.getElementById('tutStepText').textContent  = step.text;
    document.getElementById('tutProgress').textContent  = (n + 1) + ' / ' + TUT_STEPS.length;
    var nextBtn = document.getElementById('tutNextBtn');
    nextBtn.textContent = (n === TUT_STEPS.length - 1) ? 'DONE \u2713' : 'NEXT \u2192';

    var isMobile = window.innerWidth < 640;
    var sp = document.getElementById('tutorialSpotlight');

    if (isMobile) {
      // On mobile: no spotlight, just bottom-sheet callout
      sp.style.cssText = '';
      sp.style.boxShadow = 'none';
      var cal = document.getElementById('tutorialCallout');
      cal.style.animation = 'none';
      cal.offsetHeight;
      cal.style.animation = '';
    } else {
      // Desktop: scroll then double-rAF for accurate measurement
      target.scrollIntoView({ block: 'center', behavior: 'instant' });
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          var r = target.getBoundingClientRect();
          var padX = 6, padY = 10;
          sp.style.left   = (r.left - padX) + 'px';
          sp.style.top    = (r.top  - padY) + 'px';
          sp.style.width  = (r.width  + padX*2) + 'px';
          sp.style.height = (r.height + padY*2) + 'px';
          sp.style.boxShadow = '';

          var cal = document.getElementById('tutorialCallout');
          var calW = 300, calH = cal.offsetHeight || 140;
          var vw = window.innerWidth, vh = window.innerHeight;
          var left, top;
          if (step.pos === 'below') {
            top  = Math.min(r.bottom + padY + 14, vh - calH - 16);
            left = Math.max(8, Math.min(r.left, vw - calW - 8));
          } else {
            top  = Math.max(8, r.top - calH - padY - 14);
            left = Math.max(8, Math.min(r.left, vw - calW - 8));
          }
          cal.style.left = left + 'px';
          cal.style.top  = top  + 'px';
          cal.style.animation = 'none';
          cal.offsetHeight;
          cal.style.animation = '';
        });
      });
    }
  }

  function advanceTutorial() {
    _tutStep++;
    if (_tutStep >= TUT_STEPS.length) { completeTutorial(); return; }
    _tutRender(_tutStep);
  }

  function skipTutorial() { completeTutorial(); }

  function completeTutorial() {
    document.getElementById('tutorialOverlay').classList.remove('tut-active');
    document.getElementById('tutSkipFixed').style.display = 'none';
    localStorage.setItem('btcp_tutorial_done', '1');
  }
  </script>

<!-- ‚îÄ‚îÄ SATOSHI WIDGET v2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<style>
#satW{position:fixed;bottom:24px;left:24px;z-index:8990;display:flex;flex-direction:column;align-items:flex-start;gap:10px;pointer-events:none;}
#satW>*{pointer-events:auto;}
/* avatar */
#satAv{width:42px;height:42px;border-radius:50%;background:rgba(8,10,22,.97);border:1.5px solid rgba(247,147,26,.45);color:#f7931a;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 0 18px rgba(247,147,26,.12),0 2px 8px rgba(0,0,0,.5);transition:transform .18s,box-shadow .18s,border-color .18s;user-select:none;flex-shrink:0;}
#satAv:hover{transform:scale(1.09);box-shadow:0 0 28px rgba(247,147,26,.35),0 2px 8px rgba(0,0,0,.5);}
#satAv.open{border-color:rgba(247,147,26,.9);box-shadow:0 0 22px rgba(247,147,26,.28),0 2px 8px rgba(0,0,0,.5);}
/* panel */
#satPanel{width:300px;height:440px;display:flex;flex-direction:column;background:rgba(8,10,22,.98);border:1px solid rgba(247,147,26,.2);box-shadow:0 8px 40px rgba(0,0,0,.7),0 0 20px rgba(247,147,26,.05);overflow:hidden;transform-origin:bottom left;}
#satPanel.sp-hidden{display:none;}
#satPanel.sp-in{animation:spIn .3s cubic-bezier(.175,.885,.32,1.275) both;}
#satPanel.sp-out{animation:spOut .2s ease forwards;}
@keyframes spIn{from{opacity:0;transform:scale(.88) translateY(14px);}to{opacity:1;transform:scale(1) translateY(0);}}
@keyframes spOut{to{opacity:0;transform:scale(.88) translateY(14px);}}
/* header */
#satHdr{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;border-bottom:1px solid rgba(247,147,26,.1);flex-shrink:0;}
.shinfo{display:flex;align-items:center;gap:9px;}
.shav{width:26px;height:26px;border-radius:50%;background:rgba(247,147,26,.1);border:1px solid rgba(247,147,26,.35);color:#f7931a;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.shname{font-family:'SF Mono','Fira Code','Courier New',monospace;font-size:11px;font-weight:700;color:rgba(255,255,255,.9);letter-spacing:.05em;}
.shstatus{font-size:8.5px;color:rgba(0,255,136,.55);letter-spacing:.1em;font-family:'SF Mono','Fira Code','Courier New',monospace;margin-top:1px;}
#satXBtn{background:none;border:none;color:rgba(255,255,255,.22);font-size:16px;cursor:pointer;line-height:1;padding:3px 6px;transition:color .15s;}
#satXBtn:hover{color:rgba(255,255,255,.65);}
/* messages */
#satMsgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;min-height:0;scroll-behavior:smooth;}
#satMsgs::-webkit-scrollbar{width:3px;}
#satMsgs::-webkit-scrollbar-thumb{background:rgba(247,147,26,.18);border-radius:2px;}
.sm{max-width:88%;font-family:'SF Mono','Fira Code','Courier New',monospace;font-size:10.5px;line-height:1.68;padding:9px 12px;word-break:break-word;}
.sm-bot{align-self:flex-start;background:rgba(247,147,26,.07);border:1px solid rgba(247,147,26,.14);color:rgba(255,255,255,.82);border-radius:0 10px 10px 10px;}
.sm-user{align-self:flex-end;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.09);color:rgba(255,255,255,.68);border-radius:10px 10px 0 10px;}
/* typing dots */
.sm-dots{align-self:flex-start;padding:10px 14px;display:flex;gap:4px;align-items:center;background:rgba(247,147,26,.05);border:1px solid rgba(247,147,26,.1);border-radius:0 10px 10px 10px;}
.sm-dots span{width:5px;height:5px;border-radius:50%;background:rgba(247,147,26,.5);animation:sdot 1.1s ease-in-out infinite;}
.sm-dots span:nth-child(2){animation-delay:.22s;}
.sm-dots span:nth-child(3){animation-delay:.44s;}
@keyframes sdot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-4px)}}
/* typewriter cursor */
.sc{display:inline-block;width:6px;height:10px;background:rgba(247,147,26,.8);margin-left:1px;vertical-align:middle;animation:scur .85s step-end infinite;}
@keyframes scur{0%,100%{opacity:1}50%{opacity:0}}
/* text input row */
#satInpWrap{flex-shrink:0;border-top:1px solid rgba(247,147,26,.1);padding:9px 11px;display:flex;gap:7px;align-items:center;}
#satInp{flex:1;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.09);color:rgba(255,255,255,.8);font-family:'SF Mono','Fira Code','Courier New',monospace;font-size:10.5px;padding:7px 10px;outline:none;transition:border-color .18s;border-radius:2px;}
#satInp:focus{border-color:rgba(247,147,26,.4);}
#satInp::placeholder{color:rgba(255,255,255,.17);}
#satSnd{background:rgba(247,147,26,.12);border:1px solid rgba(247,147,26,.3);color:#f7931a;font-size:13px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:background .18s;border-radius:2px;}
#satSnd:hover{background:rgba(247,147,26,.25);}
/* email input row */
#satEmailWrap{flex-shrink:0;border-top:1px solid rgba(0,255,136,.1);padding:9px 11px;display:none;gap:7px;align-items:center;}
#satEmailWrap.se-show{display:flex;}
#satEmailInp{flex:1;background:rgba(255,255,255,.03);border:1px solid rgba(0,255,136,.2);color:rgba(255,255,255,.8);font-family:'SF Mono','Fira Code','Courier New',monospace;font-size:10.5px;padding:7px 10px;outline:none;transition:border-color .18s;border-radius:2px;}
#satEmailInp:focus{border-color:rgba(0,255,136,.55);}
#satEmailInp::placeholder{color:rgba(255,255,255,.17);}
#satEmailBtn{background:rgba(0,255,136,.1);border:1px solid rgba(0,255,136,.25);color:#00ff88;font-size:12px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:background .18s;border-radius:2px;}
#satEmailBtn:hover{background:rgba(0,255,136,.22);}
#satGdpr{display:none;padding:4px 11px 8px;font-size:9px;color:rgba(255,255,255,.25);line-height:1.5;}
#satGdpr a{color:rgba(0,255,136,.45);text-decoration:none;}
#satGdpr a:hover{color:#00ff88;}
#satGdpr.gdpr-show{display:block;}
</style>

<div id="satW">
  <div id="satPanel" class="sp-hidden">
    <div id="satHdr">
      <div class="shinfo">
        <div class="shav">‚Çø</div>
        <div>
          <div class="shname">Satoshi</div>
          <div class="shstatus">‚óè on-chain ¬∑ sempre</div>
        </div>
      </div>
      <button id="satXBtn" onclick="satPanelClose()">√ó</button>
    </div>
    <div id="satMsgs"></div>
    <div id="satInpWrap">
      <input id="satInp" type="text" placeholder="Scrivi a Satoshi..." maxlength="200"
             onkeydown="if(event.key==='Enter')satSend()">
      <button id="satSnd" onclick="satSend()">‚Üí</button>
    </div>
    <div id="satEmailWrap">
      <input id="satEmailInp" type="email" placeholder="Niente spam."
             onkeydown="if(event.key==='Enter')satEmailSubmit()">
      <button id="satEmailBtn" onclick="satEmailSubmit()">‚úì</button>
    </div>
    <div id="satGdpr">Cliccando ‚úì acconsenti al trattamento dell'email ai sensi del GDPR ¬∑ <a href="/privacy" target="_blank" rel="noopener">Privacy Policy</a></div>
  </div>
  <div id="satAv" onclick="satToggle()" title="Parla con Satoshi">‚Çø</div>
</div>

<script>
(function(){
  /* ‚îÄ‚îÄ responses ‚îÄ‚îÄ */
  var R={
    greet:  ["Sono qui.\nCosa vuoi sapere?",
             "Il genesis block era silenzio.\nPoi tutto √® cominciato.\nDimmi."],
    btc:    ["Bitcoin risolve un problema\nche la maggioranza non sa ancora\ndi avere.",
             "La scarsit√† √® codice.\nIl codice √® legge.\nIl resto √® rumore."],
    pred:   ["261 trade aperti e chiusi.\nOgni hash su Polygon.\nNon chiedere fiducia ‚Äî verifica.",
             "L'AI genera. L'economista valida.\nLa blockchain registra.\nTu verifichi."],
    chain:  ["Polygon PoS.\nContratto 0xe4661F7dB626...\nAperto. Sempre.",
             "Ogni bet committata on-chain\nprima di aprire.\nImpossibile fare cherry-picking."],
    how:    ["1. Signal AI\n2. Validazione economista\n3. Commit on-chain (prima)\n4. Trade su Kraken\n5. Resolve on-chain (dopo)\n6. Tu verifichi tutto."],
    trust:  ["La fiducia √® un protocollo rotto.\nL'on-chain √® il fix.",
             "Non chiedo fiducia.\nTi do hash. Ti do contratti.\nVerifica da solo."],
    aureo:  ["L'Italia risparmia pi√π di quasi tutti.\nE perde pi√π di quasi tutti.\nAUREO vuole chiudere quel gap.\naureo.it ‚Äî gratis, forever."],
    result: ["53% win rate. Live.\nI dati non mentono.",
             "261 trade verificabili.\nOgni predizione hashata.\nIl track record √® sul dashboard."],
    thanks: ["The chain doesn't lie.",
             "Il codice √® aperto.\nI trade sono pubblici."],
    dflt:   ["Alcune cose restano nell'ombra.\nAltre sono on-chain per sempre.",
             "Non ho abbastanza dati.\nProva con una domanda diversa.",
             "Il silenzio ha valore.\nMa meriti una risposta migliore."]
  };
  var PRE_EMAIL ="Stai ancora cercando.\n\n√à raro.\nSi vede subito.";
  var EMAIL_ASK="Sei ancora qui.\nSignifica che sei curioso.\n\nLasciami un'email ‚Äî\nti avviso quando qualcosa\ncambia on-chain.\nNiente spam.";
  var EMAIL_OK ="Salvato.\nNiente spam. Solo segnali.\n\nThe chain doesn't lie. \u20bf";
  var EMAIL_NO ="Come vuoi.\nIl dashboard √® sempre aperto.";

  /* ‚îÄ‚îÄ state ‚îÄ‚îÄ */
  var exchanges=0, emailAsked=false, emailDone=false, typing=false, typeTimer=null;

  function $i(id){return document.getElementById(id);}
  function rand(a){return a[Math.floor(Math.random()*a.length)];}
  function scrollMsgs(){var m=$i('satMsgs');m.scrollTop=m.scrollHeight;}

  function addMsg(html,role){
    var d=document.createElement('div');
    d.className='sm sm-'+(role==='bot'?'bot':'user');
    d.innerHTML=html;
    $i('satMsgs').appendChild(d);
    scrollMsgs();
    return d;
  }

  function showDots(){
    var d=document.createElement('div');
    d.id='satDots';d.className='sm-dots';
    d.innerHTML='<span></span><span></span><span></span>';
    $i('satMsgs').appendChild(d);scrollMsgs();
  }
  function rmDots(){var d=$i('satDots');if(d)d.remove();}

  function typeInto(el,text,cb){
    typing=true;
    if(typeTimer){clearInterval(typeTimer);typeTimer=null;}
    el.innerHTML='';
    var t=text.replace(/\n/g,'<br>');
    var i=0;
    typeTimer=setInterval(function(){
      if(i<t.length){
        if(t.slice(i,i+4)==='<br>'){i+=4;}else{i++;}
        el.innerHTML=t.slice(0,i)+'<span class="sc"></span>';
        scrollMsgs();
      }else{
        el.innerHTML=t;
        clearInterval(typeTimer);typeTimer=null;
        typing=false;
        if(cb)cb();
      }
    },30);
  }

  function botSay(text,delay,cb){
    var pause=Math.min(850,text.replace(/\n/g,' ').length*6+180);
    setTimeout(function(){
      showDots();
      setTimeout(function(){
        rmDots();
        var el=addMsg('','bot');
        typeInto(el,text,cb);
      },pause);
    },delay||0);
  }

  /* ‚îÄ‚îÄ intent ‚îÄ‚îÄ */
  function intent(t){
    t=t.toLowerCase();
    if(/\b(ciao|hello|hey|salve|buongiorno|buonasera|hi\b|hola)\b/.test(t)) return 'greet';
    if(/\b(come funziona|how|spiegami|explain|step|processo|pipeline)\b/.test(t)) return 'how';
    if(/\b(bitcoin|btc|crypto|criptovaluta)\b/.test(t)) return 'btc';
    if(/\b(previsioni?|predizioni?|signal|segnale|trade|modello|xgb)\b/.test(t)) return 'pred';
    if(/\b(onchain|on.chain|polygon|hash|contratto|verif)\b/.test(t)) return 'chain';
    if(/\b(fid[aio]|trust|sicuro|affidabile|legit)\b/.test(t)) return 'trust';
    if(/\b(aureo|finanza|invest|risparmio|italia|etf|pensione)\b/.test(t)) return 'aureo';
    if(/\b(risultat|result|win|loss|pnl|53|261|performance)\b/.test(t)) return 'result';
    if(/\b(grazie|thanks|ok|capito|cool|bello|wow|super)\b/.test(t)) return 'thanks';
    if(/\b(skip|no grazie|passa|dopo|non|newsletter)\b/.test(t)) return '__skip';
    return 'dflt';
  }

  /* ‚îÄ‚îÄ send ‚îÄ‚îÄ */
  window.satSend=function(){
    if(typing)return;
    var v=$i('satInp').value.trim();if(!v)return;
    $i('satInp').value='';
    addMsg(v,'user');
    exchanges++;
    // email typed directly in chat
    if(!emailDone&&/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(v)){doSaveEmail(v);return;}
    var it=intent(v);
    if(it==='__skip'&&emailAsked){
      emailDone=true;
      $i('satEmailWrap').classList.remove('se-show');
      $i('satInpWrap').style.display='flex';
      botSay(EMAIL_NO,250);
      return;
    }
    var willAskEmail=exchanges>=2&&!emailAsked&&!emailDone;
    var reply=(willAskEmail&&it==='dflt')?PRE_EMAIL:rand(R[it]||R.dflt);
    botSay(reply,350,function(){
      if(exchanges>=2&&!emailAsked&&!emailDone){
        emailAsked=true;
        botSay(EMAIL_ASK,950,function(){
          $i('satInpWrap').style.display='none';
          $i('satEmailWrap').classList.add('se-show');
          $i('satGdpr').classList.add('gdpr-show');
          setTimeout(function(){$i('satEmailInp').focus();},80);
        });
      }
    });
  };

  /* ‚îÄ‚îÄ email submit ‚îÄ‚îÄ */
  window.satEmailSubmit=function(){
    var e=$i('satEmailInp').value.trim();
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(e))return;
    $i('satEmailInp').value='';
    $i('satEmailWrap').classList.remove('se-show');
    $i('satInpWrap').style.display='flex';
    addMsg(e,'user');
    doSaveEmail(e);
  };

  function doSaveEmail(email){
    emailDone=true;
    fetch('/satoshi-lead',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email:email,source:'satoshi_widget',metadata:{exchanges:exchanges}})
    }).catch(function(){});
    botSay(EMAIL_OK,350);
  }

  /* ‚îÄ‚îÄ open / close ‚îÄ‚îÄ */
  function openPanel(){
    var p=$i('satPanel');
    p.classList.remove('sp-hidden','sp-out');
    void p.offsetWidth;
    p.classList.add('sp-in');
    $i('satAv').classList.add('open');
    if($i('satMsgs').children.length===0){
      botSay("The chain doesn't lie.\nNeither does the data.\n\nCosa vuoi sapere?",320);
    }
    setTimeout(function(){$i('satInp').focus();},380);
    sessionStorage.setItem('sat_seen','1');
  }

  window.satPanelClose=function(){
    var p=$i('satPanel');
    p.classList.remove('sp-in');
    p.classList.add('sp-out');
    setTimeout(function(){p.classList.remove('sp-out');p.classList.add('sp-hidden');},210);
    $i('satAv').classList.remove('open');
  };

  window.satToggle=function(){
    $i('satPanel').classList.contains('sp-hidden')?openPanel():satPanelClose();
  };

  /* auto-open disabilitato: Satoshi si apre solo al click */
})();
</script>
<!-- ‚îÄ‚îÄ END SATOSHI WIDGET v2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
</body>
</html>
