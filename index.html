<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BTC BOT Â· ASTRA DIGITAL</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080b0f;
    --surface: #0d1117;
    --card: #111820;
    --border: #1e2d3d;
    --accent: #00ff88;
    --blue: #00aaff;
    --text: #e8f0fe;
    --muted: #4a6070;
    --danger: #ff4466;
    --warn: #ffaa00;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.025) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { position: relative; z-index: 1; max-width: 1600px; margin: 0 auto; padding: 20px 24px; }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .logo { font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; color: var(--muted); }
  .logo span { color: var(--accent); }
  h1 { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
  h1 span { color: var(--accent); }

  .header-right { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }

  .btc-live-ticker { display: flex; flex-direction: column; align-items: flex-end; }
  .btc-live-price { font-size: 20px; font-weight: 900; color: var(--accent); font-family: 'Syne', sans-serif; letter-spacing: -0.5px; line-height: 1; transition: color 0.3s; }
  .btc-live-price.up { color: var(--accent); }
  .btc-live-price.down { color: var(--danger); }
  .btc-price-meta { font-size: 9px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 2px; }
  .btc-price-change { font-size: 10px; font-weight: 700; }
  .btc-price-change.pos { color: var(--accent); }
  .btc-price-change.neg { color: var(--danger); }

  .live-badge { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); border: 1px solid rgba(0,255,136,0.3); padding: 5px 12px; border-radius: 2px; background: rgba(0,255,136,0.05); }
  .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 1.5s infinite; }
  .last-update { font-size: 10px; color: var(--muted); letter-spacing: 1px; }

  .bot-status { display: flex; align-items: center; gap: 7px; font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; padding: 5px 12px; border-radius: 2px; border: 1px solid; transition: all 0.4s; }
  .bot-status.alive   { color: var(--accent); border-color: rgba(0,255,136,0.3); background: rgba(0,255,136,0.05); }
  .bot-status.warning { color: var(--warn);   border-color: rgba(255,170,0,0.3); background: rgba(255,170,0,0.05); }
  .bot-status.dead    { color: var(--danger);  border-color: rgba(255,68,102,0.3); background: rgba(255,68,102,0.07); animation: deadPulse 2s infinite; }
  .bot-status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .alive .bot-status-dot   { background: var(--accent); box-shadow: 0 0 5px var(--accent); animation: pulse 1.5s infinite; }
  .warning .bot-status-dot { background: var(--warn);   box-shadow: 0 0 5px var(--warn); animation: pulse 2s infinite; }
  .dead .bot-status-dot    { background: var(--danger); }
  .bot-status-inner { display: flex; flex-direction: column; }
  .bot-status-detail { font-size: 9px; color: var(--muted); letter-spacing: 1px; font-weight: 400; margin-top: 1px; }

  @keyframes pulse    { 0%,100%{opacity:1} 50%{opacity:0.4} }
  @keyframes deadPulse{ 0%,100%{opacity:1} 50%{opacity:0.5} }
  @keyframes blink    { 0%,100%{opacity:1} 50%{opacity:0} }
  .loading { display: inline-block; animation: blink 1s step-end infinite; color: var(--accent); }

  /* KPI GRID */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  @media (max-width: 1300px) { .kpi-grid { grid-template-columns: repeat(5, 1fr); } }
  @media (max-width: 700px)  { .kpi-grid { grid-template-columns: repeat(3, 1fr); } }

  .kpi { background: var(--card); border: 1px solid var(--border); padding: 14px 16px; position: relative; overflow: hidden; transition: border-color 0.2s; min-width: 0; }
  .kpi:hover { border-color: rgba(255,255,255,0.12); }
  .kpi::after { content: ''; position: absolute; top: 0; left: 0; width: 2px; height: 100%; }
  .kpi.green::after  { background: var(--accent); }
  .kpi.red::after    { background: var(--danger); }
  .kpi.yellow::after { background: var(--warn); }
  .kpi.blue::after   { background: var(--blue); }
  .kpi.purple::after { background: #aa66ff; }

  .kpi-label { font-size: 9px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .kpi-value { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
  .kpi-value.green  { color: var(--accent); }
  .kpi-value.red    { color: var(--danger); }
  .kpi-value.yellow { color: var(--warn); }
  .kpi-value.white  { color: var(--text); }
  .kpi-value.blue   { color: var(--blue); }
  .kpi-value.purple { color: #aa66ff; }
  .kpi-sub { font-size: 10px; color: var(--muted); margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* STATS ROW */
  .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); margin-bottom: 16px; }
  .stat-cell { background: var(--card); padding: 14px 18px; text-align: center; }
  .stat-cell-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .stat-cell-val { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; }

  /* MAIN GRID */
  .main-grid { display: grid; grid-template-columns: 1fr 320px; gap: 14px; margin-bottom: 14px; }
  @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }

  /* PANEL */
  .panel { background: var(--card); border: 1px solid var(--border); overflow: hidden; }
  .panel-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 18px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.015); flex-wrap: wrap; gap: 8px; }
  .panel-title { font-size: 10px; font-weight: 700; letter-spacing: 2.5px; text-transform: uppercase; color: var(--muted); }
  .panel-tag { font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; padding: 3px 9px; border-radius: 2px; }
  .tag-green  { background: rgba(0,255,136,0.08);  color: var(--accent); border: 1px solid rgba(0,255,136,0.2); }
  .tag-red    { background: rgba(255,68,102,0.08); color: var(--danger); border: 1px solid rgba(255,68,102,0.2); }
  .tag-yellow { background: rgba(255,170,0,0.08);  color: var(--warn);   border: 1px solid rgba(255,170,0,0.2); }
  .tag-blue   { background: rgba(0,170,255,0.08);  color: var(--blue);   border: 1px solid rgba(0,170,255,0.2); }

  /* TABLE */
  .table-wrap { overflow-x: auto; max-height: 500px; overflow-y: auto; }
  .table-wrap::-webkit-scrollbar { width: 3px; height: 3px; }
  .table-wrap::-webkit-scrollbar-thumb { background: var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 11px; }
  thead th { text-align: left; font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); padding: 9px 12px; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 2; white-space: nowrap; }
  tbody tr { border-bottom: 1px solid rgba(30,45,61,0.4); transition: background 0.12s; }
  tbody tr:hover { background: rgba(255,255,255,0.025); }
  tbody td { padding: 8px 12px; white-space: nowrap; vertical-align: middle; }

  .dir-up   { color: var(--accent); font-weight: 700; }
  .dir-down { color: var(--danger); font-weight: 700; }

  .badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 7px; border-radius: 2px; font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .badge-bet     { background: rgba(0,170,255,0.1);  color: var(--blue); }
  .badge-nobet   { background: rgba(74,96,112,0.15); color: var(--muted); }
  .badge-correct { background: rgba(0,255,136,0.1);  color: var(--accent); }
  .badge-wrong   { background: rgba(255,68,102,0.1); color: var(--danger); }

  .pnl-pos  { color: var(--accent); }
  .pnl-neg  { color: var(--danger); }
  .pnl-null { color: var(--muted); }
  .no-data-row td { text-align: center; color: var(--muted); padding: 28px; font-size: 11px; letter-spacing: 2px; }

  /* SIZE cell */
  .size-val    { color: var(--blue); font-weight: 700; font-size: 10px; display: block; }
  .size-reason { color: var(--muted); font-size: 9px; display: block; margin-top: 2px; letter-spacing: 0.5px; }
  .size-mult   { font-size: 9px; }
  .size-mult.up   { color: var(--accent); }
  .size-mult.down { color: var(--danger); }
  .size-mult.base { color: var(--muted); }

  /* FILTERS */
  .filters-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
  .time-pill { font-family: inherit; font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; padding: 3px 9px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; border-radius: 2px; transition: all 0.15s; }
  .time-pill:hover { color: var(--text); border-color: var(--muted); }
  .time-pill.active { background: var(--accent); border-color: var(--accent); color: #000; }
  select.filter-sel { background: var(--surface); border: 1px solid var(--border); color: var(--text); font-family: inherit; font-size: 9px; padding: 3px 7px; letter-spacing: 1px; cursor: pointer; outline: none; border-radius: 2px; }

  /* CHART */
  .chart-area { padding: 16px 18px; }
  .pnl-chart { display: flex; align-items: flex-end; gap: 2px; height: 90px; margin-bottom: 6px; }
  .bar { flex: 1; border-radius: 1px 1px 0 0; min-width: 6px; transition: opacity 0.15s; cursor: pointer; position: relative; }
  .bar:hover { opacity: 0.75; }
  .bar.pos  { background: var(--accent); }
  .bar.neg  { background: var(--danger); align-self: flex-start; border-radius: 0 0 1px 1px; }
  .bar.zero { background: var(--muted); height: 2px !important; }
  .bar-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--muted); }
  .tooltip { position: absolute; bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%); background: var(--surface); border: 1px solid var(--border); padding: 3px 7px; font-size: 9px; white-space: nowrap; pointer-events: none; z-index: 100; display: none; }
  .bar:hover .tooltip { display: block; }

  /* SIGNAL QUALITY */
  .signal-grid { padding: 14px 18px; display: flex; flex-direction: column; gap: 12px; }
  .signal-row { display: flex; flex-direction: column; gap: 5px; }
  .signal-meta { display: flex; justify-content: space-between; font-size: 9px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
  .signal-label { color: var(--muted); }
  .signal-val   { color: var(--text); }
  .signal-bar-bg   { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .signal-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

  /* CONF DIST */
  .conf-bars { padding: 14px 18px; display: flex; flex-direction: column; gap: 9px; }
  .conf-row { display: flex; align-items: center; gap: 9px; }
  .conf-label   { font-size: 9px; color: var(--muted); width: 42px; text-align: right; }
  .conf-bar-bg  { flex: 1; height: 12px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .conf-bar-fill{ height: 100%; background: var(--blue); transition: width 0.5s ease; }
  .conf-count   { font-size: 9px; color: var(--muted); width: 22px; text-align: right; }

  .equity-svg { width: 100%; }

  /* WALLET STRIP */
  .wallet-strip {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  @media (max-width: 700px) { .wallet-strip { grid-template-columns: repeat(2, 1fr); } }

  footer { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
  .footer-text { font-size: 9px; color: var(--muted); letter-spacing: 1px; }
  .footer-text span { color: var(--accent); }
  .config-hint { font-size: 9px; color: var(--muted); background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 5px 12px; border-radius: 2px; letter-spacing: 1px; }
  .config-hint code { color: var(--accent); }

  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-thumb { background: var(--border); }
</style>
</head>
<body>
<div class="container">

  <header>
    <div>
      <div class="logo">ASTRA DIGITAL Â· <span>BOT ENGINE v2.0</span></div>
      <h1>BTC <span>SIGNAL</span> DASHBOARD</h1>
    </div>
    <div class="header-right">
      <div class="btc-live-ticker">
        <div class="btc-live-price" id="btcLivePrice">â€”</div>
        <div class="btc-price-meta">BTC/USD Â· LIVE <span class="btc-price-change" id="btcPriceChange"></span></div>
      </div>
      <span class="last-update" id="lastUpdate">LAST UPDATE: <span class="loading">â€”</span></span>
      <div class="live-badge"><div class="live-dot"></div>LIVE DATA</div>
      <div id="botStatus" class="bot-status alive">
        <div class="bot-status-dot"></div>
        <div class="bot-status-inner">
          <div id="botStatusText">BOT ALIVE</div>
          <div class="bot-status-detail" id="botStatusDetail">Checking...</div>
        </div>
      </div>
    </div>
  </header>

  <!-- 9 KPI tiles -->
  <div class="kpi-grid">
    <div class="kpi blue">
      <div class="kpi-label">BTC Price</div>
      <div class="kpi-value blue" id="kpiPrice">â€”</div>
      <div class="kpi-sub">Last entry</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Total Signals</div>
      <div class="kpi-value white" id="kpiTotal">â€”</div>
      <div class="kpi-sub">All time</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Accuracy</div>
      <div class="kpi-value green" id="kpiAccuracy">â€”</div>
      <div class="kpi-sub">Correct pred.</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Total PnL</div>
      <div class="kpi-value green" id="kpiPnl">â€”</div>
      <div class="kpi-sub">USD (real bets)</div>
    </div>
    <div class="kpi purple">
      <div class="kpi-label">Capital ROI</div>
      <div class="kpi-value purple" id="kpiRoi">â€”</div>
      <div class="kpi-sub">on $20 USDC</div>
    </div>
    <div class="kpi yellow">
      <div class="kpi-label">Win Rate</div>
      <div class="kpi-value yellow" id="kpiWinRate">â€”</div>
      <div class="kpi-sub">Executed trades</div>
    </div>
    <div class="kpi blue">
      <div class="kpi-label">Fear &amp; Greed</div>
      <div class="kpi-value blue" id="kpiFG">â€”</div>
      <div class="kpi-sub" id="kpiFGLabel">Loading...</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Bets Taken</div>
      <div class="kpi-value white" id="kpiBets">â€”</div>
      <div class="kpi-sub">Out of total</div>
    </div>
    <div class="kpi red">
      <div class="kpi-label">Max Drawdown</div>
      <div class="kpi-value red" id="kpiDrawdown">â€”</div>
      <div class="kpi-sub">Single trade</div>
    </div>
  </div>

  <!-- WALLET & FEES STRIP -->
  <div class="wallet-strip">
    <div class="kpi yellow">
      <div class="kpi-label">Wallet Equity</div>
      <div class="kpi-value white" id="walletEquity">â€”</div>
      <div class="kpi-sub" id="walletEquitySub">fetching...</div>
    </div>
    <div class="kpi blue">
      <div class="kpi-label">USDC Available</div>
      <div class="kpi-value blue" id="walletUsdc">â€”</div>
      <div class="kpi-sub">cash on hand</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Live P&amp;L</div>
      <div class="kpi-value white" id="walletDelta">â€”</div>
      <div class="kpi-sub">vs $20.00 initial</div>
    </div>
    <div class="kpi red">
      <div class="kpi-label">Fees Paid</div>
      <div class="kpi-value yellow" id="feesTotal">â€”</div>
      <div class="kpi-sub" id="feesSub">exit fees Â· supabase</div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-cell">
      <div class="stat-cell-label">Avg Confidence</div>
      <div class="stat-cell-val" id="statConf" style="color:var(--blue)">â€”</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Best Trade PnL</div>
      <div class="stat-cell-val" id="statBest" style="color:var(--accent)">â€”</div>
    </div>
    <div class="stat-cell">
      <div class="stat-cell-label">Worst Trade PnL</div>
      <div class="stat-cell-val" id="statWorst" style="color:var(--danger)">â€”</div>
    </div>
  </div>

  <div class="main-grid">

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title" id="signalLogTitle">Signal Log</div>
        <div class="filters-row">
          <button class="time-pill active" data-period="ALL"   onclick="setTimePeriod(this)">ALL</button>
          <button class="time-pill"        data-period="TODAY" onclick="setTimePeriod(this)">TODAY</button>
          <button class="time-pill"        data-period="24H"   onclick="setTimePeriod(this)">24H</button>
          <button class="time-pill"        data-period="7D"    onclick="setTimePeriod(this)">7D</button>
          <select id="filterDir"   class="filter-sel"><option value="ALL">ALL DIR</option><option value="UP">UP</option><option value="DOWN">DOWN</option></select>
          <select id="filterClass" class="filter-sel"><option value="ALL">ALL</option><option value="BET">BETS</option><option value="NO_BET">NO-BET</option></select>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>DATE/TIME</th>
              <th>DIR</th>
              <th>CONF</th>
              <th>ENTRY $</th>
              <th>EXIT $</th>
              <th>RSI</th>
              <th>EMA</th>
              <th>SCORE</th>
              <th>SIZE</th>
              <th>TYPE</th>
              <th>RESULT</th>
              <th>PnL $</th>
            </tr>
          </thead>
          <tbody id="signalTable"></tbody>
        </table>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:14px;">

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">PnL per Trade</div>
          <div class="panel-tag tag-green" id="totalPnlTag">TOTAL: â€”</div>
        </div>
        <div class="chart-area">
          <div class="pnl-chart" id="pnlChart"></div>
          <div class="bar-labels"><span id="chartStart">â€”</span><span>PnL USD</span><span id="chartEnd">â€”</span></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Signal Quality</div>
          <div class="panel-tag tag-blue">LIVE</div>
        </div>
        <div class="signal-grid" id="signalQuality"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Confidence Distribution</div>
          <div class="panel-tag tag-yellow">HISTOGRAM</div>
        </div>
        <div class="conf-bars" id="confDist"></div>
      </div>

    </div>
  </div>

  <div class="panel" style="margin-bottom:14px;">
    <div class="panel-header">
      <div class="panel-title">Cumulative Equity Curve (Real Bets)</div>
      <div class="panel-tag tag-green" id="equityTag">LOADING</div>
    </div>
    <div style="padding:16px 18px 10px;">
      <svg id="equitySvg" class="equity-svg" height="110" viewBox="0 0 1000 110" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <footer>
    <div class="footer-text">ASTRA DIGITAL MARKETING Â· <span>BOT ENGINE</span> Â· AUTO REFRESH 60s</div>
    <div class="config-hint">Table: <code>btc_predictions</code> Â· Capital: <code>$20 USDC</code> Â· Refresh <code>60s</code></div>
  </footer>

</div>
<script>
const CONFIG = {
  RAILWAY_URL: 'https://web-production-e27d0.up.railway.app',
  BTC_REFRESH: 10000,
  LIMIT: 500,
  REFRESH_INTERVAL: 60000,
  CAPITAL: 20
};

const SAMPLE_DATA = [];

async function fetchData() {
  try {
    const res = await fetch(`${CONFIG.RAILWAY_URL}/signals?limit=${CONFIG.LIMIT}`);
    if (!res.ok) throw new Error('Railway fetch failed');
    return await res.json();
  } catch(e) {
    console.warn('Fetch failed:', e);
    return SAMPLE_DATA;
  }
}

function fmtTime(ts) {
  return new Date(ts).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
}
function fmtDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }) + ' '
       + d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
}
function fmtPrice(p) {
  if (p === null || p === undefined) return 'â€”';
  return '$' + parseFloat(p).toLocaleString('en-US', { maximumFractionDigits: 0 });
}
function fmtConf(c) { return (parseFloat(c) * 100).toFixed(0) + '%'; }
function fmtPnl(v) {
  if (v === null || v === undefined) return 'â€”';
  const n = parseFloat(v);
  return (n >= 0 ? '+' : '') + '$' + n.toFixed(4);
}
function emaLabel(e) {
  if (!e) return 'â€”';
  return e.includes('bullish') ? 'ðŸŸ¢ BULL' : 'ðŸ”´ BEAR';
}

// Render SIZE cell with multiplier context
function renderSizeCell(d) {
  if (!d.bet_size) return '<span style="color:var(--muted)">â€”</span>';

  const size = parseFloat(d.bet_size);
  const reason = d.size_reason || '';

  // Determine multiplier style from reason
  let multClass = 'base';
  let multLabel = 'Ã—1.0';

  if (reason.includes('win_streak')) {
    multClass = 'up';
    multLabel = reason.includes('high_conf') ? 'Ã—1.5' : 'Ã—1.2';
  } else if (reason.includes('loss_streak')) {
    multClass = 'down';
    multLabel = 'Ã—0.5';
  } else if (reason.includes('drawdown')) {
    multClass = 'down';
    multLabel = 'Ã—0.25';
  }

  // Format reason for display â€” shorten it
  let reasonDisplay = reason
    .replace('_high_conf', '')
    .replace('_low_conf', '')
    .replace('win_streak_', 'WÃ—')
    .replace('loss_streak_', 'LÃ—')
    .replace('drawdown_protection', 'drawdown')
    .replace('insufficient_history', 'no hist.')
    .replace('base', 'â€”');

  return `<span class="size-val">${size.toFixed(5)}</span>` +
         `<span class="size-mult ${multClass}">${multLabel} ${reasonDisplay}</span>`;
}

let currentPeriod = 'ALL';
let allData = [];

function setTimePeriod(btn) {
  document.querySelectorAll('.time-pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentPeriod = btn.dataset.period;
  renderAll(allData);
}

function filterByPeriod(data) {
  if (currentPeriod === 'ALL') return data;
  const now = new Date();
  let cutoff;
  if      (currentPeriod === 'TODAY') cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  else if (currentPeriod === '24H')   cutoff = new Date(now - 86400000);
  else if (currentPeriod === '7D')    cutoff = new Date(now - 7 * 86400000);
  return data.filter(d => new Date(d.created_at) >= cutoff);
}

function updateBotStatus(data) {
  if (!data || !data.length) return;
  const latest = data[0];
  if (!latest || !latest.created_at) return;
  const minutesAgo = Math.floor((new Date() - new Date(latest.created_at)) / 60000);
  const el       = document.getElementById('botStatus');
  const textEl   = document.getElementById('botStatusText');
  const detailEl = document.getElementById('botStatusDetail');
  const timeStr  = new Date(latest.created_at).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
  const timeLabel= minutesAgo < 1 ? 'just now' : minutesAgo + ' min ago';
  detailEl.textContent = 'Last: ' + timeStr + ' (' + timeLabel + ')';
  el.className = 'bot-status';
  if      (minutesAgo <= 8)  { el.classList.add('alive');   textEl.textContent = 'BOT ALIVE'; }
  else if (minutesAgo <= 20) { el.classList.add('warning'); textEl.textContent = 'BOT SLOW âš ï¸'; }
  else                       { el.classList.add('dead');    textEl.textContent = 'ðŸš¨ BOT OFFLINE'; detailEl.textContent = 'No signal for ' + minutesAgo + ' min!'; }
}

let lastBtcPrice = null;
async function fetchLiveBtcPrice() {
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/btc-price', { signal: AbortSignal.timeout(5000) });
    if (!res.ok) throw new Error();
    const data  = await res.json();
    const price = data.mark_price || data.last_price;
    if (!price) return;
    const priceEl  = document.getElementById('btcLivePrice');
    const changeEl = document.getElementById('btcPriceChange');
    if (lastBtcPrice !== null) {
      const diff    = price - lastBtcPrice;
      const diffPct = ((diff / lastBtcPrice) * 100).toFixed(3);
      priceEl.className  = 'btc-live-price ' + (diff >= 0 ? 'up' : 'down');
      changeEl.className = 'btc-price-change ' + (diff >= 0 ? 'pos' : 'neg');
      changeEl.textContent = (diff >= 0 ? '+' : '') + diffPct + '%';
    }
    priceEl.textContent = '$' + price.toLocaleString('it-IT', { maximumFractionDigits: 0 });
    lastBtcPrice = price;
  } catch(e) {
    const priceEl = document.getElementById('btcLivePrice');
    if (priceEl.textContent === 'â€”' && allData.length) {
      const last = allData.find(d => d.btc_price_entry);
      if (last) priceEl.textContent = '$' + Number(last.btc_price_entry).toLocaleString('it-IT', { maximumFractionDigits: 0 });
    }
  }
}

function renderAll(data) {
  const filtered = filterByPeriod(data);
  const titleEl  = document.getElementById('signalLogTitle');
  titleEl.textContent = currentPeriod === 'ALL'
    ? 'Signal Log'
    : `Signal Log Â· ${filtered.length} signals (${currentPeriod})`;
  render(filtered);
}

function render(data) {
  updateBotStatus(data);
  document.getElementById('lastUpdate').innerHTML =
    `LAST UPDATE: <strong>${new Date().toLocaleTimeString('it-IT')}</strong>`;

  const bets        = data.filter(d => d.classification === 'BET');
  const realBets    = bets.filter(d => d.pnl_usd !== null);
  const closedBets  = bets.filter(d => d.correct !== null);
  const correctBets = closedBets.filter(d => d.correct === true);
  const closed      = data.filter(d => d.correct !== null);
  const correct     = closed.filter(d => d.correct === true);

  const totalPnl  = realBets.reduce((s, d) => s + parseFloat(d.pnl_usd   || 0), 0);
  const totalFees = realBets.reduce((s, d) => s + parseFloat(d.fees_total || 0), 0);
  const roiPct   = (totalPnl / CONFIG.CAPITAL) * 100;
  const avgConf  = data.length ? data.reduce((s, d) => s + parseFloat(d.confidence || 0), 0) / data.length : 0;
  const pnlVals  = realBets.map(d => parseFloat(d.pnl_usd || 0));
  const bestPnl  = pnlVals.length ? Math.max(...pnlVals) : 0;
  const worstPnl = pnlVals.length ? Math.min(...pnlVals) : 0;

  const lastEntry = data.find(d => d.btc_price_entry);
  const lastFG    = lastEntry ? lastEntry.fear_greed_value : null;

  // KPIs
  document.getElementById('kpiPrice').textContent   = lastEntry ? fmtPrice(lastEntry.btc_price_entry) : 'â€”';
  document.getElementById('kpiTotal').textContent   = data.length;

  const accEl = document.getElementById('kpiAccuracy');
  accEl.textContent = closed.length ? Math.round(correct.length / closed.length * 100) + '%' : 'â€”';

  const pnlEl = document.getElementById('kpiPnl');
  pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(4);
  pnlEl.className   = 'kpi-value ' + (totalPnl >= 0 ? 'green' : 'red');

  const roiEl = document.getElementById('kpiRoi');
  roiEl.textContent = (roiPct >= 0 ? '+' : '') + roiPct.toFixed(2) + '%';
  roiEl.className   = 'kpi-value ' + (roiPct >= 0 ? 'purple' : 'red');

  document.getElementById('kpiWinRate').textContent = closedBets.length ? Math.round(correctBets.length / closedBets.length * 100) + '%' : 'â€”';
  document.getElementById('kpiFG').textContent      = lastFG !== null ? lastFG : 'â€”';
  document.getElementById('kpiFGLabel').textContent = lastFG !== null
    ? (lastFG < 20 ? 'EXTREME FEAR' : lastFG < 40 ? 'FEAR' : lastFG < 60 ? 'NEUTRAL' : lastFG < 80 ? 'GREED' : 'EXTREME GREED') : '';
  document.getElementById('kpiBets').textContent    = bets.length + '/' + data.length;
  document.getElementById('kpiDrawdown').textContent= worstPnl ? '$' + worstPnl.toFixed(4) : 'â€”';

  document.getElementById('feesTotal').textContent = '$' + totalFees.toFixed(4);
  document.getElementById('feesSub').textContent   = 'exit fees Â· ' + realBets.filter(d => parseFloat(d.fees_total || 0) > 0).length + ' trades';

  document.getElementById('statConf').textContent  = (avgConf * 100).toFixed(1) + '%';
  document.getElementById('statBest').textContent  = bestPnl  ? '+$' + bestPnl.toFixed(4)  : 'â€”';
  document.getElementById('statWorst').textContent = worstPnl ? '$'  + worstPnl.toFixed(4) : 'â€”';

  renderTable(data);

  const chronoBets = [...realBets].reverse();
  renderPnlChart(chronoBets);
  renderSignalQuality(data);
  renderConfDist(data);
  renderEquityCurve(chronoBets, totalPnl);

  const tag = document.getElementById('totalPnlTag');
  tag.textContent = 'TOTAL: ' + (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(4);
  tag.className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');
}

function renderTable(data) {
  const dirFilter   = document.getElementById('filterDir').value;
  const classFilter = document.getElementById('filterClass').value;
  const filtered = data.filter(d => {
    if (dirFilter   !== 'ALL' && d.direction      !== dirFilter)   return false;
    if (classFilter !== 'ALL' && d.classification !== classFilter) return false;
    return true;
  });
  const tbody = document.getElementById('signalTable');
  if (!filtered.length) {
    tbody.innerHTML = '<tr class="no-data-row"><td colspan="13">NO DATA</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(d => {
    const dirCls  = d.direction === 'UP' ? 'dir-up' : 'dir-down';
    const dirIcon = d.direction === 'UP' ? 'â†‘' : 'â†“';
    const betBadge = d.classification === 'BET'
      ? '<span class="badge badge-bet">BET</span>'
      : '<span class="badge badge-nobet">NO BET</span>';
    const resultBadge = d.correct === true
      ? '<span class="badge badge-correct">âœ“ WIN</span>'
      : d.correct === false
        ? '<span class="badge badge-wrong">âœ— LOSS</span>'
        : '<span style="color:var(--muted);font-size:10px;">OPEN</span>';
    const pnlCls    = d.pnl_usd === null ? 'pnl-null' : parseFloat(d.pnl_usd) >= 0 ? 'pnl-pos' : 'pnl-neg';
    const score     = (d.technical_score !== null && d.technical_score !== undefined) ? parseFloat(d.technical_score).toFixed(1) : 'â€”';
    const scoreColor= parseFloat(d.technical_score) >= 0 ? 'var(--accent)' : 'var(--danger)';
    return `<tr>
      <td style="color:var(--muted)">${d.id}</td>
      <td style="color:var(--muted)">${fmtDate(d.created_at)}</td>
      <td class="${dirCls}">${dirIcon} ${d.direction}</td>
      <td>${fmtConf(d.confidence)}</td>
      <td>${fmtPrice(d.btc_price_entry)}</td>
      <td>${fmtPrice(d.btc_price_exit)}</td>
      <td>${d.rsi14 ? parseFloat(d.rsi14).toFixed(1) : 'â€”'}</td>
      <td>${emaLabel(d.ema_trend)}</td>
      <td style="color:${scoreColor}">${score}</td>
      <td>${renderSizeCell(d)}</td>
      <td>${betBadge}</td>
      <td>${resultBadge}</td>
      <td class="${pnlCls}">${fmtPnl(d.pnl_usd)}</td>
    </tr>`;
  }).join('');
}

function renderPnlChart(chronoBets) {
  if (!chronoBets.length) return;
  const chart  = document.getElementById('pnlChart');
  const maxAbs = Math.max(...chronoBets.map(d => Math.abs(parseFloat(d.pnl_usd || 0))));
  const maxH   = 82;
  chart.innerHTML = chronoBets.map(d => {
    const v   = parseFloat(d.pnl_usd || 0);
    const h   = maxAbs > 0 ? Math.max(2, Math.abs(v) / maxAbs * maxH) : 2;
    const cls = v > 0 ? 'pos' : v < 0 ? 'neg' : 'zero';
    return `<div class="bar ${cls}" style="height:${h}px"><div class="tooltip">${fmtPnl(v)}</div></div>`;
  }).join('');
  const times = chronoBets.map(d => fmtTime(d.created_at));
  document.getElementById('chartStart').textContent = times[0];
  document.getElementById('chartEnd').textContent   = times[times.length - 1];
}

function renderSignalQuality(data) {
  const pct = (arr, fn) => arr.length ? Math.round(arr.filter(fn).length / arr.length * 100) : 0;
  const closed    = data.filter(d => d.correct !== null);
  const upClosed  = data.filter(d => d.direction === 'UP'   && d.correct !== null);
  const dnClosed  = data.filter(d => d.direction === 'DOWN' && d.correct !== null);
  const betClosed = data.filter(d => d.classification === 'BET' && d.correct !== null);
  const metrics = [
    { label: 'Overall Accuracy',     value: pct(closed,    d => d.correct), color: 'var(--accent)' },
    { label: 'Bet Win Rate',         value: pct(betClosed, d => d.correct), color: 'var(--blue)'   },
    { label: 'UP Signal Accuracy',   value: pct(upClosed,  d => d.correct), color: 'var(--accent)' },
    { label: 'DOWN Signal Accuracy', value: pct(dnClosed,  d => d.correct), color: 'var(--danger)' },
    { label: 'Bet Coverage',         value: data.length ? Math.round(data.filter(d => d.classification === 'BET').length / data.length * 100) : 0, color: 'var(--warn)' },
  ];
  document.getElementById('signalQuality').innerHTML = metrics.map(m => `
    <div class="signal-row">
      <div class="signal-meta">
        <span class="signal-label">${m.label}</span>
        <span class="signal-val" style="color:${m.color}">${m.value}%</span>
      </div>
      <div class="signal-bar-bg"><div class="signal-bar-fill" style="width:${m.value}%;background:${m.color}"></div></div>
    </div>`).join('');
}

function renderConfDist(data) {
  const buckets = [
    { label: '50-54%', min: 0.50, max: 0.55 },
    { label: '55-59%', min: 0.55, max: 0.60 },
    { label: '60-64%', min: 0.60, max: 0.65 },
    { label: '65-69%', min: 0.65, max: 0.70 },
    { label: '70%+',   min: 0.70, max: 1.01 },
  ];
  const counts   = buckets.map(b => ({ ...b, count: data.filter(d => { const c = parseFloat(d.confidence); return c >= b.min && c < b.max; }).length }));
  const maxCount = Math.max(...counts.map(c => c.count), 1);
  document.getElementById('confDist').innerHTML = counts.map(c => `
    <div class="conf-row">
      <div class="conf-label">${c.label}</div>
      <div class="conf-bar-bg"><div class="conf-bar-fill" style="width:${Math.round(c.count / maxCount * 100)}%"></div></div>
      <div class="conf-count">${c.count}</div>
    </div>`).join('');
}

function renderEquityCurve(chronoBets, totalPnl) {
  const svg = document.getElementById('equitySvg');
  if (!chronoBets.length) { svg.innerHTML = ''; return; }
  let cum = 0;
  const points = [{ i: 0, cum: 0 }];
  chronoBets.forEach((d, i) => { cum += parseFloat(d.pnl_usd || 0); points.push({ i: i+1, cum }); });
  const minV = Math.min(...points.map(p => p.cum));
  const maxV = Math.max(...points.map(p => p.cum));
  const range= maxV - minV || 0.001;
  const W = 1000, H = 100;
  const toX = i => (i / (points.length - 1)) * W;
  const toY = v => H - ((v - minV) / range) * (H - 10) - 5;
  const pts  = points.map((p, i) => `${toX(i).toFixed(1)},${toY(p.cum).toFixed(1)}`).join(' ');
  const areaClose = `${toX(points.length-1).toFixed(1)},${H} 0,${H}`;
  const color  = totalPnl >= 0 ? 'var(--accent)' : 'var(--danger)';
  const gradId = totalPnl >= 0 ? 'eqG' : 'eqGR';
  svg.innerHTML = `
    <defs>
      <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${pts} ${areaClose}" fill="url(#${gradId})"/>
    <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${toX(points.length-1).toFixed(1)}" cy="${toY(points[points.length-1].cum).toFixed(1)}" r="3.5" fill="${color}"/>`;
  document.getElementById('equityTag').textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(4);
  document.getElementById('equityTag').className   = 'panel-tag ' + (totalPnl >= 0 ? 'tag-green' : 'tag-red');
}

async function fetchWalletData() {
  try {
    const res = await fetch(CONFIG.RAILWAY_URL + '/account-summary', { signal: AbortSignal.timeout(8000) });
    if (!res.ok) throw new Error();
    const d = await res.json();
    const portfolio = d.wallet?.portfolio_value;
    const usdc      = d.wallet?.usdc_available;
    const margin    = d.wallet?.margin_usage_pct;
    const posOpen   = d.position?.open;

    if (portfolio != null) {
      const eq = parseFloat(portfolio);
      const equityEl = document.getElementById('walletEquity');
      equityEl.textContent = '$' + eq.toFixed(4);
      equityEl.className   = 'kpi-value ' + (eq >= CONFIG.CAPITAL ? 'green' : 'red');
      document.getElementById('walletEquitySub').textContent =
        posOpen ? 'margin ' + (margin ?? 0) + '% Â· position open' : 'flat Â· no position';

      const delta   = eq - CONFIG.CAPITAL;
      const deltaEl = document.getElementById('walletDelta');
      deltaEl.textContent = (delta >= 0 ? '+' : '') + '$' + delta.toFixed(4);
      deltaEl.className   = 'kpi-value ' + (delta >= 0 ? 'green' : 'red');
    }
    if (usdc != null) {
      document.getElementById('walletUsdc').textContent = '$' + parseFloat(usdc).toFixed(4);
    }
  } catch(e) {
    console.warn('Wallet fetch failed:', e);
  }
}

async function refresh() {
  try { allData = await fetchData(); renderAll(allData); }
  catch(e) { console.error('Render error:', e); }
}

document.getElementById('filterDir').addEventListener('change',   () => renderTable(filterByPeriod(allData)));
document.getElementById('filterClass').addEventListener('change', () => renderTable(filterByPeriod(allData)));

refresh();
setInterval(refresh, CONFIG.REFRESH_INTERVAL);
fetchLiveBtcPrice();
setInterval(fetchLiveBtcPrice, CONFIG.BTC_REFRESH);
fetchWalletData();
setInterval(fetchWalletData, 30000);
</script>
</body>
</html>
